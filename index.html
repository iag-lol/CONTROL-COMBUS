<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics | Sistema Avanzado de Gestión</title>

    <!-- CSS Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <!-- Icon Library -->
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- XLSX.js for Excel file handling -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>

    
:root {
    /* Paleta principal - Tonos azules profesionales */
    --primary-50: #e6f8ff;
    --primary-100: #b3ecff;
    --primary-200: #80dfff;
    --primary-300: #4dd2ff;
    --primary-400: #26c6ff;
    --primary-500: #00baff;
    --primary-600: #0095cc;
    --primary-700: #007099;
    --primary-800: #004c66;
    --primary-900: #002733;

    /* Paleta secundaria - Tonos violetas elegantes */
    --secondary-50: #f0ebff;
    --secondary-100: #d1c2ff;
    --secondary-200: #b39aff;
    --secondary-300: #9472ff;
    --secondary-400: #764aff;
    --secondary-500: #5722ff;
    --secondary-600: #461bcc;
    --secondary-700: #341499;
    --secondary-800: #230e66;
    --secondary-900: #110733;

    /* Tonos de éxito - Verdes vibrantes */
    --success-50: #e6fff0;
    --success-100: #b3ffda;
    --success-200: #80ffc3;
    --success-300: #4dffad;
    --success-400: #26ff9a;
    --success-500: #00ff87;
    --success-600: #00cc6c;
    --success-700: #009951;
    --success-800: #006636;
    --success-900: #00331b;

    /* Tonos de advertencia - Amarillos refinados */
    --warning-50: #fffde6;
    --warning-100: #fffab3;
    --warning-200: #fff780;
    --warning-300: #fff44d;
    --warning-400: #fff226;
    --warning-500: #fff000;
    --warning-600: #ccc000;
    --warning-700: #999000;
    --warning-800: #666000;
    --warning-900: #333000;

    /* Tonos de peligro - Rojos impactantes */
    --danger-50: #ffe6e6;
    --danger-100: #ffb3b3;
    --danger-200: #ff8080;
    --danger-300: #ff4d4d;
    --danger-400: #ff2626;
    --danger-500: #ff0000;
    --danger-600: #cc0000;
    --danger-700: #990000;
    --danger-800: #660000;
    --danger-900: #330000;

    /* Modo claro - Tonos neutros elegantes */
    --text-light: #1a1f36;
    --text-light-secondary: #424770;
    --bg-light: #f7fafc;
    --card-light: #ffffff;
    --border-light: #e2e8f0;
    --surface-light: #f8fafc;

    /* Modo oscuro - Futurista y sofisticado */
    --text-dark: #f8fafc;
    --text-dark-secondary: #a5b4fc;
    --bg-dark: #0f172a;
    --card-dark: #1e293b;
    --border-dark: #334155;
    --surface-dark: #0f1629;

    /* Radios de borde refinados */
    --border-radius-sm: 0.25rem;
    --border-radius-md: 0.375rem;
    --border-radius-lg: 0.5rem;
    --border-radius-xl: 0.75rem;
    --border-radius-2xl: 1rem;
    --border-radius-full: 9999px;

    /* Sistema de sombras empresarial */
    --shadow-sm: 0 2px 5px -1px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 10px -1px rgba(0, 0, 0, 0.1), 0 2px 6px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
    
    /* Sombras modo oscuro */
    --shadow-dark-sm: 0 2px 5px -1px rgba(0, 0, 0, 0.25);
    --shadow-dark-md: 0 4px 10px -1px rgba(0, 0, 0, 0.3), 0 2px 6px -1px rgba(0, 0, 0, 0.26);
    --shadow-dark-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.35), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
    --shadow-dark-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
    --shadow-dark-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.3);

    /* Efectos de resplandor */
    --glow-primary: 0 0 15px rgba(0, 186, 255, 0.5);
    --glow-secondary: 0 0 15px rgba(87, 34, 255, 0.5);
    --glow-success: 0 0 15px rgba(0, 255, 135, 0.5);
    --glow-warning: 0 0 15px rgba(255, 240, 0, 0.5);
    --glow-danger: 0 0 15px rgba(255, 0, 0, 0.5);

    /* Tiempos de transición refinados */
    --transition-fast: 150ms;
    --transition-normal: 250ms;
    --transition-slow: 350ms;
    --transition-very-slow: 500ms;
    
    /* Curvas de aceleración personalizadas */
    --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
    --ease-out: cubic-bezier(0, 0, 0.2, 1);
    --ease-in: cubic-bezier(0.4, 0, 1, 1);
    
    /* Fuentes personalizadas */
    --font-heading: 'Inter', sans-serif;
    --font-body: 'Inter', sans-serif;
    --font-mono: 'JetBrains Mono', monospace;
    
    /* Z-index system */
    --z-negative: -1;
    --z-base: 1;
    --z-dropdown: 10;
    --z-sticky: 20;
    --z-fixed: 30;
    --z-modal-backdrop: 40;
    --z-modal: 50;
    --z-popover: 60;
    --z-tooltip: 70;
}

/* Base styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html {
    font-size: 16px;
    scroll-behavior: smooth;
}

body {
    font-family: var(--font-body);
    background-color: var(--bg-light);
    color: var(--text-light);
    line-height: 1.5;
    transition: background-color var(--transition-normal) var(--ease-out),
                color var(--transition-normal) var(--ease-out);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

body.dark {
    background-color: var(--bg-dark);
    color: var(--text-dark);
}

/* Scrollbar styling */
::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

::-webkit-scrollbar-track {
    background: var(--bg-light);
    border-radius: var(--border-radius-full);
}

.dark ::-webkit-scrollbar-track {
    background: var(--bg-dark);
}

::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: var(--border-radius-full);
    transition: background var(--transition-normal);
}

.dark ::-webkit-scrollbar-thumb {
    background: #475569;
}

::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

.dark ::-webkit-scrollbar-thumb:hover {
    background: #64748b;
}

/* Dashboard layout */
.dashboard-container {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

.dashboard-main {
    display: flex;
    flex-grow: 1;
    overflow: hidden;
    max-height: calc(100vh - 60px);
}

.sidebar {
    width: 260px;
    flex-shrink: 0;
    overflow-y: auto;
    border-right: 1px solid var(--border-light);
    background-color: var(--card-light);
    transition: width var(--transition-normal) var(--ease-out),
                transform var(--transition-normal) var(--ease-out),
                background-color var(--transition-normal) var(--ease-out),
                border-color var(--transition-normal) var(--ease-out);
    z-index: var(--z-sticky);
    height: calc(100vh - 60px);
    box-shadow: var(--shadow-sm);
}

.dark .sidebar {
    border-right-color: var(--border-dark);
    background-color: var(--card-dark);
    box-shadow: var(--shadow-dark-sm);
}

.sidebar:hover {
    box-shadow: var(--shadow-md);
}

.dark .sidebar:hover {
    box-shadow: var(--shadow-dark-md);
}

.content-wrapper {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.content {
    padding: 1.25rem;
    overflow-y: auto;
    height: calc(100vh - 60px);
}

@media (max-width: 1024px) {
    .sidebar {
        position: fixed;
        top: 60px;
        left: 0;
        bottom: 0;
        transform: translateX(-100%);
        box-shadow: var(--shadow-lg);
        z-index: var(--z-fixed);
    }

    .dark .sidebar {
        box-shadow: var(--shadow-dark-lg);
    }

    .sidebar.open {
        transform: translateX(0);
    }

    .overlay {
        position: fixed;
        top: 60px;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: var(--z-modal-backdrop);
        opacity: 0;
        visibility: hidden;
        transition: opacity var(--transition-normal) var(--ease-out),
                    visibility var(--transition-normal) var(--ease-out);
    }

    .overlay.active {
        opacity: 1;
        visibility: visible;
    }
}

/* Header */
.header {
    height: 60px;
    background-color: var(--card-light);
    border-bottom: 1px solid var(--border-light);
    display: flex;
    align-items: center;
    padding: 0 1.25rem;
    position: sticky;
    top: 0;
    z-index: var(--z-sticky);
    box-shadow: var(--shadow-sm);
    transition: background-color var(--transition-normal) var(--ease-out),
                border-color var(--transition-normal) var(--ease-out),
                box-shadow var(--transition-normal) var(--ease-out);
}

.dark .header {
    background-color: var(--card-dark);
    border-bottom-color: var(--border-dark);
    box-shadow: var(--shadow-dark-sm);
}

/* Card styling */
.card {
    background-color: var(--card-light);
    border-radius: var(--border-radius-lg);
    border: 1px solid var(--border-light);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    transition: all var(--transition-normal) var(--ease-out);
    position: relative;
}

.dark .card {
    background-color: var(--card-dark);
    border-color: var(--border-dark);
    box-shadow: var(--shadow-dark-sm);
}

.card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(to right, var(--primary-500), var(--secondary-500));
    opacity: 0;
    transition: opacity var(--transition-normal) var(--ease-out);
}

.card:hover::before {
    opacity: 1;
}

.card-hover {
    transition: all var(--transition-normal) var(--ease-out);
}

.card-hover:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
}

.dark .card-hover:hover {
    box-shadow: var(--shadow-dark-md);
}

/* Button styling */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: var(--border-radius-md);
    font-weight: 500;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all var(--transition-normal) var(--ease-out);
    position: relative;
    overflow: hidden;
    border: none;
    outline: none;
}

.btn::after {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    background: rgba(255, 255, 255, 0.1);
    opacity: 0;
    transition: opacity var(--transition-normal) var(--ease-out);
}

.btn:hover::after {
    opacity: 1;
}

.btn:active {
    transform: translateY(1px);
}

.btn-primary {
    background-image: linear-gradient(135deg, var(--primary-600), var(--secondary-600));
    color: white;
    box-shadow: 0 2px 6px rgba(0, 186, 255, 0.4);
}

.btn-primary:hover {
    box-shadow: 0 4px 12px rgba(0, 186, 255, 0.6);
}

.btn-secondary {
    background-color: #1e293b;
    color: white;
}

.btn-secondary:hover {
    background-color: #0f172a;
}

.btn-outline {
    background-color: transparent;
    border: 1px solid var(--border-light);
    color: var(--text-light);
}

.dark .btn-outline {
    border-color: var(--border-dark);
    color: var(--text-dark);
}

.btn-outline:hover {
    background-color: rgba(0, 0, 0, 0.05);
}

.dark .btn-outline:hover {
    background-color: rgba(255, 255, 255, 0.05);
}

.btn-icon {
    width: 2.25rem;
    height: 2.25rem;
    padding: 0;
    border-radius: var(--border-radius-full);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn:disabled::after {
    display: none;
}

/* Input fields */
.input-field {
    background-color: var(--surface-light);
    border: 1px solid var(--border-light);
    color: var(--text-light);
    border-radius: var(--border-radius-md);
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    transition: all var(--transition-normal) var(--ease-out);
    outline: none;
    width: 100%;
    box-shadow: var(--shadow-sm);
}

.dark .input-field {
    background-color: var(--surface-dark);
    border-color: var(--border-dark);
    color: var(--text-dark);
    box-shadow: var(--shadow-dark-sm);
}

.input-field:focus {
    border-color: var(--primary-500);
    box-shadow: 0 0 0 2px rgba(0, 186, 255, 0.2);
}

.dark .input-field:focus {
    border-color: var(--primary-400);
    box-shadow: 0 0 0 2px rgba(0, 186, 255, 0.3);
}

.input-field::placeholder {
    color: #94a3b8;
}

.dark .input-field::placeholder {
    color: #64748b;
}

/* Badge styling */
.badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.2rem 0.6rem;
    font-size: 0.75rem;
    font-weight: 500;
    border-radius: var(--border-radius-full);
    transition: all var(--transition-normal) var(--ease-out);
}

.badge-primary {
    background-color: var(--primary-100);
    color: var(--primary-700);
}

.dark .badge-primary {
    background-color: rgba(0, 186, 255, 0.2);
    color: var(--primary-300);
}

.badge-success {
    background-color: var(--success-100);
    color: var(--success-700);
}

.dark .badge-success {
    background-color: rgba(0, 255, 135, 0.2);
    color: var(--success-300);
}

.badge-warning {
    background-color: var(--warning-100);
    color: var(--warning-700);
}

.dark .badge-warning {
    background-color: rgba(255, 240, 0, 0.2);
    color: var(--warning-300);
}

.badge-danger {
    background-color: var(--danger-100);
    color: var(--danger-700);
}

.dark .badge-danger {
    background-color: rgba(255, 0, 0, 0.2);
    color: var(--danger-300);
}

/* Table styling */
.table-container {
    overflow-x: auto;
    border-radius: var(--border-radius-lg);
    border: 1px solid var(--border-light);
    transition: border-color var(--transition-normal) var(--ease-out);
    background: var(--card-light);
}

.dark .table-container {
    border-color: var(--border-dark);
    background: var(--card-dark);
}

.data-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.875rem;
}

.data-table th {
    background-color: var(--surface-light);
    color: var(--text-light-secondary);
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--border-light);
    position: sticky;
    top: 0;
    z-index: var(--z-base);
    transition: background-color var(--transition-normal) var(--ease-out),
                color var(--transition-normal) var(--ease-out),
                border-color var(--transition-normal) var(--ease-out);
}

.dark .data-table th {
    background-color: var(--surface-dark);
    color: var(--text-dark-secondary);
    border-bottom-color: var(--border-dark);
}

.data-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-light);
    color: var(--text-light);
    white-space: nowrap;
    transition: background-color var(--transition-normal) var(--ease-out),
                color var(--transition-normal) var(--ease-out),
                border-color var(--transition-normal) var(--ease-out);
}

.dark .data-table td {
    color: var(--text-dark);
    border-bottom-color: var(--border-dark);
}

.data-table tr:last-child td {
    border-bottom: none;
}

.data-table tr {
    transition: background-color var(--transition-fast) var(--ease-out);
}

.data-table tr:hover td {
    background-color: rgba(0, 0, 0, 0.02);
}

.dark .data-table tr:hover td {
    background-color: rgba(255, 255, 255, 0.02);
}

/* Status indicators */
.status-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 5px;
    transition: background-color var(--transition-normal) var(--ease-out);
}

.status-operational {
    background-color: var(--success-500);
    box-shadow: 0 0 4px var(--success-500);
}

.status-maintenance {
    background-color: var(--warning-500);
    box-shadow: 0 0 4px var(--warning-500);
}

.status-panne {
    background-color: var(--danger-500);
    box-shadow: 0 0 4px var(--danger-500);
}

.status-inactive {
    background-color: #94a3b8;
}

/* Tabs styling */
.tabs {
    display: flex;
    border-bottom: 1px solid var(--border-light);
    margin-bottom: 1rem;
    overflow-x: auto;
    scrollbar-width: none;
    transition: border-color var(--transition-normal) var(--ease-out);
}

.dark .tabs {
    border-bottom-color: var(--border-dark);
}

.tabs::-webkit-scrollbar {
    display: none;
}

.tab {
    padding: 0.75rem 1rem;
    font-weight: 500;
    font-size: 0.875rem;
    color: var(--text-light-secondary);
    border-bottom: 2px solid transparent;
    cursor: pointer;
    white-space: nowrap;
    transition: all var(--transition-normal) var(--ease-out);
    position: relative;
    overflow: hidden;
}

.dark .tab {
    color: var(--text-dark-secondary);
}

.tab::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    width: 0;
    height: 2px;
    background-image: linear-gradient(to right, var(--primary-500), var(--secondary-500));
    transition: width var(--transition-normal) var(--ease-out),
                left var(--transition-normal) var(--ease-out);
}

.tab:hover {
    color: var(--primary-600);
}

.dark .tab:hover {
    color: var(--primary-400);
}

.tab:hover::after {
    width: 100%;
    left: 0;
}

.tab.active {
    color: var(--primary-600);
    font-weight: 600;
}

.dark .tab.active {
    color: var(--primary-400);
}

.tab.active::after {
    width: 100%;
    left: 0;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
    animation: fadeIn 0.4s var(--ease-out);
}

/* Nav menu styling */
.nav-menu {
    list-style: none;
    padding: 0;
    margin: 0;
}

.nav-menu-item {
    margin-bottom: 0.25rem;
}

.nav-menu-link {
    display: flex;
    align-items: center;
    padding: 0.6rem 0.75rem;
    color: var(--text-light-secondary);
    text-decoration: none;
    border-radius: var(--border-radius-md);
    transition: all var(--transition-normal) var(--ease-out);
    font-size: 0.875rem;
    position: relative;
    overflow: hidden;
}

.dark .nav-menu-link {
    color: var(--text-dark-secondary);
}

.nav-menu-link::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 0;
    height: 100%;
    background-image: linear-gradient(to right, rgba(0, 186, 255, 0.1), rgba(87, 34, 255, 0.1));
    transition: width var(--transition-slow) var(--ease-out);
    z-index: -1;
}

.nav-menu-link:hover {
    color: var(--text-light);
}

.dark .nav-menu-link:hover {
    color: var(--text-dark);
}

.nav-menu-link:hover::after {
    width: 100%;
}

.nav-menu-link.active {
    background-image: linear-gradient(to right, rgba(0, 186, 255, 0.1), rgba(87, 34, 255, 0.1));
    color: var(--primary-600);
    font-weight: 500;
}

.dark .nav-menu-link.active {
    background-image: linear-gradient(to right, rgba(0, 186, 255, 0.2), rgba(87, 34, 255, 0.2));
    color: var(--primary-400);
}

.nav-menu-link.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    width: 3px;
    background-image: linear-gradient(to bottom, var(--primary-500), var(--secondary-500));
    border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0;
}

.nav-menu-icon {
    margin-right: 0.75rem;
    font-size: 1.25rem;
    opacity: 0.7;
    transition: opacity var(--transition-normal) var(--ease-out),
                transform var(--transition-normal) var(--ease-out);
}

.nav-menu-link:hover .nav-menu-icon,
.nav-menu-link.active .nav-menu-icon {
    opacity: 1;
    transform: scale(1.1);
}

/* Divider */
.divider {
    height: 1px;
    background-color: var(--border-light);
    margin: 1rem 0;
    transition: background-color var(--transition-normal) var(--ease-out);
}

.dark .divider {
    background-color: var(--border-dark);
}

/* Tooltip */
.tooltip {
    position: relative;
    display: inline-block;
}

.tooltip .tooltip-text {
    visibility: hidden;
    width: 180px;
    background-color: #27272a;
    color: #f8fafc;
    text-align: center;
    border-radius: var(--border-radius-md);
    padding: 0.5rem;
    position: absolute;
    z-index: var(--z-tooltip);
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%) scale(0.95);
    opacity: 0;
    transition: all var(--transition-normal) var(--ease-out);
    box-shadow: var(--shadow-lg);
    font-size: 0.75rem;
    pointer-events: none;
}

.tooltip .tooltip-text::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #27272a transparent transparent transparent;
}

.tooltip:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
    transform: translateX(-50%) scale(1);
}

/* Loading spinner */
.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid rgba(0, 0, 0, 0.1);
    border-top-color: var(--primary-500);
    animation: spin 1s linear infinite;
}

.dark .loading-spinner {
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-top-color: var(--primary-400);
}

@keyframes spin {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}

/* Toast notification */
.toast {
    position: fixed;
    bottom: 1.5rem;
    left: 1.5rem;
    background-color: var(--card-light);
    border: 1px solid var(--border-light);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-xl);
    padding: 1rem;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    max-width: 24rem;
    z-index: var(--z-tooltip);
    transform: translateY(150%);
    opacity: 0;
    transition: transform var(--transition-normal) var(--ease-out),
                opacity var(--transition-normal) var(--ease-out),
                background-color var(--transition-normal) var(--ease-out),
                border-color var(--transition-normal) var(--ease-out);
}

.dark .toast {
    background-color: var(--card-dark);
    border-color: var(--border-dark);
    box-shadow: var(--shadow-dark-xl);
}

.toast.show {
    transform: translateY(0);
    opacity: 1;
}

.toast-icon {
    flex-shrink: 0;
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.toast-content {
    flex-grow: 1;
}

.toast-title {
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--text-light);
    margin-bottom: 0.25rem;
}

.dark .toast-title {
    color: var(--text-dark);
}

.toast-message {
    font-size: 0.8125rem;
    color: var(--text-light-secondary);
}

.dark .toast-message {
    color: var(--text-dark-secondary);
}

/* Modal */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(6px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: var(--z-modal);
    opacity: 0;
    visibility: hidden;
    transition: opacity var(--transition-normal) var(--ease-out),
                visibility var(--transition-normal) var(--ease-out);
}

.modal.open {
    opacity: 1;
    visibility: visible;
}

.modal-content {
    background-color: var(--card-light);
    border-radius: var(--border-radius-xl);
    box-shadow: var(--shadow-xl);
    width: 100%;
    max-width: 32rem;
    max-height: 90vh;
    overflow: auto;
    transform: scale(0.95);
    opacity: 0;
    transition: transform var(--transition-normal) var(--ease-out),
                opacity var(--transition-normal) var(--ease-out),
                background-color var(--transition-normal) var(--ease-out);
    border: 1px solid var(--border-light);
}

.dark .modal-content {
    background-color: var(--card-dark);
    box-shadow: var(--shadow-dark-xl);
    border-color: var(--border-dark);
}

.modal.open .modal-content {
    transform: scale(1);
    opacity: 1;
}

.modal-header {
    padding: 1rem;
    border-bottom: 1px solid var(--border-light);
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: border-color var(--transition-normal) var(--ease-out);
}

.dark .modal-header {
    border-bottom-color: var(--border-dark);
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    padding: 1rem;
    border-top: 1px solid var(--border-light);
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    transition: border-color var(--transition-normal) var(--ease-out);
}

.dark .modal-footer {
    border-top-color: var(--border-dark);
}

/* File upload */
.file-upload {
    border: 2px dashed var(--border-light);
    border-radius: var(--border-radius-lg);
    padding: 1.5rem;
    text-align: center;
    transition: all var(--transition-normal) var(--ease-out);
    cursor: pointer;
    background-color: var(--surface-light);
}

.dark .file-upload {
    border-color: var(--border-dark);
    background-color: var(--surface-dark);
}

.file-upload:hover {
    border-color: var(--primary-500);
    background-color: rgba(0, 186, 255, 0.05);
    transform: translateY(-2px);
}

.dark .file-upload:hover {
    border-color: var(--primary-400);
    background-color: rgba(0, 186, 255, 0.1);
}

.file-upload-icon {
    font-size: 2rem;
    color: #94a3b8;
    margin-bottom: 0.5rem;
    transition: color var(--transition-normal) var(--ease-out), 
                transform var(--transition-normal) var(--ease-out);
}

.dark .file-upload-icon {
    color: #64748b;
}

.file-upload:hover .file-upload-icon {
    color: var(--primary-500);
    transform: scale(1.1);
}

.dark .file-upload:hover .file-upload-icon {
    color: var(--primary-400);
}

/* Switch toggle */
.switch {
    position: relative;
    display: inline-block;
    width: 3rem;
    height: 1.5rem;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #cbd5e1;
    transition: var(--transition-normal);
    border-radius: var(--border-radius-full);
}

.slider:before {
    position: absolute;
    content: "";
    height: 1.1rem;
    width: 1.1rem;
    left: 0.2rem;
    bottom: 0.2rem;
    background-color: white;
    transition: var(--transition-normal);
    border-radius: 50%;
    box-shadow: var(--shadow-sm);
}

input:checked + .slider {
    background-image: linear-gradient(to right, var(--primary-500), var(--secondary-500));
}

input:focus + .slider {
    box-shadow: 0 0 0 2px rgba(0, 186, 255, 0.2);
}

input:checked + .slider:before {
    transform: translateX(1.5rem);
}

/* Grid layout */
.grid-cols-1 {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
}

.grid-cols-2 {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

.grid-cols-3 {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
}

.grid-cols-4 {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
}

@media (max-width: 1280px) {
    .grid-cols-4 {
        grid-template-columns: repeat(2, 1fr);
    }

    .grid-cols-3 {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .grid-cols-2,
    .grid-cols-3,
    .grid-cols-4 {
        grid-template-columns: 1fr;
    }
}

/* Chart container */
.chart-container {
    position: relative;
    height: 240px;
    width: 100%;
    transition: all var(--transition-normal) var(--ease-out);
}

.chart-container:hover {
    transform: translateY(-2px);
}

/* Animations */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideIn {
    from {
        transform: translateY(1rem);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(0, 186, 255, 0.4);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(0, 186, 255, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(0, 186, 255, 0);
    }
}

.animate-fade-in {
    animation: fadeIn 0.4s var(--ease-out);
}

.animate-slide-in {
    animation: slideIn 0.4s var(--ease-out);
}

.animate-pulse {
    animation: pulse 2s infinite;
}

/* Status pill */
.status-pill {
    display: inline-flex;
    align-items: center;
    padding: 0.2rem 0.7rem;
    border-radius: var(--border-radius-full);
    font-size: 0.75rem;
    font-weight: 500;
    transition: all var(--transition-normal) var(--ease-out);
}

.status-operational {
    background-color: var(--success-100);
    color: var(--success-700);
    box-shadow: 0 0 0 1px rgba(0, 255, 135, 0.1);
}

.dark .status-operational {
    background-color: rgba(0, 255, 135, 0.2);
    color: var(--success-300);
    box-shadow: 0 0 0 1px rgba(0, 255, 135, 0.3);
}

.status-maintenance {
    background-color: var(--warning-100);
    color: var(--warning-700);
    box-shadow: 0 0 0 1px rgba(255, 240, 0, 0.1);
}

.dark .status-maintenance {
    background-color: rgba(255, 240, 0, 0.2);
    color: var(--warning-300);
    box-shadow: 0 0 0 1px rgba(255, 240, 0, 0.3);
}

.status-panne {
    background-color: var(--danger-100);
    color: var(--danger-700);
    box-shadow: 0 0 0 1px rgba(255, 0, 0, 0.1);
}

.dark .status-panne {
    background-color: rgba(255, 0, 0, 0.2);
    color: var(--danger-300);
    box-shadow: 0 0 0 1px rgba(255, 0, 0, 0.3);
}

.status-inactive {
    background-color: #e2e8f0;
    color: #64748b;
}

.dark .status-inactive {
    background-color: rgba(100, 116, 139, 0.2);
    color: #94a3b8;
}

/* Data card */
.data-card {
    display: flex;
    flex-direction: column;
    height: 100%;
    transition: all var(--transition-normal) var(--ease-out);
}

.data-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.dark .data-card:hover {
    box-shadow: var(--shadow-dark-md);
}

.data-card-header {
    padding: 1rem;
    border-bottom: 1px solid var(--border-light);
    transition: border-color var(--transition-normal) var(--ease-out);
}

.dark .data-card-header {
    border-bottom-color: var(--border-dark);
}

.data-card-title {
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--text-light);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .data-card-title {
    color: var(--text-dark);
}

.data-card-body {
    padding: 1rem;
    flex-grow: 1;
    overflow: auto;
}

.data-card-footer {
    padding: 0.75rem 1rem;
    border-top: 1px solid var(--border-light);
    background-color: rgba(0, 0, 0, 0.01);
    font-size: 0.75rem;
    color: var(--text-light-secondary);
    transition: background-color var(--transition-normal) var(--ease-out),
                border-color var(--transition-normal) var(--ease-out),
                color var(--transition-normal) var(--ease-out);
}

.dark .data-card-footer {
    border-top-color: var(--border-dark);
    background-color: rgba(255, 255, 255, 0.01);
    color: var(--text-dark-secondary);
}

/* Stat card */
.stat-card {
    padding: 1.25rem;
    transition: all var(--transition-normal) var(--ease-out);
    border-radius: var(--border-radius-lg);
    border: 1px solid var(--border-light);
    background-color: var(--card-light);
    position: relative;
    overflow: hidden;
}

.dark .stat-card {
    background-color: var(--card-dark);
    border-color: var(--border-dark);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(to right, var(--primary-500), var(--secondary-500));
    opacity: 0;
    transition: opacity var(--transition-normal) var(--ease-out);
}

.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
}

.dark .stat-card:hover {
    box-shadow: var(--shadow-dark-md);
}

.stat-card:hover::before {
    opacity: 1;
}

.stat-card-label {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-light-secondary);
    margin-bottom: 0.5rem;
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .stat-card-label {
    color: var(--text-dark-secondary);
}

.stat-card-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-light);
    margin-bottom: 0.5rem;
    transition: color var(--transition-normal) var(--ease-out);
    background: linear-gradient(to right, var(--primary-600), var(--secondary-600));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    display: inline-block;
}

.dark .stat-card-value {
    background: linear-gradient(to right, var(--primary-400), var(--secondary-400));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.stat-card-change {
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
    transition: color var(--transition-normal) var(--ease-out);
}

.stat-card-change.positive {
    color: var(--success-600);
}

.dark .stat-card-change.positive {
    color: var(--success-400);
}

.stat-card-change.negative {
    color: var(--danger-600);
}

.dark .stat-card-change.negative {
    color: var(--danger-400);
}

/* Terminal badge */
.terminal-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.2rem 0.5rem;
    font-size: 0.6875rem;
    font-weight: 600;
    border-radius: var(--border-radius-full);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: all var(--transition-normal) var(--ease-out);
}

.terminal-el-roble {
    background-color: #dbeafe;
    color: #1e40af;
}

.dark .terminal-el-roble {
    background-color: rgba(30, 64, 175, 0.2);
    color: #93c5fd;
}

.terminal-la-reina {
    background-color: #fef3c7;
    color: #92400e;
}

.dark .terminal-la-reina {
    background-color: rgba(146, 64, 14, 0.2);
    color: #fcd34d;
}

.terminal-maria-angelica {
    background-color: #d1fae5;
    color: #065f46;
}

.dark .terminal-maria-angelica {
    background-color: rgba(6, 95, 70, 0.2);
    color: #6ee7b7;
}

/* Advanced stat card */
.advanced-stat-card {
    border-radius: var(--border-radius-lg);
    padding: 1rem;
    background-color: var(--surface-light);
    border: 1px solid var(--border-light);
    box-shadow: var(--shadow-sm);
    transition: all var(--transition-normal) var(--ease-out);
}

.dark .advanced-stat-card {
    background-color: var(--surface-dark);
    border-color: var(--border-dark);
    box-shadow: var(--shadow-dark-sm);
}

.advanced-stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.dark .advanced-stat-card:hover {
    box-shadow: var(--shadow-dark-md);
}

.advanced-stat-title {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-light-secondary);
    margin-bottom: 0.5rem;
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .advanced-stat-title {
    color: var(--text-dark-secondary);
}

.advanced-stat-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-light);
    margin-bottom: 0.5rem;
    display: flex;
    align-items: baseline;
    transition: color var(--transition-normal) var(--ease-out);
    background: linear-gradient(to right, var(--primary-600), var(--secondary-600));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.dark .advanced-stat-value {
    background: linear-gradient(to right, var(--primary-400), var(--secondary-400));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.advanced-stat-value .unit {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-light-secondary);
    margin-left: 0.25rem;
    transition: color var(--transition-normal) var(--ease-out);
    -webkit-text-fill-color: initial;
}

.dark .advanced-stat-value .unit {
    color: var(--text-dark-secondary);
}

.advanced-stat-progress {
    height: 5px;
    background-color: var(--border-light);
    border-radius: var(--border-radius-full);
    margin-bottom: 0.5rem;
    overflow: hidden;
    transition: background-color var(--transition-normal) var(--ease-out);
}

.dark .advanced-stat-progress {
    background-color: var(--border-dark);
}

.advanced-stat-progress-bar {
    height: 100%;
    border-radius: var(--border-radius-full);
    transition: width var(--transition-slow) var(--ease-out);
    background-image: linear-gradient(to right, var(--primary-500), var(--secondary-500));
}

.advanced-stat-details {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: var(--text-light-secondary);
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .advanced-stat-details {
    color: var(--text-dark-secondary);
}

/* Font utilities */
.font-mono {
    font-family: var(--font-mono);
}

/* File info */
.file-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background-color: var(--surface-light);
    border: 1px solid var(--border-light);
    border-radius: var(--border-radius-lg);
    margin-top: 0.5rem;
    font-size: 0.8125rem;
    transition: all var(--transition-normal) var(--ease-out);
}

.dark .file-info {
    background-color: var(--surface-dark);
    border-color: var(--border-dark);
}

.file-info:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

.dark .file-info:hover {
    box-shadow: var(--shadow-dark-sm);
}

.file-info-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    background-color: var(--border-light);
    border-radius: var(--border-radius-lg);
    color: var(--text-light-secondary);
    font-size: 1.25rem;
    transition: all var(--transition-normal) var(--ease-out);
}

.dark .file-info-icon {
    background-color: var(--border-dark);
    color: var(--text-dark-secondary);
}

.file-info:hover .file-info-icon {
    background-color: rgba(0, 186, 255, 0.1);
    color: var(--primary-600);
    transform: scale(1.05);
}

.dark .file-info:hover .file-info-icon {
    background-color: rgba(0, 186, 255, 0.2);
    color: var(--primary-400);
}

.file-info-details {
    flex-grow: 1;
}

.file-info-name {
    font-weight: 500;
    color: var(--text-light);
    margin-bottom: 0.25rem;
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .file-info-name {
    color: var(--text-dark);
}

.file-info-meta {
    font-size: 0.75rem;
    color: var(--text-light-secondary);
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .file-info-meta {
    color: var(--text-dark-secondary);
}

/* Sheet selector */
.sheet-selector {
    display: flex;
    overflow-x: auto;
    scrollbar-width: none;
    gap: 0.5rem;
    padding-bottom: 0.5rem;
}

.sheet-selector::-webkit-scrollbar {
    display: none;
}

.sheet-button {
    padding: 0.5rem 0.75rem;
    background-color: var(--surface-light);
    border: 1px solid var(--border-light);
    border-radius: var(--border-radius-md);
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-light-secondary);
    white-space: nowrap;
    cursor: pointer;
    transition: all var(--transition-normal) var(--ease-out);
}

.dark .sheet-button {
    background-color: var(--surface-dark);
    border-color: var(--border-dark);
    color: var(--text-dark-secondary);
}

.sheet-button:hover {
    background-color: var(--bg-light);
    border-color: var(--border-light);
    color: var(--text-light);
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm);
}

.dark .sheet-button:hover {
    background-color: var(--bg-dark);
    border-color: var(--border-dark);
    color: var(--text-dark);
    box-shadow: var(--shadow-dark-sm);
}

.sheet-button.active {
    background-image: linear-gradient(to right, rgba(0, 186, 255, 0.1), rgba(87, 34, 255, 0.1));
    border-color: var(--primary-500);
    color: var(--primary-600);
    box-shadow: var(--shadow-sm);
}

.dark .sheet-button.active {
    background-image: linear-gradient(to right, rgba(0, 186, 255, 0.2), rgba(87, 34, 255, 0.2));
    border-color: var(--primary-400);
    color: var(--primary-400);
    box-shadow: var(--shadow-dark-sm);
}

/* Empty state */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem 1.5rem;
    text-align: center;
    border-radius: var(--border-radius-lg);
    background-color: var(--surface-light);
    border: 1px dashed var(--border-light);
    transition: all var(--transition-normal) var(--ease-out);
}

.dark .empty-state {
    background-color: var(--surface-dark);
    border-color: var(--border-dark);
}

.empty-state-icon {
    font-size: 3rem;
    color: var(--border-light);
    margin-bottom: 1rem;
    transition: all var(--transition-normal) var(--ease-out);
}

.dark .empty-state-icon {
    color: var(--border-dark);
}

.empty-state:hover .empty-state-icon {
    color: var(--primary-500);
    transform: scale(1.1);
}

.dark .empty-state:hover .empty-state-icon {
    color: var(--primary-400);
}

.empty-state-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-light);
    margin-bottom: 0.5rem;
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .empty-state-title {
    color: var(--text-dark);
}

.empty-state-description {
    font-size: 0.875rem;
    color: var(--text-light-secondary);
    max-width: 24rem;
    margin-bottom: 1.5rem;
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .empty-state-description {
    color: var(--text-dark-secondary);
}

/* Bus grid */
.bus-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
    gap: 0.5rem;
}

.bus-item {
    padding: 0.75rem 0.5rem;
    border-radius: var(--border-radius-lg);
    background-color: var(--surface-light);
    border: 1px solid var(--border-light);
    font-size: 0.75rem;
    text-align: center;
    transition: all var(--transition-normal) var(--ease-out);
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.dark .bus-item {
    background-color: var(--surface-dark);
    border-color: var(--border-dark);
}

.bus-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    transition: all var(--transition-normal) var(--ease-out);
    opacity: 0.8;
}

.bus-item:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: var(--shadow-md);
    z-index: 1;
}

.dark .bus-item:hover {
    box-shadow: var(--shadow-dark-md);
}

.bus-item-plate {
    font-weight: 600;
    color: var(--text-light);
    margin-bottom: 0.25rem;
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .bus-item-plate {
    color: var(--text-dark);
}

.bus-item-terminal {
    font-size: 0.6875rem;
    color: var(--text-light-secondary);
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .bus-item-terminal {
    color: var(--text-dark-secondary);
}

.bus-item.operational {
    border-left: 3px solid var(--success-500);
}

.bus-item.operational::before {
    background-color: var(--success-500);
}

.bus-item.maintenance {
    border-left: 3px solid var(--warning-500);
}

.bus-item.maintenance::before {
    background-color: var(--warning-500);
}

.bus-item.panne {
    border-left: 3px solid var(--danger-500);
}

.bus-item.panne::before {
    background-color: var(--danger-500);
}

.bus-item.inactive {
    border-left: 3px solid #94a3b8;
}

.bus-item.inactive::before {
    background-color: #94a3b8;
}

/* Search results */
.search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background-color: var(--card-light);
    border: 1px solid var(--border-light);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-xl);
    margin-top: 0.5rem;
    max-height: 320px;
    overflow-y: auto;
    z-index: var(--z-dropdown);
    display: none;
    transition: all var(--transition-normal) var(--ease-out);
}

.dark .search-results {
    background-color: var(--card-dark);
    border-color: var(--border-dark);
    box-shadow: var(--shadow-dark-xl);
}

.search-results.show {
    display: block;
    animation: fadeIn 0.3s var(--ease-out);
}

.search-results-item {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-light);
    cursor: pointer;
    transition: all var(--transition-fast) var(--ease-out);
}

.dark .search-results-item {
    border-bottom-color: var(--border-dark);
}

.search-results-item:last-child {
    border-bottom: none;
}

.search-results-item:hover {
    background-color: rgba(0, 186, 255, 0.05);
    transform: translateX(3px);
}

.dark .search-results-item:hover {
    background-color: rgba(0, 186, 255, 0.1);
}

.search-results-primary {
    font-weight: 600;
    color: var(--text-light);
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .search-results-primary {
    color: var(--text-dark);
}

.search-results-secondary {
    font-size: 0.75rem;
    color: var(--text-light-secondary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .search-results-secondary {
    color: var(--text-dark-secondary);
}

/* Welcome section */
.welcome-section {
    margin-bottom: 1.5rem;
    animation: fadeIn 0.5s var(--ease-out);
}

.welcome-title {
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: var(--text-light);
    transition: color var(--transition-normal) var(--ease-out);
    background: linear-gradient(to right, var(--primary-600), var(--secondary-600));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.dark .welcome-title {
    background: linear-gradient(to right, var(--primary-400), var(--secondary-400));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.welcome-subtitle {
    font-size: 1rem;
    color: var(--text-light-secondary);
    margin-bottom: 1.5rem;
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .welcome-subtitle {
    color: var(--text-dark-secondary);
}

/* Files section */
.files-section {
    padding: 1.5rem;
    background-color: var(--card-light);
    border: 1px solid var(--border-light);
    border-radius: var(--border-radius-xl);
    margin-bottom: 2rem;
    box-shadow: var(--shadow-md);
    transition: all var(--transition-normal) var(--ease-out);
    animation: fadeIn 0.6s var(--ease-out);
    position: relative;
    overflow: hidden;
}

.dark .files-section {
    background-color: var(--card-dark);
    border-color: var(--border-dark);
    box-shadow: var(--shadow-dark-md);
}

.files-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(to right, var(--primary-500), var(--secondary-500));
    transition: opacity var(--transition-normal) var(--ease-out);
}

.files-section:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg);
}

.dark .files-section:hover {
    box-shadow: var(--shadow-dark-lg);
}

.files-title {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-light);
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .files-title {
    color: var(--text-dark);
}

.files-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1.5rem;
}

/* Quick filters */
.quick-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.filter-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.375rem 0.75rem;
    background-color: var(--surface-light);
    border: 1px solid var(--border-light);
    border-radius: var(--border-radius-full);
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-light-secondary);
    cursor: pointer;
    transition: all var(--transition-normal) var(--ease-out);
}

.dark .filter-chip {
    background-color: var(--surface-dark);
    border-color: var(--border-dark);
    color: var(--text-dark-secondary);
}

.filter-chip:hover {
    background-color: var(--bg-light);
    border-color: var(--border-light);
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

.dark .filter-chip:hover {
    background-color: var(--bg-dark);
    border-color: var(--border-dark);
    box-shadow: var(--shadow-dark-sm);
}

.filter-chip.active {
    background-image: linear-gradient(to right, rgba(0, 186, 255, 0.1), rgba(87, 34, 255, 0.1));
    border-color: var(--primary-500);
    color: var(--primary-600);
    box-shadow: 0 2px 4px rgba(0, 186, 255, 0.2);
}

.dark .filter-chip.active {
    background-image: linear-gradient(to right, rgba(0, 186, 255, 0.2), rgba(87, 34, 255, 0.2));
    border-color: var(--primary-400);
    color: var(--primary-400);
    box-shadow: 0 2px 4px rgba(0, 186, 255, 0.3);
}

/* Bus details card */
.bus-details-card {
    border-radius: var(--border-radius-xl);
    overflow: hidden;
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border-light);
    transition: all var(--transition-normal) var(--ease-out);
}

.dark .bus-details-card {
    box-shadow: var(--shadow-dark-lg);
    border-color: var(--border-dark);
}

.bus-details-header {
    padding: 1.5rem;
    background-image: linear-gradient(135deg, var(--primary-600), var(--secondary-600));
    color: white;
    position: relative;
    overflow: hidden;
}

.bus-details-header::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none"><rect width="20" height="20" fill="white" fill-opacity="0.05"/></svg>');
    opacity: 0.2;
}

.bus-details-body {
    padding: 1.5rem;
    background-color: var(--card-light);
    transition: background-color var(--transition-normal) var(--ease-out);
}

.dark .bus-details-body {
    background-color: var(--card-dark);
}

.bus-details-plate {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.bus-details-status {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    padding: 0.25rem 0.75rem;
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: var(--border-radius-full);
    backdrop-filter: blur(5px);
}

.bus-details-section {
    margin-bottom: 1.5rem;
}

.bus-details-section-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-light);
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .bus-details-section-title {
    color: var(--text-dark);
}

.bus-details-info-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
}

.bus-details-info-item {
    background-color: var(--surface-light);
    border-radius: var(--border-radius-lg);
    padding: 0.75rem;
    border: 1px solid var(--border-light);
    transition: all var(--transition-normal) var(--ease-out);
}

.dark .bus-details-info-item {
    background-color: var(--surface-dark);
    border-color: var(--border-dark);
}

.bus-details-info-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

.dark .bus-details-info-item:hover {
    box-shadow: var(--shadow-dark-sm);
}

.bus-details-info-label {
    font-size: 0.75rem;
    color: var(--text-light-secondary);
    margin-bottom: 0.25rem;
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .bus-details-info-label {
    color: var(--text-dark-secondary);
}

.bus-details-info-value {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-light);
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .bus-details-info-value {
    color: var(--text-dark);
}

/* Badge counter */
.badge-counter {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background-color: var(--danger-500);
    color: white;
    border-radius: 9999px;
    height: 18px;
    min-width: 18px;
    font-size: 0.65rem;
    font-weight: 700;
    padding: 0 6px;
    position: absolute;
    top: -5px;
    right: -5px;
    box-shadow: 0 0 0 2px var(--card-light);
    transition: all var(--transition-normal) var(--ease-out),
                box-shadow var(--transition-normal) var(--ease-out);
    animation: pulse 2s infinite;
}

.dark .badge-counter {
    box-shadow: 0 0 0 2px var(--card-dark);
}

/* Search box */
.search-box {
    position: relative;
}

.search-box .search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-light-secondary);
    pointer-events: none;
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .search-box .search-icon {
    color: var(--text-dark-secondary);
}

.search-box .search-input {
    padding-left: 36px;
    padding-right: 36px;
}

.search-box .search-input:focus + .search-icon {
    color: var(--primary-500);
}

.dark .search-box .search-input:focus + .search-icon {
    color: var(--primary-400);
}

.search-box .clear-button {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-light-secondary);
    cursor: pointer;
    display: none;
    transition: color var(--transition-normal) var(--ease-out),
                transform var(--transition-normal) var(--ease-out);
}

.dark .search-box .clear-button {
    color: var(--text-dark-secondary);
}

.search-box .clear-button:hover {
    color: var(--danger-500);
    transform: translateY(-50%) scale(1.1);
}

.search-box .clear-button.show {
    display: block;
    animation: fadeIn 0.2s var(--ease-out);
}

/* Pump analysis card */
.pump-analysis-card {
    border-radius: var(--border-radius-lg);
    background-color: var(--card-light);
    border: 1px solid var(--border-light);
    transition: all var(--transition-normal) var(--ease-out);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    position: relative;
}

.dark .pump-analysis-card {
    background-color: var(--card-dark);
    border-color: var(--border-dark);
    box-shadow: var(--shadow-dark-sm);
}

.pump-analysis-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(to right, var(--primary-500), var(--secondary-500));
    opacity: 0;
    transition: opacity var(--transition-normal) var(--ease-out);
}

.pump-analysis-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
}

.dark .pump-analysis-card:hover {
    box-shadow: var(--shadow-dark-md);
}

.pump-analysis-card:hover::before {
    opacity: 1;
}

.pump-analysis-header {
    padding: 1rem;
    border-bottom: 1px solid var(--border-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: border-color var(--transition-normal) var(--ease-out);
}

.dark .pump-analysis-header {
    border-bottom-color: var(--border-dark);
}

.pump-analysis-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-light);
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .pump-analysis-title {
    color: var(--text-dark);
}

.pump-analysis-body {
    padding: 1rem;
}

.pump-stat {
    padding: 0.75rem;
    border-radius: var(--border-radius-md);
    margin-bottom: 0.75rem;
    background-color: var(--surface-light);
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all var(--transition-normal) var(--ease-out);
    border: 1px solid var(--border-light);
}

.dark .pump-stat {
    background-color: var(--surface-dark);
    border-color: var(--border-dark);
}

.pump-stat:hover {
    transform: translateX(3px);
    box-shadow: var(--shadow-sm);
}

.dark .pump-stat:hover {
    box-shadow: var(--shadow-dark-sm);
}

.pump-stat-name {
    font-weight: 500;
    font-size: 0.8125rem;
    color: var(--text-light);
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .pump-stat-name {
    color: var(--text-dark);
}

.pump-stat-value {
    font-weight: 600;
    font-size: 0.8125rem;
    color: var(--primary-600);
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .pump-stat-value {
    color: var(--primary-400);
}

.pump-progress {
    height: 6px;
    background-color: var(--border-light);
    border-radius: var(--border-radius-full);
    margin-top: 0.5rem;
    overflow: hidden;
    transition: background-color var(--transition-normal) var(--ease-out);
}

.dark .pump-progress {
    background-color: var(--border-dark);
}

.pump-progress-bar {
    height: 100%;
    background-image: linear-gradient(to right, var(--primary-500), var(--secondary-500));
    border-radius: var(--border-radius-full);
    transition: width var(--transition-slow) var(--ease-out);
}

/* Quick search panel */
.quick-search-panel {
    border-radius: var(--border-radius-xl);
    background-color: var(--card-light);
    border: 1px solid var(--border-light);
    box-shadow: var(--shadow-lg);
    padding: 1.5rem;
    transition: all var(--transition-normal) var(--ease-out);
    position: relative;
    overflow: hidden;
    animation: fadeIn 0.5s var(--ease-out);
}

.dark .quick-search-panel {
    background-color: var(--card-dark);
    border-color: var(--border-dark);
    box-shadow: var(--shadow-dark-lg);
}

.quick-search-panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(to right, var(--primary-500), var(--secondary-500));
}

.quick-search-panel:hover {
    transform: translateY(-3px);
}

.quick-search-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-light);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .quick-search-title {
    color: var(--text-dark);
}

.quick-search-form {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
}

.quick-search-input {
    flex-grow: 1;
    padding: 0.75rem 1rem;
    border-radius: var(--border-radius-lg);
    border: 1px solid var(--border-light);
    font-size: 0.875rem;
    transition: all var(--transition-normal) var(--ease-out);
    background-color: var(--surface-light);
    color: var(--text-light);
    box-shadow: var(--shadow-sm);
}

.dark .quick-search-input {
    background-color: var(--surface-dark);
    border-color: var(--border-dark);
    color: var(--text-dark);
    box-shadow: var(--shadow-dark-sm);
}

.quick-search-input:focus {
    border-color: var(--primary-500);
    outline: none;
    box-shadow: 0 0 0 3px rgba(0, 186, 255, 0.2);
    transform: translateY(-1px);
}

.dark .quick-search-input:focus {
    border-color: var(--primary-400);
    box-shadow: 0 0 0 3px rgba(0, 186, 255, 0.3);
}

.quick-search-button {
    padding: 0.75rem 1.25rem;
    background-image: linear-gradient(135deg, var(--primary-600), var(--secondary-600));
    color: white;
    border: none;
    border-radius: var(--border-radius-lg);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-normal) var(--ease-out);
    box-shadow: 0 4px 6px rgba(0, 186, 255, 0.2);
    position: relative;
    overflow: hidden;
}

.quick-search-button::after {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    background: rgba(255, 255, 255, 0.1);
    opacity: 0;
    transition: opacity var(--transition-normal) var(--ease-out);
}

.quick-search-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 186, 255, 0.3);
}

.quick-search-button:hover::after {
    opacity: 1;
}

.quick-search-button:active {
    transform: translateY(1px);
}

.quick-search-result {
    background-color: var(--surface-light);
    border-radius: var(--border-radius-lg);
    border: 1px solid var(--border-light);
    padding: 1.5rem;
    margin-top: 1.5rem;
    animation: fadeIn 0.4s var(--ease-out);
    box-shadow: var(--shadow-md);
    transition: all var(--transition-normal) var(--ease-out);
    position: relative;
    overflow: hidden;
}

.dark .quick-search-result {
    background-color: var(--surface-dark);
    border-color: var(--border-dark);
    box-shadow: var(--shadow-dark-md);
}

.quick-search-result::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, var(--primary-500), var(--secondary-500));
}

.quick-search-result:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.dark .quick-search-result:hover {
    box-shadow: var(--shadow-dark-lg);
}

.result-plate {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-light);
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .result-plate {
    color: var(--text-dark);
}

.result-info-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 1rem;
}

.result-info-item {
    background-color: rgba(0, 0, 0, 0.02);
    border-radius: var(--border-radius-md);
    padding: 0.75rem;
    transition: all var(--transition-normal) var(--ease-out);
    border: 1px solid var(--border-light);
}

.dark .result-info-item {
    background-color: rgba(255, 255, 255, 0.02);
    border-color: var(--border-dark);
}

.result-info-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

.dark .result-info-item:hover {
    box-shadow: var(--shadow-dark-sm);
}

.result-info-label {
    font-size: 0.75rem;
    color: var(--text-light-secondary);
    margin-bottom: 0.25rem;
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .result-info-label {
    color: var(--text-dark-secondary);
}

.result-info-value {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-light);
    transition: color var(--transition-normal) var(--ease-out);
}

.dark .result-info-value {
    color: var(--text-dark);
}

.result-detail {
    font-size: 0.8125rem;
    color: var(--text-light-secondary);
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--border-light);
    transition: all var(--transition-normal) var(--ease-out);
}

.dark .result-detail {
    color: var(--text-dark-secondary);
    border-top-color: var(--border-dark);
}

/* Bad loads card */
.bad-loads-card {
    border-radius: var(--border-radius-lg);
    background-color: var(--card-light);
    border: 1px solid var(--border-light);
    overflow: hidden;
    box-shadow: var(--shadow-md);
    transition: all var(--transition-normal) var(--ease-out);
    position: relative;
}

.dark .bad-loads-card {
    background-color: var(--card-dark);
    border-color: var(--border-dark);
    box-shadow: var(--shadow-dark-md);
}

.bad-loads-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg);
}

.dark .bad-loads-card:hover {
    box-shadow: var(--shadow-dark-lg);
}
        
    </style>
</head>

<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="header">
            <div class="flex items-center gap-2">
                <button id="sidebar-toggle" class="lg:hidden btn-icon btn-outline">
                    <iconify-icon icon="heroicons:bars-3"></iconify-icon>
                </button>
                <div class="flex items-center gap-2">
                    <div
                        class="w-7 h-7 rounded-lg bg-gradient-to-br from-primary-500 to-secondary-500 flex items-center justify-center text-white">
                        <iconify-icon icon="fluent:vehicle-truck-24-filled"></iconify-icon>
                    </div>
                    <div>
                        <h1 class="text-base font-bold">Analisis de Combustible</h1>
                        <p class="text-[10px] text-slate-500 dark:text-slate-400">Sistema Avanzado de Gestión</p>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-2 ml-auto">
                <div class="search-box relative">
                    <input type="text" id="global-search" placeholder="Buscar PPU o N° Interno..."
                        class="input-field search-input w-48 md:w-64 py-1.5">
                    <iconify-icon icon="heroicons:magnifying-glass" class="search-icon"></iconify-icon>
                    <iconify-icon icon="heroicons:x-mark" id="clear-search" class="clear-button"></iconify-icon>
                    <div id="search-results" class="search-results"></div>
                </div>
                <div id="status-indicator"
                    class="hidden md:flex items-center gap-1.5 px-2 py-1 rounded-full text-xs bg-emerald-100 dark:bg-emerald-900/30 text-emerald-800 dark:text-emerald-400">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                    <span>Sistema Operativo</span>
                </div>
                <button id="theme-toggle" class="btn-icon btn-outline">
                    <iconify-icon icon="heroicons:moon" class="block dark:hidden"></iconify-icon>
                    <iconify-icon icon="heroicons:sun" class="hidden dark:block"></iconify-icon>
                </button>
                <div id="notifications-container" class="relative">
                    <button id="notifications-toggle" class="btn-icon btn-outline relative">
                        <iconify-icon icon="heroicons:bell"></iconify-icon>
                        <span id="notifications-badge" class="badge-counter">5</span>
                    </button>
                </div>
                <button id="user-menu-button"
                    class="w-7 h-7 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center">
                    <iconify-icon icon="heroicons:user"></iconify-icon>
                </button>
            </div>
        </header>

        <div class="dashboard-main">
            <!-- Sidebar -->
            <aside id="sidebar" class="sidebar">
                <div class="flex flex-col h-full p-3">
         

                   

                    <div class="flex-grow">
                        <h2 class="text-xs uppercase font-semibold text-slate-500 dark:text-slate-400 mb-2 pl-2">
                            Archivos</h2>
                        <div class="space-y-3">
                            <div class="card p-2">
                                <h3 class="text-xs font-medium text-slate-700 dark:text-slate-300 mb-1.5">Archivos
                                    Requeridos</h3>
                                <div class="space-y-2">
                                    <input type="file" id="fuel-file" class="hidden" accept=".xlsx, .xls">
                                    <label for="fuel-file"
                                        class="file-upload flex flex-col items-center justify-center py-2">
                                        <iconify-icon icon="heroicons:document-arrow-up"
                                            class="file-upload-icon"></iconify-icon>
                                        <span id="fuel-file-text"
                                            class="text-sm font-medium text-slate-700 dark:text-slate-300">Combustible</span>
                                    </label>

                                    <input type="file" id="operativity-file" class="hidden" accept=".xlsx, .xls">
                                    <label for="operativity-file"
                                        class="file-upload flex flex-col items-center justify-center py-2">
                                        <iconify-icon icon="heroicons:clipboard-document-check"
                                            class="file-upload-icon"></iconify-icon>
                                        <span id="operativity-file-text"
                                            class="text-sm font-medium text-slate-700 dark:text-slate-300">Operatividad</span>
                                    </label>
                                </div>

                                <div class="mt-2">
                                    <div id="fuel-file-info" class="text-xs"></div>
                                    <div id="operativity-file-info" class="text-xs"></div>
                                </div>

                                <button id="process-button"
                                    class="btn btn-primary w-full flex items-center justify-center gap-2 mt-2" disabled>
                                    <iconify-icon icon="heroicons:arrow-path"></iconify-icon>
                                    <span>Procesar Datos</span>
                                </button>
                            </div><br>

                            <div class="divider"></div><br>

                            <div class="card p-2">
                                <h3 class="text-xs font-medium text-slate-700 dark:text-slate-300 mb-1.5">Flota (PPU)
                                </h3>
                                <div class="flex justify-between mb-1">
                                    <button id="edit-fleet"
                                        class="text-xs text-primary-600 dark:text-primary-400 hover:underline">Editar</button>
                                    <button id="import-fleet"
                                        class="text-xs text-primary-600 dark:text-primary-400 hover:underline">Importar</button>
                                </div>
                                <div id="fleet-preview"
                                    class="bg-slate-50 dark:bg-slate-900 rounded-lg p-2 min-h-12 max-h-24 overflow-y-auto text-xs">
                                    <div class="flex flex-wrap gap-1">
                                        <!-- Fleet preview badges will be rendered here -->
                                    </div>
                                </div>
                                <p id="fleet-count" class="mt-1 text-xs text-slate-500 dark:text-slate-400">0 buses
                                    registrados</p>
                            </div>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <div>
                        <div class="card p-2 bg-gradient-to-br from-primary-900/50 to-secondary-900/50 border-none">
                            <h3 class="text-xs font-medium text-white mb-1.5">Acciones Rápidas</h3>
                            <div class="grid grid-cols-2 gap-1.5">
                                <button id="export-data-btn"
                                    class="btn btn-outline text-xs py-1 bg-white/10 border-white/20 text-white">
                                    <iconify-icon icon="heroicons:document-arrow-down" class="mr-1"></iconify-icon>
                                    <span>Exportar</span>
                                </button>
                                <button id="print-report-btn"
                                    class="btn btn-outline text-xs py-1 bg-white/10 border-white/20 text-white">
                                    <iconify-icon icon="heroicons:printer" class="mr-1"></iconify-icon>
                                    <span>Imprimir</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Mobile sidebar overlay -->
            <div id="sidebar-overlay" class="overlay"></div>

            <!-- Main Content -->
            <div class="content-wrapper">
                <div class="content">
                    <!-- Welcome Screen (shown before data is loaded) -->
                    <div id="welcome-screen" class="animate-fade-in">
                        <div class="welcome-section">
                            <h2 class="welcome-title">Analizador de Combustible El Roble</h2>
                            <p class="welcome-subtitle">Sistema avanzado para el análisis de combustible y operatividad
                                de flota.</p>
                        </div>

                        <div class="files-section">
                            <h3 class="files-title">Carga de Archivos</h3>
                            <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">
                                Para comenzar, cargue los archivos de combustible y operatividad. El sistema procesará
                                automáticamente
                                todos los datos y generará análisis para todas las secciones.
                            </p>

                            <div class="files-grid">
                                <div class="card p-4">
                                    <h4
                                        class="text-base font-semibold text-slate-900 dark:text-white mb-2 flex items-center gap-2">
                                        <iconify-icon icon="heroicons:truck" class="text-primary-500"></iconify-icon>
                                        <span>Reporte de Operatividad</span>
                                    </h4>
                                    <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">
                                        Archivo Excel con el estado operativo y ubicación de la flota.
                                    </p>
                                    <input type="file" id="welcome-operativity-file" class="hidden"
                                        accept=".xlsx, .xls">
                                    <label for="welcome-operativity-file"
                                        class="file-upload flex flex-col items-center justify-center py-3">
                                        <iconify-icon icon="heroicons:clipboard-document-check"
                                            class="file-upload-icon text-2xl"></iconify-icon>
                                        <span
                                            class="text-sm font-medium text-slate-700 dark:text-slate-300 mt-2">Seleccionar
                                            archivo</span>
                                        <span class="text-xs text-slate-500 dark:text-slate-400 mt-1">XLSX o XLS</span>
                                    </label>
                                </div>
                            </div>

                            <div class="mt-4 text-center">
                                <button id="welcome-process-button" class="btn btn-primary px-8" disabled>
                                    <iconify-icon icon="heroicons:arrow-path" class="mr-2"></iconify-icon>
                                    <span>Procesar Archivos</span>
                                </button>
                            </div>
                        </div>

                        <div class="text-sm text-slate-600 dark:text-slate-400 text-center">
                            <p>
                                También puede cargar los archivos desde el panel lateral en cualquier momento.
                                <br>El sistema procesará automáticamente todos los datos.
                            </p>
                        </div>
                    </div>

                    <!-- Dashboard (hidden initially) -->
                    <div id="dashboard-content" class="hidden">
                        <!-- Dashboard Header -->
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-2 mb-3">
                            <div>
                                <h2 class="text-lg font-bold text-slate-900 dark:text-white">Dashboard Operativo</h2>
                                <p class="text-xs text-slate-600 dark:text-slate-400">Vista integral del estado de la
                                    flota</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="relative">
                                    <input type="text" placeholder="Filtrar buses..." id="dashboard-filter"
                                        class="input-field pl-8 pr-3 py-1.5">
                                    <iconify-icon icon="heroicons:funnel"
                                        class="absolute left-2.5 top-2 text-slate-400"></iconify-icon>
                                </div>
                                <button id="refresh-data" class="btn btn-primary">
                                    <iconify-icon icon="heroicons:arrow-path"></iconify-icon>
                                    <span>Actualizar</span>
                                </button>
                            </div>
                        </div>

                        <!-- Quick Search Panel -->
                        <div class="quick-search-panel mb-4">
                            <div class="quick-search-title">
                                <iconify-icon icon="heroicons:magnifying-glass"></iconify-icon>
                                <span>Consulta Rápida de Buses</span>
                            </div>
                            <div class="quick-search-form">
                                <input type="text" id="quick-search-input"
                                    placeholder="Buscar por PPU o N° Interno (Ej: LXWP57, P05)"
                                    class="quick-search-input">
                                <button id="quick-search-button" class="quick-search-button">Buscar</button>
                            </div>
                            <div id="quick-search-result"></div>
                            <div class="keyboard-shortcuts-container">
                                <div class="keyboard-shortcut-item">
                                    <span>Buscar:</span>
                                    <span class="keyboard-shortcut">/</span>
                                </div>
                                <div class="keyboard-shortcut-item">
                                    <span>Limpiar:</span>
                                    <span class="keyboard-shortcut">Esc</span>
                                </div>
                            </div>
                            <div class="search-history">
                                <div class="search-history-title">Búsquedas recientes</div>
                                <div class="search-history-items" id="search-history-container">
                                    <!-- Will be populated dynamically -->
                                </div>
                            </div>
                        </div>

                        <!-- Quick Filters -->
                        <div class="quick-filters mb-3">
                            <div class="filter-chip active" data-filter="all">
                                <iconify-icon icon="heroicons:squares-2x2"></iconify-icon>
                                <span>Todos</span>
                            </div>
                            <div class="filter-chip" data-filter="operational">
                                <iconify-icon icon="heroicons:check-circle"></iconify-icon>
                                <span>Operativos</span>
                            </div>
                            <div class="filter-chip" data-filter="pending">
                                <iconify-icon icon="heroicons:clock"></iconify-icon>
                                <span>Pendientes</span>
                            </div>
                            <div class="filter-chip" data-filter="maintenance">
                                <iconify-icon icon="heroicons:wrench-screwdriver"></iconify-icon>
                                <span>Mantención</span>
                            </div>
                            <div class="filter-chip" data-filter="panne">
                                <iconify-icon icon="heroicons:exclamation-triangle"></iconify-icon>
                                <span>Panne</span>
                            </div>
                            <div class="filter-chip" data-filter="bad-loads">
                                <iconify-icon icon="heroicons:exclamation-circle"></iconify-icon>
                                <span>Cargas Manuales</span>
                            </div>
                        </div>

                        <!-- Main Tabs -->
                        <div class="tabs">
                            <div class="tab active" data-tab="general">General</div>
                            <div class="tab" data-tab="fuel">Combustible</div>
                            <div class="tab" data-tab="bad-loads">Cargas Manuales</div>
                            <div class="tab" data-tab="operativity">Operatividad</div>
                            <div class="tab" data-tab="pumps">Surtidores</div>
                        </div>

                        <!-- General Tab Content -->
                        <div id="general-tab" class="tab-content active">
                            <!-- Key Metrics -->
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-3">
                                <div class="card stat-card">
                                    <div class="stat-card-label">Total Litros</div>
                                    <div id="total-liters" class="stat-card-value">0</div>
                                    <div id="liters-change" class="stat-card-change positive">
                                        <iconify-icon icon="heroicons:arrow-trending-up"></iconify-icon>
                                        <span>0% vs. promedio</span>
                                    </div>
                                </div>

                                <div class="card stat-card">
                                    <div class="stat-card-label">Buses Cargados</div>
                                    <div id="buses-loaded" class="stat-card-value">0</div>
                                    <div id="loaded-percent" class="stat-card-change">
                                        <span>0% de la flota</span>
                                    </div>
                                </div>

                                <div class="card stat-card">
                                    <div class="stat-card-label">Buses Pendientes</div>
                                    <div id="buses-pending" class="stat-card-value text-amber-600 dark:text-amber-400">0
                                    </div>
                                    <div id="pending-percent" class="stat-card-change">
                                        <span>0% de la flota</span>
                                    </div>
                                </div>

                                <div class="card stat-card">
                                    <div class="stat-card-label">Cargas Manuales</div>
                                    <div id="bad-loads-count" class="stat-card-value text-red-600 dark:text-red-400">0
                                    </div>
                                    <div id="bad-loads-amount" class="stat-card-change negative">
                                        <span>0 litros</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Fleet Status Analytics -->
                            <div class="analytics-card mb-4">
                                <div class="analytics-header">
                                    <div class="analytics-title">
                                        <iconify-icon icon="heroicons:chart-bar"></iconify-icon>
                                        <span>Estado de la Flota</span>
                                    </div>
                                    <span class="text-xs text-slate-500 dark:text-slate-400"
                                        id="fleet-status-date">Actualizado: Hoy</span>
                                </div>
                                <div class="analytics-body">
                                    <div class="flex justify-between text-sm mb-2">
                                        <span class="font-medium text-slate-700 dark:text-slate-300">Distribución de
                                            Estado</span>
                                        <span class="text-slate-500 dark:text-slate-400" id="fleet-total-count">Total: 0
                                            buses</span>
                                    </div>

                                    <div class="segment-bar" id="fleet-status-bar">
                                        <div class="segment segment-operational" style="width: 0%"></div>
                                        <div class="segment segment-maintenance" style="width: 0%"></div>
                                        <div class="segment segment-panne" style="width: 0%"></div>
                                        <div class="segment segment-unknown" style="width: 100%"></div>
                                    </div>

                                    <div class="segments-legend">
                                        <div class="legend-item">
                                            <div class="legend-color legend-operational"></div>
                                            <span>Operativos: <strong id="operational-count">0</strong></span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color legend-maintenance"></div>
                                            <span>Mantención: <strong id="maintenance-count">0</strong></span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color legend-panne"></div>
                                            <span>Panne: <strong id="panne-count">0</strong></span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color legend-unknown"></div>
                                            <span>Sin Datos: <strong id="unknown-count">0</strong></span>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 mt-4">
                                        <div class="chart-container">
                                            <canvas id="fleet-status-chart"></canvas>
                                        </div>

                                        <div class="chart-container">
                                            <canvas id="terminal-distribution-chart"></canvas>
                                        </div>

                                        <div class="chart-container">
                                            <canvas id="hourly-chart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pending Buses -->
                            <div class="card mb-3">
                                <div class="data-card-header flex justify-between items-center">
                                    <div class="data-card-title">
                                        <iconify-icon icon="heroicons:clock"></iconify-icon>
                                        <span>Buses Pendientes por Cargar</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="text" id="filter-pending"
                                            class="input-field text-xs py-1 px-2 w-32" placeholder="Filtrar...">
                                        <button id="export-pending-btn" class="btn btn-outline text-xs py-1 px-2">
                                            <iconify-icon icon="heroicons:arrow-down-tray"></iconify-icon>
                                            <span>Exportar</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Patente</th>
                                                <th>Terminal</th>
                                                <th>Ubicación</th>
                                                <th>Estado</th>
                                                <th>Servicio</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="pending-buses-table">
                                            <!-- Table will be populated with JavaScript -->
                                            <tr>
                                                <td colspan="6"
                                                    class="text-center py-6 text-slate-500 dark:text-slate-400">
                                                    Cargue los archivos para ver el listado de buses pendientes
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Bad Loads Summary -->
                            <div class="bad-loads-card mb-3">
                                <div class="bad-loads-header">
                                    <div class="bad-loads-title">
                                        <iconify-icon icon="heroicons:exclamation-circle"></iconify-icon>
                                        <span>Resumen de Cargas Manuales</span>
                                    </div>
                                    <button id="view-all-bad-loads"
                                        class="btn btn-outline bg-white/20 border-red-200 text-red-700 dark:border-red-800 dark:text-red-400 text-xs py-1 px-2">
                                        <span>Ver Detalle</span>
                                    </button>
                                </div>
                                <div class="bad-loads-body">
                                    <div class="bad-loads-summary">
                                        <div class="bad-loads-total">
                                            <span>Total Cargas Manuales:</span>
                                            <span id="bad-loads-summary-count">0 cargas</span>
                                        </div>
                                        <div class="bad-loads-total">
                                            <span>Total Litros:</span>
                                            <span id="bad-loads-summary-liters">0 litros</span>
                                        </div>
                                        <div class="bad-loads-breakdown">
                                            <div id="bad-loads-breakdown"></div>
                                        </div>
                                    </div>

                                    <div id="bad-loads-preview"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Fuel Tab Content -->
                        <div id="fuel-tab" class="tab-content">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 mb-3">
                                <!-- Fuel Summary -->
                                <div class="card">
                                    <div class="data-card-header">
                                        <div class="data-card-title">
                                            <iconify-icon icon="heroicons:beaker"></iconify-icon>
                                            <span>Resumen de Combustible</span>
                                        </div>
                                    </div>
                                    <div class="data-card-body space-y-2.5">
                                        <div class="advanced-stat-card">
                                            <div class="advanced-stat-title">Total Cargado</div>
                                            <div class="advanced-stat-value" id="fuel-total-liters">
                                                0<span class="unit">Lts</span>
                                            </div>
                                        </div>

                                        <div class="advanced-stat-card">
                                            <div class="advanced-stat-title">Promedio por Bus</div>
                                            <div class="advanced-stat-value" id="fuel-avg-per-bus">
                                                0<span class="unit">Lts</span>
                                            </div>
                                        </div>

                                        <div class="advanced-stat-card">
                                            <div class="advanced-stat-title">Total Cargas</div>
                                            <div class="advanced-stat-value" id="fuel-total-loads">
                                                0
                                            </div>
                                        </div>

                                        <div class="advanced-stat-card">
                                            <div class="advanced-stat-title">Eficiencia de Carga</div>
                                            <div class="advanced-stat-value" id="fuel-efficiency">
                                                0<span class="unit">%</span>
                                            </div>
                                            <div class="advanced-stat-progress">
                                                <div id="fuel-efficiency-bar"
                                                    class="advanced-stat-progress-bar bg-primary-500" style="width: 0%">
                                                </div>
                                            </div>
                                            <div class="advanced-stat-details">
                                                <span id="fuel-loaded-count">0 buses cargados</span>
                                                <span id="fuel-total-buses">de 0 buses</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Terminal Consumption -->
                                <div class="card">
                                    <div class="data-card-header">
                                        <div class="data-card-title">
                                            <iconify-icon icon="heroicons:map"></iconify-icon>
                                            <span>Consumo por Terminal</span>
                                        </div>
                                    </div>
                                    <div class="data-card-body">
                                        <div class="chart-container">
                                            <canvas id="terminal-consumption-chart"></canvas>
                                        </div>
                                    </div>
                                </div>

                                <!-- Hourly Consumption -->
                                <div class="card">
                                    <div class="data-card-header">
                                        <div class="data-card-title">
                                            <iconify-icon icon="heroicons:clock"></iconify-icon>
                                            <span>Consumo por Hora</span>
                                        </div>
                                    </div>
                                    <div class="data-card-body">
                                        <div class="chart-container">
                                            <canvas id="hourly-consumption-chart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Top Consumers -->
                            <div class="card mb-3">
                                <div class="data-card-header">
                                    <div class="data-card-title">
                                        <iconify-icon icon="heroicons:fire"></iconify-icon>
                                        <span>Top 10 Buses - Mayor Consumo</span>
                                    </div>
                                </div>
                                <div class="data-card-body">
                                    <div class="chart-container h-64">
                                        <canvas id="top-consumers-chart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- Bus Consumption -->
                            <div class="card mb-3">
                                <div class="data-card-header flex justify-between items-center">
                                    <div class="data-card-title">
                                        <iconify-icon icon="heroicons:truck"></iconify-icon>
                                        <span>Consumo por Bus</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="text" id="filter-consumption"
                                            class="input-field text-xs py-1 px-2 w-32" placeholder="Filtrar...">
                                        <select id="sort-consumption" class="input-field text-xs py-1 px-2 w-40">
                                            <option value="plate">Ordenar por Patente</option>
                                            <option value="liters-desc">Mayor Consumo</option>
                                            <option value="liters-asc">Menor Consumo</option>
                                            <option value="loads">N° de Cargas</option>
                                            <option value="terminal">Terminal</option>
                                        </select>
                                        <button id="export-consumption-btn" class="btn btn-outline text-xs py-1 px-2">
                                            <iconify-icon icon="heroicons:arrow-down-tray"></iconify-icon>
                                            <span>Exportar</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Patente</th>
                                                <th>Terminal</th>
                                                <th>Cargas</th>
                                                <th>Total Litros</th>
                                                <th>Promedio</th>
                                                <th>Última Carga</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="consumption-table">
                                            <!-- Table will be populated with JavaScript -->
                                            <tr>
                                                <td colspan="7"
                                                    class="text-center py-6 text-slate-500 dark:text-slate-400">
                                                    Cargue los archivos para ver el consumo por bus
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Bad Loads Tab Content -->
                        <div id="bad-loads-tab" class="tab-content">
                            <div class="bad-loads-card mb-3">
                                <div class="bad-loads-header">
                                    <div class="bad-loads-title">
                                        <iconify-icon icon="heroicons:exclamation-circle"></iconify-icon>
                                        <span>Análisis de Cargas Manuales</span>
                                    </div>
                                </div>
                                <div class="bad-loads-body">
                                    <div class="bad-loads-summary">
                                        <div class="bad-loads-total">
                                            <span>Total Cargas Manuales:</span>
                                            <span id="bad-loads-detail-count">0 cargas</span>
                                        </div>
                                        <div class="bad-loads-total">
                                            <span>Total Litros:</span>
                                            <span id="bad-loads-detail-liters">0 litros</span>
                                        </div>
                                        <div class="bad-loads-breakdown">
                                            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
                                                <div
                                                    class="p-2 bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-900/30 rounded-md">
                                                    <div class="text-xs text-red-800 dark:text-red-300 font-medium">
                                                        Impacto en Consumo Total</div>
                                                    <div class="text-sm font-bold text-red-700 dark:text-red-400"
                                                        id="bad-loads-impact">0%</div>
                                                </div>
                                                <div
                                                    class="p-2 bg-amber-50 dark:bg-amber-900/20 border border-amber-100 dark:border-amber-900/30 rounded-md">
                                                    <div class="text-xs text-amber-800 dark:text-amber-300 font-medium">
                                                        Buses Afectados</div>
                                                    <div class="text-sm font-bold text-amber-700 dark:text-amber-400"
                                                        id="bad-loads-buses">0 buses</div>
                                                </div>
                                                <div
                                                    class="p-2 bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-900/30 rounded-md">
                                                    <div class="text-xs text-blue-800 dark:text-blue-300 font-medium">
                                                        Promedio por Carga</div>
                                                    <div class="text-sm font-bold text-blue-700 dark:text-blue-400"
                                                        id="bad-loads-avg">0 litros</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                                        <div class="chart-container h-64">
                                            <canvas id="bad-loads-by-terminal-chart"></canvas>
                                        </div>
                                        <div class="chart-container h-64">
                                            <canvas id="bad-loads-by-day-chart"></canvas>
                                        </div>
                                    </div>

                                    <div class="mt-4">
                                        <div class="flex justify-between items-center mb-2">
                                            <h3 class="font-medium text-sm text-slate-800 dark:text-slate-200">Detalle
                                                de Cargas Manuales</h3>
                                            <div class="flex items-center gap-2">
                                                <input type="text" id="filter-bad-loads"
                                                    class="input-field text-xs py-1 px-2 w-32" placeholder="Filtrar...">
                                                <button id="export-bad-loads-btn"
                                                    class="btn btn-outline text-xs py-1 px-2">
                                                    <iconify-icon icon="heroicons:arrow-down-tray"></iconify-icon>
                                                    <span>Exportar</span>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="table-container">
                                            <table class="data-table">
                                                <thead>
                                                    <tr>
                                                        <th>Patente</th>
                                                        <th>Terminal</th>
                                                        <th>Litros</th>
                                                        <th>Fecha</th>
                                                        <th>Conductor</th>
                                                        <th>Tipo</th>
                                                        <th>Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="bad-loads-table">
                                                    <!-- Table will be populated with JavaScript -->
                                                    <tr>
                                                        <td colspan="7"
                                                            class="text-center py-6 text-slate-500 dark:text-slate-400">
                                                            Cargue los archivos para ver el detalle de cargas manuales
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Operativity Tab Content -->
                        <div id="operativity-tab" class="tab-content">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 mb-3">
                                <!-- Operativity Summary -->
                                <div class="card">
                                    <div class="data-card-header">
                                        <div class="data-card-title">
                                            <iconify-icon icon="heroicons:signal"></iconify-icon>
                                            <span>Resumen de Operatividad</span>
                                        </div>
                                    </div>
                                    <div class="data-card-body space-y-2.5">
                                        <div class="advanced-stat-card">
                                            <div class="advanced-stat-title">Flota Total</div>
                                            <div class="advanced-stat-value" id="op-total-fleet">
                                                0<span class="unit">buses</span>
                                            </div>
                                        </div>

                                        <div class="advanced-stat-card">
                                            <div class="advanced-stat-title">Buses Operativos</div>
                                            <div class="advanced-stat-value" id="op-total-operational">
                                                0<span class="unit">buses</span>
                                            </div>
                                            <div class="advanced-stat-progress">
                                                <div id="op-operational-bar"
                                                    class="advanced-stat-progress-bar bg-emerald-500" style="width: 0%">
                                                </div>
                                            </div>
                                            <div class="advanced-stat-details">
                                                <span id="op-operational-percent">0% de la flota</span>
                                            </div>
                                        </div>

                                        <div class="advanced-stat-card">
                                            <div class="advanced-stat-title">Buses en Mantención</div>
                                            <div class="advanced-stat-value" id="op-total-maintenance">
                                                0<span class="unit">buses</span>
                                            </div>
                                            <div class="advanced-stat-progress">
                                                <div id="op-maintenance-bar"
                                                    class="advanced-stat-progress-bar bg-amber-500" style="width: 0%">
                                                </div>
                                            </div>
                                            <div class="advanced-stat-details">
                                                <span id="op-maintenance-percent">0% de la flota</span>
                                            </div>
                                        </div>

                                        <div class="advanced-stat-card">
                                            <div class="advanced-stat-title">Buses en Panne</div>
                                            <div class="advanced-stat-value" id="op-total-panne">
                                                0<span class="unit">buses</span>
                                            </div>
                                            <div class="advanced-stat-progress">
                                                <div id="op-panne-bar" class="advanced-stat-progress-bar bg-red-500"
                                                    style="width: 0%"></div>
                                            </div>
                                            <div class="advanced-stat-details">
                                                <span id="op-panne-percent">0% de la flota</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Status by Terminal -->
                                <div class="card">
                                    <div class="data-card-header">
                                        <div class="data-card-title">
                                            <iconify-icon icon="heroicons:map"></iconify-icon>
                                            <span>Estado por Terminal</span>
                                        </div>
                                    </div>
                                    <div class="data-card-body">
                                        <div class="space-y-3">
                                            <div class="grid grid-cols-5 gap-1">
                                                <div
                                                    class="col-span-2 text-xs font-medium text-slate-600 dark:text-slate-400">
                                                    Terminal</div>
                                                <div
                                                    class="text-xs font-medium text-slate-600 dark:text-slate-400 text-center">
                                                    Operativos</div>
                                                <div
                                                    class="text-xs font-medium text-slate-600 dark:text-slate-400 text-center">
                                                    Mantención</div>
                                                <div
                                                    class="text-xs font-medium text-slate-600 dark:text-slate-400 text-center">
                                                    Panne</div>
                                            </div>

                                            <div class="grid grid-cols-5 gap-1 items-center">
                                                <div class="col-span-2 flex items-center gap-1.5">
                                                    <span class="terminal-badge terminal-el-roble">ER</span>
                                                    <span
                                                        class="text-xs font-medium text-slate-800 dark:text-slate-200">El
                                                        Roble</span>
                                                </div>
                                                <div class="text-center">
                                                    <span id="el-roble-operational"
                                                        class="text-xs font-semibold text-emerald-600 dark:text-emerald-400">0</span>
                                                </div>
                                                <div class="text-center">
                                                    <span id="el-roble-maintenance"
                                                        class="text-xs font-semibold text-amber-600 dark:text-amber-400">0</span>
                                                </div>
                                                <div class="text-center">
                                                    <span id="el-roble-panne"
                                                        class="text-xs font-semibold text-red-600 dark:text-red-400">0</span>
                                                </div>
                                            </div>

                                            <div class="grid grid-cols-5 gap-1 items-center">
                                                <div class="col-span-2 flex items-center gap-1.5">
                                                    <span class="terminal-badge terminal-la-reina">LR</span>
                                                    <span
                                                        class="text-xs font-medium text-slate-800 dark:text-slate-200">La
                                                        Reina</span>
                                                </div>
                                                <div class="text-center">
                                                    <span id="la-reina-operational"
                                                        class="text-xs font-semibold text-emerald-600 dark:text-emerald-400">0</span>
                                                </div>
                                                <div class="text-center">
                                                    <span id="la-reina-maintenance"
                                                        class="text-xs font-semibold text-amber-600 dark:text-amber-400">0</span>
                                                </div>
                                                <div class="text-center">
                                                    <span id="la-reina-panne"
                                                        class="text-xs font-semibold text-red-600 dark:text-red-400">0</span>
                                                </div>
                                            </div>

                                            <div class="grid grid-cols-5 gap-1 items-center">
                                                <div class="col-span-2 flex items-center gap-1.5">
                                                    <span class="terminal-badge terminal-maria-angelica">MA</span>
                                                    <span
                                                        class="text-xs font-medium text-slate-800 dark:text-slate-200">María
                                                        Angélica</span>
                                                </div>
                                                <div class="text-center">
                                                    <span id="maria-angelica-operational"
                                                        class="text-xs font-semibold text-emerald-600 dark:text-emerald-400">0</span>
                                                </div>
                                                <div class="text-center">
                                                    <span id="maria-angelica-maintenance"
                                                        class="text-xs font-semibold text-amber-600 dark:text-amber-400">0</span>
                                                </div>
                                                <div class="text-center">
                                                    <span id="maria-angelica-panne"
                                                        class="text-xs font-semibold text-red-600 dark:text-red-400">0</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-700">
                                            <div class="chart-container h-40">
                                                <canvas id="terminal-status-chart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Location Summary -->
                                <div class="card">
                                    <div class="data-card-header">
                                        <div class="data-card-title">
                                            <iconify-icon icon="heroicons:map-pin"></iconify-icon>
                                            <span>Ubicaciones</span>
                                        </div>
                                    </div>
                                    <div class="data-card-body">
                                        <div id="locations-container" class="space-y-2">
                                            <!-- Will be populated with JavaScript -->
                                            <div class="text-center py-6 text-slate-500 dark:text-slate-400">
                                                Cargue los archivos para ver las ubicaciones
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- All Buses Status -->
                            <div class="card mb-3">
                                <div class="data-card-header flex justify-between items-center">
                                    <div class="data-card-title">
                                        <iconify-icon icon="heroicons:truck"></iconify-icon>
                                        <span>Estado Completo de Flota</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="text" id="filter-status" class="input-field text-xs py-1 px-2 w-32"
                                            placeholder="Filtrar...">
                                        <select id="sort-status" class="input-field text-xs py-1 px-2 w-40">
                                            <option value="plate">Ordenar por Patente</option>
                                            <option value="status">Estado</option>
                                            <option value="terminal">Terminal</option>
                                            <option value="location">Ubicación</option>
                                        </select>
                                        <button id="export-status-btn" class="btn btn-outline text-xs py-1 px-2">
                                            <iconify-icon icon="heroicons:arrow-down-tray"></iconify-icon>
                                            <span>Exportar</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Patente</th>
                                                <th>Terminal</th>
                                                <th>Estado</th>
                                                <th>Ubicación</th>
                                                <th>Detalle</th>
                                                <th>Combustible</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="status-table">
                                            <!-- Table will be populated with JavaScript -->
                                            <tr>
                                                <td colspan="7"
                                                    class="text-center py-6 text-slate-500 dark:text-slate-400">
                                                    Cargue los archivos para ver el estado de la flota
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Pumps Tab Content -->
                        <div id="pumps-tab" class="tab-content">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 mb-3">
                                <!-- Pumps Summary -->
                                <div class="card">
                                    <div class="data-card-header">
                                        <div class="data-card-title">
                                            <iconify-icon icon="heroicons:adjustments-vertical"></iconify-icon>
                                            <span>Resumen de Surtidores</span>
                                        </div>
                                    </div>
                                    <div class="data-card-body space-y-2.5">
                                        <div class="advanced-stat-card">
                                            <div class="advanced-stat-title">Total Surtidores</div>
                                            <div class="advanced-stat-value" id="pumps-total-count">
                                                0<span class="unit">surtidores</span>
                                            </div>
                                        </div>

                                        <div class="advanced-stat-card">
                                            <div class="advanced-stat-title">Total Litros Dispensados</div>
                                            <div class="advanced-stat-value" id="pumps-total-liters">
                                                0<span class="unit">litros</span>
                                            </div>
                                        </div>

                                        <div class="advanced-stat-card">
                                            <div class="advanced-stat-title">Cargas Procesadas</div>
                                            <div class="advanced-stat-value" id="pumps-total-loads">
                                                0<span class="unit">cargas</span>
                                            </div>
                                        </div>

                                        <div class="advanced-stat-card">
                                            <div class="advanced-stat-title">Promedio por Carga</div>
                                            <div class="advanced-stat-value" id="pumps-avg-per-load">
                                                0<span class="unit">litros</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Pumps Distribution -->
                                <div class="card">
                                    <div class="data-card-header">
                                        <div class="data-card-title">
                                            <iconify-icon icon="heroicons:chart-pie"></iconify-icon>
                                            <span>Distribución por Surtidor</span>
                                        </div>
                                    </div>
                                    <div class="data-card-body">
                                        <div class="chart-container">
                                            <canvas id="pumps-distribution-chart"></canvas>
                                        </div>
                                    </div>
                                </div>

                                <!-- Pumps Hourly Usage -->
                                <div class="card">
                                    <div class="data-card-header">
                                        <div class="data-card-title">
                                            <iconify-icon icon="heroicons:clock"></iconify-icon>
                                            <span>Uso por Hora</span>
                                        </div>
                                    </div>
                                    <div class="data-card-body">
                                        <div class="chart-container">
                                            <canvas id="pumps-hourly-chart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pump Analysis Cards -->
                            <div class="mb-4">
                                <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Análisis de
                                    Surtidores</h3>
                                <div id="pump-analysis-container"
                                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                    <!-- Will be populated with JavaScript -->
                                    <div class="text-center py-6 text-slate-500 dark:text-slate-400">
                                        Cargue los archivos para ver el análisis de surtidores
                                    </div>
                                </div>
                            </div>

                            <!-- Pumps Detail Table -->
                            <div class="card mb-3">
                                <div class="data-card-header flex justify-between items-center">
                                    <div class="data-card-title">
                                        <iconify-icon icon="heroicons:adjustments-vertical"></iconify-icon>
                                        <span>Detalle de Surtidores</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="text" id="filter-pumps" class="input-field text-xs py-1 px-2 w-32"
                                            placeholder="Filtrar...">
                                        <button id="export-pumps-btn" class="btn btn-outline text-xs py-1 px-2">
                                            <iconify-icon icon="heroicons:arrow-down-tray"></iconify-icon>
                                            <span>Exportar</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Surtidor</th>
                                                <th>Terminal</th>
                                                <th>Total Litros</th>
                                                <th>Total Cargas</th>
                                                <th>Buses Atendidos</th>
                                                <th>Promedio por Carga</th>
                                                <th>% del Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="pumps-table">
                                            <!-- Table will be populated with JavaScript -->
                                            <tr>
                                                <td colspan="7"
                                                    class="text-center py-6 text-slate-500 dark:text-slate-400">
                                                    Cargue los archivos para ver el detalle de surtidores
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bus Detail Modal -->
    <div id="bus-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-base font-semibold text-slate-900 dark:text-white">Detalle de Bus</h3>
                <button class="modal-close btn-icon btn-outline">
                    <iconify-icon icon="heroicons:x-mark"></iconify-icon>
                </button>
            </div>
            <div class="modal-body" id="bus-detail-content">
                <!-- Bus details will be populated here -->
                <div class="text-center py-6 text-slate-500 dark:text-slate-400">
                    Cargando información del bus...
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close">Cerrar</button>
                <button class="btn btn-primary" id="print-bus-detail">
                    <iconify-icon icon="heroicons:printer" class="mr-1"></iconify-icon>
                    <span>Imprimir</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Fleet Modal -->
    <div id="edit-fleet-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-base font-semibold text-slate-900 dark:text-white">Editar Flota</h3>
                <button class="modal-close btn-icon btn-outline">
                    <iconify-icon icon="heroicons:x-mark"></iconify-icon>
                </button>
            </div>
            <div class="modal-body">
                <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">
                    Ingrese las patentes de los buses, una por línea.
                </p>
                <textarea id="fleet-textarea" class="input-field w-full h-48"
                    placeholder="Ej: LXWP57&#10;LXWP58&#10;LXWP59"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close">Cancelar</button>
                <button class="btn btn-primary" id="save-fleet">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Import Fleet Modal -->
    <div id="import-fleet-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-base font-semibold text-slate-900 dark:text-white">Importar Flota</h3>
                <button class="modal-close btn-icon btn-outline">
                    <iconify-icon icon="heroicons:x-mark"></iconify-icon>
                </button>
            </div>
            <div class="modal-body">
                <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">
                    Pegue datos desde Excel o un archivo de texto. El sistema extraerá automáticamente las patentes
                    válidas.
                </p>
                <textarea id="import-fleet-textarea" class="input-field w-full h-48"
                    placeholder="Pegue sus datos aquí..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close">Cancelar</button>
                <button class="btn btn-primary" id="process-import-fleet">Importar</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <div id="toast-icon"
            class="toast-icon bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400">
            <iconify-icon icon="heroicons:check"></iconify-icon>
        </div>
        <div class="toast-content">
            <div id="toast-title" class="toast-title">Operación Exitosa</div>
            <div id="toast-message" class="toast-message">La operación se completó correctamente.</div>
        </div>
        <button id="toast-close"
            class="text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300">
            <iconify-icon icon="heroicons:x-mark"></iconify-icon>
        </button>
    </div>

    <script>

        // -------------------------------------------------------------
// GLOBAL VARIABLES
// -------------------------------------------------------------
let isDarkMode = false;
let masterFleet = [];
let fuelData = null;
let operativityData = null;
let combinedData = {
    buses: {},
    terminals: {
        'EL ROBLE': { buses: [], operationalCount: 0, maintenanceCount: 0, panneCount: 0, loadedCount: 0, totalLiters: 0 },
        'LA REINA': { buses: [], operationalCount: 0, maintenanceCount: 0, panneCount: 0, loadedCount: 0, totalLiters: 0 },
        'MARIA ANGELICA': { buses: [], operationalCount: 0, maintenanceCount: 0, panneCount: 0, loadedCount: 0, totalLiters: 0 },
        'EL DESCANSO': { buses: [], operationalCount: 0, maintenanceCount: 0, panneCount: 0, loadedCount: 0, totalLiters: 0 }
    },
    status: {
        operational: 0,
        maintenance: 0,
        panne: 0,
        unknown: 0
    },
    fuel: {
        totalLiters: 0,
        loadedBuses: [],
        hourlyLoads: Array(24).fill(0),
        hourlyLiters: Array(24).fill(0),
        badLoads: [],
        terminals: {},
        pumps: {}
    },
    locations: {},
    pendingBuses: [],
    maintenanceBuses: []
};
let charts = {};
let searchHistory = [];
const internalToPPU = {};

// Default fleet data
const defaultFleet = `LXWP57
LXWP58
LXWP59
LXWP60
LXWP61
LXWP62
LXWP64
LXWP66
LXWP67
LXWP68
LXWP69
LXWP70
LXWP71
LXWP72
LXWP73
LXWP74
LXWP75
LXWP76
LXWP77
LXWP78
LXWP79
LXWP80
LXWP81
LXWP82
LXWP83
LXWP85
LXWP86
LXWP87
PFTV77
PFTW19
PFTW20
PFTW25
PFTW26
PFTW28
PFTW29
PFTW30
PFTW31
PFTW32
PFTW34
PFTW35
PFTW36
PFTW38
PFTW39
PFTW40
PFTW41
PFTW42
PFTW44
PFTW45
PFTW46
PFTW47
PFTW48
PFTW49
PFTW50
PFTW51
PFTW55
PFTW56
PFTW57
PFTW58
PFTW59
PFTW60
PFTW61
PFTW62
PFVG75
PFVG76
PFVG77
PFVG78
PFVG79
PFVG80
PFVG82
PFVG83
PFVG85
PFVG86
PFVG87
PFVG88
PFVG89
PFVG90
PFVG92
PFVG94
PFVG95
PFVG96
PFVG97
PFVG98
PFVG99
PFVH10
PFVH11
PFVH12
PFVH13
PFVH14
PFVH15
PFYC13
PFYC14
PFYC16
PFYC17
PFYC19
PFYC20
PFYC25
PFYC26
PFYC27
PFYC28
PFYC29
PFYC31
PFYC32
PFYC33
PFYC34
PFYC35
PFYC36
PFYC37
PFYC43
PFYC44
PFYC46
PFYC49
PFYC50
PFYC53
PFYC55
PFYC57
PFYC58
PFYC60
PFYC61
PFYC64
PFYC65
PFYC66
PFYC68
PFYC69
PFYC70
PFYC72
PFYC75
PFYC76
PFYC77
PFYC79
PFYC80
PFYC81
PFYC85
PFYC88
PFYC90
PFZK83
PFZK91
PGBF59
PGBY67
PGBY72
PGBY73
PGBY83
PGKP67
PGLD42
PGLD67
PGRZ67
PGTT95
PGTV12
PGWT98
SHCV78
SHCV83
SHCX39
SHCY22
SHCY28
SHXD75
SHXD77
SHXD79
SHXD85
SHXF13
SHXF14
SHXF29
SHXF31
SHXF84
SHXF85
SHXF87
SHXF88
SHXF90
SHXF92
SHXF93
SHXF97
SHXG36
SHXG38
SJPB21
SJPB25
SJPC73
SJPD42
SJPD44
SJPD71
SJPD72
SJPD97
SJPF43
SJPF44
SKPH70
SKPH73
SKPJ90
SKPK18
SKPK19
SKPK20
SKPK21
SKPK22
SKPK23
SKPK25
SKPK26
SKPK27
SKPK28
SKPK31
SKPK32
SKPK34
SKPK35
SKPK37
SKPK39
SKPK40
SKPK42
SKPK44
SKPK45
SKPK62
SKPK63
SKPL28
SKPL30
SKPL33
SKPL34
SKPL36`;

// -------------------------------------------------------------
// INITIALIZATION
// -------------------------------------------------------------
document.addEventListener('DOMContentLoaded', () => {
    initApp();
});

function initApp() {
    loadDefaultFleet();

    initThemeListeners();        // aquí ya están los listeners de tema + sidebar
    initFileListeners();         // archivos de combustible y operatividad
    initFleetListeners();        // editar/importar flota
    initNavigationListeners();   // pestañas y filtros
    initSearchListeners();       // búsqueda global y rápida
    initKeyboardShortcuts();     // atajos de teclado
    initModalListeners();        // Listeners para modales

    initEmptyCharts();
    updateChartsForTheme();
    checkDarkMode();

    // Expose global functions for direct HTML access
    window.showBusDetail = showBusDetail;
    window.printBusDetail = printBusDetail;
    window.activateTab = activateTab;
    window.getTerminalBadge = getTerminalBadge;
    window.getStatusText = getStatusText;
    window.formatDate = formatDate;
    window.exportData = exportData;
    window.exportCurrentView = exportCurrentView;
    window.printCurrentView = printCurrentView;
    window.getRecommendedActions = getRecommendedActions;
    window.refreshData = refreshData;
    window.filterTable = filterTable;
    window.sortTable = sortTable;
}

function safeAddEventListener(elementId, eventType, handler) {
    const element = document.getElementById(elementId);
    if (element) {
        element.addEventListener(eventType, handler);
        return true;
    }
    console.warn(`Elemento con ID '${elementId}' no encontrado.`);
    return false;
}

function initThemeListeners() {
    safeAddEventListener('theme-toggle', 'click', toggleTheme);

    // Sidebar mobile
    safeAddEventListener('sidebar-toggle', 'click', toggleSidebar);
    safeAddEventListener('sidebar-overlay', 'click', closeSidebar);
}

function initFileListeners() {
    // Archivos de combustible
    const setupFuelFileInput = (inputId, textId, infoId) => {
        safeAddEventListener(inputId, 'change', (event) => {
            handleFileSelection(event, textId, infoId, 'fuel');
        });
    };

    setupFuelFileInput('fuel-file', 'fuel-file-text', 'fuel-file-info');
    setupFuelFileInput('welcome-fuel-file', 'fuel-file-text', 'fuel-file-info');

    // Archivos de operatividad
    const setupOperativityFileInput = (inputId, textId, infoId) => {
        safeAddEventListener(inputId, 'change', (event) => {
            handleFileSelection(event, textId, infoId, 'operativity');
        });
    };

    setupOperativityFileInput('operativity-file', 'operativity-file-text', 'operativity-file-info');
    setupOperativityFileInput('welcome-operativity-file', 'operativity-file-text', 'operativity-file-info');

    // Botones de procesamiento
    safeAddEventListener('process-button', 'click', processFiles);
    safeAddEventListener('welcome-process-button', 'click', processFiles);
    safeAddEventListener('refresh-data', 'click', refreshData);
}

function initModalListeners() {
    const modalCloseButtons = document.querySelectorAll('.modal-close');
    modalCloseButtons.forEach(button => {
        button.addEventListener('click', () => {
            const modal = button.closest('.modal');
            closeModal(modal);
        });
    });

    const toastClose = document.getElementById('toast-close');
    if (toastClose) {
        toastClose.addEventListener('click', hideToast);
    }

    const printBusDetailBtn = document.getElementById('print-bus-detail');
    if (printBusDetailBtn) {
        printBusDetailBtn.addEventListener('click', printBusDetail);
    }

    // Click outside modal to close
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal(modal);
            }
        });
    });
}

function handleFileSelection(event, textId, infoId, fileType) {
    const file = event.target.files[0];
    const textElement = document.getElementById(textId);
    const infoElement = document.getElementById(infoId);

    if (!file || !textElement || !infoElement) {
        return;
    }

    const fileSize = (file.size / 1024 / 1024).toFixed(2);
    const icon = fileType === 'fuel' ? 'heroicons:document-text' : 'heroicons:clipboard-document-check';
    const label = fileType === 'fuel' ? 'Combustible' : 'Operatividad';

    if (file) {
        textElement.textContent = 'Archivo seleccionado';
        infoElement.innerHTML = `
            <div class="file-info">
                <div class="file-info-icon">
                    <iconify-icon icon="${icon}"></iconify-icon>
                </div>
                <div class="file-info-details">
                    <div class="file-info-name">${file.name}</div>
                    <div class="file-info-meta">${fileSize} MB • Excel</div>
                </div>
            </div>
        `;
    } else {
        textElement.textContent = label;
        infoElement.innerHTML = '';
    }

    checkProcessButtonState();
}

function initSearchListeners() {
    // Búsqueda global
    const globalSearch = document.getElementById('global-search');
    const clearSearch = document.getElementById('clear-search');
    const searchResults = document.getElementById('search-results');

    if (globalSearch) {
        globalSearch.addEventListener('input', handleGlobalSearch);
        globalSearch.addEventListener('focus', () => {
            if (globalSearch.value.trim().length > 0) {
                handleGlobalSearch();
                if (clearSearch) clearSearch.classList.add('show');
            }
        });

        if (searchResults) {
            globalSearch.addEventListener('blur', () => {
                setTimeout(() => {
                    searchResults.classList.remove('show');
                }, 200);
            });
        }
    }

    if (clearSearch && globalSearch) {
        clearSearch.addEventListener('click', () => {
            globalSearch.value = '';
            clearSearch.classList.remove('show');
            if (searchResults) searchResults.classList.remove('show');
            globalSearch.focus();
        });
    }

    // Búsqueda rápida
    const quickSearchInput = document.getElementById('quick-search-input');
    const quickSearchButton = document.getElementById('quick-search-button');

    if (quickSearchButton && quickSearchInput) {
        quickSearchButton.addEventListener('click', () => {
            performQuickSearch(quickSearchInput.value);
        });

        quickSearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performQuickSearch(quickSearchInput.value);
            }
        });
    }

    // Filtros de tabla
    const setupTableFilters = () => {
        const filterInputs = document.querySelectorAll('input[id^="filter-"]');
        filterInputs.forEach(input => {
            const tableId = input.id.replace('filter-', '');
            input.addEventListener('input', () => {
                filterTable(tableId, input.value);
            });
        });

        // Inicializar selectores de ordenamiento
        const sortSelectors = document.querySelectorAll('select[id^="sort-"]');
        sortSelectors.forEach(selector => {
            const tableId = selector.id.replace('sort-', '');
            selector.addEventListener('change', () => {
                sortTable(tableId, selector.value);
            });
        });
    };

    // Esperar a que el DOM esté completamente cargado para inicializar filtros de tabla
    if (document.readyState === 'complete') {
        setupTableFilters();
    } else {
        window.addEventListener('load', setupTableFilters);
    }

    // Dashboard filter
    const dashboardFilter = document.getElementById('dashboard-filter');
    if (dashboardFilter) {
        dashboardFilter.addEventListener('input', (e) => filterDashboard(e));
    }
}

function initFleetListeners() {
    safeAddEventListener('edit-fleet', 'click', showEditFleetModal);
    safeAddEventListener('import-fleet', 'click', showImportFleetModal);
    safeAddEventListener('save-fleet', 'click', saveFleet);
    safeAddEventListener('process-import-fleet', 'click', processImportFleet);
}

function initNavigationListeners() {
    // Pestañas principales
    const tabs = document.querySelectorAll('.tab');
    if (tabs.length > 0) {
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                activateTab(tabId);
            });
        });
    }

    // Fichas de filtro
    const filterChips = document.querySelectorAll('.filter-chip');
    if (filterChips.length > 0) {
        filterChips.forEach(chip => {
            chip.addEventListener('click', () => {
                document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                const filter = chip.getAttribute('data-filter');
                applyDashboardFilter(filter);
            });
        });
    }

    // Enlaces de navegación del sidebar
    const navLinks = document.querySelectorAll('.nav-menu-link');
    if (navLinks.length > 0) {
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const href = link.getAttribute('href');
                if (href && href.startsWith('#')) {
                    const tabId = href.substring(1);
                    activateTab(tabId);
                    
                    // Actualizar clase active en enlaces
                    document.querySelectorAll('.nav-menu-link').forEach(l => {
                        l.classList.remove('active');
                    });
                    link.classList.add('active');
                    
                    // Cerrar sidebar en móvil
                    closeSidebar();
                }
            });
        });
    }

    // Botones de exportación
    const exportButtons = document.querySelectorAll('button[id$="-btn"][id^="export-"]');
    if (exportButtons.length > 0) {
        exportButtons.forEach(button => {
            button.addEventListener('click', () => {
                const dataType = button.id.replace('export-', '').replace('-btn', '');
                exportData(dataType);
            });
        });
    }

    // Botón para ver todas las cargas manuales
    safeAddEventListener('view-all-bad-loads', 'click', () => {
        activateTab('bad-loads');
    });

    // Botones de exportación/impresión rápidos
    safeAddEventListener('export-data-btn', 'click', exportCurrentView);
    safeAddEventListener('print-report-btn', 'click', printCurrentView);
}

function initKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
        // Atajo para buscar
        if (e.key === '/' && !e.ctrlKey && !e.metaKey) {
            e.preventDefault();
            const globalSearch = document.getElementById('global-search');
            if (globalSearch) {
                globalSearch.focus();
            }
        }

        // Atajo para limpiar búsqueda
        if (e.key === 'Escape') {
            const globalSearch = document.getElementById('global-search');
            if (document.activeElement === globalSearch) {
                globalSearch.value = '';
                document.getElementById('clear-search').classList.remove('show');
                document.getElementById('search-results').classList.remove('show');
            }

            const quickSearchInput = document.getElementById('quick-search-input');
            if (document.activeElement === quickSearchInput) {
                quickSearchInput.value = '';
            }

            // Cerrar modales abiertos
            document.querySelectorAll('.modal.open').forEach(modal => {
                closeModal(modal);
            });
        }

        // Navegación entre pestañas con Alt + número
        if (e.altKey && !isNaN(parseInt(e.key)) && parseInt(e.key) >= 1 && parseInt(e.key) <= 5) {
            const tabIndex = parseInt(e.key) - 1;
            const tabs = document.querySelectorAll('.tab');
            if (tabs.length > tabIndex) {
                tabs[tabIndex].click();
            }
        }
    });
}

function loadDefaultFleet() {
    masterFleet = defaultFleet.split('\n').filter(line => line.trim() !== '');
    updateFleetPreview();
}

function initEmptyCharts() {
    const fleetStatusCtx = document.getElementById('fleet-status-chart')?.getContext('2d');
    const terminalDistributionCtx = document.getElementById('terminal-distribution-chart')?.getContext('2d');
    const hourlyCtx = document.getElementById('hourly-chart')?.getContext('2d');
    const terminalConsumptionCtx = document.getElementById('terminal-consumption-chart')?.getContext('2d');
    const hourlyConsumptionCtx = document.getElementById('hourly-consumption-chart')?.getContext('2d');
    const terminalStatusCtx = document.getElementById('terminal-status-chart')?.getContext('2d');
    const topConsumersCtx = document.getElementById('top-consumers-chart')?.getContext('2d');
    const badLoadsByTerminalCtx = document.getElementById('bad-loads-by-terminal-chart')?.getContext('2d');
    const badLoadsByDayCtx = document.getElementById('bad-loads-by-day-chart')?.getContext('2d');
    const pumpsDistributionCtx = document.getElementById('pumps-distribution-chart')?.getContext('2d');
    const pumpsHourlyCtx = document.getElementById('pumps-hourly-chart')?.getContext('2d');

    if (!fleetStatusCtx) return; // Si no hay contextos de gráficos, no inicializamos

    Chart.defaults.color = isDarkMode ? '#94a3b8' : '#64748b';
    Chart.defaults.borderColor = isDarkMode ? 'rgba(71, 85, 105, 0.2)' : 'rgba(203, 213, 225, 0.3)';
    Chart.defaults.font.size = 10;
    Chart.defaults.font.family = "'Inter', sans-serif";

    // Definir paletas de colores
    const terminalColors = {
        'EL ROBLE': {
            bg: 'rgba(59, 130, 246, 0.7)',
            border: 'rgba(59, 130, 246, 1)'
        },
        'LA REINA': {
            bg: 'rgba(245, 158, 11, 0.7)',
            border: 'rgba(245, 158, 11, 1)'
        },
        'MARIA ANGELICA': {
            bg: 'rgba(16, 185, 129, 0.7)',
            border: 'rgba(16, 185, 129, 1)'
        },
        'EL DESCANSO': {
            bg: 'rgba(139, 92, 246, 0.7)',
            border: 'rgba(139, 92, 246, 1)'
        }
    };

    const statusColors = {
        operational: {
            bg: 'rgba(16, 185, 129, 0.7)',
            border: 'rgba(16, 185, 129, 1)'
        },
        maintenance: {
            bg: 'rgba(245, 158, 11, 0.7)',
            border: 'rgba(245, 158, 11, 1)'
        },
        panne: {
            bg: 'rgba(239, 68, 68, 0.7)',
            border: 'rgba(239, 68, 68, 1)'
        },
        unknown: {
            bg: 'rgba(148, 163, 184, 0.7)',
            border: 'rgba(148, 163, 184, 1)'
        }
    };

    charts.fleetStatus = new Chart(fleetStatusCtx, {
        type: 'doughnut',
        data: {
            labels: ['Operativos', 'Mantención', 'Panne', 'Sin Datos'],
            datasets: [{
                data: [0, 0, 0, 100],
                backgroundColor: [
                    statusColors.operational.bg,
                    statusColors.maintenance.bg,
                    statusColors.panne.bg,
                    statusColors.unknown.bg
                ],
                borderColor: isDarkMode ? '#1e293b' : '#ffffff',
                borderWidth: 1,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 10,
                        padding: 10
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            const value = context.raw;
                            const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${context.label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    charts.terminalDistribution = new Chart(terminalDistributionCtx, {
        type: 'bar',
        data: {
            labels: ['EL ROBLE', 'LA REINA', 'MARIA ANGELICA', 'EL DESCANSO'],
            datasets: [{
                label: 'Buses',
                data: [0, 0, 0, 0],
                backgroundColor: [
                    terminalColors['EL ROBLE'].bg,
                    terminalColors['LA REINA'].bg,
                    terminalColors['MARIA ANGELICA'].bg,
                    terminalColors['EL DESCANSO'].bg
                ],
                borderColor: [
                    terminalColors['EL ROBLE'].border,
                    terminalColors['LA REINA'].border,
                    terminalColors['MARIA ANGELICA'].border,
                    terminalColors['EL DESCANSO'].border
                ],
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Distribución por Terminal',
                    font: {
                        size: 12
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                },
                y: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    charts.hourly = new Chart(hourlyCtx, {
        type: 'line',
        data: {
            labels: Array.from({ length: 24 }, (_, i) => `${i.toString().padStart(2, '0')}:00`),
            datasets: [{
                label: 'Cargas',
                data: Array(24).fill(0),
                borderColor: 'rgba(14, 165, 233, 1)',
                backgroundColor: 'rgba(14, 165, 233, 0.1)',
                fill: true,
                tension: 0.4,
                pointBackgroundColor: 'rgba(14, 165, 233, 1)',
                pointBorderColor: isDarkMode ? '#1e293b' : '#ffffff',
                pointBorderWidth: 1,
                pointRadius: 2,
                pointHoverRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Cargas por Hora',
                    font: {
                        size: 12
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxRotation: 0,
                        autoSkip: true,
                        maxTicksLimit: 8
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });

    charts.terminalConsumption = new Chart(terminalConsumptionCtx, {
        type: 'pie',
        data: {
            labels: ['EL ROBLE', 'LA REINA', 'MARIA ANGELICA', 'EL DESCANSO'],
            datasets: [{
                data: [0, 0, 0, 0],
                backgroundColor: [
                    terminalColors['EL ROBLE'].bg,
                    terminalColors['LA REINA'].bg,
                    terminalColors['MARIA ANGELICA'].bg,
                    terminalColors['EL DESCANSO'].bg
                ],
                borderColor: isDarkMode ? '#1e293b' : '#ffffff',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 10,
                        padding: 10
                    }
                },
                title: {
                    display: true,
                    text: 'Consumo por Terminal',
                    font: {
                        size: 12
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            const value = context.raw;
                            const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${context.label}: ${value.toLocaleString('es-CL')} Lts (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    charts.hourlyConsumption = new Chart(hourlyConsumptionCtx, {
        type: 'bar',
        data: {
            labels: Array.from({ length: 24 }, (_, i) => `${i.toString().padStart(2, '0')}:00`),
            datasets: [{
                label: 'Litros',
                data: Array(24).fill(0),
                backgroundColor: 'rgba(14, 165, 233, 0.7)',
                borderColor: 'rgba(14, 165, 233, 1)',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Litros por Hora',
                    font: {
                        size: 12
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxRotation: 0,
                        autoSkip: true,
                        maxTicksLimit: 8
                    }
                },
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    charts.terminalStatus = new Chart(terminalStatusCtx, {
        type: 'bar',
        data: {
            labels: ['EL ROBLE', 'LA REINA', 'MARIA ANGELICA', 'EL DESCANSO'],
            datasets: [
                {
                    label: 'Operativos',
                    data: [0, 0, 0, 0],
                    backgroundColor: statusColors.operational.bg,
                    borderColor: statusColors.operational.border,
                    borderWidth: 1,
                    borderRadius: 4
                },
                {
                    label: 'Mantención',
                    data: [0, 0, 0, 0],
                    backgroundColor: statusColors.maintenance.bg,
                    borderColor: statusColors.maintenance.border,
                    borderWidth: 1,
                    borderRadius: 4
                },
                {
                    label: 'Panne',
                    data: [0, 0, 0, 0],
                    backgroundColor: statusColors.panne.bg,
                    borderColor: statusColors.panne.border,
                    borderWidth: 1,
                    borderRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 10,
                        padding: 5
                    }
                },
                title: {
                    display: true,
                    text: 'Estado por Terminal',
                    font: {
                        size: 12
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    }
                },
                y: {
                    beginAtZero: true,
                    stacked: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });

    charts.topConsumers = new Chart(topConsumersCtx, {
        type: 'bar',
        data: {
            labels: Array(10).fill(''),
            datasets: [{
                label: 'Litros',
                data: Array(10).fill(0),
                backgroundColor: 'rgba(14, 165, 233, 0.7)',
                borderColor: 'rgba(14, 165, 233, 1)',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Top 10 Consumo',
                    font: {
                        size: 12
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    grid: {
                        display: true
                    }
                },
                y: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    charts.badLoadsByTerminal = new Chart(badLoadsByTerminalCtx, {
        type: 'doughnut',
        data: {
            labels: ['EL ROBLE', 'LA REINA', 'MARIA ANGELICA', 'EL DESCANSO'],
            datasets: [{
                data: [0, 0, 0, 0],
                backgroundColor: [
                    terminalColors['EL ROBLE'].bg,
                    terminalColors['LA REINA'].bg,
                    terminalColors['MARIA ANGELICA'].bg,
                    terminalColors['EL DESCANSO'].bg
                ],
                borderColor: isDarkMode ? '#1e293b' : '#ffffff',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 10,
                        padding: 5
                    }
                },
                title: {
                    display: true,
                    text: 'Cargas Manuales por Terminal',
                    font: {
                        size: 12
                    }
                }
            }
        }
    });

    charts.badLoadsByDay = new Chart(badLoadsByDayCtx, {
        type: 'bar',
        data: {
            labels: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'],
            datasets: [{
                label: 'Cargas',
                data: [0, 0, 0, 0, 0, 0, 0],
                backgroundColor: 'rgba(239, 68, 68, 0.7)',
                borderColor: 'rgba(239, 68, 68, 1)',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Cargas Manuales por Día',
                    font: {
                        size: 12
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });

    charts.pumpsDistribution = new Chart(pumpsDistributionCtx, {
        type: 'pie',
        data: {
            labels: ['Sin Datos'],
            datasets: [{
                data: [100],
                backgroundColor: ['rgba(148, 163, 184, 0.7)'],
                borderColor: isDarkMode ? '#1e293b' : '#ffffff',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 10,
                        padding: 5
                    }
                },
                title: {
                    display: true,
                    text: 'Distribución por Surtidor',
                    font: {
                        size: 12
                    }
                }
            }
        }
    });

    charts.pumpsHourly = new Chart(pumpsHourlyCtx, {
        type: 'line',
        data: {
            labels: Array.from({ length: 24 }, (_, i) => `${i.toString().padStart(2, '0')}:00`),
            datasets: [{
                label: 'Cargas',
                data: Array(24).fill(0),
                borderColor: 'rgba(14, 165, 233, 1)',
                backgroundColor: 'rgba(14, 165, 233, 0.1)',
                fill: true,
                tension: 0.4,
                pointBackgroundColor: 'rgba(14, 165, 233, 1)',
                pointBorderColor: isDarkMode ? '#1e293b' : '#ffffff',
                pointBorderWidth: 1,
                pointRadius: 2,
                pointHoverRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Uso por Hora',
                    font: {
                        size: 12
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxRotation: 0,
                        autoSkip: true,
                        maxTicksLimit: 8
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
}

function checkDarkMode() {
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        toggleTheme();
    }
}

// -------------------------------------------------------------
// FILE HANDLING
// -------------------------------------------------------------
function checkProcessButtonState() {
    const fuelFileInput = document.getElementById('fuel-file');
    const operativityFileInput = document.getElementById('operativity-file');
    const processButton = document.getElementById('process-button');
    const welcomeProcessButton = document.getElementById('welcome-process-button');

    if (!fuelFileInput || !operativityFileInput) return;

    const fuelFile = fuelFileInput.files[0];
    const operativityFile = operativityFileInput.files[0];

    // Solo necesitamos el archivo de operatividad y la flota para procesar
    const isReady = operativityFile && masterFleet.length > 0;

    if (processButton) processButton.disabled = !isReady;
    if (welcomeProcessButton) welcomeProcessButton.disabled = !isReady;
}

function processFiles() {
    const operativityFileInput = document.getElementById('operativity-file');
    const processButton = document.getElementById('process-button');
    const welcomeProcessButton = document.getElementById('welcome-process-button');

    const operativityFile = operativityFileInput.files[0];

    if (!operativityFile) {
        showToast('Error', 'Debe seleccionar el archivo de operatividad para continuar', 'error');
        return;
    }

    if (processButton) {
        processButton.disabled = true;
        processButton.innerHTML = '<div class="loading-spinner mr-2"></div> <span>Procesando...</span>';
    }

    if (welcomeProcessButton) {
        welcomeProcessButton.disabled = true;
        welcomeProcessButton.innerHTML = '<div class="loading-spinner mr-2"></div> <span>Procesando...</span>';
    }

    // Si hay archivo de combustible, lo procesamos
    const fuelFileInput = document.getElementById('fuel-file');
    const fuelFile = fuelFileInput ? fuelFileInput.files[0] : null;

    let fuelPromise = fuelFile 
        ? processFuelFile(fuelFile) 
        : Promise.resolve(null);

    // Procesamos el archivo de operatividad
    Promise.all([
        fuelPromise,
        processOperativityFile(operativityFile)
    ])
        .then(([fuelResult, operativityResult]) => {
            fuelData = fuelResult;
            operativityData = operativityResult;

            combineData();
            renderDashboard();

            showToast('Éxito', 'Archivos procesados correctamente', 'success');
        })
        .catch(error => {
            console.error('Error processing files:', error);
            showToast('Error', error.message || 'Error al procesar los archivos', 'error');
        })
        .finally(() => {
            if (processButton) {
                processButton.disabled = false;
                processButton.innerHTML = '<iconify-icon icon="heroicons:arrow-path" class="mr-1"></iconify-icon> <span>Procesar Datos</span>';
            }

            if (welcomeProcessButton) {
                welcomeProcessButton.disabled = false;
                welcomeProcessButton.innerHTML = '<iconify-icon icon="heroicons:arrow-path" class="mr-2"></iconify-icon> <span>Procesar Archivos</span>';
            }
        });
}

function processFuelFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = (event) => {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { range: 2, defval: "" });

                if (jsonData.length === 0) {
                    throw new Error("El archivo de combustible parece estar vacío.");
                }

                const processedData = processFuelData(jsonData);
                resolve(processedData);
            } catch (error) {
                reject(new Error(`Error en el archivo de combustible: ${error.message}`));
            }
        };

        reader.onerror = () => {
            reject(new Error("No se pudo leer el archivo de combustible."));
        };

        reader.readAsArrayBuffer(file);
    });
}

function processOperativityFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = (event) => {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });

                // Buscamos las hojas requeridas
                const requiredSheets = ['US6 EL ROBLE', 'LA REINA', 'MARIA ANGELICA', 'EL DESCANSO'];
                const availableSheets = [];
                
                for (const sheet of requiredSheets) {
                    if (workbook.SheetNames.includes(sheet)) {
                        availableSheets.push(sheet);
                    }
                }
                
                if (availableSheets.length === 0) {
                    throw new Error(`No se encontraron hojas de terminales en el archivo de operatividad. Busque las hojas: ${requiredSheets.join(', ')}`);
                }

                // Procesar cada hoja disponible
                const terminalData = {};
                
                for (const sheet of availableSheets) {
                    const worksheet = workbook.Sheets[sheet];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { range: 5, defval: "" });
                    
                    let terminalName = '';
                    if (sheet === 'US6 EL ROBLE') terminalName = 'EL ROBLE';
                    else if (sheet === 'LA REINA') terminalName = 'LA REINA';
                    else if (sheet === 'MARIA ANGELICA') terminalName = 'MARIA ANGELICA';
                    else if (sheet === 'EL DESCANSO') terminalName = 'EL DESCANSO';
                    
                    terminalData[terminalName] = jsonData;
                }

                const processedData = processOperativityData(terminalData);
                resolve(processedData);
            } catch (error) {
                reject(new Error(`Error en el archivo de operatividad: ${error.message}`));
            }
        };

        reader.onerror = () => {
            reject(new Error("No se pudo leer el archivo de operatividad."));
        };

        reader.readAsArrayBuffer(file);
    });
}

function processFuelData(jsonData) {
    const firstRow = jsonData[0];
    const keys = {
        plate: findKey(firstRow, ['patente', 'ppu', 'placa']),
        liters: findKey(firstRow, ['litros', 'cantidad', 'volumen']),
        loadedBy: findKey(firstRow, ['cargado por', 'origen']),
        terminal: findKey(firstRow, ['terminal', 'estación']),
        pump: findKey(firstRow, ['surtidor', 'bomba']),
        model: findKey(firstRow, ['modelo', 'modelo chasis', 'tipo']),
        time: findKey(firstRow, ['hora', 'tiempo', 'fecha y hora']),
        internalNum: findKey(firstRow, ['número interno', 'interno', 'id']),
        driver: findKey(firstRow, ['nombre conductor', 'conductor', 'operador']),
        date: findKey(firstRow, ['fecha', 'día'])
    };

    const missingKeys = [];
    if (!keys.plate) missingKeys.push('Patente/PPU');
    if (!keys.liters) missingKeys.push('Litros');

    if (missingKeys.length > 0) {
        throw new Error(`Columnas esenciales no encontradas: ${missingKeys.join(', ')}`);
    }

    const processedData = {
        rows: jsonData,
        keys: keys,
        summary: {
            totalLiters: 0,
            loadedBuses: new Set(),
            terminals: {},
            pumps: {},
            hourlyLoads: Array(24).fill(0),
            hourlyLiters: Array(24).fill(0),
            badLoads: [],
            badLoadsByTerminal: {},
            badLoadsByDay: Array(7).fill(0)
        }
    };

    // Primero mapeamos los números internos a patentes
    jsonData.forEach(row => {
        const plate = row[keys.plate]?.toString().trim().toUpperCase();
        const internalNum = row[keys.internalNum]?.toString().trim();

        if (plate && internalNum) {
            internalToPPU[internalNum] = plate;
        }
    });

    // Luego procesamos los datos de combustible
    jsonData.forEach(row => {
        const liters = parseFloat(row[keys.liters]) || 0;
        const plate = row[keys.plate]?.toString().trim().toUpperCase();
        const loadedBy = row[keys.loadedBy]?.toString().trim().toLowerCase();
        let terminal = row[keys.terminal]?.toString().trim() || 'No especificado';
        const pump = row[keys.pump]?.toString().trim() || 'No especificado';
        const date = row[keys.date];
        const driver = row[keys.driver]?.toString().trim() || 'No especificado';

        // Normalizar nombres de terminales
        if (terminal.toUpperCase().includes('ROBLE')) {
            terminal = 'EL ROBLE';
        } else if (terminal.toUpperCase().includes('REINA')) {
            terminal = 'LA REINA';
        } else if (terminal.toUpperCase().includes('ANGEL')) {
            terminal = 'MARIA ANGELICA';
        } else if (terminal.toUpperCase().includes('DESCANSO')) {
            terminal = 'EL DESCANSO';
        }

        if (liters > 0 && plate) {
            processedData.summary.totalLiters += liters;
            processedData.summary.loadedBuses.add(plate);

            if (!processedData.summary.terminals[terminal]) {
                processedData.summary.terminals[terminal] = {
                    totalLiters: 0,
                    loadedBuses: new Set(),
                    pumps: {}
                };
            }
            processedData.summary.terminals[terminal].totalLiters += liters;
            processedData.summary.terminals[terminal].loadedBuses.add(plate);

            if (!processedData.summary.pumps[pump]) {
                processedData.summary.pumps[pump] = {
                    totalLiters: 0,
                    loadedBuses: new Set(),
                    loadCount: 0,
                    terminal: terminal,
                    hourlyLoads: Array(24).fill(0),
                    hourlyLiters: Array(24).fill(0)
                };
            }
            processedData.summary.pumps[pump].totalLiters += liters;
            processedData.summary.pumps[pump].loadedBuses.add(plate);
            processedData.summary.pumps[pump].loadCount++;

            let hour = -1;
            const time = row[keys.time];

            if (time instanceof Date) {
                hour = time.getHours();
            } else if (typeof time === 'number' && time < 1) {
                const parsedDate = XLSX.SSF.parse_date_code(time);
                hour = parsedDate.H;
            } else if (typeof time === 'string') {
                const timeParts = time.split(':');
                if (timeParts.length >= 2) {
                    hour = parseInt(timeParts[0], 10);
                }
            }

            if (hour >= 0 && hour < 24) {
                processedData.summary.hourlyLoads[hour]++;
                processedData.summary.hourlyLiters[hour] += liters;

                if (processedData.summary.pumps[pump]) {
                    processedData.summary.pumps[pump].hourlyLoads[hour]++;
                    processedData.summary.pumps[pump].hourlyLiters[hour] += liters;
                }
            }

            if (loadedBy === 'carga masiva' || loadedBy === 'manual') {
                const badLoad = {
                    plate: plate,
                    liters: liters,
                    driver: driver,
                    terminal: terminal,
                    pump: pump,
                    date: date,
                    time: time,
                    type: loadedBy
                };

                processedData.summary.badLoads.push(badLoad);

                if (!processedData.summary.badLoadsByTerminal[terminal]) {
                    processedData.summary.badLoadsByTerminal[terminal] = {
                        count: 0,
                        liters: 0
                    };
                }
                processedData.summary.badLoadsByTerminal[terminal].count++;
                processedData.summary.badLoadsByTerminal[terminal].liters += liters;

                let dayOfWeek = 0;
                if (date instanceof Date) {
                    dayOfWeek = date.getDay();
                } else if (typeof date === 'string') {
                    try {
                        const dateObj = new Date(date);
                        if (!isNaN(dateObj.getTime())) {
                            dayOfWeek = dateObj.getDay();
                        }
                    } catch (e) { }
                }

                if (dayOfWeek >= 0 && dayOfWeek < 7) {
                    processedData.summary.badLoadsByDay[dayOfWeek]++;
                }
            }
        }
    });

    // Convertir Sets a Arrays para más fácil manipulación
    processedData.summary.loadedBuses = Array.from(processedData.summary.loadedBuses);

    Object.keys(processedData.summary.terminals).forEach(terminal => {
        processedData.summary.terminals[terminal].loadedBuses =
            Array.from(processedData.summary.terminals[terminal].loadedBuses);
    });

    Object.keys(processedData.summary.pumps).forEach(pump => {
        processedData.summary.pumps[pump].loadedBuses =
            Array.from(processedData.summary.pumps[pump].loadedBuses);
    });

    return processedData;
}

function processOperativityData(terminalData) {
    const processedTerminals = {};
    const summary = {
        totalBuses: 0,
        operational: 0,
        maintenance: 0,
        panne: 0
    };

    // Procesar cada terminal
    Object.entries(terminalData).forEach(([terminalName, data]) => {
        if (data.length === 0) return;

        // Detectar columnas
        const firstRow = data[0];
        const keys = {
            code: findKeyInOperativityData(firstRow, ['COD', 'CODIGO']),
            plate: findKeyInOperativityData(firstRow, ['PPU', 'PATENTE']),
            zone: findKeyInOperativityData(firstRow, ['ZONA']),
            service: findKeyInOperativityData(firstRow, ['SERVICIO', 'E']), // Columna E contiene el servicio
            status: findKeyInOperativityData(firstRow, ['Estado', 'ESTADO', 'P']), // Columna P indica estado
            location: findKeyInOperativityData(firstRow, ['UBICACIÓN', 'UBICACION', 'O']), // Columna O indica ubicación
            observations: findKeyInOperativityData(firstRow, ['Observaciones', 'OBSERVACIONES']),
            detail: findKeyInOperativityData(firstRow, ['Detalle Panne', 'DETALLE'])
        };

        // Validar columnas esenciales
        const missingKeys = [];
        if (!keys.plate) missingKeys.push('PPU/PATENTE');

        if (missingKeys.length > 0) {
            console.warn(`Columnas esenciales no encontradas en ${terminalName}: ${missingKeys.join(', ')}`);
            return;
        }

        // Procesar datos
        const processedBuses = data
            .filter(row => row[keys.plate] && typeof row[keys.plate] === 'string' && row[keys.plate].trim() !== '')
            .map(row => {
                const plate = row[keys.plate].toString().trim().toUpperCase();
                let status = 'unknown';

                // Detectar status según columna P (Operatividad)
                // Si P está vacío, el bus está operativo
                // Si P dice "NO OPERATIVO" o similar, no está operativo
                if (keys.status) {
                    const statusValue = row[keys.status];
                    if (!statusValue || statusValue === '') {
                        status = 'operational';
                    } else if (typeof statusValue === 'string' && 
                              (statusValue.toUpperCase().includes('NO') || 
                               statusValue.toUpperCase().includes('PANNE') ||
                               statusValue.toUpperCase().includes('MANTEN'))) {
                        if (statusValue.toUpperCase().includes('MANTEN')) {
                            status = 'maintenance';
                        } else {
                            status = 'panne';
                        }
                    }
                }

                // Obtener ubicación de columna O
                let location = row[keys.location] || '';
                if (!location || location === '') {
                    location = 'En ruta';
                }

                // Obtener servicio de columna E
                const service = row[keys.service] || '';

                let detail = row[keys.detail] || '';
                if (status === 'panne' && !detail && keys.observations) {
                    detail = row[keys.observations] || '';
                }

                return {
                    plate: plate,
                    terminal: terminalName,
                    zone: row[keys.zone] || '',
                    service: service,
                    status: status,
                    detail: detail,
                    observations: row[keys.observations] || '',
                    location: location,
                    code: row[keys.code] || ''
                };
            });

        // Actualizar contadores de resumen
        summary.totalBuses += processedBuses.length;
        summary.operational += processedBuses.filter(bus => bus.status === 'operational').length;
        summary.maintenance += processedBuses.filter(bus => bus.status === 'maintenance').length;
        summary.panne += processedBuses.filter(bus => bus.status === 'panne').length;

        // Guardar datos procesados
        processedTerminals[terminalName] = processedBuses;
    });

    return {
        terminals: processedTerminals,
        summary: summary
    };
}

function findKey(obj, possibleMatches) {
    const keys = Object.keys(obj);
    for (const match of possibleMatches) {
        const foundKey = keys.find(key => {
            if (!key) return false;
            return key.toString().toLowerCase().includes(match.toLowerCase());
        });
        if (foundKey) return foundKey;
    }
    return null;
}

function findKeyInOperativityData(obj, possibleMatches) {
    if (!obj) return null;

    const keys = Object.keys(obj);
    
    // Primero intentamos con coincidencias exactas
    for (const match of possibleMatches) {
        const foundKey = keys.find(key => {
            if (!key) return false;
            return key.toString().toUpperCase() === match.toUpperCase();
        });
        if (foundKey) return foundKey;
    }
    
    // Si no encontramos, intentamos con coincidencias parciales
    for (const match of possibleMatches) {
        const foundKey = keys.find(key => {
            if (!key) return false;
            return key.toString().toUpperCase().includes(match.toUpperCase());
        });
        if (foundKey) return foundKey;
    }
    
    return null;
}

function combineData() {
    if (!operativityData) {
        showToast('Error', 'No hay datos de operatividad para combinar', 'error');
        return;
    }

    // Inicializar estructura de datos combinados
    combinedData = {
        buses: {},
        terminals: {
            'EL ROBLE': { buses: [], operationalCount: 0, maintenanceCount: 0, panneCount: 0, loadedCount: 0, totalLiters: 0 },
            'LA REINA': { buses: [], operationalCount: 0, maintenanceCount: 0, panneCount: 0, loadedCount: 0, totalLiters: 0 },
            'MARIA ANGELICA': { buses: [], operationalCount: 0, maintenanceCount: 0, panneCount: 0, loadedCount: 0, totalLiters: 0 },
            'EL DESCANSO': { buses: [], operationalCount: 0, maintenanceCount: 0, panneCount: 0, loadedCount: 0, totalLiters: 0 }
        },
        status: {
            operational: 0,
            maintenance: 0,
            panne: 0,
            unknown: 0
        },
        fuel: {
            totalLiters: fuelData ? fuelData.summary.totalLiters : 0,
            loadedBuses: fuelData ? fuelData.summary.loadedBuses : [],
            hourlyLoads: fuelData ? fuelData.summary.hourlyLoads : Array(24).fill(0),
            hourlyLiters: fuelData ? fuelData.summary.hourlyLiters : Array(24).fill(0),
            badLoads: fuelData ? fuelData.summary.badLoads : [],
            badLoadsByTerminal: fuelData ? fuelData.summary.badLoadsByTerminal : {},
            badLoadsByDay: fuelData ? fuelData.summary.badLoadsByDay : Array(7).fill(0),
            terminals: fuelData ? fuelData.summary.terminals : {},
            pumps: fuelData ? fuelData.summary.pumps : {}
        },
        locations: {},
        pendingBuses: [],
        maintenanceBuses: []
    };

    // Inicializar todos los buses de la flota maestra
    masterFleet.forEach(plate => {
        combinedData.buses[plate] = {
            plate: plate,
            loaded: false,
            totalLiters: 0,
            loadCount: 0,
            status: 'unknown',
            terminal: '',
            location: '',
            detail: '',
            service: ''
        };
    });

    // Si tenemos datos de combustible, procesarlos
    if (fuelData) {
        fuelData.summary.loadedBuses.forEach(plate => {
            if (!combinedData.buses[plate]) {
                combinedData.buses[plate] = {
                    plate: plate,
                    loaded: true,
                    totalLiters: 0,
                    loadCount: 0,
                    status: 'unknown',
                    terminal: '',
                    location: '',
                    detail: '',
                    service: ''
                };

                masterFleet.push(plate);
            }

            combinedData.buses[plate].loaded = true;

            let totalLiters = 0;
            let loadCount = 0;
            let lastLoadTime = null;

            fuelData.rows.forEach(row => {
                const rowPlate = row[fuelData.keys.plate]?.toString().trim().toUpperCase();
                if (rowPlate === plate) {
                    const liters = parseFloat(row[fuelData.keys.liters]) || 0;
                    totalLiters += liters;
                    loadCount++;

                    if (!combinedData.buses[plate].terminal && row[fuelData.keys.terminal]) {
                        let terminal = row[fuelData.keys.terminal].trim();
                        
                        // Normalizar nombres de terminales
                        if (terminal.toUpperCase().includes('ROBLE')) {
                            terminal = 'EL ROBLE';
                        } else if (terminal.toUpperCase().includes('REINA')) {
                            terminal = 'LA REINA';
                        } else if (terminal.toUpperCase().includes('ANGEL')) {
                            terminal = 'MARIA ANGELICA';
                        } else if (terminal.toUpperCase().includes('DESCANSO')) {
                            terminal = 'EL DESCANSO';
                        }
                        
                        combinedData.buses[plate].terminal = terminal;
                    }

                    const time = row[fuelData.keys.time];
                    if (time && (!lastLoadTime || (time instanceof Date && time > lastLoadTime))) {
                        lastLoadTime = time;
                    }
                }
            });

            combinedData.buses[plate].totalLiters = totalLiters;
            combinedData.buses[plate].loadCount = loadCount;
            combinedData.buses[plate].lastLoadTime = lastLoadTime;
        });
    }

    // Procesar datos de operatividad por terminal
    Object.entries(operativityData.terminals).forEach(([terminalName, buses]) => {
        buses.forEach(bus => {
            const plate = bus.plate;

            if (!combinedData.buses[plate]) {
                combinedData.buses[plate] = {
                    plate: plate,
                    loaded: false,
                    totalLiters: 0,
                    loadCount: 0,
                    status: 'unknown',
                    terminal: '',
                    location: '',
                    detail: '',
                    service: ''
                };

                if (!masterFleet.includes(plate)) {
                    masterFleet.push(plate);
                }
            }

            combinedData.buses[plate].status = bus.status;
            combinedData.buses[plate].terminal = terminalName;
            combinedData.buses[plate].location = bus.location;
            combinedData.buses[plate].detail = bus.detail;
            combinedData.buses[plate].service = bus.service;
            combinedData.buses[plate].observations = bus.observations;

            if (bus.location) {
                if (!combinedData.locations[bus.location]) {
                    combinedData.locations[bus.location] = {
                        count: 0,
                        terminal: terminalName,
                        buses: []
                    };
                }
                combinedData.locations[bus.location].count++;
                combinedData.locations[bus.location].buses.push(plate);
            }

            combinedData.terminals[terminalName].buses.push(plate);
            if (bus.status === 'operational') {
                combinedData.terminals[terminalName].operationalCount++;
                combinedData.status.operational++;
            } else if (bus.status === 'maintenance') {
                combinedData.terminals[terminalName].maintenanceCount++;
                combinedData.status.maintenance++;
            } else if (bus.status === 'panne') {
                combinedData.terminals[terminalName].panneCount++;
                combinedData.status.panne++;
            } else {
                combinedData.status.unknown++;
            }

            if (combinedData.buses[plate].loaded) {
                combinedData.terminals[terminalName].loadedCount++;
                combinedData.terminals[terminalName].totalLiters += combinedData.buses[plate].totalLiters;
            }
        });
    });

    // Si hay datos de combustible pero no de operatividad para algún bus, asumimos operativo
    if (fuelData) {
        Object.values(combinedData.buses).forEach(bus => {
            if (bus.status === 'unknown' && bus.loaded) {
                bus.status = 'operational';
                combinedData.status.unknown--;
                combinedData.status.operational++;

                // Si no tiene terminal asignada pero tiene combustible, buscar en datos de combustible
                if (!bus.terminal && fuelData.summary.terminals) {
                    Object.entries(fuelData.summary.terminals).forEach(([terminal, data]) => {
                        if (data.loadedBuses.includes(bus.plate)) {
                            bus.terminal = terminal;
                            
                            // Incrementar contador operacional para la terminal
                            if (combinedData.terminals[terminal]) {
                                if (!combinedData.terminals[terminal].buses.includes(bus.plate)) {
                                    combinedData.terminals[terminal].buses.push(bus.plate);
                                }
                                combinedData.terminals[terminal].operationalCount++;
                                
                                // Solo actualizar contadores de combustible si no se han actualizado antes
                                if (!combinedData.terminals[terminal].loadedCount) {
                                    combinedData.terminals[terminal].loadedCount++;
                                    combinedData.terminals[terminal].totalLiters += bus.totalLiters;
                                }
                            }
                        }
                    });
                }
            }
        });
    }

    // Calcular promedios por terminal
    Object.keys(combinedData.terminals).forEach(terminal => {
        const busCount = combinedData.terminals[terminal].loadedCount;
        combinedData.terminals[terminal].avgLitersPerBus =
            busCount > 0 ? combinedData.terminals[terminal].totalLiters / busCount : 0;
    });

    // Generar listas filtradas
    combinedData.pendingBuses = Object.values(combinedData.buses)
        .filter(bus => !bus.loaded && bus.status === 'operational')
        .map(bus => ({
            plate: bus.plate,
            terminal: bus.terminal,
            location: bus.location,
            status: 'Pendiente',
            service: bus.service
        }));

    combinedData.maintenanceBuses = Object.values(combinedData.buses)
        .filter(bus => bus.status === 'maintenance' || bus.status === 'panne')
        .map(bus => ({
            plate: bus.plate,
            terminal: bus.terminal,
            type: bus.status === 'maintenance' ? 'Mantención' : 'Panne',
            detail: bus.detail || bus.observations || 'No especificado',
            location: bus.location
        }));

    // Procesar análisis de surtidores si hay datos de combustible
    if (fuelData) {
        processPumpAnalytics();
    }
}

function processPumpAnalytics() {
    const pumps = combinedData.fuel.pumps;

    Object.keys(pumps).forEach(pumpId => {
        const pump = pumps[pumpId];
        pump.avgLitersPerLoad = pump.loadCount > 0 ? pump.totalLiters / pump.loadCount : 0;
        pump.avgLitersPerBus = pump.loadedBuses.length > 0 ? pump.totalLiters / pump.loadedBuses.length : 0;
        pump.percentOfTotal = combinedData.fuel.totalLiters > 0 ? (pump.totalLiters / combinedData.fuel.totalLiters) * 100 : 0;

        const peakHourIndex = pump.hourlyLoads.indexOf(Math.max(...pump.hourlyLoads));
        pump.peakHour = peakHourIndex >= 0 ?
            `${peakHourIndex.toString().padStart(2, '0')}:00 - ${(peakHourIndex + 1).toString().padStart(2, '0')}:00` :
            'N/A';
    });
}

function renderDashboard() {
    const welcomeScreen = document.getElementById('welcome-screen');
    const dashboardContent = document.getElementById('dashboard-content');

    if (welcomeScreen) welcomeScreen.classList.add('hidden');
    if (dashboardContent) dashboardContent.classList.remove('hidden');

    updateKeyMetrics();
    updateCharts();
    renderTables();
    updateTerminalMetrics();
    renderLocations();
    renderBadLoads();
    renderPumpAnalysis();
    updateFilterChips();

    updateBadLoadsCounter();

    const statusDateEl = document.getElementById('fleet-status-date');
    if (statusDateEl) statusDateEl.textContent = `Actualizado: ${formatDate(new Date())}`;
}

function updateKeyMetrics() {
    const totalBuses = masterFleet.length;
    const loadedBuses = combinedData.fuel.loadedBuses.length;
    const pendingBuses = combinedData.pendingBuses.length;
    const badLoadsCount = combinedData.fuel.badLoads.length;

    const loadedPercent = totalBuses > 0 ? Math.round((loadedBuses / totalBuses) * 100) : 0;
    const pendingPercent = totalBuses > 0 ? Math.round((pendingBuses / totalBuses) * 100) : 0;

    let totalBadLoadsLiters = 0;
    combinedData.fuel.badLoads.forEach(load => {
        totalBadLoadsLiters += load.liters;
    });

    // Actualizar métricas clave en el panel general
    safeUpdateElementText('total-liters', Math.round(combinedData.fuel.totalLiters).toLocaleString('es-CL'));
    safeUpdateElementText('buses-loaded', loadedBuses.toLocaleString('es-CL'));
    safeUpdateElementText('buses-pending', pendingBuses.toLocaleString('es-CL'));
    safeUpdateElementText('bad-loads-count', badLoadsCount.toLocaleString('es-CL'));

    safeUpdateElementText('loaded-percent', `${loadedPercent}% de la flota`);
    safeUpdateElementText('pending-percent', `${pendingPercent}% de la flota`);
    safeUpdateElementText('bad-loads-amount', `${Math.round(totalBadLoadsLiters).toLocaleString('es-CL')} litros`);

    // Encontrar la hora pico
    const peakHourIndex = combinedData.fuel.hourlyLoads.indexOf(Math.max(...combinedData.fuel.hourlyLoads));
    if (document.getElementById('peak-hour')) {
        document.getElementById('peak-hour').textContent = peakHourIndex >= 0 ?
            `${peakHourIndex.toString().padStart(2, '0')}:00 - ${(peakHourIndex + 1).toString().padStart(2, '0')}:00` :
            'N/A';
    }

    // Actualizar contadores de estado
    safeUpdateElementText('operational-count', combinedData.status.operational.toLocaleString('es-CL'));
    safeUpdateElementText('maintenance-count', combinedData.status.maintenance.toLocaleString('es-CL'));
    safeUpdateElementText('panne-count', combinedData.status.panne.toLocaleString('es-CL'));
    safeUpdateElementText('unknown-count', combinedData.status.unknown.toLocaleString('es-CL'));
    safeUpdateElementText('fleet-total-count', `Total: ${totalBuses.toLocaleString('es-CL')} buses`);

    // Actualizar métricas de combustible
    safeUpdateElementText('fuel-total-liters', Math.round(combinedData.fuel.totalLiters).toLocaleString('es-CL'));

    const avgPerBus = loadedBuses > 0 ? Math.round(combinedData.fuel.totalLiters / loadedBuses) : 0;
    safeUpdateElementText('fuel-avg-per-bus', avgPerBus.toLocaleString('es-CL'));

    let totalLoads = 0;
    Object.values(combinedData.buses).forEach(bus => {
        totalLoads += bus.loadCount || 0;
    });
    safeUpdateElementText('fuel-total-loads', totalLoads.toLocaleString('es-CL'));

    const efficiency = totalBuses > 0 ? Math.round((loadedBuses / totalBuses) * 100) : 0;
    safeUpdateElementText('fuel-efficiency', efficiency);
    
    const efficiencyBar = document.getElementById('fuel-efficiency-bar');
    if (efficiencyBar) efficiencyBar.style.width = `${efficiency}%`;
    
    safeUpdateElementText('fuel-loaded-count', `${loadedBuses} buses cargados`);
    safeUpdateElementText('fuel-total-buses', `de ${totalBuses} buses`);

    // Actualizar métricas de operatividad
    safeUpdateElementText('op-total-fleet', totalBuses);
    safeUpdateElementText('op-total-operational', combinedData.status.operational);
    safeUpdateElementText('op-total-maintenance', combinedData.status.maintenance);
    safeUpdateElementText('op-total-panne', combinedData.status.panne);

    const operationalPercent = totalBuses > 0 ? Math.round((combinedData.status.operational / totalBuses) * 100) : 0;
    const maintenancePercent = totalBuses > 0 ? Math.round((combinedData.status.maintenance / totalBuses) * 100) : 0;
    const panneStatusPercent = totalBuses > 0 ? Math.round((combinedData.status.panne / totalBuses) * 100) : 0;

    const opOperationalBar = document.getElementById('op-operational-bar');
    const opMaintenanceBar = document.getElementById('op-maintenance-bar');
    const opPanneBar = document.getElementById('op-panne-bar');
    
    if (opOperationalBar) opOperationalBar.style.width = `${operationalPercent}%`;
    if (opMaintenanceBar) opMaintenanceBar.style.width = `${maintenancePercent}%`;
    if (opPanneBar) opPanneBar.style.width = `${panneStatusPercent}%`;

    safeUpdateElementText('op-operational-percent', `${operationalPercent}% de la flota`);
    safeUpdateElementText('op-maintenance-percent', `${maintenancePercent}% de la flota`);
    safeUpdateElementText('op-panne-percent', `${panneStatusPercent}% de la flota`);

    updateFleetStatusBar(operationalPercent, maintenancePercent, panneStatusPercent);

    // Actualizar métricas de cargas manuales
    const badLoadsTotalLiters = Math.round(totalBadLoadsLiters);
    const badLoadsImpact = combinedData.fuel.totalLiters > 0 ?
        Math.round((totalBadLoadsLiters / combinedData.fuel.totalLiters) * 100) : 0;

    const badLoadsUniqueBuses = new Set();
    combinedData.fuel.badLoads.forEach(load => {
        badLoadsUniqueBuses.add(load.plate);
    });

    const badLoadsAvg = badLoadsCount > 0 ? Math.round(totalBadLoadsLiters / badLoadsCount) : 0;

    safeUpdateElementText('bad-loads-summary-count', `${badLoadsCount} cargas`);
    safeUpdateElementText('bad-loads-summary-liters', `${badLoadsTotalLiters.toLocaleString('es-CL')} litros`);

    safeUpdateElementText('bad-loads-detail-count', `${badLoadsCount} cargas`);
    safeUpdateElementText('bad-loads-detail-liters', `${badLoadsTotalLiters.toLocaleString('es-CL')} litros`);
    safeUpdateElementText('bad-loads-impact', `${badLoadsImpact}%`);
    safeUpdateElementText('bad-loads-buses', `${badLoadsUniqueBuses.size} buses`);
    safeUpdateElementText('bad-loads-avg', `${badLoadsAvg} litros`);

    const terminalBreakdown = [];
    Object.keys(combinedData.fuel.badLoadsByTerminal).forEach(terminal => {
        terminalBreakdown.push(`${terminal}: ${combinedData.fuel.badLoadsByTerminal[terminal].count} cargas`);
    });

    safeUpdateElementText('bad-loads-breakdown', terminalBreakdown.join(' | '));

    // Actualizar métricas de surtidores
    const pumpsCount = Object.keys(combinedData.fuel.pumps).length;
    const pumpsTotalLiters = combinedData.fuel.totalLiters;
    const pumpsTotalLoads = totalLoads;
    const pumpsAvgPerLoad = pumpsTotalLoads > 0 ? Math.round(pumpsTotalLiters / pumpsTotalLoads) : 0;

    safeUpdateElementText('pumps-total-count', pumpsCount);
    safeUpdateElementText('pumps-total-liters', Math.round(pumpsTotalLiters).toLocaleString('es-CL'));
    safeUpdateElementText('pumps-total-loads', pumpsTotalLoads.toLocaleString('es-CL'));
    safeUpdateElementText('pumps-avg-per-load', pumpsAvgPerLoad.toLocaleString('es-CL'));
}

function safeUpdateElementText(id, text) {
    const element = document.getElementById(id);
    if (element) {
        element.textContent = text;
    }
}

function updateFleetStatusBar(operationalPercent, maintenancePercent, panneStatusPercent) {
    const unknownPercent = 100 - operationalPercent - maintenancePercent - panneStatusPercent;

    const operationalBar = document.querySelector('#fleet-status-bar .segment-operational');
    const maintenanceBar = document.querySelector('#fleet-status-bar .segment-maintenance');
    const panneBar = document.querySelector('#fleet-status-bar .segment-panne');
    const unknownBar = document.querySelector('#fleet-status-bar .segment-unknown');

    if (operationalBar) operationalBar.style.width = `${operationalPercent}%`;
    if (maintenanceBar) maintenanceBar.style.width = `${maintenancePercent}%`;
    if (panneBar) panneBar.style.width = `${panneStatusPercent}%`;
    if (unknownBar) unknownBar.style.width = `${unknownPercent}%`;
}

function updateCharts() {
    if (!charts.fleetStatus) return; // Si no hay gráficos inicializados, salimos
    
    Chart.defaults.color = isDarkMode ? '#94a3b8' : '#64748b';
    Chart.defaults.borderColor = isDarkMode ? 'rgba(71, 85, 105, 0.2)' : 'rgba(203, 213, 225, 0.3)';

    const operational = combinedData.status.operational;
    const maintenance = combinedData.status.maintenance;
    const panne = combinedData.status.panne;
    const unknown = combinedData.status.unknown;

    // Actualizar gráfico de estado de flota
    charts.fleetStatus.data.datasets[0].data = [operational, maintenance, panne, unknown];
    charts.fleetStatus.update();

    // Preparar datos para gráfico de distribución por terminal
    const terminalLabels = ['EL ROBLE', 'LA REINA', 'MARIA ANGELICA', 'EL DESCANSO'];
    const terminalCounts = terminalLabels.map(terminal => 
        combinedData.terminals[terminal]?.buses.length || 0
    );

    charts.terminalDistribution.data.datasets[0].data = terminalCounts;
    charts.terminalDistribution.update();

    // Actualizar gráfico de cargas por hora
    charts.hourly.data.datasets[0].data = combinedData.fuel.hourlyLoads;
    charts.hourly.update();

    // Actualizar gráfico de consumo por terminal
    const terminalLiters = terminalLabels.map(terminal => 
        combinedData.terminals[terminal]?.totalLiters || 0
    );

    charts.terminalConsumption.data.datasets[0].data = terminalLiters;
    charts.terminalConsumption.update();

    // Actualizar gráfico de consumo por hora
    charts.hourlyConsumption.data.datasets[0].data = combinedData.fuel.hourlyLiters;
    charts.hourlyConsumption.update();

    // Actualizar gráfico de estado por terminal
    const operationalByTerminal = terminalLabels.map(terminal => 
        combinedData.terminals[terminal]?.operationalCount || 0
    );
    
    const maintenanceByTerminal = terminalLabels.map(terminal => 
        combinedData.terminals[terminal]?.maintenanceCount || 0
    );
    
    const panneByTerminal = terminalLabels.map(terminal => 
        combinedData.terminals[terminal]?.panneCount || 0
    );

    charts.terminalStatus.data.datasets[0].data = operationalByTerminal;
    charts.terminalStatus.data.datasets[1].data = maintenanceByTerminal;
    charts.terminalStatus.data.datasets[2].data = panneByTerminal;
    charts.terminalStatus.update();

    // Actualizar otros gráficos específicos
    updateTopConsumersChart();
    updateBadLoadsCharts();
    updatePumpsCharts();
}

function updateTopConsumersChart() {
    if (!charts.topConsumers) return;
    
    const topConsumers = Object.values(combinedData.buses)
        .filter(bus => bus.totalLiters > 0)
        .sort((a, b) => b.totalLiters - a.totalLiters)
        .slice(0, 10);

    const labels = topConsumers.map(bus => bus.plate);
    const data = topConsumers.map(bus => Math.round(bus.totalLiters));

    charts.topConsumers.data.labels = labels;
    charts.topConsumers.data.datasets[0].data = data;
    
    // Actualizar colores según terminal
    const colors = topConsumers.map(bus => {
        switch(bus.terminal) {
            case 'EL ROBLE': return 'rgba(59, 130, 246, 0.7)';
            case 'LA REINA': return 'rgba(245, 158, 11, 0.7)';
            case 'MARIA ANGELICA': return 'rgba(16, 185, 129, 0.7)';
            case 'EL DESCANSO': return 'rgba(139, 92, 246, 0.7)';
            default: return 'rgba(148, 163, 184, 0.7)';
        }
    });
    
    const borderColors = topConsumers.map(bus => {
        switch(bus.terminal) {
            case 'EL ROBLE': return 'rgba(59, 130, 246, 1)';
            case 'LA REINA': return 'rgba(245, 158, 11, 1)';
            case 'MARIA ANGELICA': return 'rgba(16, 185, 129, 1)';
            case 'EL DESCANSO': return 'rgba(139, 92, 246, 1)';
            default: return 'rgba(148, 163, 184, 1)';
        }
    });
    
    charts.topConsumers.data.datasets[0].backgroundColor = colors;
    charts.topConsumers.data.datasets[0].borderColor = borderColors;
    charts.topConsumers.update();
}

function updateBadLoadsCharts() {
    if (!charts.badLoadsByTerminal || !charts.badLoadsByDay) return;
    
    // Si no hay cargas manuales, mostramos datos vacíos
    if (combinedData.fuel.badLoads.length === 0) {
        charts.badLoadsByTerminal.data.labels = ['Sin datos'];
        charts.badLoadsByTerminal.data.datasets[0].data = [100];
        charts.badLoadsByTerminal.data.datasets[0].backgroundColor = ['rgba(148, 163, 184, 0.7)'];
        charts.badLoadsByTerminal.update();
        
        charts.badLoadsByDay.data.datasets[0].data = [0, 0, 0, 0, 0, 0, 0];
        charts.badLoadsByDay.update();
        return;
    }

    // Preparar datos para gráfico de cargas manuales por terminal
    const terminalLabels = Object.keys(combinedData.fuel.badLoadsByTerminal);
    const terminalData = terminalLabels.map(terminal =>
        combinedData.fuel.badLoadsByTerminal[terminal].liters);

    charts.badLoadsByTerminal.data.labels = terminalLabels;
    charts.badLoadsByTerminal.data.datasets[0].data = terminalData;
    
    // Colores personalizados según terminal
    const colors = terminalLabels.map(terminal => {
        switch(terminal) {
            case 'EL ROBLE': return 'rgba(59, 130, 246, 0.7)';
            case 'LA REINA': return 'rgba(245, 158, 11, 0.7)';
            case 'MARIA ANGELICA': return 'rgba(16, 185, 129, 0.7)';
            case 'EL DESCANSO': return 'rgba(139, 92, 246, 0.7)';
            default: return 'rgba(148, 163, 184, 0.7)';
        }
    });
    
    charts.badLoadsByTerminal.data.datasets[0].backgroundColor = colors;
    charts.badLoadsByTerminal.update();

    // Actualizar gráfico de cargas manuales por día
    charts.badLoadsByDay.data.datasets[0].data = combinedData.fuel.badLoadsByDay;
    charts.badLoadsByDay.update();
}

function updatePumpsCharts() {
    if (!charts.pumpsDistribution || !charts.pumpsHourly) return;
    
    const pumpsData = combinedData.fuel.pumps;
    const pumpIds = Object.keys(pumpsData);

    if (pumpIds.length === 0) {
        charts.pumpsDistribution.data.labels = ['Sin datos'];
        charts.pumpsDistribution.data.datasets[0].data = [100];
        charts.pumpsDistribution.data.datasets[0].backgroundColor = ['rgba(148, 163, 184, 0.7)'];
        charts.pumpsDistribution.update();
        
        charts.pumpsHourly.data.datasets[0].data = Array(24).fill(0);
        charts.pumpsHourly.update();
        return;
    }

    const labels = pumpIds;
    const data = pumpIds.map(id => Math.round(pumpsData[id].totalLiters));

    // Colores según terminal
    const colors = pumpIds.map(id => {
        const terminal = pumpsData[id].terminal;
        switch(terminal) {
            case 'EL ROBLE': return 'rgba(59, 130, 246, 0.7)';
            case 'LA REINA': return 'rgba(245, 158, 11, 0.7)';
            case 'MARIA ANGELICA': return 'rgba(16, 185, 129, 0.7)';
            case 'EL DESCANSO': return 'rgba(139, 92, 246, 0.7)';
            default: return 'rgba(148, 163, 184, 0.7)';
        }
    });

    charts.pumpsDistribution.data.labels = labels;
    charts.pumpsDistribution.data.datasets[0].data = data;
    charts.pumpsDistribution.data.datasets[0].backgroundColor = colors;
    charts.pumpsDistribution.update();

    const hourlyData = Array(24).fill(0);
    pumpIds.forEach(id => {
        const pump = pumpsData[id];
        for (let i = 0; i < 24; i++) {
            hourlyData[i] += pump.hourlyLoads[i];
        }
    });

    charts.pumpsHourly.data.datasets[0].data = hourlyData;
    charts.pumpsHourly.update();
}

function updateTerminalMetrics() {
    const terminals = ['EL ROBLE', 'LA REINA', 'MARIA ANGELICA', 'EL DESCANSO'];
    
    terminals.forEach(terminal => {
        // Normalizamos el nombre para los IDs (sin espacios, minúsculas)
        const terminalId = terminal.toLowerCase().replace(/ /g, '-');
        
        safeUpdateElementText(`${terminalId}-operational`, combinedData.terminals[terminal]?.operationalCount || 0);
        safeUpdateElementText(`${terminalId}-maintenance`, combinedData.terminals[terminal]?.maintenanceCount || 0);
        safeUpdateElementText(`${terminalId}-panne`, combinedData.terminals[terminal]?.panneCount || 0);
    });
}

function renderTables() {
    renderPendingBusesTable();
    renderConsumptionTable();
    renderStatusTable();
    renderBadLoadsTable();
    renderPumpsTable();
}

function renderPendingBusesTable() {
    const table = document.getElementById('pending-buses-table');
    if (!table) return;

    if (combinedData.pendingBuses.length === 0) {
        table.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4 text-slate-500 dark:text-slate-400">
                    No hay buses pendientes por cargar
                </td>
            </tr>
        `;
        return;
    }

    table.innerHTML = '';

    combinedData.pendingBuses.forEach(bus => {
        table.innerHTML += `
            <tr>
                <td>
                    <div class="font-medium">${bus.plate}</div>
                </td>
                <td>
                    <div class="inline-flex items-center">
                        ${getTerminalBadge(bus.terminal)}
                        <span class="ml-1.5">${bus.terminal || 'No asignado'}</span>
                    </div>
                </td>
                <td>${bus.location || 'No especificado'}</td>
                <td>
                    <span class="status-pill status-operational">Operativo</span>
                </td>
                <td>${bus.service || 'No especificado'}</td>
                <td>
                    <button class="btn btn-outline text-xs py-1 px-2" onclick="showBusDetail('${bus.plate}')">
                        <iconify-icon icon="heroicons:eye"></iconify-icon>
                        <span>Ver</span>
                    </button>
                </td>
            </tr>
        `;
    });
}

function renderConsumptionTable() {
    const table = document.getElementById('consumption-table');
    if (!table) return;

    if (!combinedData.fuel.loadedBuses || combinedData.fuel.loadedBuses.length === 0) {
        table.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4 text-slate-500 dark:text-slate-400">
                    No hay datos de consumo disponibles
                </td>
            </tr>
        `;
        return;
    }

    table.innerHTML = '';

    const loadedBuses = combinedData.fuel.loadedBuses.slice().sort();

    loadedBuses.forEach(plate => {
        const bus = combinedData.buses[plate];
        if (!bus) return;

        const avgLiters = bus.loadCount > 0 ? Math.round(bus.totalLiters / bus.loadCount) : 0;
        const lastLoad = bus.lastLoadTime ? formatDate(bus.lastLoadTime) : 'N/A';

        table.innerHTML += `
            <tr>
                <td>
                    <div class="font-medium">${bus.plate}</div>
                </td>
                <td>
                    <div class="inline-flex items-center">
                        ${getTerminalBadge(bus.terminal)}
                        <span class="ml-1.5">${bus.terminal || 'No asignado'}</span>
                    </div>
                </td>
                <td class="text-center">${bus.loadCount}</td>
                <td class="text-right">${Math.round(bus.totalLiters).toLocaleString('es-CL')}</td>
                <td class="text-right">${avgLiters.toLocaleString('es-CL')}</td>
                <td>${lastLoad}</td>
                <td>
                    <button class="btn btn-outline text-xs py-1 px-2" onclick="showBusDetail('${bus.plate}')">
                        <iconify-icon icon="heroicons:eye"></iconify-icon>
                        <span>Ver</span>
                    </button>
                </td>
            </tr>
        `;
    });
}

function renderStatusTable() {
    const table = document.getElementById('status-table');
    if (!table) return;

    if (!masterFleet.length) {
        table.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4 text-slate-500 dark:text-slate-400">
                    No hay datos de estado disponibles
                </td>
            </tr>
        `;
        return;
    }

    table.innerHTML = '';

    const sortedFleet = masterFleet.slice().sort();

    sortedFleet.forEach(plate => {
        const bus = combinedData.buses[plate];
        if (!bus) return;

        let statusPill = '';
        if (bus.status === 'operational') {
            statusPill = '<span class="status-pill status-operational">Operativo</span>';
        } else if (bus.status === 'maintenance') {
            statusPill = '<span class="status-pill status-maintenance">Mantención</span>';
        } else if (bus.status === 'panne') {
            statusPill = '<span class="status-pill status-panne">Panne</span>';
        } else {
            statusPill = '<span class="status-pill status-inactive">Sin datos</span>';
        }

        // Destacar mejor si está pendiente por cargar
        let fuelStatus = '';
        if (!bus.loaded && bus.status === 'operational') {
            fuelStatus = `
                <div class="flex items-center">
                    <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full animate-pulse">PENDIENTE</span>
                </div>`;
        } else if (bus.loaded) {
            fuelStatus = `<span class="text-emerald-600 dark:text-emerald-400 font-medium">Cargado</span> (${Math.round(bus.totalLiters).toLocaleString('es-CL')} Lts)`;
        } else {
            fuelStatus = '<span class="text-slate-500 dark:text-slate-400">No aplica</span>';
        }

        table.innerHTML += `
            <tr>
                <td>
                    <div class="font-medium">${bus.plate}</div>
                </td>
                <td>
                    <div class="inline-flex items-center">
                        ${getTerminalBadge(bus.terminal)}
                        <span class="ml-1.5">${bus.terminal || 'No asignado'}</span>
                    </div>
                </td>
                <td>${statusPill}</td>
                <td>${bus.location || 'No especificado'}</td>
                <td>${bus.detail || bus.observations || 'No especificado'}</td>
                <td>${fuelStatus}</td>
                <td>
                    <button class="btn btn-outline text-xs py-1 px-2" onclick="showBusDetail('${bus.plate}')">
                        <iconify-icon icon="heroicons:eye"></iconify-icon>
                        <span>Ver</span>
                    </button>
                </td>
            </tr>
        `;
    });
}

function renderBadLoadsTable() {
    const table = document.getElementById('bad-loads-table');
    if (!table) return;
    
    const badLoads = combinedData.fuel.badLoads;

    if (badLoads.length === 0) {
        table.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4 text-slate-500 dark:text-slate-400">
                    No hay cargas manuales registradas
                </td>
            </tr>
        `;
        return;
    }

    table.innerHTML = '';

    badLoads.forEach(load => {
        const formattedDate = load.date ? formatDate(load.date) : 'N/A';

        table.innerHTML += `
            <tr>
                <td>
                    <div class="font-medium">${load.plate}</div>
                </td>
                <td>
                    <div class="inline-flex items-center">
                        ${getTerminalBadge(load.terminal)}
                        <span class="ml-1.5">${load.terminal || 'No especificado'}</span>
                    </div>
                </td>
                <td class="text-right font-medium text-red-600 dark:text-red-400">
                    ${Math.round(load.liters).toLocaleString('es-CL')}
                </td>
                <td>${formattedDate}</td>
                <td>${load.driver || 'No especificado'}</td>
                <td>
                    <span class="status-pill status-panne">${load.type === 'carga masiva' ? 'Carga masiva' : 'Manual'}</span>
                </td>
                <td>
                    <button class="btn btn-outline text-xs py-1 px-2" onclick="showBusDetail('${load.plate}')">
                        <iconify-icon icon="heroicons:eye"></iconify-icon>
                        <span>Ver Bus</span>
                    </button>
                </td>
            </tr>
        `;
    });
}

function renderPumpsTable() {
    const table = document.getElementById('pumps-table');
    if (!table) return;
    
    const pumps = combinedData.fuel.pumps;
    const pumpIds = Object.keys(pumps);

    if (pumpIds.length === 0) {
        table.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4 text-slate-500 dark:text-slate-400">
                    No hay datos de surtidores disponibles
                </td>
            </tr>
        `;
        return;
    }

    table.innerHTML = '';

    pumpIds.sort().forEach(pumpId => {
        const pump = pumps[pumpId];

        table.innerHTML += `
            <tr>
                <td>
                    <div class="font-medium">${pumpId}</div>
                </td>
                <td>
                    <div class="inline-flex items-center">
                        ${getTerminalBadge(pump.terminal)}
                        <span class="ml-1.5">${pump.terminal || 'No especificado'}</span>
                    </div>
                </td>
                <td class="text-right">${Math.round(pump.totalLiters).toLocaleString('es-CL')}</td>
                <td class="text-center">${pump.loadCount}</td>
                <td class="text-center">${pump.loadedBuses.length}</td>
                <td class="text-right">${Math.round(pump.avgLitersPerLoad).toLocaleString('es-CL')}</td>
                <td class="text-right">${pump.percentOfTotal.toFixed(1)}%</td>
            </tr>
        `;
    });
}

function renderLocations() {
    const locationsContainer = document.getElementById('locations-container');
    if (!locationsContainer) return;

    locationsContainer.innerHTML = '';

    if (Object.keys(combinedData.locations).length === 0) {
        locationsContainer.innerHTML = `
            <div class="text-center py-4 text-slate-500 dark:text-slate-400">
                No hay datos de ubicación disponibles
            </div>
        `;
        return;
    }

    const sortedLocations = Object.entries(combinedData.locations)
        .sort((a, b) => b[1].count - a[1].count);

    sortedLocations.forEach(([location, data]) => {
        locationsContainer.innerHTML += `
            <div class="flex justify-between items-center p-2 bg-slate-50 dark:bg-slate-900 rounded-lg">
                <div>
                    <div class="font-medium text-xs text-slate-800 dark:text-slate-200">${location}</div>
                    <div class="text-xs text-slate-500 dark:text-slate-400">${data.terminal}</div>
                </div>
                <div class="text-xs font-semibold">${data.count} buses</div>
            </div>
        `;
    });
}

function renderBadLoads() {
    const badLoadsPreview = document.getElementById('bad-loads-preview');
    if (!badLoadsPreview) return;
    
    const badLoads = combinedData.fuel.badLoads;

    if (badLoads.length === 0) {
        badLoadsPreview.innerHTML = `
            <div class="text-center py-4 text-slate-500 dark:text-slate-400">
                No hay cargas manuales registradas
            </div>
        `;
        return;
    }

    badLoadsPreview.innerHTML = '';

    const previewLimit = Math.min(3, badLoads.length);

    for (let i = 0; i < previewLimit; i++) {
        const load = badLoads[i];
        const formattedDate = load.date ? formatDate(load.date) : 'N/A';

        badLoadsPreview.innerHTML += `
            <div class="bad-load-item">
                <div class="bad-load-header">
                    <div class="bad-load-plate">${load.plate}</div>
                    <div class="bad-load-amount">${Math.round(load.liters).toLocaleString('es-CL')} Lts</div>
                </div>
                <div class="bad-load-details">
                    <div class="bad-load-detail-item">
                        <div class="bad-load-detail-label">Terminal</div>
                        <div class="bad-load-detail-value">${load.terminal || 'No especificado'}</div>
                    </div>
                    <div class="bad-load-detail-item">
                        <div class="bad-load-detail-label">Conductor</div>
                        <div class="bad-load-detail-value">${load.driver || 'No especificado'}</div>
                    </div>
                    <div class="bad-load-detail-item">
                        <div class="bad-load-detail-label">Fecha</div>
                        <div class="bad-load-detail-value">${formattedDate}</div>
                    </div>
                    <div class="bad-load-detail-item">
                        <div class="bad-load-detail-label">Tipo</div>
                        <div class="bad-load-detail-value">${load.type === 'carga masiva' ? 'Carga masiva' : 'Manual'}</div>
                    </div>
                </div>
            </div>
        `;
    }

    if (badLoads.length > previewLimit) {
        badLoadsPreview.innerHTML += `
            <div class="text-center mt-2">
                <button id="view-more-bad-loads" class="text-xs text-primary-600 dark:text-primary-400 hover:underline" onclick="activateTab('bad-loads')">
                    Ver ${badLoads.length - previewLimit} cargas más
                </button>
            </div>
        `;
    }
}

function renderPumpAnalysis() {
    const pumpAnalysisContainer = document.getElementById('pump-analysis-container');
    if (!pumpAnalysisContainer) return;
    
    const pumps = combinedData.fuel.pumps;
    const pumpIds = Object.keys(pumps);

    if (pumpIds.length === 0) {
        pumpAnalysisContainer.innerHTML = `
            <div class="text-center py-4 text-slate-500 dark:text-slate-400">
                No hay datos de surtidores disponibles
            </div>
        `;
        return;
    }

    pumpAnalysisContainer.innerHTML = '';

    const sortedPumpIds = pumpIds.sort((a, b) => pumps[b].totalLiters - pumps[a].totalLiters);

    sortedPumpIds.forEach(pumpId => {
        const pump = pumps[pumpId];
        const percentOfTotal = pump.percentOfTotal.toFixed(1);
        
        // Determinar color según terminal
        let terminalColor = '';
        switch (pump.terminal) {
            case 'EL ROBLE':
                terminalColor = 'from-blue-500 to-blue-700';
                break;
            case 'LA REINA':
                terminalColor = 'from-amber-500 to-amber-700';
                break;
            case 'MARIA ANGELICA':
                terminalColor = 'from-emerald-500 to-emerald-700';
                break;
            case 'EL DESCANSO':
                terminalColor = 'from-purple-500 to-purple-700';
                break;
            default:
                terminalColor = 'from-slate-500 to-slate-700';
                break;
        }

        pumpAnalysisContainer.innerHTML += `
            <div class="pump-analysis-card">
                <div class="pump-analysis-header bg-gradient-to-r ${terminalColor} text-white">
                    <div class="pump-analysis-title">Surtidor ${pumpId}</div>
                    <span class="text-xs text-white/80">${pump.terminal}</span>
                </div>
                <div class="pump-analysis-body">
                    <div class="pump-stat">
                        <div class="pump-stat-name">Total Litros</div>
                        <div class="pump-stat-value">${Math.round(pump.totalLiters).toLocaleString('es-CL')}</div>
                    </div>
                    <div class="pump-stat">
                        <div class="pump-stat-name">Total Cargas</div>
                        <div class="pump-stat-value">${pump.loadCount}</div>
                    </div>
                    <div class="pump-stat">
                        <div class="pump-stat-name">Buses Atendidos</div>
                        <div class="pump-stat-value">${pump.loadedBuses.length}</div>
                    </div>
                    <div class="pump-stat">
                        <div class="pump-stat-name">Prom. por Carga</div>
                        <div class="pump-stat-value">${Math.round(pump.avgLitersPerLoad)}</div>
                    </div>
                    <div class="pump-stat">
                        <div class="pump-stat-name">Hora Pico</div>
                        <div class="pump-stat-value">${pump.peakHour}</div>
                    </div>
                    <div class="pump-stat">
                        <div class="pump-stat-name">% del Total</div>
                        <div class="pump-stat-value">${percentOfTotal}%</div>
                    </div>
                    <div class="pump-progress">
                        <div class="pump-progress-bar bg-gradient-to-r ${terminalColor}" style="width: ${percentOfTotal}%"></div>
                    </div>
                </div>
            </div>
        `;
    });
}

function updateBadLoadsCounter() {
    const badLoadsCount = combinedData.fuel.badLoads.length;
    const badLoadsCounter = document.getElementById('bad-loads-counter');

    if (badLoadsCounter) {
        if (badLoadsCount > 0) {
            badLoadsCounter.textContent = badLoadsCount;
            badLoadsCounter.style.display = 'flex';
        } else {
            badLoadsCounter.style.display = 'none';
        }
    }
}

function updateFilterChips() {
    const filterChips = document.querySelectorAll('.filter-chip');
    if (!filterChips.length) return;
    
    filterChips.forEach(chip => {
        if (chip.getAttribute('data-filter') === 'all') {
            chip.classList.add('active');
        } else {
            chip.classList.remove('active');
        }
    });
}

function handleGlobalSearch() {
    const searchInput = document.getElementById('global-search');
    const searchResults = document.getElementById('search-results');
    const clearSearch = document.getElementById('clear-search');

    if (!searchInput || !searchResults || !clearSearch) return;

    const query = searchInput.value.trim().toUpperCase();

    if (query.length < 2) {
        searchResults.classList.remove('show');
        clearSearch.classList.remove('show');
        return;
    }

    clearSearch.classList.add('show');

    const matchingBuses = [];

    // Búsqueda exacta por patente
    if (combinedData.buses[query]) {
        matchingBuses.push(combinedData.buses[query]);
    }

    // Búsqueda parcial por patente
    Object.values(combinedData.buses).forEach(bus => {
        if (bus.plate !== query && bus.plate.includes(query)) {
            matchingBuses.push(bus);
        }
    });

    // Búsqueda por número interno exacto
    if (internalToPPU[query] && combinedData.buses[internalToPPU[query]]) {
        const bus = combinedData.buses[internalToPPU[query]];
        if (!matchingBuses.some(b => b.plate === bus.plate)) {
            matchingBuses.push(bus);
        }
    }

    // Búsqueda parcial por número interno
    Object.entries(internalToPPU).forEach(([internal, plate]) => {
        if (internal.includes(query) && combinedData.buses[plate]) {
            const bus = combinedData.buses[plate];
            if (!matchingBuses.some(b => b.plate === bus.plate)) {
                matchingBuses.push(bus);
            }
        }
    });

    const limitedMatches = matchingBuses.slice(0, 10);

    if (limitedMatches.length === 0) {
        searchResults.innerHTML = `
            <div class="p-3 text-center text-slate-500 dark:text-slate-400 text-sm">
                No se encontraron buses que coincidan con "${query}"
            </div>
        `;
    } else {
        searchResults.innerHTML = '';

        limitedMatches.forEach(bus => {
            let statusPill = '';
            let statusClass = '';
            
            if (bus.status === 'operational') {
                statusPill = '<span class="status-pill status-operational">Operativo</span>';
                statusClass = 'text-emerald-600 dark:text-emerald-400';
            } else if (bus.status === 'maintenance') {
                statusPill = '<span class="status-pill status-maintenance">Mantención</span>';
                statusClass = 'text-amber-600 dark:text-amber-400';
            } else if (bus.status === 'panne') {
                statusPill = '<span class="status-pill status-panne">Panne</span>';
                statusClass = 'text-red-600 dark:text-red-400';
            } else {
                statusPill = '<span class="status-pill status-inactive">Sin datos</span>';
                statusClass = 'text-slate-500 dark:text-slate-400';
            }

            // Indicador destacado de bus pendiente
            let pendingIndicator = '';
            if (!bus.loaded && bus.status === 'operational') {
                pendingIndicator = `<div class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full animate-ping"></div>`;
            }

            searchResults.innerHTML += `
                <div class="search-results-item relative" onclick="showBusDetail('${bus.plate}')">
                    ${pendingIndicator}
                    <div class="search-results-primary">
                        <span>${bus.plate}</span>
                        ${statusPill}
                    </div>
                    <div class="search-results-secondary">
                        ${getTerminalBadge(bus.terminal)}
                        <span>${bus.terminal || 'No asignado'}</span>
                        ${!bus.loaded && bus.status === 'operational' ? 
                            `<span class="ml-auto text-red-600 dark:text-red-400 font-bold">PENDIENTE</span>` :
                            bus.loaded ? 
                                `<span class="ml-auto text-emerald-600 dark:text-emerald-400">${Math.round(bus.totalLiters)} Lts</span>` :
                                '<span class="ml-auto text-slate-500 dark:text-slate-400">Sin cargas</span>'
                        }
                    </div>
                </div>
            `;
        });
    }

    searchResults.classList.add('show');
}

function performQuickSearch(query) {
    query = query.trim().toUpperCase();
    const quickSearchResult = document.getElementById('quick-search-result');
    if (!quickSearchResult) return;

    if (query.length === 0) {
        quickSearchResult.innerHTML = '';
        return;
    }

    let bus = null;

    // Búsqueda exacta por patente
    if (combinedData.buses[query]) {
        bus = combinedData.buses[query];
    } 
    // Búsqueda por número interno
    else if (internalToPPU[query] && combinedData.buses[internalToPPU[query]]) {
        bus = combinedData.buses[internalToPPU[query]];
    }

    if (!bus) {
        quickSearchResult.innerHTML = `
            <div class="result-not-found bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-3">
                <div class="flex items-start gap-2">
                    <div class="text-amber-500 dark:text-amber-400 mt-0.5">
                        <iconify-icon icon="heroicons:exclamation-triangle"></iconify-icon>
                    </div>
                    <div>
                        <div class="font-medium text-amber-800 dark:text-amber-300">No se encontró el bus</div>
                        <p class="text-sm text-amber-700 dark:text-amber-400">
                            No se encontró ningún bus con PPU o N° Interno "${query}".
                            Verifique e intente nuevamente.
                        </p>
                    </div>
                </div>
            </div>
        `;
        return;
    }

    addToSearchHistory(query);
    document.getElementById('quick-search-input').value = '';

    let statusClass = '';
    let statusText = '';
    let statusIcon = '';

    if (bus.status === 'operational') {
        statusClass = 'bg-emerald-50 dark:bg-emerald-900/20 border-emerald-200 dark:border-emerald-800';
        statusText = 'Operativo';
        statusIcon = 'heroicons:check-circle';
    } else if (bus.status === 'maintenance') {
        statusClass = 'bg-amber-50 dark:bg-amber-900/20 border-amber-200 dark:border-amber-800';
        statusText = 'En Mantención';
        statusIcon = 'heroicons:wrench-screwdriver';
    } else if (bus.status === 'panne') {
        statusClass = 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800';
        statusText = 'En Panne';
        statusIcon = 'heroicons:exclamation-circle';
    } else {
        statusClass = 'bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700';
        statusText = 'Sin datos';
        statusIcon = 'heroicons:question-mark-circle';
    }

    // Destaque especial para buses pendientes
    let pendingAlert = '';
    if (!bus.loaded && bus.status === 'operational') {
        pendingAlert = `
            <div class="mb-3 bg-red-100 dark:bg-red-900/30 border border-red-200 dark:border-red-900/50 rounded-lg p-3 animate-pulse">
                <div class="flex items-center gap-2">
                    <div class="text-red-600 dark:text-red-400">
                        <iconify-icon icon="heroicons:exclamation-triangle" width="24"></iconify-icon>
                    </div>
                    <div>
                        <div class="font-bold text-red-700 dark:text-red-300">¡PENDIENTE POR CARGAR!</div>
                        <p class="text-sm text-red-600 dark:text-red-400">
                            Este bus está operativo pero no ha cargado combustible.
                        </p>
                    </div>
                </div>
            </div>`;
    }

    const fuelStatus = bus.loaded ?
        `<span class="text-emerald-600 dark:text-emerald-400 font-medium">Cargado</span> (${Math.round(bus.totalLiters).toLocaleString('es-CL')} Lts)` :
        '<span class="text-amber-600 dark:text-amber-400 font-medium">Pendiente</span>';

    quickSearchResult.innerHTML = `
        <div class="quick-search-result ${statusClass} border rounded-lg p-4">
            ${pendingAlert}
            <div class="result-plate">
                <span>${bus.plate}</span>
                <span class="text-sm px-2 py-1 rounded-md ${bus.status === 'operational' ? 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-800 dark:text-emerald-400' :
                    bus.status === 'maintenance' ? 'bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-400' :
                        bus.status === 'panne' ? 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-400' :
                            'bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300'}">${statusText}</span>
            </div>
            
            <div class="result-info-grid">
                <div class="result-info-item">
                    <div class="result-info-label">Terminal</div>
                    <div class="result-info-value">${bus.terminal || 'No asignado'}</div>
                </div>
                <div class="result-info-item">
                    <div class="result-info-label">Ubicación</div>
                    <div class="result-info-value">${bus.location || 'No especificado'}</div>
                </div>
                <div class="result-info-item">
                    <div class="result-info-label">Combustible</div>
                    <div class="result-info-value">${fuelStatus}</div>
                </div>
                <div class="result-info-item">
                    <div class="result-info-label">Cargas</div>
                    <div class="result-info-value">${bus.loadCount || 0}</div>
                </div>
            </div>
            
            ${bus.detail || bus.observations ? `
            <div class="result-detail">
                <strong>Detalle:</strong> ${bus.detail || bus.observations}
            </div>
            ` : ''}
            
            <div class="flex justify-end mt-4">
                <button class="btn btn-primary text-xs py-1 px-3" onclick="showBusDetail('${bus.plate}')">
                    <iconify-icon icon="heroicons:information-circle" class="mr-1"></iconify-icon>
                    <span>Ver Detalle Completo</span>
                </button>
            </div>
        </div>
    `;
}

function addToSearchHistory(query) {
    // No añadir duplicados y mantener único
    if (!searchHistory.includes(query)) {
        searchHistory.unshift(query);
        if (searchHistory.length > 5) {
            searchHistory.pop();
        }
        updateSearchHistory();
    }
}

function updateSearchHistory() {
    const container = document.getElementById('search-history-container');
    if (!container) return;
    
    container.innerHTML = '';

    searchHistory.forEach(query => {
        const item = document.createElement('div');
        item.className = 'search-history-item';
        item.textContent = query;
        item.addEventListener('click', () => {
            document.getElementById('quick-search-input').value = query;
            performQuickSearch(query);
        });
        container.appendChild(item);
    });
}

function filterDashboard(event) {
    const query = event.target.value.trim().toUpperCase();

    // Restablecer filtros activos
    document.querySelectorAll('.filter-chip').forEach(chip => chip.classList.remove('active'));
    document.querySelector('.filter-chip[data-filter="all"]')?.classList.add('active');

    // Aplicar filtro a todas las tablas visibles
    filterTable('pending-buses', query);
    filterTable('consumption', query);
    filterTable('status', query);
    filterTable('bad-loads', query);
    filterTable('pumps', query);
}

function applyDashboardFilter(filter) {
    resetAllTables();

    if (filter === 'all') {
        return;
    }

    if (filter === 'pending') {
        // Mostrar todos los buses pendientes
        const busElements = document.querySelectorAll('#pending-buses-table tr');
        busElements.forEach(row => {
            row.style.display = '';
        });

        activateTab('general');
    } else if (filter === 'operational') {
        filterTableByStatus('status', 'operational');
        activateTab('operativity');
    } else if (filter === 'maintenance') {
        filterTableByStatus('status', 'maintenance');
        activateTab('operativity');
    } else if (filter === 'panne') {
        filterTableByStatus('status', 'panne');
        activateTab('operativity');
    } else if (filter === 'bad-loads') {
        activateTab('bad-loads');
    }
}

function filterTableByStatus(tableId, statusType) {
    const rows = document.querySelectorAll(`#${tableId}-table tr`);
    if (!rows.length) return;

    rows.forEach(row => {
        const statusCell = row.querySelector('td:nth-child(3)');
        if (!statusCell) return;

        if (statusType === 'operational' && statusCell.querySelector('.status-operational')) {
            row.style.display = '';
        } else if (statusType === 'maintenance' && statusCell.querySelector('.status-maintenance')) {
            row.style.display = '';
        } else if (statusType === 'panne' && statusCell.querySelector('.status-panne')) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function resetAllTables() {
    const tables = ['pending-buses-table', 'consumption-table', 'status-table', 'bad-loads-table', 'pumps-table'];
    tables.forEach(tableId => {
        const rows = document.querySelectorAll(`#${tableId} tr`);
        rows.forEach(row => {
            row.style.display = '';
        });
    });
}

function filterTable(tableId, query) {
    const selector = `#${tableId}-table tr`;
    const elements = document.querySelectorAll(selector);
    if (!elements.length) return;

    if (query === '') {
        elements.forEach(el => {
            el.style.display = '';
        });
        return;
    }

    elements.forEach(el => {
        // Solo filtramos filas de datos, no encabezados o mensajes vacíos
        if (el.querySelector('th') || el.querySelector('td[colspan]')) {
            el.style.display = '';
            return;
        }
        
        let text = Array.from(el.querySelectorAll('td')).map(td => td.textContent).join(' ');

        if (text.toUpperCase().includes(query)) {
            el.style.display = '';
        } else {
            el.style.display = 'none';
        }
    });
}

function sortTable(tableId, sortBy) {
    const table = document.getElementById(`${tableId}-table`);
    if (!table) return;

    const rows = Array.from(table.querySelectorAll('tr:not(:first-child)'));

    if (rows.length === 0 || (rows.length === 1 && rows[0].cells.length === 1 && rows[0].cells[0].colSpan > 1)) {
        return;
    }

    rows.sort((a, b) => {
        // Ignorar filas de mensaje
        if (a.querySelector('td[colspan]') || b.querySelector('td[colspan]')) {
            return 0;
        }
        
        switch (sortBy) {
            case 'plate':
                const plateA = a.querySelector('td:first-child')?.textContent.trim() || '';
                const plateB = b.querySelector('td:first-child')?.textContent.trim() || '';
                return plateA.localeCompare(plateB);

            case 'liters-desc':
                const litersA = parseFloat(a.querySelector('td:nth-child(4)')?.textContent.replace(/\./g, '').replace(',', '.')) || 0;
                const litersB = parseFloat(b.querySelector('td:nth-child(4)')?.textContent.replace(/\./g, '').replace(',', '.')) || 0;
                return litersB - litersA;

            case 'liters-asc':
                const litersAsc = parseFloat(a.querySelector('td:nth-child(4)')?.textContent.replace(/\./g, '').replace(',', '.')) || 0;
                const litersBsc = parseFloat(b.querySelector('td:nth-child(4)')?.textContent.replace(/\./g, '').replace(',', '.')) || 0;
                return litersAsc - litersBsc;

            case 'loads':
                const loadsA = parseInt(a.querySelector('td:nth-child(3)')?.textContent) || 0;
                const loadsB = parseInt(b.querySelector('td:nth-child(3)')?.textContent) || 0;
                return loadsB - loadsA;

            case 'terminal':
                const terminalA = a.querySelector('td:nth-child(2)')?.textContent.trim() || '';
                const terminalB = b.querySelector('td:nth-child(2)')?.textContent.trim() || '';
                return terminalA.localeCompare(terminalB);

            case 'status':
                const statusA = a.querySelector('td:nth-child(3)')?.textContent.trim() || '';
                const statusB = b.querySelector('td:nth-child(3)')?.textContent.trim() || '';
                return statusA.localeCompare(statusB);

            case 'location':
                const locationA = a.querySelector('td:nth-child(4)')?.textContent.trim() || '';
                const locationB = b.querySelector('td:nth-child(4)')?.textContent.trim() || '';
                return locationA.localeCompare(locationB);

            default:
                return 0;
        }
    });

    // Reordenar filas en la tabla
    rows.forEach(row => table.appendChild(row));
}

function exportData(dataType) {
    let exportData = [];
    let filename = '';

    switch (dataType) {
        case 'pending-btn':
            exportData = combinedData.pendingBuses.map(bus => ({
                Patente: bus.plate,
                Terminal: bus.terminal || 'No asignado',
                Ubicación: bus.location || 'No especificado',
                Estado: 'Pendiente',
                Servicio: bus.service || 'No especificado'
            }));
            filename = 'Buses_Pendientes';
            break;

        case 'consumption-btn':
            exportData = combinedData.fuel.loadedBuses.map(plate => {
                const bus = combinedData.buses[plate];
                return {
                    Patente: bus.plate,
                    Terminal: bus.terminal || 'No asignado',
                    Cargas: bus.loadCount,
                    'Total Litros': Math.round(bus.totalLiters),
                    'Promedio': bus.loadCount > 0 ? Math.round(bus.totalLiters / bus.loadCount) : 0
                };
            });
            filename = 'Consumo_Combustible';
            break;

        case 'status-btn':
            exportData = Object.values(combinedData.buses).map(bus => ({
                Patente: bus.plate,
                Terminal: bus.terminal || 'No asignado',
                Estado: getStatusText(bus.status),
                Ubicación: bus.location || 'No especificado',
                Detalle: bus.detail || bus.observations || 'No especificado',
                'Litros Cargados': Math.round(bus.totalLiters)
            }));
            filename = 'Estado_Flota';
            break;

        case 'bad-loads-btn':
            exportData = combinedData.fuel.badLoads.map(load => ({
                Patente: load.plate,
                Terminal: load.terminal || 'No asignado',
                Litros: Math.round(load.liters),
                Fecha: load.date ? formatDate(load.date) : 'N/A',
                Conductor: load.driver || 'No especificado',
                Tipo: load.type === 'carga masiva' ? 'Carga masiva' : 'Manual'
            }));
            filename = 'Cargas_Manuales';
            break;

        case 'pumps-btn':
            exportData = Object.entries(combinedData.fuel.pumps).map(([pumpId, pump]) => ({
                Surtidor: pumpId,
                Terminal: pump.terminal || 'No asignado',
                'Total Litros': Math.round(pump.totalLiters),
                'Total Cargas': pump.loadCount,
                'Buses Atendidos': pump.loadedBuses.length,
                'Promedio por Carga': Math.round(pump.avgLitersPerLoad),
                'Porcentaje del Total': pump.percentOfTotal.toFixed(1) + '%'
            }));
            filename = 'Surtidores';
            break;

        default:
            showToast('Error', 'Tipo de datos no reconocido', 'error');
            return;
    }

    if (exportData.length === 0) {
        showToast('Info', 'No hay datos para exportar', 'info');
        return;
    }

    exportToExcel(exportData, filename);
}

function exportToExcel(data, filename) {
    try {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(data);

        const colWidths = [];
        if (data.length > 0) {
            Object.keys(data[0]).forEach(key => {
                colWidths.push({ wch: Math.max(key.length, 12) });
            });
            ws['!cols'] = colWidths;
        }

        XLSX.utils.book_append_sheet(wb, ws, 'Reporte');

        XLSX.writeFile(wb, `${filename}_${getFormattedDateFilename()}.xlsx`);

        showToast('Éxito', 'Archivo exportado correctamente', 'success');
    } catch (error) {
        console.error('Error exporting to Excel:', error);
        showToast('Error', 'No se pudo exportar el archivo', 'error');
    }
}

function exportCurrentView() {
    const activeTab = document.querySelector('.tab.active');
    if (!activeTab) {
        showToast('Error', 'No se pudo determinar la vista actual', 'error');
        return;
    }

    const tabId = activeTab.getAttribute('data-tab');

    switch (tabId) {
        case 'general':
            exportData('status-btn');
            break;

        case 'fuel':
            exportData('consumption-btn');
            break;

        case 'bad-loads':
            exportData('bad-loads-btn');
            break;

        case 'operativity':
            exportData('status-btn');
            break;

        case 'pumps':
            exportData('pumps-btn');
            break;

        default:
            showToast('Error', 'Tipo de vista no reconocido', 'error');
    }
}

function printCurrentView() {
    const activeTab = document.querySelector('.tab.active');
    if (!activeTab) {
        showToast('Error', 'No se pudo determinar la vista actual', 'error');
        return;
    }

    const tabId = activeTab.getAttribute('data-tab');

    let reportTitle = '';
    let reportData = [];

    switch (tabId) {
        case 'general':
            reportTitle = 'Reporte de Estado de Flota';
            reportData = Object.values(combinedData.buses).map(bus => ({
                Patente: bus.plate,
                Terminal: bus.terminal || 'No asignado',
                Estado: getStatusText(bus.status),
                Ubicación: bus.location || 'No especificado',
                Detalle: bus.detail || bus.observations || 'No especificado'
            }));
            break;

        case 'fuel':
            reportTitle = 'Reporte de Consumo de Combustible';
            reportData = combinedData.fuel.loadedBuses.map(plate => {
                const bus = combinedData.buses[plate];
                return {
                    Patente: bus.plate,
                    Terminal: bus.terminal || 'No asignado',
                    'N° Cargas': bus.loadCount || 0,
                    'Total Litros': Math.round(bus.totalLiters || 0),
                    'Promedio': bus.loadCount > 0 ? Math.round(bus.totalLiters / bus.loadCount) : 0
                };
            });
            break;

        case 'bad-loads':
            reportTitle = 'Reporte de Cargas Manuales';
            reportData = combinedData.fuel.badLoads.map(load => ({
                Patente: load.plate,
                Terminal: load.terminal || 'No asignado',
                Litros: Math.round(load.liters),
                Fecha: load.date ? formatDate(load.date) : 'N/A',
                Conductor: load.driver || 'No especificado',
                Tipo: load.type === 'carga masiva' ? 'Carga masiva' : 'Manual'
            }));
            break;

        case 'operativity':
            reportTitle = 'Reporte de Operatividad de Flota';
            reportData = Object.values(combinedData.buses).map(bus => ({
                Patente: bus.plate,
                Terminal: bus.terminal || 'No asignado',
                Estado: getStatusText(bus.status),
                Ubicación: bus.location || 'No especificado',
                Detalle: bus.detail || bus.observations || 'No especificado'
            }));
            break;

        case 'pumps':
            reportTitle = 'Reporte de Surtidores';
            reportData = Object.entries(combinedData.fuel.pumps).map(([pumpId, pump]) => ({
                Surtidor: pumpId,
                Terminal: pump.terminal || 'No asignado',
                'Total Litros': Math.round(pump.totalLiters),
                'Total Cargas': pump.loadCount,
                'Buses Atendidos': pump.loadedBuses.length,
                'Promedio por Carga': Math.round(pump.avgLitersPerLoad)
            }));
            break;

        default:
            showToast('Error', 'Tipo de vista no reconocido', 'error');
            return;
    }

    if (reportData.length > 0) {
        printReport(reportTitle, reportData);
    } else {
        showToast('Info', 'No hay datos para imprimir', 'info');
    }
}

function showBusDetail(plate) {
    const bus = combinedData.buses[plate];
    const busDetailModal = document.getElementById('bus-detail-modal');
    const busDetailContent = document.getElementById('bus-detail-content');

    if (!bus || !busDetailModal || !busDetailContent) {
        showToast('Error', `No se encontró información para el bus ${plate}`, 'error');
        return;
    }

    let statusClass = '';
    let statusIcon = '';

    if (bus.status === 'operational') {
        statusClass = 'text-emerald-600 dark:text-emerald-400';
        statusIcon = 'heroicons:check-circle';
    } else if (bus.status === 'maintenance') {
        statusClass = 'text-amber-600 dark:text-amber-400';
        statusIcon = 'heroicons:wrench-screwdriver';
    } else if (bus.status === 'panne') {
        statusClass = 'text-red-600 dark:text-red-400';
        statusIcon = 'heroicons:exclamation-circle';
    } else {
        statusClass = 'text-slate-500 dark:text-slate-400';
        statusIcon = 'heroicons:question-mark-circle';
    }

    // Alerta de pendiente
    let pendingAlert = '';
    if (!bus.loaded && bus.status === 'operational') {
        pendingAlert = `
            <div class="bg-red-100 dark:bg-red-900/30 border border-red-200 dark:border-red-900/50 rounded-lg p-3 mb-4 animate-pulse">
                <div class="flex items-center gap-2">
                    <div class="text-red-600 dark:text-red-400">
                        <iconify-icon icon="heroicons:exclamation-triangle" width="24"></iconify-icon>
                    </div>
                    <div>
                        <div class="font-bold text-red-700 dark:text-red-300">¡PENDIENTE POR CARGAR!</div>
                        <p class="text-sm text-red-600 dark:text-red-400">
                            Este bus está operativo pero no ha cargado combustible.
                        </p>
                    </div>
                </div>
            </div>`;
    }

    const fuelStatus = bus.loaded
        ? `<span class="text-emerald-600 dark:text-emerald-400 font-medium">Cargado</span> (${Math.round(bus.totalLiters).toLocaleString('es-CL')} Lts)`
        : '<span class="text-amber-600 dark:text-amber-400 font-medium">Pendiente</span>';

    // Determinar color según terminal
    let headerBgClass = '';
    switch (bus.terminal) {
        case 'EL ROBLE':
            headerBgClass = 'bg-gradient-to-r from-blue-600 to-blue-800';
            break;
        case 'LA REINA':
            headerBgClass = 'bg-gradient-to-r from-amber-600 to-amber-800';
            break;
        case 'MARIA ANGELICA':
            headerBgClass = 'bg-gradient-to-r from-emerald-600 to-emerald-800';
            break;
        case 'EL DESCANSO':
            headerBgClass = 'bg-gradient-to-r from-purple-600 to-purple-800';
            break;
        default:
            headerBgClass = 'bg-gradient-to-r from-primary-600 to-secondary-600';
            break;
    }

    busDetailContent.innerHTML = `
        <div class="bus-details-card">
            <div class="bus-details-header ${headerBgClass}">
                <div class="bus-details-plate">${plate}</div>
                <div class="bus-details-status">
                    <iconify-icon icon="${statusIcon}"></iconify-icon>
                    <span>${getStatusText(bus.status)}</span>
                </div>
            </div>
            
            <div class="bus-details-body">
                ${pendingAlert}
                
                <div class="bus-details-section">
                    <div class="bus-details-section-title">
                        <iconify-icon icon="heroicons:truck"></iconify-icon>
                        <span>Información General</span>
                    </div>
                    
                    <div class="bus-details-info-grid">
                        <div class="bus-details-info-item">
                            <div class="bus-details-info-label">Terminal</div>
                            <div class="bus-details-info-value">${bus.terminal || 'No asignado'}</div>
                        </div>
                        
                        <div class="bus-details-info-item">
                            <div class="bus-details-info-label">Ubicación</div>
                            <div class="bus-details-info-value">${bus.location || 'No especificado'}</div>
                        </div>
                        
                        <div class="bus-details-info-item">
                            <div class="bus-details-info-label">Servicio</div>
                            <div class="bus-details-info-value">${bus.service || 'No especificado'}</div>
                        </div>
                        
                        <div class="bus-details-info-item">
                            <div class="bus-details-info-label">Estado</div>
                            <div class="bus-details-info-value ${statusClass}">${getStatusText(bus.status)}</div>
                        </div>
                    </div>
                </div>
                
                <div class="bus-details-section">
                    <div class="bus-details-section-title">
                        <iconify-icon icon="heroicons:beaker"></iconify-icon>
                        <span>Información de Combustible</span>
                    </div>
                    
                    <div class="bus-details-info-grid">
                        <div class="bus-details-info-item">
                            <div class="bus-details-info-label">Estado</div>
                            <div class="bus-details-info-value">${fuelStatus}</div>
                        </div>
                        
                        <div class="bus-details-info-item">
                            <div class="bus-details-info-label">Cargas</div>
                            <div class="bus-details-info-value">${bus.loadCount || 0}</div>
                        </div>
                        
                        <div class="bus-details-info-item">
                            <div class="bus-details-info-label">Litros Totales</div>
                            <div class="bus-details-info-value">${Math.round(bus.totalLiters || 0).toLocaleString('es-CL')} Lts</div>
                        </div>
                        
                        <div class="bus-details-info-item">
                            <div class="bus-details-info-label">Promedio por Carga</div>
                            <div class="bus-details-info-value">
                                ${bus.loadCount > 0 ? Math.round(bus.totalLiters / bus.loadCount).toLocaleString('es-CL') : 0} Lts
                            </div>
                        </div>
                    </div>
                </div>
                
                ${(bus.detail || bus.observations) ? `
                <div class="bus-details-section">
                    <div class="bus-details-section-title">
                        <iconify-icon icon="heroicons:information-circle"></iconify-icon>
                        <span>Detalles Adicionales</span>
                    </div>
                    
                    <div class="p-3 bg-slate-50 dark:bg-slate-900 rounded-lg">
                        ${bus.detail ? `<p class="text-sm mb-2">${bus.detail}</p>` : ''}
                        ${bus.observations ? `<p class="text-sm">${bus.observations}</p>` : ''}
                    </div>
                </div>
                ` : ''}
                
                <div class="bus-details-section">
                    <div class="bus-details-section-title">
                        <iconify-icon icon="heroicons:clipboard-document-list"></iconify-icon>
                        <span>Acciones Recomendadas</span>
                    </div>
                    
                    <div class="p-3 bg-slate-50 dark:bg-slate-900 rounded-lg">
                        ${getRecommendedActions(bus)}
                    </div>
                </div>
            </div>
        </div>
    `;

    busDetailModal.classList.add('open');
}

function getRecommendedActions(bus) {
    if (!bus.loaded && bus.status === 'operational') {
        return `
            <div class="text-sm text-amber-600 dark:text-amber-400 font-medium mb-2 flex items-center gap-1.5">
                <iconify-icon icon="heroicons:exclamation-triangle"></iconify-icon>
                <span>Bus operativo pendiente por cargar</span>
            </div>
            <p class="text-sm text-slate-600 dark:text-slate-400">
                Este bus está marcado como operativo pero no registra cargas de combustible.
                Se recomienda priorizar su carga o verificar su ubicación actual.
            </p>
        `;
    } else if (bus.status === 'maintenance') {
        return `
            <div class="text-sm text-amber-600 dark:text-amber-400 font-medium mb-2 flex items-center gap-1.5">
                <iconify-icon icon="heroicons:wrench-screwdriver"></iconify-icon>
                <span>Bus en mantención programada</span>
            </div>
            <p class="text-sm text-slate-600 dark:text-slate-400">
                Este bus se encuentra actualmente en mantención programada.
                ${bus.detail ? `Detalle: ${bus.detail}` : 'No hay detalles adicionales registrados.'}
            </p>
        `;
    } else if (bus.status === 'panne') {
        return `
            <div class="text-sm text-red-600 dark:text-red-400 font-medium mb-2 flex items-center gap-1.5">
                <iconify-icon icon="heroicons:exclamation-circle"></iconify-icon>
                <span>Bus en panne</span>
            </div>
            <p class="text-sm text-slate-600 dark:text-slate-400">
                Este bus se encuentra actualmente en panne.
                ${bus.detail ? `Detalle: ${bus.detail}` : 'No hay detalles adicionales registrados.'}
                Se recomienda contactar al departamento de mantenimiento.
            </p>
        `;
    } else if (bus.loaded && bus.status === 'operational') {
        // Check if this bus has bad loads
        const hasBadLoads = combinedData.fuel.badLoads.some(load => load.plate === bus.plate);

        if (hasBadLoads) {
            return `
                <div class="text-sm text-amber-600 dark:text-amber-400 font-medium mb-2 flex items-center gap-1.5">
                    <iconify-icon icon="heroicons:exclamation-triangle"></iconify-icon>
                    <span>Bus con cargas manuales</span>
                </div>
                <p class="text-sm text-slate-600 dark:text-slate-400">
                    Este bus tiene cargas manuales registradas. 
                    Se recomienda verificar que estas cargas estén autorizadas.
                </p>
            `;
        }

        return `
            <div class="text-sm text-emerald-600 dark:text-emerald-400 font-medium mb-2 flex items-center gap-1.5">
                <iconify-icon icon="heroicons:check-circle"></iconify-icon>
                <span>Bus operativo y cargado</span>
            </div>
            <p class="text-sm text-slate-600 dark:text-slate-400">
                Este bus está operativo y ha sido cargado con combustible.
                No se requieren acciones adicionales en este momento.
            </p>
        `;
    } else {
        return `
            <div class="text-sm text-slate-600 dark:text-slate-400 font-medium mb-2 flex items-center gap-1.5">
                <iconify-icon icon="heroicons:information-circle"></iconify-icon>
                <span>Información insuficiente</span>
            </div>
            <p class="text-sm text-slate-600 dark:text-slate-400">
                No hay suficiente información para generar recomendaciones.
                Se sugiere verificar el estado operativo del bus.
            </p>
        `;
    }
}

function printBusDetail() {
    const busDetailContent = document.getElementById('bus-detail-content');
    if (!busDetailContent) return;
    
    const printWindow = window.open('', '_blank');

    if (!printWindow) {
        showToast('Error', 'El navegador bloqueó la ventana emergente para impresión', 'error');
        return;
    }

    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Detalle de Bus</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    margin: 20px;
                    color: #333;
                }
                h1 {
                    font-size: 20px;
                    margin-bottom: 10px;
                }
                .section {
                    margin-bottom: 20px;
                }
                .section-title {
                    font-size: 16px;
                    font-weight: bold;
                    margin-bottom: 10px;
                    padding-bottom: 5px;
                    border-bottom: 1px solid #ddd;
                }
                .info-grid {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 10px;
                }
                .info-item {
                    padding: 8px;
                    background-color: #f8f8f8;
                    border-radius: 4px;
                }
                .info-label {
                    font-size: 12px;
                    color: #666;
                    margin-bottom: 4px;
                }
                .info-value {
                    font-size: 14px;
                    font-weight: 600;
                }
                .details-box {
                    background-color: #f8f8f8;
                    padding: 10px;
                    border-radius: 4px;
                    margin-bottom: 15px;
                }
                .status-operational {
                    color: #047857;
                }
                .status-maintenance {
                    color: #b45309;
                }
                .status-panne {
                    color: #b91c1c;
                }
                .footer {
                    margin-top: 20px;
                    font-size: 12px;
                    color: #666;
                    text-align: center;
                }
                .alert-box {
                    background-color: #fef2f2;
                    border: 1px solid #fee2e2;
                    border-radius: 4px;
                    padding: 10px;
                    margin-bottom: 15px;
                    color: #b91c1c;
                }
                .alert-title {
                    font-weight: bold;
                    margin-bottom: 5px;
                }
            </style>
        </head>
        <body>
            <h1>Detalle de Bus</h1>
            <div class="bus-details">
                ${busDetailContent.innerHTML}
            </div>
            <div class="footer">
                Fleet Analytics Pro - Documento generado el ${formatDate(new Date())}
            </div>
        </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.addEventListener('load', function () {
        printWindow.print();
        printWindow.close();
    });

    showToast('Info', 'Preparando impresión...', 'info');
}

function printReport(title, data) {
    const printWindow = window.open('', '_blank');

    if (!printWindow) {
        showToast('Error', 'El navegador bloqueó la ventana emergente para impresión', 'error');
        return;
    }

    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>${title}</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    margin: 20px;
                }
                h1 {
                    font-size: 18px;
                    margin-bottom: 10px;
                }
                .date {
                    font-size: 12px;
                    color: #666;
                    margin-bottom: 20px;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                }
                th, td {
                    border: 1px solid #ddd;
                    padding: 8px;
                    text-align: left;
                    font-size: 12px;
                }
                th {
                    background-color: #f2f2f2;
                    font-weight: bold;
                }
                tr:nth-child(even) {
                    background-color: #f9f9f9;
                }
                .footer {
                    margin-top: 20px;
                    font-size: 12px;
                    color: #666;
                    text-align: center;
                }
            </style>
        </head>
        <body>
            <h1>${title}</h1>
            <div class="date">Fecha: ${formatDate(new Date())}</div>
            <table>
                <thead>
                    <tr>
                        ${Object.keys(data[0]).map(key => `<th>${key}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${data.map(row => `
                        <tr>
                            ${Object.values(row).map(value => `<td>${value}</td>`).join('')}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div class="footer">
                Fleet Analytics Pro - Reporte generado el ${formatDate(new Date())}
            </div>
        </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.addEventListener('load', function () {
        printWindow.print();
        printWindow.close();
    });

    showToast('Info', 'Preparando impresión...', 'info');
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');

    if (!sidebar || !sidebarOverlay) return;

    sidebar.classList.toggle('open');
    sidebarOverlay.classList.toggle('active');
}

function closeSidebar() {
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');

    if (!sidebar || !sidebarOverlay) return;

    sidebar.classList.remove('open');
    sidebarOverlay.classList.remove('active');
}

function toggleTheme() {
    isDarkMode = !isDarkMode;
    document.body.classList.toggle('dark', isDarkMode);

    updateChartsForTheme();
}

function updateChartsForTheme() {
    if (!charts.fleetStatus) return; // Si no hay gráficos inicializados, salimos
    
    Chart.defaults.color = isDarkMode ? '#94a3b8' : '#64748b';
    Chart.defaults.borderColor = isDarkMode ? 'rgba(71, 85, 105, 0.2)' : 'rgba(203, 213, 225, 0.3)';

    Object.values(charts).forEach(chart => {
        if (chart.config.type === 'line') {
            chart.data.datasets.forEach(dataset => {
                dataset.pointBorderColor = isDarkMode ? '#1e293b' : '#ffffff';
            });
        }

        if (chart.config.type === 'doughnut' || chart.config.type === 'pie') {
            chart.data.datasets.forEach(dataset => {
                dataset.borderColor = isDarkMode ? '#1e293b' : '#ffffff';
            });
        }

        chart.update();
    });
}

function activateTab(tabId) {
    // Activar pestaña en navbar
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
        if (tab.getAttribute('data-tab') === tabId) {
            tab.classList.add('active');
        } else {
            tab.classList.remove('active');
        }
    });

    // Activar contenido de pestaña
    const tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(content => {
        if (content.id === `${tabId}-tab`) {
            content.classList.add('active');
        } else {
            content.classList.remove('active');
        }
    });
    
    // Activar enlace en sidebar
    const navLinks = document.querySelectorAll('.nav-menu-link');
    navLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href && href.substring(1) === tabId) {
            link.classList.add('active');
        } else {
            link.classList.remove('active');
        }
    });
    
    // Si hay gráficos, forzar su actualización para evitar problemas de renderizado
    if (Object.keys(charts).length > 0) {
        setTimeout(() => {
            Object.values(charts).forEach(chart => {
                try {
                    chart.update();
                } catch (e) { 
                    // Ignorar errores si el gráfico no está visible
                }
            });
        }, 100);
    }
}

function closeModal(modal) {
    if (modal) {
        modal.classList.remove('open');
    }
}

function showToast(title, message, type = 'success') {
    const toast = document.getElementById('toast');
    const toastIcon = document.getElementById('toast-icon');
    const toastTitle = document.getElementById('toast-title');
    const toastMessage = document.getElementById('toast-message');

    if (!toast || !toastIcon || !toastTitle || !toastMessage) {
        console.warn('Elementos del toast no encontrados');
        return;
    }

    // Configurar icono y colores según el tipo
    if (type === 'success') {
        toastIcon.innerHTML = '<iconify-icon icon="heroicons:check"></iconify-icon>';
        toastIcon.className = 'toast-icon bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400';
    } else if (type === 'error') {
        toastIcon.innerHTML = '<iconify-icon icon="heroicons:x-mark"></iconify-icon>';
        toastIcon.className = 'toast-icon bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400';
    } else if (type === 'warning') {
        toastIcon.innerHTML = '<iconify-icon icon="heroicons:exclamation-triangle"></iconify-icon>';
        toastIcon.className = 'toast-icon bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400';
    } else if (type === 'info') {
        toastIcon.innerHTML = '<iconify-icon icon="heroicons:information-circle"></iconify-icon>';
        toastIcon.className = 'toast-icon bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400';
    }

    // Establecer contenido
    toastTitle.textContent = title;
    toastMessage.textContent = message;

    // Mostrar toast
    toast.classList.add('show');

    // Auto-ocultar después de 5 segundos
    setTimeout(() => {
        hideToast();
    }, 5000);
}

function hideToast() {
    const toast = document.getElementById('toast');
    if (toast) {
        toast.classList.remove('show');
    }
}

function getTerminalBadge(terminal) {
    if (!terminal) return '<span class="terminal-badge">--</span>';

    const upperTerminal = terminal.toUpperCase();
    
    if (upperTerminal.includes('ROBLE')) {
        return '<span class="terminal-badge terminal-el-roble">ER</span>';
    } else if (upperTerminal.includes('REINA')) {
        return '<span class="terminal-badge terminal-la-reina">LR</span>';
    } else if (upperTerminal.includes('ANGEL')) {
        return '<span class="terminal-badge terminal-maria-angelica">MA</span>';
    } else if (upperTerminal.includes('DESCANSO')) {
        return '<span class="terminal-badge terminal-el-descanso">ED</span>';
    } else {
        return '<span class="terminal-badge">--</span>';
    }
}

function getStatusText(status) {
    switch (status) {
        case 'operational':
            return 'Operativo';
        case 'maintenance':
            return 'Mantención';
        case 'panne':
            return 'Panne';
        default:
            return 'Sin datos';
    }
}

function formatDate(date) {
    if (!date) return 'N/A';

    if (typeof date === 'string') {
        return date;
    }

    try {
        const options = {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };

        return date.toLocaleDateString('es-CL', options);
    } catch (e) {
        return 'Fecha inválida';
    }
}

function getFormattedDateFilename() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    return `${year}${month}${day}`;
}

function updateFleetPreview() {
    const fleetPreview = document.getElementById('fleet-preview');
    const fleetCount = document.getElementById('fleet-count');

    if (!fleetPreview || !fleetCount) return;

    fleetPreview.innerHTML = '';

    if (masterFleet.length === 0) {
        fleetPreview.innerHTML = '<div class="text-slate-500 dark:text-slate-400">No hay buses registrados</div>';
        fleetCount.textContent = '0 buses registrados';
        return;
    }

    const previewLimit = 20;
    const previewBuses = masterFleet.slice(0, previewLimit);
    const remainingCount = masterFleet.length - previewLimit;

    previewBuses.forEach(plate => {
        const badge = document.createElement('span');
        badge.className = 'inline-block bg-slate-200 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded-md px-1.5 py-0.5 m-0.5';
        badge.textContent = plate;
        fleetPreview.appendChild(badge);
    });

    if (remainingCount > 0) {
        const moreIndicator = document.createElement('span');
        moreIndicator.className = 'inline-block bg-slate-300 dark:bg-slate-700 text-slate-800 dark:text-slate-200 rounded-md px-1.5 py-0.5 m-0.5 font-medium';
        moreIndicator.textContent = `+${remainingCount} más`;
        fleetPreview.appendChild(moreIndicator);
    }

    fleetCount.textContent = `${masterFleet.length} buses registrados`;

    checkProcessButtonState();
}

function saveFleet() {
    const fleetTextarea = document.getElementById('fleet-textarea');
    const editFleetModal = document.getElementById('edit-fleet-modal');

    if (!fleetTextarea || !editFleetModal) return;

    const fleetText = fleetTextarea.value;
    masterFleet = fleetText
        .split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0);

    updateFleetPreview();
    closeModal(editFleetModal);
    showToast('Éxito', 'Flota actualizada correctamente', 'success');
}

function processImportFleet() {
    const importFleetTextarea = document.getElementById('import-fleet-textarea');
    const importFleetModal = document.getElementById('import-fleet-modal');

    if (!importFleetTextarea || !importFleetModal) return;

    const importText = importFleetTextarea.value;
    if (!importText.trim()) {
        showToast('Error', 'Debe ingresar datos para importar', 'error');
        return;
    }

    const processedPlates = processPlatesInput(importText);

    if (processedPlates.length === 0) {
        showToast('Error', 'No se encontraron patentes válidas en los datos ingresados', 'error');
        return;
    }

    const oldCount = masterFleet.length;
    const uniquePlates = new Set([...masterFleet, ...processedPlates]);
    masterFleet = Array.from(uniquePlates);

    updateFleetPreview();
    closeModal(importFleetModal);

    const newPlates = masterFleet.length - oldCount;
    showToast('Éxito', `${processedPlates.length} patentes procesadas, ${newPlates} nuevas agregadas`, 'success');
}

function processPlatesInput(input) {
    const parts = input.split(/[\n\t,;]+/);

    const platePattern = /([A-Z]{2,4}[0-9]{2,3})/;

    const plates = [];

    parts.forEach(part => {
        const cleanPart = part.trim().toUpperCase();

        if (platePattern.test(cleanPart)) {
            plates.push(cleanPart);
            return;
        }

        const matches = cleanPart.match(platePattern);
        if (matches) {
            plates.push(matches[0]);
        }
    });

    return [...new Set(plates)];
}

function refreshData() {
    if (!operativityData) {
        showToast('Error', 'No hay datos para actualizar', 'error');
        return;
    }

    combineData();

    updateKeyMetrics();
    updateCharts();
    renderTables();
    updateTerminalMetrics();
    renderLocations();
    renderBadLoads();
    renderPumpAnalysis();

    updateBadLoadsCounter();

    showToast('Éxito', 'Datos actualizados correctamente', 'success');
}
    </script>

    <script>
        // Este fragmento debe reemplazar las funciones correspondientes en el código principal

// Corrige la función faltante - necesaria para showEditFleetModal
function openModal(modal) {
    if (modal) {
        modal.classList.add('open');
    }
}

// Funciones de modales para flota
function showEditFleetModal() {
    const editFleetModal = document.getElementById('edit-fleet-modal');
    const fleetTextarea = document.getElementById('fleet-textarea');

    if (editFleetModal && fleetTextarea) {
        fleetTextarea.value = masterFleet.join('\n');
        openModal(editFleetModal);
    }
}

function showImportFleetModal() {
    const importFleetModal = document.getElementById('import-fleet-modal');
    const importFleetTextarea = document.getElementById('import-fleet-textarea');

    if (importFleetModal && importFleetTextarea) {
        importFleetTextarea.value = '';
        openModal(importFleetModal);
    }
}

// Corrección de initFleetListeners para asegurar que las funciones se definan antes
function initFleetListeners() {
    // Botón para editar flota
    const editFleetBtn = document.getElementById('edit-fleet');
    if (editFleetBtn) {
        editFleetBtn.addEventListener('click', showEditFleetModal);
    }
    
    // Botón para importar flota
    const importFleetBtn = document.getElementById('import-fleet');
    if (importFleetBtn) {
        importFleetBtn.addEventListener('click', showImportFleetModal);
    }
    
    // Botón para guardar flota
    const saveFleetBtn = document.getElementById('save-fleet');
    if (saveFleetBtn) {
        saveFleetBtn.addEventListener('click', saveFleet);
    }
    
    // Botón para procesar importación
    const processImportFleetBtn = document.getElementById('process-import-fleet');
    if (processImportFleetBtn) {
        processImportFleetBtn.addEventListener('click', processImportFleet);
    }
}
    </script>
</body>

</html>
