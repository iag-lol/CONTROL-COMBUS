<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Analytics Pro | Sistema Integral de Gestión</title>
    
    <!-- CSS Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Icon Library -->
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- XLSX.js for Excel file handling -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        /* ======================= CONFIGURACIÓN BASE ======================= */
        :root {
            /* Paleta de colores principal */
            --primary-50: #ecfeff;
            --primary-100: #cffafe;
            --primary-200: #a5f3fc;
            --primary-300: #67e8f9;
            --primary-400: #22d3ee;
            --primary-500: #06b6d4;
            --primary-600: #0891b2;
            --primary-700: #0e7490;
            --primary-800: #155e75;
            --primary-900: #164e63;
            
            /* Paleta de colores secundaria */
            --secondary-50: #f5f3ff;
            --secondary-100: #ede9fe;
            --secondary-200: #ddd6fe;
            --secondary-300: #c4b5fd;
            --secondary-400: #a78bfa;
            --secondary-500: #8b5cf6;
            --secondary-600: #7c3aed;
            --secondary-700: #6d28d9;
            --secondary-800: #5b21b6;
            --secondary-900: #4c1d95;
            
            /* Colores de estado */
            --success-50: #ecfdf5;
            --success-100: #d1fae5;
            --success-200: #a7f3d0;
            --success-300: #6ee7b7;
            --success-400: #34d399;
            --success-500: #10b981;
            --success-600: #059669;
            --success-700: #047857;
            --success-800: #065f46;
            --success-900: #064e3b;
            
            --warning-50: #fffbeb;
            --warning-100: #fef3c7;
            --warning-200: #fde68a;
            --warning-300: #fcd34d;
            --warning-400: #fbbf24;
            --warning-500: #f59e0b;
            --warning-600: #d97706;
            --warning-700: #b45309;
            --warning-800: #92400e;
            --warning-900: #78350f;
            
            --danger-50: #fef2f2;
            --danger-100: #fee2e2;
            --danger-200: #fecaca;
            --danger-300: #fca5a5;
            --danger-400: #f87171;
            --danger-500: #ef4444;
            --danger-600: #dc2626;
            --danger-700: #b91c1c;
            --danger-800: #991b1b;
            --danger-900: #7f1d1d;
            
            /* Colores para modo claro */
            --text-light: #1e293b;
            --bg-light: #f1f5f9;
            --card-light: #ffffff;
            --border-light: #e2e8f0;
            
            /* Colores para modo oscuro */
            --text-dark: #f8fafc;
            --bg-dark: #0f172a;
            --card-dark: #1e293b;
            --border-dark: #334155;
            
            /* Espaciado y bordes */
            --border-radius-sm: 0.25rem;
            --border-radius-md: 0.375rem;
            --border-radius-lg: 0.5rem;
            --border-radius-xl: 0.75rem;
            --border-radius-full: 9999px;
            
            /* Sombras */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            /* Transiciones */
            --transition-fast: 150ms;
            --transition-normal: 300ms;
            --transition-slow: 500ms;
        }

        /* ======================= ESTILOS GENERALES ======================= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
            line-height: 1.5;
            transition: background-color var(--transition-normal), 
                        color var(--transition-normal);
        }

        body.dark {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }

        /* ======================= SCROLLBAR PERSONALIZADO ======================= */
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-light);
            border-radius: var(--border-radius-full);
        }

        .dark ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: var(--border-radius-full);
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* ======================= LAYOUT PRINCIPAL ======================= */
        .dashboard-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .dashboard-main {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            max-height: calc(100vh - 55px);
        }

        .sidebar {
            width: 230px;
            flex-shrink: 0;
            overflow-y: auto;
            border-right: 1px solid var(--border-light);
            background-color: var(--card-light);
            transition: width var(--transition-normal), 
                        transform var(--transition-normal),
                        background-color var(--transition-normal);
            z-index: 20;
            height: calc(100vh - 55px);
        }

        .dark .sidebar {
            border-right-color: var(--border-dark);
            background-color: var(--card-dark);
        }

        .content-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content {
            padding: 1rem;
            overflow-y: auto;
            height: calc(100vh - 55px);
        }

        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                top: 55px;
                left: 0;
                bottom: 0;
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }

            .overlay {
                position: fixed;
                top: 55px;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 10;
                opacity: 0;
                visibility: hidden;
                transition: opacity var(--transition-normal), 
                            visibility var(--transition-normal);
            }

            .overlay.active {
                opacity: 1;
                visibility: visible;
            }
        }

        /* ======================= COMPONENTES ======================= */
        /* Header */
        .header {
            height: 55px;
            background-color: var(--card-light);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            padding: 0 1rem;
            position: sticky;
            top: 0;
            z-index: 30;
            box-shadow: var(--shadow-sm);
            transition: background-color var(--transition-normal),
                        border-color var(--transition-normal);
        }

        .dark .header {
            background-color: var(--card-dark);
            border-bottom-color: var(--border-dark);
        }

        /* Cards */
        .card {
            background-color: var(--card-light);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: all var(--transition-normal);
        }

        .dark .card {
            background-color: var(--card-dark);
            border-color: var(--border-dark);
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Botones */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            padding: 0.4rem 0.75rem;
            border-radius: var(--border-radius-lg);
            font-weight: 500;
            font-size: 0.8125rem;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .btn-primary {
            background-image: linear-gradient(to right, var(--primary-600), var(--secondary-600));
            color: white;
            border: none;
            box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.2);
        }

        .btn-primary:hover {
            background-image: linear-gradient(to right, var(--primary-700), var(--secondary-700));
            box-shadow: 0 6px 10px -1px rgba(14, 165, 233, 0.3);
        }

        .btn-secondary {
            background-color: #1e293b;
            color: white;
            border: none;
        }

        .btn-secondary:hover {
            background-color: #0f172a;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--border-light);
            color: var(--text-light);
        }

        .dark .btn-outline {
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        .btn-outline:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .dark .btn-outline:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .btn-icon {
            width: 2rem;
            height: 2rem;
            padding: 0;
            border-radius: var(--border-radius-full);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Inputs */
        .input-field {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            color: #0f172a;
            border-radius: var(--border-radius-lg);
            padding: 0.4rem 0.6rem;
            font-size: 0.8125rem;
            transition: all var(--transition-normal);
            outline: none;
            width: 100%;
        }

        .dark .input-field {
            background-color: #1e293b;
            border-color: #334155;
            color: #f8fafc;
        }

        .input-field:focus {
            border-color: var(--primary-500);
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2);
        }

        .dark .input-field:focus {
            border-color: var(--primary-400);
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.3);
        }

        .input-field::placeholder {
            color: #94a3b8;
        }

        .dark .input-field::placeholder {
            color: #64748b;
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.15rem 0.5rem;
            font-size: 0.6875rem;
            font-weight: 500;
            border-radius: var(--border-radius-full);
        }

        .badge-primary {
            background-color: var(--primary-100);
            color: var(--primary-700);
        }

        .dark .badge-primary {
            background-color: rgba(6, 182, 212, 0.2);
            color: var(--primary-300);
        }

        .badge-success {
            background-color: var(--success-100);
            color: var(--success-700);
        }

        .dark .badge-success {
            background-color: rgba(16, 185, 129, 0.2);
            color: var(--success-300);
        }

        .badge-warning {
            background-color: var(--warning-100);
            color: var(--warning-700);
        }

        .dark .badge-warning {
            background-color: rgba(245, 158, 11, 0.2);
            color: var(--warning-300);
        }

        .badge-danger {
            background-color: var(--danger-100);
            color: var(--danger-700);
        }

        .dark .badge-danger {
            background-color: rgba(239, 68, 68, 0.2);
            color: var(--danger-300);
        }

        /* Tablas */
        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-light);
        }

        .dark .table-container {
            border-color: var(--border-dark);
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.8125rem;
        }

        .data-table th {
            background-color: #f8fafc;
            color: #475569;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.6875rem;
            letter-spacing: 0.05em;
            padding: 0.6rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .dark .data-table th {
            background-color: #1e293b;
            color: #94a3b8;
            border-bottom-color: var(--border-dark);
        }

        .data-table td {
            padding: 0.6rem 0.75rem;
            border-bottom: 1px solid var(--border-light);
            color: #334155;
            white-space: nowrap;
        }

        .dark .data-table td {
            color: #cbd5e1;
            border-bottom-color: var(--border-dark);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover td {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .dark .data-table tr:hover td {
            background-color: rgba(255, 255, 255, 0.02);
        }

        /* Operativity Status Indicators */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-operational {
            background-color: var(--success-500);
        }

        .status-maintenance {
            background-color: var(--warning-500);
        }

        .status-panne {
            background-color: var(--danger-500);
        }

        .status-inactive {
            background-color: #94a3b8;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-light);
            margin-bottom: 0.75rem;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .dark .tabs {
            border-bottom-color: var(--border-dark);
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            padding: 0.5rem 0.75rem;
            font-weight: 500;
            font-size: 0.8125rem;
            color: #64748b;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--transition-normal);
        }

        .dark .tab {
            color: #94a3b8;
        }

        .tab:hover {
            color: var(--primary-600);
        }

        .dark .tab:hover {
            color: var(--primary-400);
        }

        .tab.active {
            color: var(--primary-600);
            border-bottom-color: var(--primary-600);
        }

        .dark .tab.active {
            color: var(--primary-400);
            border-bottom-color: var(--primary-400);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        /* Navigation Menu */
        .nav-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-menu-item {
            margin-bottom: 0.15rem;
        }

        .nav-menu-link {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            color: #475569;
            text-decoration: none;
            border-radius: var(--border-radius-lg);
            transition: all var(--transition-normal);
            font-size: 0.8125rem;
        }

        .dark .nav-menu-link {
            color: #94a3b8;
        }

        .nav-menu-link:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-light);
        }

        .dark .nav-menu-link:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-dark);
        }

        .nav-menu-link.active {
            background-color: rgba(14, 165, 233, 0.1);
            color: var(--primary-600);
            font-weight: 500;
        }

        .dark .nav-menu-link.active {
            background-color: rgba(14, 165, 233, 0.2);
            color: var(--primary-400);
        }

        .nav-menu-icon {
            margin-right: 0.6rem;
            font-size: 1.125rem;
            opacity: 0.7;
        }

        /* Divider */
        .divider {
            height: 1px;
            background-color: var(--border-light);
            margin: 0.75rem 0;
        }

        .dark .divider {
            background-color: var(--border-dark);
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 180px;
            background-color: #27272a;
            color: #f8fafc;
            text-align: center;
            border-radius: var(--border-radius-md);
            padding: 0.4rem;
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity var(--transition-normal);
            box-shadow: var(--shadow-md);
            font-size: 0.6875rem;
            pointer-events: none;
        }

        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #27272a transparent transparent transparent;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-top-color: var(--primary-500);
            animation: spin 1s linear infinite;
        }

        .dark .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary-400);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            background-color: var(--card-light);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 0.75rem;
            display: flex;
            align-items: flex-start;
            gap: 0.6rem;
            max-width: 20rem;
            z-index: 100;
            transform: translateY(100%);
            opacity: 0;
            transition: transform var(--transition-normal), opacity var(--transition-normal);
        }

        .dark .toast {
            background-color: var(--card-dark);
            border-color: var(--border-dark);
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-icon {
            flex-shrink: 0;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toast-content {
            flex-grow: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 0.8125rem;
            color: var(--text-light);
            margin-bottom: 0.2rem;
        }

        .dark .toast-title {
            color: var(--text-dark);
        }

        .toast-message {
            font-size: 0.75rem;
            color: #64748b;
        }

        .dark .toast-message {
            color: #94a3b8;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-normal), visibility var(--transition-normal);
        }

        .modal.open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--card-light);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 30rem;
            max-height: 90vh;
            overflow: auto;
            transform: scale(0.9);
            opacity: 0;
            transition: transform var(--transition-normal), opacity var(--transition-normal);
        }

        .dark .modal-content {
            background-color: var(--card-dark);
        }

        .modal.open .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .modal-header {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .dark .modal-header {
            border-bottom-color: var(--border-dark);
        }

        .modal-body {
            padding: 1rem;
        }

        .modal-footer {
            padding: 0.75rem;
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: flex-end;
            gap: 0.6rem;
        }

        .dark .modal-footer {
            border-top-color: var(--border-dark);
        }

        /* File Upload Styles */
        .file-upload {
            border: 2px dashed var(--border-light);
            border-radius: var(--border-radius-lg);
            padding: 1rem;
            text-align: center;
            transition: all var(--transition-normal);
            cursor: pointer;
        }

        .dark .file-upload {
            border-color: var(--border-dark);
        }

        .file-upload:hover {
            border-color: var(--primary-500);
            background-color: rgba(14, 165, 233, 0.05);
        }

        .dark .file-upload:hover {
            border-color: var(--primary-400);
            background-color: rgba(14, 165, 233, 0.1);
        }

        .file-upload-icon {
            font-size: 1.5rem;
            color: #94a3b8;
            margin-bottom: 0.4rem;
        }

        .dark .file-upload-icon {
            color: #64748b;
        }

        /* Switch Button (Toggle) */
        .switch {
            position: relative;
            display: inline-block;
            width: 2.5rem;
            height: 1.25rem;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: var(--transition-normal);
            border-radius: var(--border-radius-full);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 0.9rem;
            width: 0.9rem;
            left: 0.2rem;
            bottom: 0.175rem;
            background-color: white;
            transition: var(--transition-normal);
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-500);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-500);
        }

        input:checked + .slider:before {
            transform: translateX(1.25rem);
        }

        /* Dashboard Grid Layouts */
        .grid-cols-1 {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }

        .grid-cols-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .grid-cols-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }

        .grid-cols-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }

        @media (max-width: 1280px) {
            .grid-cols-4 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .grid-cols-3 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .grid-cols-2,
            .grid-cols-3,
            .grid-cols-4 {
                grid-template-columns: 1fr;
            }
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(1rem); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        .animate-slide-in {
            animation: slideIn 0.3s ease-in-out;
        }

        /* Status Pills */
        .status-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.15rem 0.5rem;
            border-radius: var(--border-radius-full);
            font-size: 0.6875rem;
            font-weight: 500;
        }

        .status-operational {
            background-color: var(--success-100);
            color: var(--success-700);
        }

        .dark .status-operational {
            background-color: rgba(16, 185, 129, 0.2);
            color: var(--success-300);
        }

        .status-maintenance {
            background-color: var(--warning-100);
            color: var(--warning-700);
        }

        .dark .status-maintenance {
            background-color: rgba(245, 158, 11, 0.2);
            color: var(--warning-300);
        }

        .status-panne {
            background-color: var(--danger-100);
            color: var(--danger-700);
        }

        .dark .status-panne {
            background-color: rgba(239, 68, 68, 0.2);
            color: var(--danger-300);
        }

        .status-inactive {
            background-color: #e2e8f0;
            color: #64748b;
        }

        .dark .status-inactive {
            background-color: rgba(100, 116, 139, 0.2);
            color: #94a3b8;
        }

        /* Advanced Data Cards */
        .data-card {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .data-card-header {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-light);
        }

        .dark .data-card-header {
            border-bottom-color: var(--border-dark);
        }

        .data-card-title {
            font-weight: 600;
            font-size: 0.8125rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .dark .data-card-title {
            color: var(--text-dark);
        }

        .data-card-body {
            padding: 0.75rem;
            flex-grow: 1;
            overflow: auto;
        }

        .data-card-footer {
            padding: 0.5rem 0.75rem;
            border-top: 1px solid var(--border-light);
            background-color: rgba(0, 0, 0, 0.01);
            font-size: 0.6875rem;
            color: #64748b;
        }

        .dark .data-card-footer {
            border-top-color: var(--border-dark);
            background-color: rgba(255, 255, 255, 0.01);
            color: #94a3b8;
        }

        /* Stat Cards */
        .stat-card {
            padding: 1rem;
        }

        .stat-card-label {
            font-size: 0.6875rem;
            font-weight: 500;
            color: #64748b;
            margin-bottom: 0.4rem;
        }

        .dark .stat-card-label {
            color: #94a3b8;
        }

        .stat-card-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 0.4rem;
        }

        .dark .stat-card-value {
            color: var(--text-dark);
        }

        .stat-card-change {
            font-size: 0.6875rem;
            display: flex;
            align-items: center;
            gap: 0.2rem;
        }

        .stat-card-change.positive {
            color: var(--success-600);
        }

        .dark .stat-card-change.positive {
            color: var(--success-400);
        }

        .stat-card-change.negative {
            color: var(--danger-600);
        }

        .dark .stat-card-change.negative {
            color: var(--danger-400);
        }

        /* Terminal Specific Styles */
        .terminal-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.15rem 0.4rem;
            font-size: 0.625rem;
            font-weight: 500;
            border-radius: var(--border-radius-full);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .terminal-el-roble {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .dark .terminal-el-roble {
            background-color: rgba(30, 64, 175, 0.2);
            color: #93c5fd;
        }

        .terminal-la-reina {
            background-color: #fef3c7;
            color: #92400e;
        }

        .dark .terminal-la-reina {
            background-color: rgba(146, 64, 14, 0.2);
            color: #fcd34d;
        }

        .terminal-maria-angelica {
            background-color: #d1fae5;
            color: #065f46;
        }

        .dark .terminal-maria-angelica {
            background-color: rgba(6, 95, 70, 0.2);
            color: #6ee7b7;
        }

        /* Advanced Stat Cards */
        .advanced-stat-card {
            border-radius: var(--border-radius-lg);
            padding: 0.75rem;
            background-color: var(--card-light);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
        }

        .dark .advanced-stat-card {
            background-color: var(--card-dark);
            border-color: var(--border-dark);
        }

        .advanced-stat-title {
            font-size: 0.6875rem;
            font-weight: 500;
            color: #64748b;
            margin-bottom: 0.4rem;
        }

        .dark .advanced-stat-title {
            color: #94a3b8;
        }

        .advanced-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 0.4rem;
            display: flex;
            align-items: baseline;
        }

        .dark .advanced-stat-value {
            color: var(--text-dark);
        }

        .advanced-stat-value .unit {
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
            margin-left: 0.2rem;
        }

        .dark .advanced-stat-value .unit {
            color: #94a3b8;
        }

        .advanced-stat-progress {
            height: 4px;
            background-color: #e2e8f0;
            border-radius: var(--border-radius-full);
            margin-bottom: 0.4rem;
            overflow: hidden;
        }

        .dark .advanced-stat-progress {
            background-color: #334155;
        }

        .advanced-stat-progress-bar {
            height: 100%;
            border-radius: var(--border-radius-full);
        }

        .advanced-stat-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.6875rem;
            color: #64748b;
        }

        .dark .advanced-stat-details {
            color: #94a3b8;
        }

        /* Code-like font */
        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* File Upload Info */
        .file-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius-lg);
            margin-top: 0.4rem;
            font-size: 0.75rem;
        }

        .dark .file-info {
            background-color: #1e293b;
            border-color: #334155;
        }

        .file-info-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            background-color: #e2e8f0;
            border-radius: var(--border-radius-lg);
            color: #64748b;
        }

        .dark .file-info-icon {
            background-color: #334155;
            color: #94a3b8;
        }

        .file-info-details {
            flex-grow: 1;
        }

        .file-info-name {
            font-weight: 500;
            color: var(--text-light);
            margin-bottom: 0.2rem;
        }

        .dark .file-info-name {
            color: var(--text-dark);
        }

        .file-info-meta {
            font-size: 0.6875rem;
            color: #64748b;
        }

        .dark .file-info-meta {
            color: #94a3b8;
        }

        /* Sheet Selector */
        .sheet-selector {
            display: flex;
            overflow-x: auto;
            scrollbar-width: none;
            gap: 0.4rem;
            padding-bottom: 0.4rem;
        }

        .sheet-selector::-webkit-scrollbar {
            display: none;
        }

        .sheet-button {
            padding: 0.4rem 0.75rem;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius-lg);
            font-size: 0.6875rem;
            font-weight: 500;
            color: #64748b;
            white-space: nowrap;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .dark .sheet-button {
            background-color: #1e293b;
            border-color: #334155;
            color: #94a3b8;
        }

        .sheet-button:hover {
            background-color: #f1f5f9;
            border-color: #cbd5e1;
            color: var(--text-light);
        }

        .dark .sheet-button:hover {
            background-color: #0f172a;
            border-color: #475569;
            color: var(--text-dark);
        }

        .sheet-button.active {
            background-color: rgba(14, 165, 233, 0.1);
            border-color: var(--primary-500);
            color: var(--primary-600);
        }

        .dark .sheet-button.active {
            background-color: rgba(14, 165, 233, 0.2);
            border-color: var(--primary-400);
            color: var(--primary-400);
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
            text-align: center;
        }

        .empty-state-icon {
            font-size: 2.5rem;
            color: #cbd5e1;
            margin-bottom: 0.75rem;
        }

        .dark .empty-state-icon {
            color: #475569;
        }

        .empty-state-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.4rem;
        }

        .dark .empty-state-title {
            color: var(--text-dark);
        }

        .empty-state-description {
            font-size: 0.8125rem;
            color: #64748b;
            max-width: 20rem;
            margin-bottom: 1rem;
        }

        .dark .empty-state-description {
            color: #94a3b8;
        }

        /* Bus Visualization Grid */
        .bus-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
            gap: 0.4rem;
        }

        .bus-item {
            padding: 0.4rem;
            border-radius: var(--border-radius-lg);
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            font-size: 0.6875rem;
            text-align: center;
            transition: all var(--transition-normal);
            cursor: pointer;
        }

        .dark .bus-item {
            background-color: #1e293b;
            border-color: #334155;
        }

        .bus-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .bus-item-plate {
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.2rem;
        }

        .dark .bus-item-plate {
            color: var(--text-dark);
        }

        .bus-item-terminal {
            font-size: 0.625rem;
            color: #64748b;
        }

        .dark .bus-item-terminal {
            color: #94a3b8;
        }

        .bus-item.operational {
            border-left: 3px solid var(--success-500);
        }

        .bus-item.maintenance {
            border-left: 3px solid var(--warning-500);
        }

        .bus-item.panne {
            border-left: 3px solid var(--danger-500);
        }

        .bus-item.inactive {
            border-left: 3px solid #94a3b8;
        }

        /* Search Results Box */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--card-light);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            margin-top: 0.4rem;
            max-height: 280px;
            overflow-y: auto;
            z-index: 50;
            display: none;
        }

        .dark .search-results {
            background-color: var(--card-dark);
            border-color: var(--border-dark);
        }

        .search-results.show {
            display: block;
            animation: fadeIn 0.2s ease-in-out;
        }

        .search-results-item {
            padding: 0.6rem 0.75rem;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: background-color var(--transition-fast);
        }

        .dark .search-results-item {
            border-bottom-color: var(--border-dark);
        }

        .search-results-item:last-child {
            border-bottom: none;
        }

        .search-results-item:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }

        .dark .search-results-item:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        .search-results-primary {
            font-weight: 600;
            color: var(--text-light);
            font-size: 0.8125rem;
            margin-bottom: 0.2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .dark .search-results-primary {
            color: var(--text-dark);
        }

        .search-results-secondary {
            font-size: 0.6875rem;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dark .search-results-secondary {
            color: #94a3b8;
        }

        /* Welcome & Files Section */
        .welcome-section {
            margin-bottom: 0.75rem;
        }

        .welcome-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.4rem;
            color: var(--text-light);
        }

        .dark .welcome-title {
            color: var(--text-dark);
        }

        .welcome-subtitle {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 1rem;
        }

        .dark .welcome-subtitle {
            color: #94a3b8;
        }

        .files-section {
            padding: 1rem;
            background-color: var(--card-light);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-xl);
            margin-bottom: 1.5rem;
        }

        .dark .files-section {
            background-color: var(--card-dark);
            border-color: var(--border-dark);
        }

        .files-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-light);
        }

        .dark .files-title {
            color: var(--text-dark);
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        /* Quick Filters */
        .quick-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-bottom: 0.75rem;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.25rem 0.6rem;
            background-color: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius-full);
            font-size: 0.6875rem;
            font-weight: 500;
            color: #475569;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .dark .filter-chip {
            background-color: #1e293b;
            border-color: #334155;
            color: #94a3b8;
        }

        .filter-chip:hover {
            background-color: #e2e8f0;
            border-color: #cbd5e1;
        }

        .dark .filter-chip:hover {
            background-color: #0f172a;
            border-color: #475569;
        }

        .filter-chip.active {
            background-color: rgba(14, 165, 233, 0.1);
            border-color: var(--primary-500);
            color: var(--primary-600);
        }

        .dark .filter-chip.active {
            background-color: rgba(14, 165, 233, 0.2);
            border-color: var(--primary-400);
            color: var(--primary-400);
        }

        /* Bus Details Card */
        .bus-details-card {
            border-radius: var(--border-radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .bus-details-header {
            padding: 1rem;
            background-image: linear-gradient(to right, var(--primary-600), var(--secondary-600));
            color: white;
        }

        .bus-details-body {
            padding: 1rem;
            background-color: var(--card-light);
        }

        .dark .bus-details-body {
            background-color: var(--card-dark);
        }

        .bus-details-plate {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.2rem;
        }

        .bus-details-status {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .bus-details-section {
            margin-bottom: 1rem;
        }

        .bus-details-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.6rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .dark .bus-details-section-title {
            color: var(--text-dark);
        }

        .bus-details-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.6rem;
        }

        .bus-details-info-item {
            background-color: #f8fafc;
            border-radius: var(--border-radius-lg);
            padding: 0.6rem;
            border: 1px solid #e2e8f0;
        }

        .dark .bus-details-info-item {
            background-color: #1e293b;
            border-color: #334155;
        }

        .bus-details-info-label {
            font-size: 0.6875rem;
            color: #64748b;
            margin-bottom: 0.2rem;
        }

        .dark .bus-details-info-label {
            color: #94a3b8;
        }

        .bus-details-info-value {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .dark .bus-details-info-value {
            color: var(--text-dark);
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="header">
            <div class="flex items-center gap-2">
                <button id="sidebar-toggle" class="lg:hidden btn-icon btn-outline">
                    <iconify-icon icon="heroicons:bars-3"></iconify-icon>
                </button>
                <div class="flex items-center gap-2">
                    <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-primary-500 to-secondary-500 flex items-center justify-center text-white">
                        <iconify-icon icon="fluent:vehicle-truck-24-filled"></iconify-icon>
                    </div>
                    <div>
                        <h1 class="text-base font-bold">Fleet Analytics Pro</h1>
                        <p class="text-[10px] text-slate-500 dark:text-slate-400">Sistema Integral de Gestión</p>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-2 ml-auto">
                <div class="relative">
                    <input type="text" id="global-search" placeholder="Buscar PPU o N° Interno..." class="input-field pl-8 pr-3 py-1.5 w-48 md:w-64">
                    <iconify-icon icon="heroicons:magnifying-glass" class="absolute left-2.5 top-2 text-slate-400"></iconify-icon>
                    <div id="search-results" class="search-results"></div>
                </div>
                <div id="status-indicator" class="hidden md:flex items-center gap-1.5 px-2 py-1 rounded-full text-xs bg-emerald-100 dark:bg-emerald-900/30 text-emerald-800 dark:text-emerald-400">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                    <span>Sistema Operativo</span>
                </div>
                <button id="theme-toggle" class="btn-icon btn-outline">
                    <iconify-icon icon="heroicons:moon" class="block dark:hidden"></iconify-icon>
                    <iconify-icon icon="heroicons:sun" class="hidden dark:block"></iconify-icon>
                </button>
                <button id="user-menu-button" class="w-7 h-7 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center">
                    <iconify-icon icon="heroicons:user"></iconify-icon>
                </button>
            </div>
        </header>
        
        <div class="dashboard-main">
            <!-- Sidebar -->
            <aside id="sidebar" class="sidebar">
                <div class="flex flex-col h-full p-3">
                    <div class="mb-4">
                        <h2 class="text-xs uppercase font-semibold text-slate-500 dark:text-slate-400 mb-2 pl-2">Navegación</h2>
                        <ul class="nav-menu">
                            <li class="nav-menu-item">
                                <a href="#dashboard" class="nav-menu-link active">
                                    <iconify-icon icon="heroicons:home" class="nav-menu-icon"></iconify-icon>
                                    <span>Inicio</span>
                                </a>
                            </li>
                            <li class="nav-menu-item">
                                <a href="#fuel-analysis" class="nav-menu-link">
                                    <iconify-icon icon="heroicons:beaker" class="nav-menu-icon"></iconify-icon>
                                    <span>Análisis de Combustible</span>
                                </a>
                            </li>
                            <li class="nav-menu-item">
                                <a href="#operativity" class="nav-menu-link">
                                    <iconify-icon icon="heroicons:truck" class="nav-menu-icon"></iconify-icon>
                                    <span>Operatividad de Flota</span>
                                </a>
                            </li>
                            <li class="nav-menu-item">
                                <a href="#terminals" class="nav-menu-link">
                                    <iconify-icon icon="heroicons:map" class="nav-menu-icon"></iconify-icon>
                                    <span>Terminales</span>
                                </a>
                            </li>
                            <li class="nav-menu-item">
                                <a href="#reports" class="nav-menu-link">
                                    <iconify-icon icon="heroicons:document-chart-bar" class="nav-menu-icon"></iconify-icon>
                                    <span>Reportes</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="divider"></div>
                    
                    <div class="flex-grow">
                        <h2 class="text-xs uppercase font-semibold text-slate-500 dark:text-slate-400 mb-2 pl-2">Archivos</h2>
                        <div class="space-y-3">
                            <div class="card p-2">
                                <h3 class="text-xs font-medium text-slate-700 dark:text-slate-300 mb-1.5">Archivos Requeridos</h3>
                                <div class="space-y-2">
                                    <input type="file" id="fuel-file" class="hidden" accept=".xlsx, .xls">
                                    <label for="fuel-file" class="file-upload flex flex-col items-center justify-center py-2">
                                        <iconify-icon icon="heroicons:document-arrow-up" class="file-upload-icon"></iconify-icon>
                                        <span id="fuel-file-text" class="text-sm font-medium text-slate-700 dark:text-slate-300">Combustible</span>
                                    </label>
                                    
                                    <input type="file" id="operativity-file" class="hidden" accept=".xlsx, .xls">
                                    <label for="operativity-file" class="file-upload flex flex-col items-center justify-center py-2">
                                        <iconify-icon icon="heroicons:clipboard-document-check" class="file-upload-icon"></iconify-icon>
                                        <span id="operativity-file-text" class="text-sm font-medium text-slate-700 dark:text-slate-300">Operatividad</span>
                                    </label>
                                </div>
                                
                                <div class="mt-2">
                                    <div id="fuel-file-info" class="text-xs"></div>
                                    <div id="operativity-file-info" class="text-xs"></div>
                                </div>
                                
                                <button id="process-button" class="btn btn-primary w-full flex items-center justify-center gap-2 mt-2" disabled>
                                    <iconify-icon icon="heroicons:arrow-path"></iconify-icon>
                                    <span>Procesar Datos</span>
                                </button>
                            </div>
                            
                            <div class="card p-2">
                                <h3 class="text-xs font-medium text-slate-700 dark:text-slate-300 mb-1.5">Flota (PPU)</h3>
                                <div class="flex justify-between mb-1">
                                    <button id="edit-fleet" class="text-xs text-primary-600 dark:text-primary-400 hover:underline">Editar</button>
                                    <button id="import-fleet" class="text-xs text-primary-600 dark:text-primary-400 hover:underline">Importar</button>
                                </div>
                                <div id="fleet-preview" class="bg-slate-50 dark:bg-slate-900 rounded-lg p-2 min-h-12 max-h-24 overflow-y-auto text-xs">
                                    <div class="flex flex-wrap gap-1">
                                        <!-- Fleet preview badges will be rendered here -->
                                    </div>
                                </div>
                                <p id="fleet-count" class="mt-1 text-xs text-slate-500 dark:text-slate-400">0 buses registrados</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="divider"></div>
                    
                    <div>
                        <div class="card p-2 bg-gradient-to-br from-primary-900/50 to-secondary-900/50 border-none">
                            <h3 class="text-xs font-medium text-white mb-1.5">Acciones Rápidas</h3>
                            <div class="grid grid-cols-2 gap-1.5">
                                <button id="export-data-btn" class="btn btn-outline text-xs py-1 bg-white/10 border-white/20 text-white">
                                    <iconify-icon icon="heroicons:document-arrow-down" class="mr-1"></iconify-icon>
                                    <span>Exportar</span>
                                </button>
                                <button id="print-report-btn" class="btn btn-outline text-xs py-1 bg-white/10 border-white/20 text-white">
                                    <iconify-icon icon="heroicons:printer" class="mr-1"></iconify-icon>
                                    <span>Imprimir</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
            
            <!-- Mobile sidebar overlay -->
            <div id="sidebar-overlay" class="overlay"></div>
            
            <!-- Main Content -->
            <div class="content-wrapper">
                <div class="content">
                    <!-- Welcome Screen (shown before data is loaded) -->
                    <div id="welcome-screen" class="animate-fade-in">
                        <div class="welcome-section">
                            <h2 class="welcome-title">Bienvenido a Fleet Analytics Pro</h2>
                            <p class="welcome-subtitle">Sistema integral para el análisis de combustible y operatividad de flota.</p>
                        </div>
                        
                        <div class="files-section">
                            <h3 class="files-title">Carga de Archivos</h3>
                            <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">
                                Para comenzar, cargue los archivos de combustible y operatividad. El sistema procesará automáticamente 
                                todos los datos y generará análisis para todas las secciones.
                            </p>
                            
                            <div class="files-grid">
                                <div class="card p-4">
                                    <h4 class="text-base font-semibold text-slate-900 dark:text-white mb-2 flex items-center gap-2">
                                        <iconify-icon icon="heroicons:beaker" class="text-primary-500"></iconify-icon>
                                        <span>Archivo de Combustible</span>
                                    </h4>
                                    <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">
                                        Archivo Excel con el registro de cargas de combustible por PPU.
                                    </p>
                                    <input type="file" id="welcome-fuel-file" class="hidden" accept=".xlsx, .xls">
                                    <label for="welcome-fuel-file" class="file-upload flex flex-col items-center justify-center py-3">
                                        <iconify-icon icon="heroicons:document-arrow-up" class="file-upload-icon text-2xl"></iconify-icon>
                                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300 mt-2">Seleccionar archivo</span>
                                        <span class="text-xs text-slate-500 dark:text-slate-400 mt-1">XLSX o XLS</span>
                                    </label>
                                </div>
                                
                                <div class="card p-4">
                                    <h4 class="text-base font-semibold text-slate-900 dark:text-white mb-2 flex items-center gap-2">
                                        <iconify-icon icon="heroicons:truck" class="text-primary-500"></iconify-icon>
                                        <span>Reporte de Operatividad</span>
                                    </h4>
                                    <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">
                                        Archivo Excel con el estado operativo y ubicación de la flota.
                                    </p>
                                    <input type="file" id="welcome-operativity-file" class="hidden" accept=".xlsx, .xls">
                                    <label for="welcome-operativity-file" class="file-upload flex flex-col items-center justify-center py-3">
                                        <iconify-icon icon="heroicons:clipboard-document-check" class="file-upload-icon text-2xl"></iconify-icon>
                                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300 mt-2">Seleccionar archivo</span>
                                        <span class="text-xs text-slate-500 dark:text-slate-400 mt-1">XLSX o XLS</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mt-4 text-center">
                                <button id="welcome-process-button" class="btn btn-primary px-8" disabled>
                                    <iconify-icon icon="heroicons:arrow-path" class="mr-2"></iconify-icon>
                                    <span>Procesar Archivos</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-sm text-slate-600 dark:text-slate-400 text-center">
                            <p>
                                También puede cargar los archivos desde el panel lateral en cualquier momento.
                                <br>El sistema procesará automáticamente todos los datos.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Dashboard (hidden initially) -->
                    <div id="dashboard-content" class="hidden">
                        <!-- Dashboard Header -->
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-2 mb-3">
                            <div>
                                <h2 class="text-lg font-bold text-slate-900 dark:text-white">Dashboard Operativo</h2>
                                <p class="text-xs text-slate-600 dark:text-slate-400">Vista integral del estado de la flota</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="relative">
                                    <input type="text" placeholder="Filtrar buses..." id="dashboard-filter" class="input-field pl-8 pr-3 py-1.5">
                                    <iconify-icon icon="heroicons:funnel" class="absolute left-2.5 top-2 text-slate-400"></iconify-icon>
                                </div>
                                <button id="refresh-data" class="btn btn-primary">
                                    <iconify-icon icon="heroicons:arrow-path"></iconify-icon>
                                    <span>Actualizar</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="quick-filters mb-3">
                            <div class="filter-chip active" data-filter="all">
                                <iconify-icon icon="heroicons:squares-2x2"></iconify-icon>
                                <span>Todos</span>
                            </div>
                            <div class="filter-chip" data-filter="operational">
                                <iconify-icon icon="heroicons:check-circle"></iconify-icon>
                                <span>Operativos</span>
                            </div>
                            <div class="filter-chip" data-filter="pending">
                                <iconify-icon icon="heroicons:clock"></iconify-icon>
                                <span>Pendientes</span>
                            </div>
                            <div class="filter-chip" data-filter="maintenance">
                                <iconify-icon icon="heroicons:wrench-screwdriver"></iconify-icon>
                                <span>Mantención</span>
                            </div>
                            <div class="filter-chip" data-filter="panne">
                                <iconify-icon icon="heroicons:exclamation-triangle"></iconify-icon>
                                <span>Panne</span>
                            </div>
                        </div>
                        
                        <!-- Tabs -->
                        <div class="tabs">
                            <div class="tab active" data-tab="general">General</div>
                            <div class="tab" data-tab="fuel">Combustible</div>
                            <div class="tab" data-tab="operativity">Operatividad</div>
                            <div class="tab" data-tab="terminals">Terminales</div>
                            <div class="tab" data-tab="reports">Reportes</div>
                        </div>
                        
                        <!-- General Tab Content -->
                        <div id="general-tab" class="tab-content active">
                            <!-- Key Metrics -->
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-3">
                                <div class="card stat-card">
                                    <div class="stat-card-label">Total Litros</div>
                                    <div id="total-liters" class="stat-card-value">0</div>
                                    <div id="liters-change" class="stat-card-change positive">
                                        <iconify-icon icon="heroicons:arrow-trending-up"></iconify-icon>
                                        <span>0% vs. promedio</span>
                                    </div>
                                </div>
                                
                                <div class="card stat-card">
                                    <div class="stat-card-label">Buses Cargados</div>
                                    <div id="buses-loaded" class="stat-card-value">0</div>
                                    <div id="loaded-percent" class="stat-card-change">
                                        <span>0% de la flota</span>
                                    </div>
                                </div>
                                
                                <div class="card stat-card">
                                    <div class="stat-card-label">Buses Pendientes</div>
                                    <div id="buses-pending" class="stat-card-value text-amber-600 dark:text-amber-400">0</div>
                                    <div id="pending-percent" class="stat-card-change">
                                        <span>0% de la flota</span>
                                    </div>
                                </div>
                                
                                <div class="card stat-card">
                                    <div class="stat-card-label">Buses en Panne</div>
                                    <div id="buses-panne" class="stat-card-value text-red-600 dark:text-red-400">0</div>
                                    <div id="panne-percent" class="stat-card-change">
                                        <span>0% de la flota</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Status Summary -->
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 mb-3">
                                <!-- Status Chart -->
                                <div class="card">
                                    <div class="data-card-header">
                                        <div class="data-card-title">
                                            <iconify-icon icon="heroicons:chart-pie"></iconify-icon>
                                            <span>Estado de la Flota</span>
                                        </div>
                                    </div>
                                    <div class="data-card-body">
                                        <div class="chart-container">
                                            <canvas id="fleet-status-chart"></canvas>
                                        </div>
                                    </div>
                                    <div class="data-card-footer">
                                        Actualizado: <span id="status-update-time">Hoy, 08:30</span>
                                    </div>
                                </div>
                                
                                <!-- Terminal Distribution -->
                                <div class="card">
                                    <div class="data-card-header">
                                        <div class="data-card-title">
                                            <iconify-icon icon="heroicons:map"></iconify-icon>
                                            <span>Distribución por Terminal</span>
                                        </div>
                                    </div>
                                    <div class="data-card-body">
                                        <div class="chart-container">
                                            <canvas id="terminal-distribution-chart"></canvas>
                                        </div>
                                    </div>
                                    <div class="data-card-footer">
                                        Buses activos por ubicación
                                    </div>
                                </div>
                                
                                <!-- Hourly Load Chart -->
                                <div class="card">
                                    <div class="data-card-header">
                                        <div class="data-card-title">
                                            <iconify-icon icon="heroicons:clock"></iconify-icon>
                                            <span>Cargas por Hora</span>
                                        </div>
                                    </div>
                                    <div class="data-card-body">
                                        <div class="chart-container">
                                            <canvas id="hourly-chart"></canvas>
                                        </div>
                                    </div>
                                    <div class="data-card-footer">
                                        Hora pico: <span id="peak-hour">10:00 - 11:00</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Bus Search & Status -->
                            <div class="card mb-3">
                                <div class="data-card-header">
                                    <div class="data-card-title">
                                        <iconify-icon icon="heroicons:magnifying-glass"></iconify-icon>
                                        <span>Consulta Rápida de Buses</span>
                                    </div>
                                </div>
                                <div class="data-card-body p-3">
                                    <div class="flex flex-col md:flex-row gap-3">
                                        <div class="w-full md:w-2/3">
                                            <div class="mb-3">
                                                <label for="quick-search" class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">Buscar por PPU o N° Interno</label>
                                                <div class="relative">
                                                    <input type="text" id="quick-search" class="input-field pl-8 pr-3 py-1.5 w-full" placeholder="Ej: LXWP57, P05, 1025...">
                                                    <iconify-icon icon="heroicons:magnifying-glass" class="absolute left-2.5 top-2 text-slate-400"></iconify-icon>
                                                    <button id="quick-search-btn" class="absolute right-2 top-1.5 text-primary-500 dark:text-primary-400">
                                                        <iconify-icon icon="heroicons:arrow-right-circle"></iconify-icon>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div id="quick-search-results" class="bg-slate-50 dark:bg-slate-900 rounded-lg p-3 min-h-24">
                                                <div class="text-center text-slate-500 dark:text-slate-400 text-sm py-6">
                                                    Ingrese una PPU o N° Interno para consultar el estado del bus
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="w-full md:w-1/3">
                                            <div class="bg-slate-100 dark:bg-slate-800 rounded-lg p-3 h-full">
                                                <h4 class="text-xs font-semibold text-slate-700 dark:text-slate-300 mb-2">Resumen de Estado</h4>
                                                <div class="space-y-2">
                                                    <div class="flex justify-between items-center">
                                                        <div class="flex items-center gap-1.5">
                                                            <span class="status-indicator status-operational"></span>
                                                            <span class="text-xs">Operativos</span>
                                                        </div>
                                                        <span id="operational-count" class="text-xs font-semibold">0</span>
                                                    </div>
                                                    <div class="flex justify-between items-center">
                                                        <div class="flex items-center gap-1.5">
                                                            <span class="status-indicator status-maintenance"></span>
                                                            <span class="text-xs">Mantención</span>
                                                        </div>
                                                        <span id="maintenance-count" class="text-xs font-semibold">0</span>
                                                    </div>
                                                    <div class="flex justify-between items-center">
                                                        <div class="flex items-center gap-1.5">
                                                            <span class="status-indicator status-panne"></span>
                                                            <span class="text-xs">Panne</span>
                                                        </div>
                                                        <span id="panne-count" class="text-xs font-semibold">0</span>
                                                    </div>
                                                    <div class="flex justify-between items-center">
                                                        <div class="flex items-center gap-1.5">
                                                            <span class="status-indicator status-inactive"></span>
                                                            <span class="text-xs">Sin Datos</span>
                                                        </div>
                                                        <span id="unknown-count" class="text-xs font-semibold">0</span>
                                                    </div>
                                                    <div class="pt-2 mt-2 border-t border-slate-200 dark:border-slate-700">
                                                        <div class="flex justify-between items-center">
                                                            <span class="text-xs font-medium">Total Flota:</span>
                                                            <span id="total-fleet-count" class="text-xs font-semibold">0</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pending Buses Table -->
                            <div class="card mb-3">
                                <div class="data-card-header flex justify-between items-center">
                                    <div class="data-card-title">
                                        <iconify-icon icon="heroicons:clock"></iconify-icon>
                                        <span>Buses Pendientes por Cargar</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="text" id="filter-pending" class="input-field text-xs py-1 px-2 w-32" placeholder="Filtrar...">
                                        <button id="export-pending-btn" class="btn btn-outline text-xs py-1 px-2">
                                            <iconify-icon icon="heroicons:arrow-down-tray"></iconify-icon>
                                            <span>Exportar</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Patente</th>
                                                <th>Terminal</th>
                                                <th>Ubicación</th>
                                                <th>Estado</th>
                                                <th>Servicio</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="pending-buses-table">
                                            <!-- Table will be populated with JavaScript -->
                                            <tr>
                                                <td colspan="6" class="text-center py-6 text-slate-500 dark:text-slate-400">
                                                    Cargue los archivos para ver el listado de buses pendientes
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Buses in Maintenance/Panne -->
                            <div class="card">
                                <div class="data-card-header flex justify-between items-center">
                                    <div class="data-card-title">
                                        <iconify-icon icon="heroicons:wrench-screwdriver"></iconify-icon>
                                        <span>Buses en Mantención o Panne</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="text" id="filter-maintenance" class="input-field text-xs py-1 px-2 w-32" placeholder="Filtrar...">
                                        <button id="export-maintenance-btn" class="btn btn-outline text-xs py-1 px-2">
                                            <iconify-icon icon="heroicons:arrow-down-tray"></iconify-icon>
                                            <span>Exportar</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Patente</th>
                                                <th>Terminal</th>
                                                <th>Tipo</th>
                                                <th>Detalle</th>
                                                <th>Ubicación</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="maintenance-buses-table">
                                            <!-- Table will be populated with JavaScript -->
                                            <tr>
                                                <td colspan="6" class="text-center py-6 text-slate-500 dark:text-slate-400">
                                                    Cargue los archivos para ver el listado de buses en mantención o panne
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Fuel Tab Content -->
                        <div id="fuel-tab" class="tab-content">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 mb-3">
                                <!-- Fuel Summary -->
                                <div class="card">
                                    <div class="data-card-header">
                                        <div class="data-card-title">
                                            <iconify-icon icon="heroicons:beaker"></iconify-icon>
                                            <span>Resumen de Combustible</span>
                                        </div>
                                    </div>
                                    <div class="data-card-body space-y-2.5">
                                        <div class="advanced-stat-card">
                                            <div class="advanced-stat-title">Total Cargado</div>
                                            <div class="advanced-stat-value" id="fuel-total-liters">
                                                0<span class="unit">Lts</span>
                                            </div>
                                        </div>
                                        
                                        <div class="advanced-stat-card">
                                            <div class="advanced-stat-title">Promedio por Bus</div>
                                            <div class="advanced-stat-value" id="fuel-avg-per-bus">
                                                0<span class="unit">Lts</span>
                                            </div>
                                        </div>
                                        
                                        <div class="advanced-stat-card">
                                            <div class="advanced-stat-title">Total Cargas</div>
                                            <div class="advanced-stat-value" id="fuel-total-loads">
                                                0
                                            </div>
                                        </div>
                                        
                                        <div class="advanced-stat-card">
                                            <div class="advanced-stat-title">Eficiencia de Carga</div>
                                            <div class="advanced-stat-value" id="fuel-efficiency">
                                                0<span class="unit">%</span>
                                            </div>
                                            <div class="advanced-stat-progress">
                                                <div id="fuel-efficiency-bar" class="advanced-stat-progress-bar bg-primary-500" style="width: 0%"></div>
                                            </div>
                                            <div class="advanced-stat-details">
                                                <span id="fuel-loaded-count">0 buses cargados</span>
                                                <span id="fuel-total-buses">de 0 buses</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Terminal Consumption -->
                                <div class="card">
                                    <div class="data-card-header">
                                        <div class="data-card-title">
                                            <iconify-icon icon="heroicons:map"></iconify-icon>
                                            <span>Consumo por Terminal</span>
                                        </div>
                                    </div>
                                    <div class="data-card-body">
                                        <div class="chart-container">
                                            <canvas id="terminal-consumption-chart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Hourly Consumption -->
                                <div class="card">
                                    <div class="data-card-header">
                                        <div class="data-card-title">
                                            <iconify-icon icon="heroicons:clock"></iconify-icon>
                                            <span>Consumo por Hora</span>
                                        </div>
                                    </div>
                                    <div class="data-card-body">
                                        <div class="chart-container">
                                            <canvas id="hourly-consumption-chart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Bus Consumption -->
                            <div class="card mb-3">
                                <div class="data-card-header flex justify-between items-center">
                                    <div class="data-card-title">
                                        <iconify-icon icon="heroicons:truck"></iconify-icon>
                                        <span>Consumo por Bus</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="text" id="filter-consumption" class="input-field text-xs py-1 px-2 w-32" placeholder="Filtrar...">
                                        <select id="sort-consumption" class="input-field text-xs py-1 px-2 w-40">
                                            <option value="plate">Ordenar por Patente</option>
                                            <option value="liters-desc">Mayor Consumo</option>
                                            <option value="liters-asc">Menor Consumo</option>
                                            <option value="loads">N° de Cargas</option>
                                            <option value="terminal">Terminal</option>
                                        </select>
                                        <button id="export-consumption-btn" class="btn btn-outline text-xs py-1 px-2">
                                            <iconify-icon icon="heroicons:arrow-down-tray"></iconify-icon>
                                            <span>Exportar</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Patente</th>
                                                <th>Terminal</th>
                                                <th>Cargas</th>
                                                <th>Total Litros</th>
                                                <th>Promedio</th>
                                                <th>Última Carga</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="consumption-table">
                                            <!-- Table will be populated with JavaScript -->
                                            <tr>
                                                <td colspan="7" class="text-center py-6 text-slate-500 dark:text-slate-400">
                                                    Cargue los archivos para ver el consumo por bus
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Fuel Anomalies -->
                            <div class="card">
                                <div class="data-card-header">
                                    <div class="data-card-title">
                                        <iconify-icon icon="heroicons:exclamation-triangle"></iconify-icon>
                                        <span>Anomalías Detectadas</span>
                                    </div>
                                </div>
                                <div class="data-card-body">
                                    <div class="space-y-3" id="anomalies-container">
                                        <!-- Will be populated with JavaScript -->
                                        <div class="text-center py-6 text-slate-500 dark:text-slate-400">
                                            Cargue los archivos para analizar posibles anomalías
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Operativity Tab Content -->
                        <div id="operativity-tab" class="tab-content">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 mb-3">
                                <!-- Operativity Summary -->
                                <div class="card">
                                    <div class="data-card-header">
                                        <div class="data-card-title">
                                            <iconify-icon icon="heroicons:signal"></iconify-icon>
                                            <span>Resumen de Operatividad</span>
                                        </div>
                                    </div>
                                    <div class="data-card-body space-y-2.5">
                                        <div class="advanced-stat-card">
                                            <div class="advanced-stat-title">Flota Total</div>
                                            <div class="advanced-stat-value" id="op-total-fleet">
                                                0<span class="unit">buses</span>
                                            </div>
                                        </div>
                                        
                                        <div class="advanced-stat-card">
                                            <div class="advanced-stat-title">Buses Operativos</div>
                                            <div class="advanced-stat-value" id="op-total-operational">
                                                0<span class="unit">buses</span>
                                            </div>
                                            <div class="advanced-stat-progress">
                                                <div id="op-operational-bar" class="advanced-stat-progress-bar bg-emerald-500" style="width: 0%"></div>
                                            </div>
                                            <div class="advanced-stat-details">
                                                <span id="op-operational-percent">0% de la flota</span>
                                            </div>
                                        </div>
                                        
                                        <div class="advanced-stat-card">
                                            <div class="advanced-stat-title">Buses en Mantención</div>
                                            <div class="advanced-stat-value" id="op-total-maintenance">
                                                0<span class="unit">buses</span>
                                            </div>
                                            <div class="advanced-stat-progress">
                                                <div id="op-maintenance-bar" class="advanced-stat-progress-bar bg-amber-500" style="width: 0%"></div>
                                            </div>
                                            <div class="advanced-stat-details">
                                                <span id="op-maintenance-percent">0% de la flota</span>
                                            </div>
                                        </div>
                                        
                                        <div class="advanced-stat-card">
                                            <div class="advanced-stat-title">Buses en Panne</div>
                                            <div class="advanced-stat-value" id="op-total-panne">
                                                0<span class="unit">buses</span>
                                            </div>
                                            <div class="advanced-stat-progress">
                                                <div id="op-panne-bar" class="advanced-stat-progress-bar bg-red-500" style="width: 0%"></div>
                                            </div>
                                            <div class="advanced-stat-details">
                                                <span id="op-panne-percent">0% de la flota</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Status by Terminal -->
                                <div class="card">
                                    <div class="data-card-header">
                                        <div class="data-card-title">
                                            <iconify-icon icon="heroicons:map"></iconify-icon>
                                            <span>Estado por Terminal</span>
                                        </div>
                                    </div>
                                    <div class="data-card-body">
                                        <div class="space-y-3">
                                            <div class="grid grid-cols-5 gap-1">
                                                <div class="col-span-2 text-xs font-medium text-slate-600 dark:text-slate-400">Terminal</div>
                                                <div class="text-xs font-medium text-slate-600 dark:text-slate-400 text-center">Operativos</div>
                                                <div class="text-xs font-medium text-slate-600 dark:text-slate-400 text-center">Mantención</div>
                                                <div class="text-xs font-medium text-slate-600 dark:text-slate-400 text-center">Panne</div>
                                            </div>
                                            
                                            <div class="grid grid-cols-5 gap-1 items-center">
                                                <div class="col-span-2 flex items-center gap-1.5">
                                                    <span class="terminal-badge terminal-el-roble">ER</span>
                                                    <span class="text-xs font-medium text-slate-800 dark:text-slate-200">El Roble</span>
                                                </div>
                                                <div class="text-center">
                                                    <span id="el-roble-operational" class="text-xs font-semibold text-emerald-600 dark:text-emerald-400">0</span>
                                                </div>
                                                <div class="text-center">
                                                    <span id="el-roble-maintenance" class="text-xs font-semibold text-amber-600 dark:text-amber-400">0</span>
                                                </div>
                                                <div class="text-center">
                                                    <span id="el-roble-panne" class="text-xs font-semibold text-red-600 dark:text-red-400">0</span>
                                                </div>
                                            </div>
                                            
                                            <div class="grid grid-cols-5 gap-1 items-center">
                                                <div class="col-span-2 flex items-center gap-1.5">
                                                    <span class="terminal-badge terminal-la-reina">LR</span>
                                                    <span class="text-xs font-medium text-slate-800 dark:text-slate-200">La Reina</span>
                                                </div>
                                                <div class="text-center">
                                                    <span id="la-reina-operational" class="text-xs font-semibold text-emerald-600 dark:text-emerald-400">0</span>
                                                </div>
                                                <div class="text-center">
                                                    <span id="la-reina-maintenance" class="text-xs font-semibold text-amber-600 dark:text-amber-400">0</span>
                                                </div>
                                                <div class="text-center">
                                                    <span id="la-reina-panne" class="text-xs font-semibold text-red-600 dark:text-red-400">0</span>
                                                </div>
                                            </div>
                                            
                                            <div class="grid grid-cols-5 gap-1 items-center">
                                                <div class="col-span-2 flex items-center gap-1.5">
                                                    <span class="terminal-badge terminal-maria-angelica">MA</span>
                                                    <span class="text-xs font-medium text-slate-800 dark:text-slate-200">María Angélica</span>
                                                </div>
                                                <div class="text-center">
                                                    <span id="maria-angelica-operational" class="text-xs font-semibold text-emerald-600 dark:text-emerald-400">0</span>
                                                </div>
                                                <div class="text-center">
                                                    <span id="maria-angelica-maintenance" class="text-xs font-semibold text-amber-600 dark:text-amber-400">0</span>
                                                </div>
                                                <div class="text-center">
                                                    <span id="maria-angelica-panne" class="text-xs font-semibold text-red-600 dark:text-red-400">0</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-700">
                                            <div class="chart-container h-40">
                                                <canvas id="terminal-status-chart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Location Summary -->
                                <div class="card">
                                    <div class="data-card-header">
                                        <div class="data-card-title">
                                            <iconify-icon icon="heroicons:map-pin"></iconify-icon>
                                            <span>Ubicaciones</span>
                                        </div>
                                    </div>
                                    <div class="data-card-body">
                                        <div id="locations-container" class="space-y-2">
                                            <!-- Will be populated with JavaScript -->
                                            <div class="text-center py-6 text-slate-500 dark:text-slate-400">
                                                Cargue los archivos para ver las ubicaciones
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- All Buses Status -->
                            <div class="card mb-3">
                                <div class="data-card-header flex justify-between items-center">
                                    <div class="data-card-title">
                                        <iconify-icon icon="heroicons:truck"></iconify-icon>
                                        <span>Estado Completo de Flota</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="text" id="filter-status" class="input-field text-xs py-1 px-2 w-32" placeholder="Filtrar...">
                                        <select id="sort-status" class="input-field text-xs py-1 px-2 w-40">
                                            <option value="plate">Ordenar por Patente</option>
                                            <option value="status">Estado</option>
                                            <option value="terminal">Terminal</option>
                                            <option value="location">Ubicación</option>
                                        </select>
                                        <button id="export-status-btn" class="btn btn-outline text-xs py-1 px-2">
                                            <iconify-icon icon="heroicons:arrow-down-tray"></iconify-icon>
                                            <span>Exportar</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Patente</th>
                                                <th>Terminal</th>
                                                <th>Estado</th>
                                                <th>Ubicación</th>
                                                <th>Detalle</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="status-table">
                                            <!-- Table will be populated with JavaScript -->
                                            <tr>
                                                <td colspan="6" class="text-center py-6 text-slate-500 dark:text-slate-400">
                                                    Cargue los archivos para ver el estado de la flota
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Maintenance Details -->
                            <div class="card">
                                <div class="data-card-header">
                                    <div class="data-card-title">
                                        <iconify-icon icon="heroicons:wrench-screwdriver"></iconify-icon>
                                        <span>Detalle de Mantenciones y Pannes</span>
                                    </div>
                                </div>
                                <div class="data-card-body">
                                    <div id="maintenance-details-container" class="space-y-3">
                                        <!-- Will be populated with JavaScript -->
                                        <div class="text-center py-6 text-slate-500 dark:text-slate-400">
                                            Cargue los archivos para ver detalles de mantenciones
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Terminals Tab Content -->
                        <div id="terminals-tab" class="tab-content">
                            <!-- Terminal Selection -->
                            <div class="grid grid-cols-3 gap-3 mb-3">
                                <div class="card cursor-pointer terminal-card" data-terminal="el-roble">
                                    <div class="p-3 flex flex-col items-center text-center">
                                        <div class="terminal-badge terminal-el-roble text-xl p-2 mb-2">ER</div>
                                        <h3 class="font-semibold text-slate-900 dark:text-white">El Roble</h3>
                                        <p id="el-roble-bus-count" class="text-xs text-slate-600 dark:text-slate-400">0 buses</p>
                                    </div>
                                </div>
                                
                                <div class="card cursor-pointer terminal-card" data-terminal="la-reina">
                                    <div class="p-3 flex flex-col items-center text-center">
                                        <div class="terminal-badge terminal-la-reina text-xl p-2 mb-2">LR</div>
                                        <h3 class="font-semibold text-slate-900 dark:text-white">La Reina</h3>
                                        <p id="la-reina-bus-count" class="text-xs text-slate-600 dark:text-slate-400">0 buses</p>
                                    </div>
                                </div>
                                
                                <div class="card cursor-pointer terminal-card" data-terminal="maria-angelica">
                                    <div class="p-3 flex flex-col items-center text-center">
                                        <div class="terminal-badge terminal-maria-angelica text-xl p-2 mb-2">MA</div>
                                        <h3 class="font-semibold text-slate-900 dark:text-white">María Angélica</h3>
                                        <p id="maria-angelica-bus-count" class="text-xs text-slate-600 dark:text-slate-400">0 buses</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Terminal Details - El Roble -->
                            <div id="el-roble-details" class="terminal-details active">
                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 mb-3">
                                    <!-- Status -->
                                    <div class="card">
                                        <div class="data-card-header">
                                            <div class="data-card-title">
                                                <iconify-icon icon="heroicons:signal"></iconify-icon>
                                                <span>Estado de Flota - El Roble</span>
                                            </div>
                                        </div>
                                        <div class="data-card-body">
                                            <div class="chart-container">
                                                <canvas id="el-roble-status-chart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Fuel -->
                                    <div class="card">
                                        <div class="data-card-header">
                                            <div class="data-card-title">
                                                <iconify-icon icon="heroicons:beaker"></iconify-icon>
                                                <span>Consumo de Combustible</span>
                                            </div>
                                        </div>
                                        <div class="data-card-body space-y-3">
                                            <div class="advanced-stat-card">
                                                <div class="advanced-stat-title">Total Cargado</div>
                                                <div class="advanced-stat-value" id="el-roble-total-liters">
                                                    0<span class="unit">Lts</span>
                                                </div>
                                            </div>
                                            
                                            <div class="advanced-stat-card">
                                                <div class="advanced-stat-title">Promedio por Bus</div>
                                                <div class="advanced-stat-value" id="el-roble-avg-liters">
                                                    0<span class="unit">Lts</span>
                                                </div>
                                            </div>
                                            
                                            <div class="advanced-stat-card">
                                                <div class="advanced-stat-title">Eficiencia de Carga</div>
                                                <div class="advanced-stat-value" id="el-roble-efficiency">
                                                    0<span class="unit">%</span>
                                                </div>
                                                <div class="advanced-stat-progress">
                                                    <div id="el-roble-efficiency-bar" class="advanced-stat-progress-bar bg-primary-500" style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Locations -->
                                    <div class="card">
                                        <div class="data-card-header">
                                            <div class="data-card-title">
                                                <iconify-icon icon="heroicons:map-pin"></iconify-icon>
                                                <span>Ubicaciones</span>
                                            </div>
                                        </div>
                                        <div class="data-card-body">
                                            <div id="el-roble-locations" class="space-y-2">
                                                <!-- Will be populated with JavaScript -->
                                                <div class="text-center py-6 text-slate-500 dark:text-slate-400">
                                                    Cargue los archivos para ver las ubicaciones
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Fleet -->
                                <div class="card">
                                    <div class="data-card-header flex justify-between items-center">
                                        <div class="data-card-title">
                                            <iconify-icon icon="heroicons:truck"></iconify-icon>
                                            <span>Flota de Buses - El Roble</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <input type="text" id="filter-el-roble" class="input-field text-xs py-1 px-2 w-32" placeholder="Filtrar...">
                                            <button id="export-el-roble-btn" class="btn btn-outline text-xs py-1 px-2">
                                                <iconify-icon icon="heroicons:arrow-down-tray"></iconify-icon>
                                                <span>Exportar</span>
                                            </button>
                                        </div>
                                    </div>
                                    <div id="el-roble-buses-container" class="data-card-body">
                                        <div class="bus-grid">
                                            <!-- Will be populated with JavaScript -->
                                            <div class="text-center py-6 text-slate-500 dark:text-slate-400 col-span-full">
                                                Cargue los archivos para ver la flota
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Terminal Details - La Reina -->
                            <div id="la-reina-details" class="terminal-details hidden">
                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 mb-3">
                                    <!-- Status -->
                                    <div class="card">
                                        <div class="data-card-header">
                                            <div class="data-card-title">
                                                <iconify-icon icon="heroicons:signal"></iconify-icon>
                                                <span>Estado de Flota - La Reina</span>
                                            </div>
                                        </div>
                                        <div class="data-card-body">
                                            <div class="chart-container">
                                                <canvas id="la-reina-status-chart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Fuel -->
                                    <div class="card">
                                        <div class="data-card-header">
                                            <div class="data-card-title">
                                                <iconify-icon icon="heroicons:beaker"></iconify-icon>
                                                <span>Consumo de Combustible</span>
                                            </div>
                                        </div>
                                        <div class="data-card-body space-y-3">
                                            <div class="advanced-stat-card">
                                                <div class="advanced-stat-title">Total Cargado</div>
                                                <div class="advanced-stat-value" id="la-reina-total-liters">
                                                    0<span class="unit">Lts</span>
                                                </div>
                                            </div>
                                            
                                            <div class="advanced-stat-card">
                                                <div class="advanced-stat-title">Promedio por Bus</div>
                                                <div class="advanced-stat-value" id="la-reina-avg-liters">
                                                    0<span class="unit">Lts</span>
                                                </div>
                                            </div>
                                            
                                            <div class="advanced-stat-card">
                                                <div class="advanced-stat-title">Eficiencia de Carga</div>
                                                <div class="advanced-stat-value" id="la-reina-efficiency">
                                                    0<span class="unit">%</span>
                                                </div>
                                                <div class="advanced-stat-progress">
                                                    <div id="la-reina-efficiency-bar" class="advanced-stat-progress-bar bg-primary-500" style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Locations -->
                                    <div class="card">
                                        <div class="data-card-header">
                                            <div class="data-card-title">
                                                <iconify-icon icon="heroicons:map-pin"></iconify-icon>
                                                <span>Ubicaciones</span>
                                            </div>
                                        </div>
                                        <div class="data-card-body">
                                            <div id="la-reina-locations" class="space-y-2">
                                                <!-- Will be populated with JavaScript -->
                                                <div class="text-center py-6 text-slate-500 dark:text-slate-400">
                                                    Cargue los archivos para ver las ubicaciones
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Fleet -->
                                <div class="card">
                                    <div class="data-card-header flex justify-between items-center">
                                        <div class="data-card-title">
                                            <iconify-icon icon="heroicons:truck"></iconify-icon>
                                            <span>Flota de Buses - La Reina</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <input type="text" id="filter-la-reina" class="input-field text-xs py-1 px-2 w-32" placeholder="Filtrar...">
                                            <button id="export-la-reina-btn" class="btn btn-outline text-xs py-1 px-2">
                                                <iconify-icon icon="heroicons:arrow-down-tray"></iconify-icon>
                                                <span>Exportar</span>
                                            </button>
                                        </div>
                                    </div>
                                    <div id="la-reina-buses-container" class="data-card-body">
                                        <div class="bus-grid">
                                            <!-- Will be populated with JavaScript -->
                                            <div class="text-center py-6 text-slate-500 dark:text-slate-400 col-span-full">
                                                Cargue los archivos para ver la flota
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Terminal Details - María Angélica -->
                            <div id="maria-angelica-details" class="terminal-details hidden">
                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 mb-3">
                                    <!-- Status -->
                                    <div class="card">
                                        <div class="data-card-header">
                                            <div class="data-card-title">
                                                <iconify-icon icon="heroicons:signal"></iconify-icon>
                                                <span>Estado de Flota - María Angélica</span>
                                            </div>
                                        </div>
                                        <div class="data-card-body">
                                            <div class="chart-container">
                                                <canvas id="maria-angelica-status-chart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Fuel -->
                                    <div class="card">
                                        <div class="data-card-header">
                                            <div class="data-card-title">
                                                <iconify-icon icon="heroicons:beaker"></iconify-icon>
                                                <span>Consumo de Combustible</span>
                                            </div>
                                        </div>
                                        <div class="data-card-body space-y-3">
                                            <div class="advanced-stat-card">
                                                <div class="advanced-stat-title">Total Cargado</div>
                                                <div class="advanced-stat-value" id="maria-angelica-total-liters">
                                                    0<span class="unit">Lts</span>
                                                </div>
                                            </div>
                                            
                                            <div class="advanced-stat-card">
                                                <div class="advanced-stat-title">Promedio por Bus</div>
                                                <div class="advanced-stat-value" id="maria-angelica-avg-liters">
                                                    0<span class="unit">Lts</span>
                                                </div>
                                            </div>
                                            
                                            <div class="advanced-stat-card">
                                                <div class="advanced-stat-title">Eficiencia de Carga</div>
                                                <div class="advanced-stat-value" id="maria-angelica-efficiency">
                                                    0<span class="unit">%</span>
                                                </div>
                                                <div class="advanced-stat-progress">
                                                    <div id="maria-angelica-efficiency-bar" class="advanced-stat-progress-bar bg-primary-500" style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Locations -->
                                    <div class="card">
                                        <div class="data-card-header">
                                            <div class="data-card-title">
                                                <iconify-icon icon="heroicons:map-pin"></iconify-icon>
                                                <span>Ubicaciones</span>
                                            </div>
                                        </div>
                                        <div class="data-card-body">
                                            <div id="maria-angelica-locations" class="space-y-2">
                                                <!-- Will be populated with JavaScript -->
                                                <div class="text-center py-6 text-slate-500 dark:text-slate-400">
                                                    Cargue los archivos para ver las ubicaciones
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Fleet -->
                                <div class="card">
                                    <div class="data-card-header flex justify-between items-center">
                                        <div class="data-card-title">
                                            <iconify-icon icon="heroicons:truck"></iconify-icon>
                                            <span>Flota de Buses - María Angélica</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <input type="text" id="filter-maria-angelica" class="input-field text-xs py-1 px-2 w-32" placeholder="Filtrar...">
                                            <button id="export-maria-angelica-btn" class="btn btn-outline text-xs py-1 px-2">
                                                <iconify-icon icon="heroicons:arrow-down-tray"></iconify-icon>
                                                <span>Exportar</span>
                                            </button>
                                        </div>
                                    </div>
                                    <div id="maria-angelica-buses-container" class="data-card-body">
                                        <div class="bus-grid">
                                            <!-- Will be populated with JavaScript -->
                                            <div class="text-center py-6 text-slate-500 dark:text-slate-400 col-span-full">
                                                Cargue los archivos para ver la flota
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Reports Tab Content -->
                        <div id="reports-tab" class="tab-content">
                            <!-- Report Types -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 mb-3">
                                <div class="card cursor-pointer report-card" data-report="status">
                                    <div class="p-3 flex flex-col items-center text-center">
                                        <div class="w-10 h-10 rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 flex items-center justify-center text-xl mb-2">
                                            <iconify-icon icon="heroicons:signal"></iconify-icon>
                                        </div>
                                        <h3 class="font-semibold text-slate-900 dark:text-white">Reporte de Estado</h3>
                                        <p class="text-xs text-slate-600 dark:text-slate-400">Estado operativo completo de la flota</p>
                                    </div>
                                </div>
                                
                                <div class="card cursor-pointer report-card" data-report="fuel">
                                    <div class="p-3 flex flex-col items-center text-center">
                                        <div class="w-10 h-10 rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 flex items-center justify-center text-xl mb-2">
                                            <iconify-icon icon="heroicons:beaker"></iconify-icon>
                                        </div>
                                        <h3 class="font-semibold text-slate-900 dark:text-white">Reporte de Combustible</h3>
                                        <p class="text-xs text-slate-600 dark:text-slate-400">Análisis detallado de consumo</p>
                                    </div>
                                </div>
                                
                                <div class="card cursor-pointer report-card" data-report="maintenance">
                                    <div class="p-3 flex flex-col items-center text-center">
                                        <div class="w-10 h-10 rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 flex items-center justify-center text-xl mb-2">
                                            <iconify-icon icon="heroicons:wrench-screwdriver"></iconify-icon>
                                        </div>
                                        <h3 class="font-semibold text-slate-900 dark:text-white">Reporte de Mantención</h3>
                                        <p class="text-xs text-slate-600 dark:text-slate-400">Buses en mantención y panne</p>
                                    </div>
                                </div>
                                
                                <div class="card cursor-pointer report-card" data-report="terminals">
                                    <div class="p-3 flex flex-col items-center text-center">
                                        <div class="w-10 h-10 rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 flex items-center justify-center text-xl mb-2">
                                            <iconify-icon icon="heroicons:map"></iconify-icon>
                                        </div>
                                        <h3 class="font-semibold text-slate-900 dark:text-white">Reporte por Terminal</h3>
                                        <p class="text-xs text-slate-600 dark:text-slate-400">Análisis por terminal y ubicación</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Report Configuration -->
                            <div class="card mb-3">
                                <div class="data-card-header">
                                    <div class="data-card-title">
                                        <iconify-icon icon="heroicons:adjustments-horizontal"></iconify-icon>
                                        <span>Configuración del Reporte</span>
                                    </div>
                                </div>
                                <div class="data-card-body">
                                    <div id="report-config-container" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">Tipo de Reporte</label>
                                            <select id="report-type" class="input-field">
                                                <option value="status">Reporte de Estado</option>
                                                <option value="fuel">Reporte de Combustible</option>
                                                <option value="maintenance">Reporte de Mantención</option>
                                                <option value="terminals">Reporte por Terminal</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">Formato de Salida</label>
                                            <select id="report-format" class="input-field">
                                                <option value="excel">Excel (.xlsx)</option>
                                                <option value="pdf">PDF</option>
                                                <option value="csv">CSV</option>
                                                <option value="print">Imprimir</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">Filtrar por Terminal</label>
                                            <select id="report-terminal" class="input-field">
                                                <option value="all">Todos los Terminales</option>
                                                <option value="el-roble">El Roble</option>
                                                <option value="la-reina">La Reina</option>
                                                <option value="maria-angelica">María Angélica</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">Filtrar por Estado</label>
                                            <select id="report-status" class="input-field">
                                                <option value="all">Todos los Estados</option>
                                                <option value="operational">Operativos</option>
                                                <option value="maintenance">Mantención</option>
                                                <option value="panne">Panne</option>
                                                <option value="pending">Pendientes por Cargar</option>
                                            </select>
                                        </div>
                                        
                                        <div class="md:col-span-2">
                                            <label class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">Buses Específicos (opcional)</label>
                                            <input type="text" id="report-buses" class="input-field" placeholder="Ingrese patentes separadas por coma (Ej: LXWP57, LXWP58)">
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-end mt-3">
                                        <button id="generate-report-btn" class="btn btn-primary">
                                            <iconify-icon icon="heroicons:document-chart-bar"></iconify-icon>
                                            <span>Generar Reporte</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Report Preview -->
                            <div class="card">
                                <div class="data-card-header flex justify-between items-center">
                                    <div class="data-card-title">
                                        <iconify-icon icon="heroicons:document-text"></iconify-icon>
                                        <span>Vista Previa del Reporte</span>
                                    </div>
                                    <div>
                                        <button id="download-report-btn" class="btn btn-outline text-xs py-1 px-2" disabled>
                                            <iconify-icon icon="heroicons:arrow-down-tray"></iconify-icon>
                                            <span>Descargar</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="data-card-body">
                                    <div id="report-preview" class="bg-slate-50 dark:bg-slate-900 rounded-lg p-3 min-h-48">
                                        <div class="text-center py-6 text-slate-500 dark:text-slate-400">
                                            Configure y genere un reporte para ver la vista previa
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bus Detail Modal -->
    <div id="bus-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-base font-semibold text-slate-900 dark:text-white">Detalle de Bus</h3>
                <button class="modal-close btn-icon btn-outline">
                    <iconify-icon icon="heroicons:x-mark"></iconify-icon>
                </button>
            </div>
            <div class="modal-body" id="bus-detail-content">
                <!-- Bus details will be populated here -->
                <div class="text-center py-6 text-slate-500 dark:text-slate-400">
                    Cargando información del bus...
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close">Cerrar</button>
                <button class="btn btn-primary" id="print-bus-detail">
                    <iconify-icon icon="heroicons:printer" class="mr-1"></iconify-icon>
                    <span>Imprimir</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Edit Fleet Modal -->
    <div id="edit-fleet-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-base font-semibold text-slate-900 dark:text-white">Editar Flota</h3>
                <button class="modal-close btn-icon btn-outline">
                    <iconify-icon icon="heroicons:x-mark"></iconify-icon>
                </button>
            </div>
            <div class="modal-body">
                <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">
                    Ingrese las patentes de los buses, una por línea.
                </p>
                <textarea id="fleet-textarea" class="input-field w-full h-48" placeholder="Ej: LXWP57&#10;LXWP58&#10;LXWP59"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close">Cancelar</button>
                <button class="btn btn-primary" id="save-fleet">Guardar</button>
            </div>
        </div>
    </div>
    
    <!-- Import Fleet Modal -->
    <div id="import-fleet-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-base font-semibold text-slate-900 dark:text-white">Importar Flota</h3>
                <button class="modal-close btn-icon btn-outline">
                    <iconify-icon icon="heroicons:x-mark"></iconify-icon>
                </button>
            </div>
            <div class="modal-body">
                <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">
                    Pegue datos desde Excel o un archivo de texto. El sistema extraerá automáticamente las patentes válidas.
                </p>
                <textarea id="import-fleet-textarea" class="input-field w-full h-48" placeholder="Pegue sus datos aquí..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close">Cancelar</button>
                <button class="btn btn-primary" id="process-import-fleet">Importar</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <div id="toast-icon" class="toast-icon bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400">
            <iconify-icon icon="heroicons:check"></iconify-icon>
        </div>
        <div class="toast-content">
            <div id="toast-title" class="toast-title">Operación Exitosa</div>
            <div id="toast-message" class="toast-message">La operación se completó correctamente.</div>
        </div>
        <button id="toast-close" class="text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300">
            <iconify-icon icon="heroicons:x-mark"></iconify-icon>
        </button>
    </div>

<script>
// -------------------------------------------------------------
// GLOBAL VARIABLES
// -------------------------------------------------------------
let isDarkMode = false; // Default to light mode
let masterFleet = [];
let fuelData = null;
let operativityData = null;
let combinedData = {
    buses: {},
    terminals: {
        'El Roble': { buses: [], operationalCount: 0, maintenanceCount: 0, panneCount: 0, loadedCount: 0, totalLiters: 0 },
        'La Reina': { buses: [], operationalCount: 0, maintenanceCount: 0, panneCount: 0, loadedCount: 0, totalLiters: 0 },
        'María Angélica': { buses: [], operationalCount: 0, maintenanceCount: 0, panneCount: 0, loadedCount: 0, totalLiters: 0 }
    },
    status: {
        operational: 0,
        maintenance: 0,
        panne: 0,
        unknown: 0
    },
    fuel: {
        totalLiters: 0,
        loadedBuses: [],
        hourlyLoads: Array(24).fill(0),
        hourlyLiters: Array(24).fill(0),
        badLoads: [],
        terminals: {},
        pumps: {}
    },
    pendingBuses: [],
    maintenanceBuses: []
};
let charts = {};

// Default fleet data
const defaultFleet = `LXWP57
LXWP58
LXWP59
LXWP60
LXWP61
LXWP62
LXWP64
LXWP66
LXWP67
LXWP68
LXWP69
LXWP70
LXWP71
LXWP72
LXWP73
LXWP74
LXWP75
LXWP76
LXWP77
LXWP78
LXWP79
LXWP80
LXWP81
LXWP82
LXWP83
LXWP85
LXWP86
LXWP87
PFTV77
PFTW19
PFTW20
PFTW25
PFTW26
PFTW28
PFTW29
PFTW30
PFTW31
PFTW32
PFTW34
PFTW35
PFTW36
PFTW38
PFTW39
PFTW40
PFTW41
PFTW42
PFTW44
PFTW45
PFTW46
PFTW47
PFTW48
PFTW49
PFTW50
PFTW51
PFTW55
PFTW56
PFTW57
PFTW58
PFTW59
PFTW60
PFTW61
PFTW62
PFVG75
PFVG76
PFVG77
PFVG78
PFVG79
PFVG80
PFVG82
PFVG83
PFVG85
PFVG86
PFVG87
PFVG88
PFVG89
PFVG90
PFVG92
PFVG94
PFVG95
PFVG96
PFVG97
PFVG98
PFVG99
PFVH10
PFVH11
PFVH12
PFVH13
PFVH14
PFVH15
PFYC13
PFYC14
PFYC16
PFYC17
PFYC19
PFYC20
PFYC25
PFYC26
PFYC27
PFYC28
PFYC29
PFYC31
PFYC32
PFYC33
PFYC34
PFYC35
PFYC36
PFYC37
PFYC43
PFYC44
PFYC46
PFYC49
PFYC50
PFYC53
PFYC55
PFYC57
PFYC58
PFYC60
PFYC61
PFYC64
PFYC65
PFYC66
PFYC68
PFYC69
PFYC70
PFYC72
PFYC75
PFYC76
PFYC77
PFYC79
PFYC80
PFYC81
PFYC85
PFYC88
PFYC90
PFZK83
PFZK91
PGBF59
PGBY67
PGBY72
PGBY73
PGBY83
PGKP67
PGLD42
PGLD67
PGRZ67
PGTT95
PGTV12
PGWT98
SHCV78
SHCV83
SHCX39
SHCY22
SHCY28
SHXD75
SHXD77
SHXD79
SHXD85
SHXF13
SHXF14
SHXF29
SHXF31
SHXF84
SHXF85
SHXF87
SHXF88
SHXF90
SHXF92
SHXF93
SHXF97
SHXG36
SHXG38
SJPB21
SJPB25
SJPC73
SJPD42
SJPD44
SJPD71
SJPD72
SJPD97
SJPF43
SJPF44
SKPH70
SKPH73
SKPJ90
SKPK18
SKPK19
SKPK20
SKPK21
SKPK22
SKPK23
SKPK25
SKPK26
SKPK27
SKPK28
SKPK31
SKPK32
SKPK34
SKPK35
SKPK37
SKPK39
SKPK40
SKPK42
SKPK44
SKPK45
SKPK62
SKPK63
SKPL28
SKPL30
SKPL33
SKPL34
SKPL36`;

// Mapping of internal numbers to PPUs (would be populated from data)
const internalToPPU = {};

// -------------------------------------------------------------
// INITIALIZATION
// -------------------------------------------------------------
document.addEventListener('DOMContentLoaded', () => {
    // Initialize the app
    initApp();
});

function initApp() {
    // Load default fleet
    loadDefaultFleet();
    
    // Initialize event listeners
    initEventListeners();
    
    // Initialize empty charts
    initEmptyCharts();
}

function loadDefaultFleet() {
    masterFleet = defaultFleet.split('\n').filter(line => line.trim() !== '');
    updateFleetPreview();
}

function initEventListeners() {
    // File inputs
    const fuelFileInput = document.getElementById('fuel-file');
    const operativityFileInput = document.getElementById('operativity-file');
    const welcomeFuelFileInput = document.getElementById('welcome-fuel-file');
    const welcomeOperativityFileInput = document.getElementById('welcome-operativity-file');
    const processButton = document.getElementById('process-button');
    const welcomeProcessButton = document.getElementById('welcome-process-button');
    
    fuelFileInput.addEventListener('change', handleFuelFileSelection);
    operativityFileInput.addEventListener('change', handleOperativityFileSelection);
    welcomeFuelFileInput.addEventListener('change', (e) => {
        fuelFileInput.files = e.target.files;
        handleFuelFileSelection(e);
    });
    welcomeOperativityFileInput.addEventListener('change', (e) => {
        operativityFileInput.files = e.target.files;
        handleOperativityFileSelection(e);
    });
    processButton.addEventListener('click', processFiles);
    welcomeProcessButton.addEventListener('click', processFiles);
    
    // Fleet management
    const editFleetBtn = document.getElementById('edit-fleet');
    const importFleetBtn = document.getElementById('import-fleet');
    const saveFleetBtn = document.getElementById('save-fleet');
    const processImportFleetBtn = document.getElementById('process-import-fleet');
    
    editFleetBtn.addEventListener('click', showEditFleetModal);
    importFleetBtn.addEventListener('click', showImportFleetModal);
    saveFleetBtn.addEventListener('click', saveFleet);
    processImportFleetBtn.addEventListener('click', processImportFleet);
    
    // Layout toggles
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const themeToggle = document.getElementById('theme-toggle');
    
    sidebarToggle.addEventListener('click', toggleSidebar);
    sidebarOverlay.addEventListener('click', closeSidebar);
    themeToggle.addEventListener('click', toggleTheme);
    
    // Tabs
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const tabId = tab.getAttribute('data-tab');
            activateTab(tabId);
        });
    });
    
    // Terminal selection in Terminals tab
    const terminalCards = document.querySelectorAll('.terminal-card');
    terminalCards.forEach(card => {
        card.addEventListener('click', () => {
            const terminalId = card.getAttribute('data-terminal');
            showTerminalDetails(terminalId);
        });
    });
    
    // Report selection in Reports tab
    const reportCards = document.querySelectorAll('.report-card');
    reportCards.forEach(card => {
        card.addEventListener('click', () => {
            const reportId = card.getAttribute('data-report');
            document.getElementById('report-type').value = reportId;
        });
    });
    
    // Search functionality
    const globalSearch = document.getElementById('global-search');
    const searchResults = document.getElementById('search-results');
    const quickSearch = document.getElementById('quick-search');
    const quickSearchBtn = document.getElementById('quick-search-btn');
    
    globalSearch.addEventListener('input', handleGlobalSearch);
    globalSearch.addEventListener('blur', () => {
        setTimeout(() => {
            searchResults.classList.remove('show');
        }, 200);
    });
    globalSearch.addEventListener('focus', () => {
        if (globalSearch.value.trim().length > 0) {
            handleGlobalSearch();
        }
    });
    
    quickSearchBtn.addEventListener('click', () => {
        performQuickSearch(quickSearch.value);
    });
    quickSearch.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            performQuickSearch(quickSearch.value);
        }
    });
    
    // Dashboard filter
    const dashboardFilter = document.getElementById('dashboard-filter');
    const filterChips = document.querySelectorAll('.filter-chip');
    
    dashboardFilter.addEventListener('input', filterDashboard);
    filterChips.forEach(chip => {
        chip.addEventListener('click', () => {
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            const filter = chip.getAttribute('data-filter');
            applyDashboardFilter(filter);
        });
    });
    
    // Table filters
    const filterInputs = document.querySelectorAll('input[id^="filter-"]');
    filterInputs.forEach(input => {
        const tableId = input.id.replace('filter-', '');
        input.addEventListener('input', () => filterTable(tableId, input.value));
    });
    
    // Sort selectors
    const sortSelectors = document.querySelectorAll('select[id^="sort-"]');
    sortSelectors.forEach(selector => {
        const tableId = selector.id.replace('sort-', '');
        selector.addEventListener('change', () => sortTable(tableId, selector.value));
    });
    
    // Export buttons
    const exportButtons = document.querySelectorAll('button[id$="-btn"][id^="export-"]');
    exportButtons.forEach(button => {
        const dataType = button.id.replace('export-', '').replace('-btn', '');
        button.addEventListener('click', () => exportData(dataType));
    });
    
    // Generate Report
    const generateReportBtn = document.getElementById('generate-report-btn');
    const downloadReportBtn = document.getElementById('download-report-btn');
    
    generateReportBtn.addEventListener('click', generateReport);
    downloadReportBtn.addEventListener('click', downloadReport);
    
    // Modal close buttons
    const modalCloseButtons = document.querySelectorAll('.modal-close');
    modalCloseButtons.forEach(button => {
        button.addEventListener('click', () => {
            const modal = button.closest('.modal');
            closeModal(modal);
        });
    });
    
    // Toast close
    const toastClose = document.getElementById('toast-close');
    toastClose.addEventListener('click', hideToast);
    
    // Print bus detail
    const printBusDetailBtn = document.getElementById('print-bus-detail');
    printBusDetailBtn.addEventListener('click', printBusDetail);
    
    // Refresh data
    const refreshDataBtn = document.getElementById('refresh-data');
    refreshDataBtn.addEventListener('click', refreshData);
    
    // Additional action buttons
    const exportDataBtn = document.getElementById('export-data-btn');
    const printReportBtn = document.getElementById('print-report-btn');
    
    exportDataBtn.addEventListener('click', exportCurrentView);
    printReportBtn.addEventListener('click', printCurrentView);
}

function initEmptyCharts() {
    // Create empty charts for initial display
    const fleetStatusCtx = document.getElementById('fleet-status-chart').getContext('2d');
    const terminalDistributionCtx = document.getElementById('terminal-distribution-chart').getContext('2d');
    const hourlyCtx = document.getElementById('hourly-chart').getContext('2d');
    const terminalConsumptionCtx = document.getElementById('terminal-consumption-chart').getContext('2d');
    const hourlyConsumptionCtx = document.getElementById('hourly-consumption-chart').getContext('2d');
    const terminalStatusCtx = document.getElementById('terminal-status-chart').getContext('2d');
    const elRobleStatusCtx = document.getElementById('el-roble-status-chart').getContext('2d');
    const laReinaStatusCtx = document.getElementById('la-reina-status-chart').getContext('2d');
    const mariaAngelicaStatusCtx = document.getElementById('maria-angelica-status-chart').getContext('2d');
    
    // Set Chart.js defaults
    Chart.defaults.color = isDarkMode ? '#94a3b8' : '#64748b';
    Chart.defaults.borderColor = isDarkMode ? 'rgba(71, 85, 105, 0.2)' : 'rgba(203, 213, 225, 0.3)';
    Chart.defaults.font.size = 10;
    Chart.defaults.font.family = "'Inter', sans-serif";
    
    // Fleet Status Chart
    charts.fleetStatus = new Chart(fleetStatusCtx, {
        type: 'doughnut',
        data: {
            labels: ['Operativos', 'Mantención', 'Panne', 'Sin Datos'],
            datasets: [{
                data: [0, 0, 0, 100],
                backgroundColor: [
                    'rgba(16, 185, 129, 0.7)',
                    'rgba(245, 158, 11, 0.7)',
                    'rgba(239, 68, 68, 0.7)',
                    'rgba(148, 163, 184, 0.7)'
                ],
                borderColor: isDarkMode ? '#1e293b' : '#ffffff',
                borderWidth: 1,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 10,
                        padding: 10
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${context.label}: ${percentage}%`;
                        }
                    }
                }
            }
        }
    });
    
    // Terminal Distribution Chart
    charts.terminalDistribution = new Chart(terminalDistributionCtx, {
        type: 'bar',
        data: {
            labels: ['El Roble', 'La Reina', 'María Angélica'],
            datasets: [{
                label: 'Buses',
                data: [0, 0, 0],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.7)',
                    'rgba(245, 158, 11, 0.7)',
                    'rgba(16, 185, 129, 0.7)'
                ],
                borderColor: [
                    'rgba(59, 130, 246, 1)',
                    'rgba(245, 158, 11, 1)',
                    'rgba(16, 185, 129, 1)'
                ],
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true
                },
                y: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
    
    // Hourly Chart
    charts.hourly = new Chart(hourlyCtx, {
        type: 'line',
        data: {
            labels: Array.from({ length: 24 }, (_, i) => `${i.toString().padStart(2, '0')}:00`),
            datasets: [{
                label: 'Cargas',
                data: Array(24).fill(0),
                borderColor: 'rgba(14, 165, 233, 1)',
                backgroundColor: 'rgba(14, 165, 233, 0.1)',
                fill: true,
                tension: 0.4,
                pointBackgroundColor: 'rgba(14, 165, 233, 1)',
                pointBorderColor: isDarkMode ? '#1e293b' : '#ffffff',
                pointBorderWidth: 1,
                pointRadius: 2,
                pointHoverRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxRotation: 0,
                        autoSkip: true,
                        maxTicksLimit: 8
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
    
    // Terminal Consumption Chart
    charts.terminalConsumption = new Chart(terminalConsumptionCtx, {
        type: 'pie',
        data: {
            labels: ['El Roble', 'La Reina', 'María Angélica'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.7)',
                    'rgba(245, 158, 11, 0.7)',
                    'rgba(16, 185, 129, 0.7)'
                ],
                borderColor: isDarkMode ? '#1e293b' : '#ffffff',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 10,
                        padding: 10
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${context.label}: ${value.toLocaleString('es-CL')} Lts (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    // Hourly Consumption Chart
    charts.hourlyConsumption = new Chart(hourlyConsumptionCtx, {
        type: 'bar',
        data: {
            labels: Array.from({ length: 24 }, (_, i) => `${i.toString().padStart(2, '0')}:00`),
            datasets: [{
                label: 'Litros',
                data: Array(24).fill(0),
                backgroundColor: 'rgba(14, 165, 233, 0.7)',
                borderColor: 'rgba(14, 165, 233, 1)',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxRotation: 0,
                        autoSkip: true,
                        maxTicksLimit: 8
                    }
                },
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Terminal Status Chart
    charts.terminalStatus = new Chart(terminalStatusCtx, {
        type: 'bar',
        data: {
            labels: ['El Roble', 'La Reina', 'María Angélica'],
            datasets: [
                {
                    label: 'Operativos',
                    data: [0, 0, 0],
                    backgroundColor: 'rgba(16, 185, 129, 0.7)',
                    borderColor: 'rgba(16, 185, 129, 1)',
                    borderWidth: 1,
                    borderRadius: 4
                },
                {
                    label: 'Mantención',
                    data: [0, 0, 0],
                    backgroundColor: 'rgba(245, 158, 11, 0.7)',
                    borderColor: 'rgba(245, 158, 11, 1)',
                    borderWidth: 1,
                    borderRadius: 4
                },
                {
                    label: 'Panne',
                    data: [0, 0, 0],
                    backgroundColor: 'rgba(239, 68, 68, 0.7)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 1,
                    borderRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 10,
                        padding: 5
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    }
                },
                y: {
                    beginAtZero: true,
                    stacked: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
    
    // Terminal-specific status charts
    const terminalChartOptions = {
        type: 'doughnut',
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 10,
                        padding: 5
                    }
                }
            }
        }
    };
    
    charts.elRobleStatus = new Chart(elRobleStatusCtx, {
        ...terminalChartOptions,
        data: {
            labels: ['Operativos', 'Mantención', 'Panne'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: [
                    'rgba(16, 185, 129, 0.7)',
                    'rgba(245, 158, 11, 0.7)',
                    'rgba(239, 68, 68, 0.7)'
                ],
                borderColor: isDarkMode ? '#1e293b' : '#ffffff',
                borderWidth: 1
            }]
        }
    });
    
    charts.laReinaStatus = new Chart(laReinaStatusCtx, {
        ...terminalChartOptions,
        data: {
            labels: ['Operativos', 'Mantención', 'Panne'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: [
                    'rgba(16, 185, 129, 0.7)',
                    'rgba(245, 158, 11, 0.7)',
                    'rgba(239, 68, 68, 0.7)'
                ],
                borderColor: isDarkMode ? '#1e293b' : '#ffffff',
                borderWidth: 1
            }]
        }
    });
    
    charts.mariaAngelicaStatus = new Chart(mariaAngelicaStatusCtx, {
        ...terminalChartOptions,
        data: {
            labels: ['Operativos', 'Mantención', 'Panne'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: [
                    'rgba(16, 185, 129, 0.7)',
                    'rgba(245, 158, 11, 0.7)',
                    'rgba(239, 68, 68, 0.7)'
                ],
                borderColor: isDarkMode ? '#1e293b' : '#ffffff',
                borderWidth: 1
            }]
        }
    });
}

// -------------------------------------------------------------
// FILE HANDLING
// -------------------------------------------------------------
function handleFuelFileSelection(event) {
    const file = event.target.files[0];
    const fuelFileText = document.getElementById('fuel-file-text');
    const fuelFileInfo = document.getElementById('fuel-file-info');
    
    if (!file) {
        fuelFileText.textContent = 'Combustible';
        fuelFileInfo.innerHTML = '';
        checkProcessButtonState();
        return;
    }
    
    const fileSize = (file.size / 1024 / 1024).toFixed(2);
    fuelFileText.textContent = 'Archivo seleccionado';
    fuelFileInfo.innerHTML = `
        <div class="file-info">
            <div class="file-info-icon">
                <iconify-icon icon="heroicons:document-text"></iconify-icon>
            </div>
            <div class="file-info-details">
                <div class="file-info-name">${file.name}</div>
                <div class="file-info-meta">${fileSize} MB • Excel</div>
            </div>
        </div>
    `;
    
    checkProcessButtonState();
}

function handleOperativityFileSelection(event) {
    const file = event.target.files[0];
    const operativityFileText = document.getElementById('operativity-file-text');
    const operativityFileInfo = document.getElementById('operativity-file-info');
    
    if (!file) {
        operativityFileText.textContent = 'Operatividad';
        operativityFileInfo.innerHTML = '';
        checkProcessButtonState();
        return;
    }
    
    const fileSize = (file.size / 1024 / 1024).toFixed(2);
    operativityFileText.textContent = 'Archivo seleccionado';
    operativityFileInfo.innerHTML = `
        <div class="file-info">
            <div class="file-info-icon">
                <iconify-icon icon="heroicons:clipboard-document-check"></iconify-icon>
            </div>
            <div class="file-info-details">
                <div class="file-info-name">${file.name}</div>
                <div class="file-info-meta">${fileSize} MB • Excel</div>
            </div>
        </div>
    `;
    
    checkProcessButtonState();
}

function checkProcessButtonState() {
    const fuelFileInput = document.getElementById('fuel-file');
    const operativityFileInput = document.getElementById('operativity-file');
    const processButton = document.getElementById('process-button');
    const welcomeProcessButton = document.getElementById('welcome-process-button');
    
    const fuelFile = fuelFileInput.files[0];
    const operativityFile = operativityFileInput.files[0];
    
    const isReady = fuelFile && operativityFile && masterFleet.length > 0;
    
    processButton.disabled = !isReady;
    if (welcomeProcessButton) {
        welcomeProcessButton.disabled = !isReady;
    }
}

function processFiles() {
    const fuelFileInput = document.getElementById('fuel-file');
    const operativityFileInput = document.getElementById('operativity-file');
    const processButton = document.getElementById('process-button');
    const welcomeProcessButton = document.getElementById('welcome-process-button');
    
    const fuelFile = fuelFileInput.files[0];
    const operativityFile = operativityFileInput.files[0];
    
    if (!fuelFile || !operativityFile) {
        showToast('Error', 'Debe seleccionar ambos archivos para continuar', 'error');
        return;
    }
    
    // Show loading state
    processButton.disabled = true;
    processButton.innerHTML = '<div class="loading-spinner mr-2"></div> <span>Procesando...</span>';
    
    if (welcomeProcessButton) {
        welcomeProcessButton.disabled = true;
        welcomeProcessButton.innerHTML = '<div class="loading-spinner mr-2"></div> <span>Procesando...</span>';
    }
    
    // Process both files
    Promise.all([
        processFuelFile(fuelFile),
        processOperativityFile(operativityFile)
    ])
    .then(([fuelResult, operativityResult]) => {
        // Store the processed data
        fuelData = fuelResult;
        operativityData = operativityResult;
        
        // Combine data for analysis
        combineData();
        
        // Render dashboard with combined data
        renderDashboard();
        
        // Show success message
        showToast('Éxito', 'Archivos procesados correctamente', 'success');
    })
    .catch(error => {
        console.error('Error processing files:', error);
        showToast('Error', error.message || 'Error al procesar los archivos', 'error');
    })
    .finally(() => {
        // Reset button state
        processButton.disabled = false;
        processButton.innerHTML = '<iconify-icon icon="heroicons:arrow-path" class="mr-1"></iconify-icon> <span>Procesar Datos</span>';
        
        if (welcomeProcessButton) {
            welcomeProcessButton.disabled = false;
            welcomeProcessButton.innerHTML = '<iconify-icon icon="heroicons:arrow-path" class="mr-2"></iconify-icon> <span>Procesar Archivos</span>';
        }
    });
}

function processFuelFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = (event) => {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { range: 2, defval: "" });
                
                if (jsonData.length === 0) {
                    throw new Error("El archivo de combustible parece estar vacío.");
                }
                
                // Process the fuel data
                const processedData = processFuelData(jsonData);
                resolve(processedData);
            } catch (error) {
                reject(new Error(`Error en el archivo de combustible: ${error.message}`));
            }
        };
        
        reader.onerror = () => {
            reject(new Error("No se pudo leer el archivo de combustible."));
        };
        
        reader.readAsArrayBuffer(file);
    });
}

function processOperativityFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = (event) => {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                
                // Check if required sheets exist
                const requiredSheets = ['US6 EL ROBLE', 'LA REINA'];
                for (const sheet of requiredSheets) {
                    if (!workbook.SheetNames.includes(sheet)) {
                        throw new Error(`Hoja '${sheet}' no encontrada en el archivo de operatividad.`);
                    }
                }
                
                // Process El Roble sheet
                const elRobleSheet = workbook.Sheets['US6 EL ROBLE'];
                const elRobleData = XLSX.utils.sheet_to_json(elRobleSheet, { range: 5, defval: "" });
                
                // Process La Reina sheet
                const laReinaSheet = workbook.Sheets['LA REINA'];
                const laReinaData = XLSX.utils.sheet_to_json(laReinaSheet, { range: 5, defval: "" });
                
                if (elRobleData.length === 0 && laReinaData.length === 0) {
                    throw new Error("El archivo de operatividad no contiene datos válidos.");
                }
                
                // Process the operativity data
                const processedData = processOperativityData(elRobleData, laReinaData);
                resolve(processedData);
            } catch (error) {
                reject(new Error(`Error en el archivo de operatividad: ${error.message}`));
            }
        };
        
        reader.onerror = () => {
            reject(new Error("No se pudo leer el archivo de operatividad."));
        };
        
        reader.readAsArrayBuffer(file);
    });
}

function processFuelData(jsonData) {
    // First, identify key columns
    const firstRow = jsonData[0];
    const keys = {
        plate: findKey(firstRow, ['patente', 'ppu', 'placa']),
        liters: findKey(firstRow, ['litros', 'cantidad', 'volumen']),
        loadedBy: findKey(firstRow, ['cargado por', 'origen']),
        terminal: findKey(firstRow, ['terminal', 'estación']),
        pump: findKey(firstRow, ['surtidor', 'bomba']),
        model: findKey(firstRow, ['modelo', 'modelo chasis', 'tipo']),
        time: findKey(firstRow, ['hora', 'tiempo', 'fecha y hora']),
        internalNum: findKey(firstRow, ['número interno', 'interno', 'id']),
        driver: findKey(firstRow, ['nombre conductor', 'conductor', 'operador'])
    };
    
    // Validate essential columns
    const missingKeys = [];
    if (!keys.plate) missingKeys.push('Patente/PPU');
    if (!keys.liters) missingKeys.push('Litros');
    
    if (missingKeys.length > 0) {
        throw new Error(`Columnas esenciales no encontradas: ${missingKeys.join(', ')}`);
    }
    
    // Process the data
    const processedData = {
        rows: jsonData,
        keys: keys,
        summary: {
            totalLiters: 0,
            loadedBuses: new Set(),
            terminals: {},
            pumps: {},
            hourlyLoads: Array(24).fill(0),
            hourlyLiters: Array(24).fill(0),
            badLoads: []
        }
    };
    
    // Map internal numbers to PPUs
    jsonData.forEach(row => {
        const plate = row[keys.plate]?.toString().trim().toUpperCase();
        const internalNum = row[keys.internalNum]?.toString().trim();
        
        if (plate && internalNum) {
            internalToPPU[internalNum] = plate;
        }
    });
    
    // Calculate summary data
    jsonData.forEach(row => {
        const liters = parseFloat(row[keys.liters]) || 0;
        const plate = row[keys.plate]?.toString().trim().toUpperCase();
        const loadedBy = row[keys.loadedBy]?.toString().trim().toLowerCase();
        const terminal = row[keys.terminal]?.toString().trim() || 'No especificado';
        const pump = row[keys.pump]?.toString().trim() || 'No especificado';
        
        if (liters > 0 && plate) {
            processedData.summary.totalLiters += liters;
            processedData.summary.loadedBuses.add(plate);
            
            // Update terminal stats
            if (!processedData.summary.terminals[terminal]) {
                processedData.summary.terminals[terminal] = {
                    totalLiters: 0,
                    loadedBuses: new Set(),
                    pumps: {}
                };
            }
            processedData.summary.terminals[terminal].totalLiters += liters;
            processedData.summary.terminals[terminal].loadedBuses.add(plate);
            
            // Update pump stats
            if (!processedData.summary.pumps[pump]) {
                processedData.summary.pumps[pump] = {
                    totalLiters: 0,
                    loadedBuses: new Set()
                };
            }
            processedData.summary.pumps[pump].totalLiters += liters;
            processedData.summary.pumps[pump].loadedBuses.add(plate);
            
            // Update hourly stats
            let hour = -1;
            const time = row[keys.time];
            
            if (time instanceof Date) {
                hour = time.getHours();
            } else if (typeof time === 'number' && time < 1) {
                const parsedDate = XLSX.SSF.parse_date_code(time);
                hour = parsedDate.H;
            } else if (typeof time === 'string') {
                const timeParts = time.split(':');
                if (timeParts.length >= 2) {
                    hour = parseInt(timeParts[0], 10);
                }
            }
            
            if (hour >= 0 && hour < 24) {
                processedData.summary.hourlyLoads[hour]++;
                processedData.summary.hourlyLiters[hour] += liters;
            }
        }
        
        // Identify bad loads
        if (loadedBy === 'carga masiva' || loadedBy === 'manual') {
            processedData.summary.badLoads.push({
                plate: plate,
                liters: liters,
                driver: row[keys.driver] || 'N/A',
                terminal: terminal
            });
        }
    });
    
    // Convert Sets to Arrays for easier handling
    processedData.summary.loadedBuses = Array.from(processedData.summary.loadedBuses);
    
    Object.keys(processedData.summary.terminals).forEach(terminal => {
        processedData.summary.terminals[terminal].loadedBuses = 
            Array.from(processedData.summary.terminals[terminal].loadedBuses);
    });
    
    Object.keys(processedData.summary.pumps).forEach(pump => {
        processedData.summary.pumps[pump].loadedBuses = 
            Array.from(processedData.summary.pumps[pump].loadedBuses);
    });
    
    return processedData;
}

function processOperativityData(elRobleData, laReinaData) {
    // Define expected column mappings for both terminals
    const elRobleKeys = {
        code: findKeyInOperativityData(elRobleData[0], ['COD', 'CODIGO']),
        plate: findKeyInOperativityData(elRobleData[0], ['PPU', 'PATENTE']),
        zone: findKeyInOperativityData(elRobleData[0], ['ZONA']),
        service: findKeyInOperativityData(elRobleData[0], ['SERVICIO']),
        operational: findKeyInOperativityData(elRobleData[0], ['OPER', 'OPERATIVO']),
        maintenance: findKeyInOperativityData(elRobleData[0], ['MANT', 'MANTENIMIENTO']),
        quality: findKeyInOperativityData(elRobleData[0], ['CALIDAD']),
        detail: findKeyInOperativityData(elRobleData[0], ['Detalle Panne', 'DETALLE']),
        observations: findKeyInOperativityData(elRobleData[0], ['Observaciones', 'OBSERVACIONES']),
        location: findKeyInOperativityData(elRobleData[0], ['UBICACIÓN', 'UBICACION']),
        status: findKeyInOperativityData(elRobleData[0], ['Estado', 'ESTADO']),
        assignment: findKeyInOperativityData(elRobleData[0], ['Asignacion Interna', 'ASIGNACION'])
    };
    
    const laReinaKeys = {
        code: findKeyInOperativityData(laReinaData[0], ['COD', 'CODIGO']),
        plate: findKeyInOperativityData(laReinaData[0], ['PPU', 'PATENTE']),
        zone: findKeyInOperativityData(laReinaData[0], ['ZONA']),
        service: findKeyInOperativityData(laReinaData[0], ['SERVICIO']),
        operational: findKeyInOperativityData(laReinaData[0], ['OPER', 'OPERATIVO']),
        maintenance: findKeyInOperativityData(laReinaData[0], ['MANT', 'MANTENIMIENTO']),
        quality: findKeyInOperativityData(laReinaData[0], ['CALIDAD']),
        detail: findKeyInOperativityData(laReinaData[0], ['Detalle Panne', 'DETALLE']),
        observations: findKeyInOperativityData(laReinaData[0], ['Observaciones', 'OBSERVACIONES']),
        location: findKeyInOperativityData(laReinaData[0], ['UBICACIÓN', 'UBICACION']),
        status: findKeyInOperativityData(laReinaData[0], ['Estado', 'ESTADO'])
    };
    
    // Validate essential columns
    for (const terminal of ['El Roble', 'La Reina']) {
        const keys = terminal === 'El Roble' ? elRobleKeys : laReinaKeys;
        const missingKeys = [];
        
        if (!keys.plate) missingKeys.push('PPU');
        if (!keys.location) missingKeys.push('UBICACIÓN');
        
        if (missingKeys.length > 0) {
            throw new Error(`Columnas esenciales no encontradas en ${terminal}: ${missingKeys.join(', ')}`);
        }
    }
    
    // Process data for each terminal
    const processedElRoble = processTerminalData(elRobleData, elRobleKeys, 'El Roble');
    const processedLaReina = processTerminalData(laReinaData, laReinaKeys, 'La Reina');
    
    // Combine results
    return {
        elRoble: processedElRoble,
        laReina: processedLaReina,
        summary: {
            totalBuses: processedElRoble.length + processedLaReina.length,
            operational: processedElRoble.filter(bus => bus.status === 'operational').length + 
                         processedLaReina.filter(bus => bus.status === 'operational').length,
            maintenance: processedElRoble.filter(bus => bus.status === 'maintenance').length + 
                         processedLaReina.filter(bus => bus.status === 'maintenance').length,
            panne: processedElRoble.filter(bus => bus.status === 'panne').length + 
                   processedLaReina.filter(bus => bus.status === 'panne').length
        }
    };
}

function processTerminalData(data, keys, terminalName) {
    return data
        .filter(row => row[keys.plate] && typeof row[keys.plate] === 'string' && row[keys.plate].trim() !== '')
        .map(row => {
            const plate = row[keys.plate].toString().trim().toUpperCase();
            let status = 'unknown';
            
            // Check explicit status column first
            if (keys.status) {
                const statusValue = row[keys.status];
                if (statusValue === '' || statusValue === undefined) {
                    // If status is empty, assume operational
                    status = 'operational';
                } else if (statusValue === 'NO' || statusValue.toString().toUpperCase() === 'PANNE') {
                    status = 'panne';
                }
            } else {
                // Otherwise check operational and maintenance columns
                const operational = row[keys.operational];
                const maintenance = row[keys.maintenance];
                
                if (operational === 'SI' || operational === 'S' || operational === 1 || operational === '1' || operational === true || operational === '') {
                    status = 'operational';
                } else if (maintenance === 'SI' || maintenance === 'S' || maintenance === 1 || maintenance === '1' || maintenance === true) {
                    status = 'maintenance';
                } else {
                    status = 'panne';
                }
            }
            
            // Get detail info - check observations for panne details
            let detail = row[keys.detail] || '';
            if (status === 'panne' && !detail && keys.observations) {
                detail = row[keys.observations] || '';
            }
            
            return {
                plate: plate,
                terminal: terminalName,
                zone: row[keys.zone] || '',
                service: row[keys.service] || '',
                status: status,
                detail: detail,
                observations: row[keys.observations] || '',
                location: row[keys.location] || '',
                assignment: row[keys.assignment] || '',
                code: row[keys.code] || ''
            };
        });
}

function findKey(obj, possibleMatches) {
    const keys = Object.keys(obj);
    for (const match of possibleMatches) {
        const foundKey = keys.find(key => {
            if (!key) return false;
            return key.toString().toLowerCase().includes(match.toLowerCase());
        });
        if (foundKey) return foundKey;
    }
    return null;
}

function findKeyInOperativityData(obj, possibleMatches) {
    if (!obj) return null;
    
    const keys = Object.keys(obj);
    for (const match of possibleMatches) {
        const foundKey = keys.find(key => {
            if (!key) return false;
            return key.toString().toUpperCase().includes(match.toUpperCase());
        });
        if (foundKey) return foundKey;
    }
    return null;
}

function combineData() {
    if (!fuelData || !operativityData) {
        showToast('Error', 'No hay datos para combinar', 'error');
        return;
    }
    
    // Reset combined data
    combinedData = {
        buses: {},
        terminals: {
            'El Roble': { buses: [], operationalCount: 0, maintenanceCount: 0, panneCount: 0, loadedCount: 0, totalLiters: 0 },
            'La Reina': { buses: [], operationalCount: 0, maintenanceCount: 0, panneCount: 0, loadedCount: 0, totalLiters: 0 },
            'María Angélica': { buses: [], operationalCount: 0, maintenanceCount: 0, panneCount: 0, loadedCount: 0, totalLiters: 0 }
        },
        status: {
            operational: 0,
            maintenance: 0,
            panne: 0,
            unknown: 0
        },
        fuel: {
            totalLiters: fuelData.summary.totalLiters,
            loadedBuses: fuelData.summary.loadedBuses,
            hourlyLoads: fuelData.summary.hourlyLoads,
            hourlyLiters: fuelData.summary.hourlyLiters,
            badLoads: fuelData.summary.badLoads,
            terminals: fuelData.summary.terminals,
            pumps: fuelData.summary.pumps
        },
        locations: {},
        pendingBuses: [],
        maintenanceBuses: []
    };
    
    // First pass: Process all buses from master fleet
    masterFleet.forEach(plate => {
        combinedData.buses[plate] = {
            plate: plate,
            loaded: false,
            totalLiters: 0,
            loadCount: 0,
            status: 'unknown',
            terminal: '',
            location: '',
            detail: '',
            service: ''
        };
    });
    
    // Second pass: Add fuel data
    fuelData.summary.loadedBuses.forEach(plate => {
        // If the bus is not in the master fleet, add it
        if (!combinedData.buses[plate]) {
            combinedData.buses[plate] = {
                plate: plate,
                loaded: true,
                totalLiters: 0,
                loadCount: 0,
                status: 'unknown',
                terminal: '',
                location: '',
                detail: '',
                service: ''
            };
            
            // Also add to master fleet
            masterFleet.push(plate);
        }
        
        // Update fuel info
        combinedData.buses[plate].loaded = true;
        
        // Calculate total liters and load count
        let totalLiters = 0;
        let loadCount = 0;
        let lastLoadTime = null;
        
        fuelData.rows.forEach(row => {
            const rowPlate = row[fuelData.keys.plate]?.toString().trim().toUpperCase();
            if (rowPlate === plate) {
                const liters = parseFloat(row[fuelData.keys.liters]) || 0;
                totalLiters += liters;
                loadCount++;
                
                // Update terminal if not set
                if (!combinedData.buses[plate].terminal && row[fuelData.keys.terminal]) {
                    combinedData.buses[plate].terminal = row[fuelData.keys.terminal].trim();
                }
                
                // Update last load time
                const time = row[fuelData.keys.time];
                if (time && (!lastLoadTime || (time instanceof Date && time > lastLoadTime))) {
                    lastLoadTime = time;
                }
            }
        });
        
        combinedData.buses[plate].totalLiters = totalLiters;
        combinedData.buses[plate].loadCount = loadCount;
        combinedData.buses[plate].lastLoadTime = lastLoadTime;
    });
    
    // Third pass: Add operativity data
    // Process El Roble buses
    operativityData.elRoble.forEach(bus => {
        const plate = bus.plate;
        
        // If the bus is not in the combined data, add it
        if (!combinedData.buses[plate]) {
            combinedData.buses[plate] = {
                plate: plate,
                loaded: false,
                totalLiters: 0,
                loadCount: 0,
                status: 'unknown',
                terminal: '',
                location: '',
                detail: '',
                service: ''
            };
            
            // Also add to master fleet if not already there
            if (!masterFleet.includes(plate)) {
                masterFleet.push(plate);
            }
        }
        
        // Update operativity info
        combinedData.buses[plate].status = bus.status;
        combinedData.buses[plate].terminal = 'El Roble';
        combinedData.buses[plate].location = bus.location;
        combinedData.buses[plate].detail = bus.detail;
        combinedData.buses[plate].service = bus.service;
        combinedData.buses[plate].observations = bus.observations;
        
        // Track location stats
        if (bus.location) {
            if (!combinedData.locations[bus.location]) {
                combinedData.locations[bus.location] = {
                    count: 0,
                    terminal: 'El Roble',
                    buses: []
                };
            }
            combinedData.locations[bus.location].count++;
            combinedData.locations[bus.location].buses.push(plate);
        }
        
        // Update terminal stats
        combinedData.terminals['El Roble'].buses.push(plate);
        if (bus.status === 'operational') {
            combinedData.terminals['El Roble'].operationalCount++;
            combinedData.status.operational++;
        } else if (bus.status === 'maintenance') {
            combinedData.terminals['El Roble'].maintenanceCount++;
            combinedData.status.maintenance++;
        } else if (bus.status === 'panne') {
            combinedData.terminals['El Roble'].panneCount++;
            combinedData.status.panne++;
        } else {
            combinedData.status.unknown++;
        }
        
        // Update loaded count for terminal
        if (combinedData.buses[plate].loaded) {
            combinedData.terminals['El Roble'].loadedCount++;
            combinedData.terminals['El Roble'].totalLiters += combinedData.buses[plate].totalLiters;
        }
    });
    
    // Process La Reina buses
    operativityData.laReina.forEach(bus => {
        const plate = bus.plate;
        
        // If the bus is not in the combined data, add it
        if (!combinedData.buses[plate]) {
            combinedData.buses[plate] = {
                plate: plate,
                loaded: false,
                totalLiters: 0,
                loadCount: 0,
                status: 'unknown',
                terminal: '',
                location: '',
                detail: '',
                service: ''
            };
            
            // Also add to master fleet if not already there
            if (!masterFleet.includes(plate)) {
                masterFleet.push(plate);
            }
        }
        
        // Update operativity info
        combinedData.buses[plate].status = bus.status;
        combinedData.buses[plate].terminal = 'La Reina';
        combinedData.buses[plate].location = bus.location;
        combinedData.buses[plate].detail = bus.detail;
        combinedData.buses[plate].service = bus.service;
        combinedData.buses[plate].observations = bus.observations;
        
        // Track location stats
        if (bus.location) {
            if (!combinedData.locations[bus.location]) {
                combinedData.locations[bus.location] = {
                    count: 0,
                    terminal: 'La Reina',
                    buses: []
                };
            }
            combinedData.locations[bus.location].count++;
            combinedData.locations[bus.location].buses.push(plate);
        }
        
        // Update terminal stats
        combinedData.terminals['La Reina'].buses.push(plate);
        if (bus.status === 'operational') {
            combinedData.terminals['La Reina'].operationalCount++;
            combinedData.status.operational++;
        } else if (bus.status === 'maintenance') {
            combinedData.terminals['La Reina'].maintenanceCount++;
            combinedData.status.maintenance++;
        } else if (bus.status === 'panne') {
            combinedData.terminals['La Reina'].panneCount++;
            combinedData.status.panne++;
        } else {
            combinedData.status.unknown++;
        }
        
        // Update loaded count for terminal
        if (combinedData.buses[plate].loaded) {
            combinedData.terminals['La Reina'].loadedCount++;
            combinedData.terminals['La Reina'].totalLiters += combinedData.buses[plate].totalLiters;
        }
    });
    
    // Get buses assigned to María Angélica from fuel data
    if (fuelData.summary.terminals['María Angélica']) {
        const mariaAngelicaBuses = fuelData.summary.terminals['María Angélica'].loadedBuses;
        
        mariaAngelicaBuses.forEach(plate => {
            // If the bus is already assigned to another terminal, skip it
            if (
                combinedData.terminals['El Roble'].buses.includes(plate) ||
                combinedData.terminals['La Reina'].buses.includes(plate)
            ) {
                return;
            }
            
            // Update bus info
            if (combinedData.buses[plate]) {
                combinedData.buses[plate].terminal = 'María Angélica';
            } else {
                combinedData.buses[plate] = {
                    plate: plate,
                    loaded: true,
                    totalLiters: 0,
                    loadCount: 0,
                    status: 'operational', // Assume operational by default
                    terminal: 'María Angélica',
                    location: '',
                    detail: '',
                    service: ''
                };
                
                // Calculate total liters and load count
                let totalLiters = 0;
                let loadCount = 0;
                
                fuelData.rows.forEach(row => {
                    const rowPlate = row[fuelData.keys.plate]?.toString().trim().toUpperCase();
                    if (rowPlate === plate) {
                        const liters = parseFloat(row[fuelData.keys.liters]) || 0;
                        totalLiters += liters;
                        loadCount++;
                    }
                });
                
                combinedData.buses[plate].totalLiters = totalLiters;
                combinedData.buses[plate].loadCount = loadCount;
                
                // Also add to master fleet if not already there
                if (!masterFleet.includes(plate)) {
                    masterFleet.push(plate);
                }
            }
            
            // Update terminal stats
            combinedData.terminals['María Angélica'].buses.push(plate);
            combinedData.terminals['María Angélica'].loadedCount++;
            combinedData.terminals['María Angélica'].totalLiters += combinedData.buses[plate].totalLiters;
            
            // Assuming all María Angélica buses are operational if not specified
            if (combinedData.buses[plate].status === 'unknown') {
                combinedData.buses[plate].status = 'operational';
                combinedData.terminals['María Angélica'].operationalCount++;
                combinedData.status.operational++;
            }
        });
    }
    
    // Update average consumption per bus for each terminal
    Object.keys(combinedData.terminals).forEach(terminal => {
        const busCount = combinedData.terminals[terminal].loadedCount;
        combinedData.terminals[terminal].avgLitersPerBus = 
            busCount > 0 ? combinedData.terminals[terminal].totalLiters / busCount : 0;
    });
    
    // Find pending buses (operational but not loaded)
    combinedData.pendingBuses = Object.values(combinedData.buses)
        .filter(bus => !bus.loaded && bus.status === 'operational')
        .map(bus => ({
            plate: bus.plate,
            terminal: bus.terminal,
            location: bus.location,
            status: 'Pendiente',
            service: bus.service
        }));
    
    // Find maintenance/panne buses
    combinedData.maintenanceBuses = Object.values(combinedData.buses)
        .filter(bus => bus.status === 'maintenance' || bus.status === 'panne')
        .map(bus => ({
            plate: bus.plate,
            terminal: bus.terminal,
            type: bus.status === 'maintenance' ? 'Mantención' : 'Panne',
            detail: bus.detail || bus.observations || 'No especificado',
            location: bus.location
        }));
}

// -------------------------------------------------------------
// DASHBOARD RENDERING
// -------------------------------------------------------------
function renderDashboard() {
    // Hide welcome screen, show dashboard
    const welcomeScreen = document.getElementById('welcome-screen');
    const dashboardContent = document.getElementById('dashboard-content');
    
    welcomeScreen.classList.add('hidden');
    dashboardContent.classList.remove('hidden');
    
    // Update key metrics
    updateKeyMetrics();
    
    // Update charts
    updateCharts();
    
    // Render tables
    renderPendingBusesTable();
    renderMaintenanceBusesTable();
    renderConsumptionTable();
    renderStatusTable();
    
    // Render terminal-specific data
    renderTerminalData();
    
    // Update terminal-specific metrics
    updateTerminalMetrics();
    
    // Render locations
    renderLocations();
    
    // Render anomalies
    renderAnomalies();
    
    // Render bus grids for each terminal
    renderTerminalBusGrids();
    
    // Update filter chips state
    updateFilterChips();
}

function updateKeyMetrics() {
    // Calculate percentages
    const totalBuses = masterFleet.length;
    const loadedBuses = combinedData.fuel.loadedBuses.length;
    const pendingBuses = combinedData.pendingBuses.length;
    const panneBuses = combinedData.status.panne;
    
    const loadedPercent = totalBuses > 0 ? Math.round((loadedBuses / totalBuses) * 100) : 0;
    const pendingPercent = totalBuses > 0 ? Math.round((pendingBuses / totalBuses) * 100) : 0;
    const pannePercent = totalBuses > 0 ? Math.round((panneBuses / totalBuses) * 100) : 0;
    
    // Update metric values
    document.getElementById('total-liters').textContent = Math.round(combinedData.fuel.totalLiters).toLocaleString('es-CL');
    document.getElementById('buses-loaded').textContent = loadedBuses.toLocaleString('es-CL');
    document.getElementById('buses-pending').textContent = pendingBuses.toLocaleString('es-CL');
    document.getElementById('buses-panne').textContent = panneBuses.toLocaleString('es-CL');
    
    // Update percentages
    document.getElementById('loaded-percent').textContent = `${loadedPercent}% de la flota`;
    document.getElementById('pending-percent').textContent = `${pendingPercent}% de la flota`;
    document.getElementById('panne-percent').textContent = `${pannePercent}% de la flota`;
    
    // Find peak hour
    const peakHourIndex = combinedData.fuel.hourlyLoads.indexOf(Math.max(...combinedData.fuel.hourlyLoads));
    document.getElementById('peak-hour').textContent = peakHourIndex >= 0 ? 
        `${peakHourIndex.toString().padStart(2, '0')}:00 - ${(peakHourIndex + 1).toString().padStart(2, '0')}:00` : 
        'N/A';
    
    // Update status counts
    document.getElementById('operational-count').textContent = combinedData.status.operational.toLocaleString('es-CL');
    document.getElementById('maintenance-count').textContent = combinedData.status.maintenance.toLocaleString('es-CL');
    document.getElementById('panne-count').textContent = combinedData.status.panne.toLocaleString('es-CL');
    document.getElementById('unknown-count').textContent = combinedData.status.unknown.toLocaleString('es-CL');
    document.getElementById('total-fleet-count').textContent = totalBuses.toLocaleString('es-CL');
    
    // Update fuel tab metrics
    document.getElementById('fuel-total-liters').textContent = Math.round(combinedData.fuel.totalLiters).toLocaleString('es-CL');
    
    const avgPerBus = loadedBuses > 0 ? Math.round(combinedData.fuel.totalLiters / loadedBuses) : 0;
    document.getElementById('fuel-avg-per-bus').textContent = avgPerBus.toLocaleString('es-CL');
    
    // Count total loads
    let totalLoads = 0;
    Object.values(combinedData.buses).forEach(bus => {
        totalLoads += bus.loadCount || 0;
    });
    document.getElementById('fuel-total-loads').textContent = totalLoads.toLocaleString('es-CL');
    
    // Calculate efficiency
    const efficiency = totalBuses > 0 ? Math.round((loadedBuses / totalBuses) * 100) : 0;
    document.getElementById('fuel-efficiency').textContent = efficiency;
    document.getElementById('fuel-efficiency-bar').style.width = `${efficiency}%`;
    document.getElementById('fuel-loaded-count').textContent = `${loadedBuses} buses cargados`;
    document.getElementById('fuel-total-buses').textContent = `de ${totalBuses} buses`;
    
    // Update operativity tab metrics
    document.getElementById('op-total-fleet').textContent = totalBuses;
    document.getElementById('op-total-operational').textContent = combinedData.status.operational;
    document.getElementById('op-total-maintenance').textContent = combinedData.status.maintenance;
    document.getElementById('op-total-panne').textContent = combinedData.status.panne;
    
    const operationalPercent = totalBuses > 0 ? Math.round((combinedData.status.operational / totalBuses) * 100) : 0;
    const maintenancePercent = totalBuses > 0 ? Math.round((combinedData.status.maintenance / totalBuses) * 100) : 0;
    const panneStatusPercent = totalBuses > 0 ? Math.round((combinedData.status.panne / totalBuses) * 100) : 0;
    
    document.getElementById('op-operational-bar').style.width = `${operationalPercent}%`;
    document.getElementById('op-maintenance-bar').style.width = `${maintenancePercent}%`;
    document.getElementById('op-panne-bar').style.width = `${panneStatusPercent}%`;
    
    document.getElementById('op-operational-percent').textContent = `${operationalPercent}% de la flota`;
    document.getElementById('op-maintenance-percent').textContent = `${maintenancePercent}% de la flota`;
    document.getElementById('op-panne-percent').textContent = `${panneStatusPercent}% de la flota`;
    
    // Update terminal bus counts
    document.getElementById('el-roble-bus-count').textContent = `${combinedData.terminals['El Roble'].buses.length} buses`;
    document.getElementById('la-reina-bus-count').textContent = `${combinedData.terminals['La Reina'].buses.length} buses`;
    document.getElementById('maria-angelica-bus-count').textContent = `${combinedData.terminals['María Angélica'].buses.length} buses`;
}

function updateCharts() {
    // Update Chart.js defaults for current theme
    Chart.defaults.color = isDarkMode ? '#94a3b8' : '#64748b';
    Chart.defaults.borderColor = isDarkMode ? 'rgba(71, 85, 105, 0.2)' : 'rgba(203, 213, 225, 0.3)';
    
    // Update Fleet Status Chart
    const operational = combinedData.status.operational;
    const maintenance = combinedData.status.maintenance;
    const panne = combinedData.status.panne;
    const unknown = combinedData.status.unknown;
    
    charts.fleetStatus.data.datasets[0].data = [operational, maintenance, panne, unknown];
    charts.fleetStatus.update();
    
    // Update Terminal Distribution Chart
    const elRobleBuses = combinedData.terminals['El Roble'].buses.length;
    const laReinaBuses = combinedData.terminals['La Reina'].buses.length;
    const mariaAngelicaBuses = combinedData.terminals['María Angélica'].buses.length;
    
    charts.terminalDistribution.data.datasets[0].data = [elRobleBuses, laReinaBuses, mariaAngelicaBuses];
    charts.terminalDistribution.update();
    
    // Update Hourly Chart
    charts.hourly.data.datasets[0].data = combinedData.fuel.hourlyLoads;
    charts.hourly.update();
    
    // Update Terminal Consumption Chart
    const elRobleLiters = combinedData.terminals['El Roble'].totalLiters;
    const laReinaLiters = combinedData.terminals['La Reina'].totalLiters;
    const mariaAngelicaLiters = combinedData.terminals['María Angélica'].totalLiters;
    
    charts.terminalConsumption.data.datasets[0].data = [elRobleLiters, laReinaLiters, mariaAngelicaLiters];
    charts.terminalConsumption.update();
    
    // Update Hourly Consumption Chart
    charts.hourlyConsumption.data.datasets[0].data = combinedData.fuel.hourlyLiters;
    charts.hourlyConsumption.update();
    
    // Update Terminal Status Chart
    charts.terminalStatus.data.datasets[0].data = [
        combinedData.terminals['El Roble'].operationalCount,
        combinedData.terminals['La Reina'].operationalCount,
        combinedData.terminals['María Angélica'].operationalCount
    ];
    charts.terminalStatus.data.datasets[1].data = [
        combinedData.terminals['El Roble'].maintenanceCount,
        combinedData.terminals['La Reina'].maintenanceCount,
        combinedData.terminals['María Angélica'].maintenanceCount
    ];
    charts.terminalStatus.data.datasets[2].data = [
        combinedData.terminals['El Roble'].panneCount,
        combinedData.terminals['La Reina'].panneCount,
        combinedData.terminals['María Angélica'].panneCount
    ];
    charts.terminalStatus.update();
    
    // Update Terminal-specific Status Charts
    charts.elRobleStatus.data.datasets[0].data = [
        combinedData.terminals['El Roble'].operationalCount,
        combinedData.terminals['El Roble'].maintenanceCount,
        combinedData.terminals['El Roble'].panneCount
    ];
    charts.elRobleStatus.update();
    
    charts.laReinaStatus.data.datasets[0].data = [
        combinedData.terminals['La Reina'].operationalCount,
        combinedData.terminals['La Reina'].maintenanceCount,
        combinedData.terminals['La Reina'].panneCount
    ];
    charts.laReinaStatus.update();
    
    charts.mariaAngelicaStatus.data.datasets[0].data = [
        combinedData.terminals['María Angélica'].operationalCount,
        combinedData.terminals['María Angélica'].maintenanceCount,
        combinedData.terminals['María Angélica'].panneCount
    ];
    charts.mariaAngelicaStatus.update();
}

function updateTerminalMetrics() {
    // Update status by terminal counts
    document.getElementById('el-roble-operational').textContent = combinedData.terminals['El Roble'].operationalCount;
    document.getElementById('el-roble-maintenance').textContent = combinedData.terminals['El Roble'].maintenanceCount;
    document.getElementById('el-roble-panne').textContent = combinedData.terminals['El Roble'].panneCount;
    
    document.getElementById('la-reina-operational').textContent = combinedData.terminals['La Reina'].operationalCount;
    document.getElementById('la-reina-maintenance').textContent = combinedData.terminals['La Reina'].maintenanceCount;
    document.getElementById('la-reina-panne').textContent = combinedData.terminals['La Reina'].panneCount;
    
    document.getElementById('maria-angelica-operational').textContent = combinedData.terminals['María Angélica'].operationalCount;
    document.getElementById('maria-angelica-maintenance').textContent = combinedData.terminals['María Angélica'].maintenanceCount || '0';
    document.getElementById('maria-angelica-panne').textContent = combinedData.terminals['María Angélica'].panneCount || '0';
    
    // Update terminal-specific metrics
    // El Roble
    document.getElementById('el-roble-total-liters').textContent = Math.round(combinedData.terminals['El Roble'].totalLiters).toLocaleString('es-CL');
    const elRobleAvgLiters = combinedData.terminals['El Roble'].loadedCount > 0 ? 
        Math.round(combinedData.terminals['El Roble'].totalLiters / combinedData.terminals['El Roble'].loadedCount) : 0;
    document.getElementById('el-roble-avg-liters').textContent = elRobleAvgLiters.toLocaleString('es-CL');
    
    const elRobleEfficiency = combinedData.terminals['El Roble'].buses.length > 0 ? 
        Math.round((combinedData.terminals['El Roble'].loadedCount / combinedData.terminals['El Roble'].buses.length) * 100) : 0;
    document.getElementById('el-roble-efficiency').textContent = elRobleEfficiency;
    document.getElementById('el-roble-efficiency-bar').style.width = `${elRobleEfficiency}%`;
    
    // La Reina
    document.getElementById('la-reina-total-liters').textContent = Math.round(combinedData.terminals['La Reina'].totalLiters).toLocaleString('es-CL');
    const laReinaAvgLiters = combinedData.terminals['La Reina'].loadedCount > 0 ? 
        Math.round(combinedData.terminals['La Reina'].totalLiters / combinedData.terminals['La Reina'].loadedCount) : 0;
    document.getElementById('la-reina-avg-liters').textContent = laReinaAvgLiters.toLocaleString('es-CL');
    
    const laReinaEfficiency = combinedData.terminals['La Reina'].buses.length > 0 ? 
        Math.round((combinedData.terminals['La Reina'].loadedCount / combinedData.terminals['La Reina'].buses.length) * 100) : 0;
    document.getElementById('la-reina-efficiency').textContent = laReinaEfficiency;
    document.getElementById('la-reina-efficiency-bar').style.width = `${laReinaEfficiency}%`;
    
    // María Angélica
    document.getElementById('maria-angelica-total-liters').textContent = Math.round(combinedData.terminals['María Angélica'].totalLiters).toLocaleString('es-CL');
    const mariaAngelicaAvgLiters = combinedData.terminals['María Angélica'].loadedCount > 0 ? 
        Math.round(combinedData.terminals['María Angélica'].totalLiters / combinedData.terminals['María Angélica'].loadedCount) : 0;
    document.getElementById('maria-angelica-avg-liters').textContent = mariaAngelicaAvgLiters.toLocaleString('es-CL');
    
    const mariaAngelicaEfficiency = combinedData.terminals['María Angélica'].buses.length > 0 ? 
        Math.round((combinedData.terminals['María Angélica'].loadedCount / combinedData.terminals['María Angélica'].buses.length) * 100) : 0;
    document.getElementById('maria-angelica-efficiency').textContent = mariaAngelicaEfficiency;
    document.getElementById('maria-angelica-efficiency-bar').style.width = `${mariaAngelicaEfficiency}%`;
}

function renderPendingBusesTable() {
    const table = document.getElementById('pending-buses-table');
    
    if (combinedData.pendingBuses.length === 0) {
        table.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4 text-slate-500 dark:text-slate-400">
                    No hay buses pendientes por cargar
                </td>
            </tr>
        `;
        return;
    }
    
    table.innerHTML = '';
    
    combinedData.pendingBuses.forEach(bus => {
        table.innerHTML += `
            <tr>
                <td>
                    <div class="font-medium">${bus.plate}</div>
                </td>
                <td>
                    <div class="inline-flex items-center">
                        ${getTerminalBadge(bus.terminal)}
                        <span class="ml-1.5">${bus.terminal || 'No asignado'}</span>
                    </div>
                </td>
                <td>${bus.location || 'No especificado'}</td>
                <td>
                    <span class="status-pill status-operational">Operativo</span>
                </td>
                <td>${bus.service || 'No especificado'}</td>
                <td>
                    <button class="btn btn-outline text-xs py-1 px-2" onclick="showBusDetail('${bus.plate}')">
                        <iconify-icon icon="heroicons:eye"></iconify-icon>
                        <span>Ver</span>
                    </button>
                </td>
            </tr>
        `;
    });
}

function renderMaintenanceBusesTable() {
    const table = document.getElementById('maintenance-buses-table');
    
    if (combinedData.maintenanceBuses.length === 0) {
        table.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4 text-slate-500 dark:text-slate-400">
                    No hay buses en mantención o panne
                </td>
            </tr>
        `;
        return;
    }
    
    table.innerHTML = '';
    
    combinedData.maintenanceBuses.forEach(bus => {
        const statusClass = bus.type === 'Mantención' ? 'status-maintenance' : 'status-panne';
        
        table.innerHTML += `
            <tr>
                <td>
                    <div class="font-medium">${bus.plate}</div>
                </td>
                <td>
                    <div class="inline-flex items-center">
                        ${getTerminalBadge(bus.terminal)}
                        <span class="ml-1.5">${bus.terminal || 'No asignado'}</span>
                    </div>
                </td>
                <td>
                    <span class="status-pill ${statusClass}">${bus.type}</span>
                </td>
                <td>${bus.detail || 'No especificado'}</td>
                <td>${bus.location || 'No especificado'}</td>
                <td>
                    <button class="btn btn-outline text-xs py-1 px-2" onclick="showBusDetail('${bus.plate}')">
                        <iconify-icon icon="heroicons:eye"></iconify-icon>
                        <span>Ver</span>
                    </button>
                </td>
            </tr>
        `;
    });
}

function renderConsumptionTable() {
    const table = document.getElementById('consumption-table');
    
    if (!combinedData.fuel.loadedBuses.length) {
        table.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4 text-slate-500 dark:text-slate-400">
                    No hay datos de consumo disponibles
                </td>
            </tr>
        `;
        return;
    }
    
    table.innerHTML = '';
    
    // Sort buses by plate for initial display
    const loadedBuses = combinedData.fuel.loadedBuses.slice().sort();
    
    loadedBuses.forEach(plate => {
        const bus = combinedData.buses[plate];
        if (!bus) return;
        
        const avgLiters = bus.loadCount > 0 ? Math.round(bus.totalLiters / bus.loadCount) : 0;
        const lastLoad = bus.lastLoadTime ? formatDate(bus.lastLoadTime) : 'N/A';
        
        table.innerHTML += `
            <tr>
                <td>
                    <div class="font-medium">${bus.plate}</div>
                </td>
                <td>
                    <div class="inline-flex items-center">
                        ${getTerminalBadge(bus.terminal)}
                        <span class="ml-1.5">${bus.terminal || 'No asignado'}</span>
                    </div>
                </td>
                <td class="text-center">${bus.loadCount}</td>
                <td class="text-right">${Math.round(bus.totalLiters).toLocaleString('es-CL')}</td>
                <td class="text-right">${avgLiters.toLocaleString('es-CL')}</td>
                <td>${lastLoad}</td>
                <td>
                    <button class="btn btn-outline text-xs py-1 px-2" onclick="showBusDetail('${bus.plate}')">
                        <iconify-icon icon="heroicons:eye"></iconify-icon>
                        <span>Ver</span>
                    </button>
                </td>
            </tr>
        `;
    });
}

function renderStatusTable() {
    const table = document.getElementById('status-table');
    
    if (!masterFleet.length) {
        table.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4 text-slate-500 dark:text-slate-400">
                    No hay datos de estado disponibles
                </td>
            </tr>
        `;
        return;
    }
    
    table.innerHTML = '';
    
    // Sort buses by plate for initial display
    const sortedFleet = masterFleet.slice().sort();
    
    sortedFleet.forEach(plate => {
        const bus = combinedData.buses[plate];
        if (!bus) return;
        
        let statusPill = '';
        if (bus.status === 'operational') {
            statusPill = '<span class="status-pill status-operational">Operativo</span>';
        } else if (bus.status === 'maintenance') {
            statusPill = '<span class="status-pill status-maintenance">Mantención</span>';
        } else if (bus.status === 'panne') {
            statusPill = '<span class="status-pill status-panne">Panne</span>';
        } else {
            statusPill = '<span class="status-pill status-inactive">Sin datos</span>';
        }
        
        table.innerHTML += `
            <tr>
                <td>
                    <div class="font-medium">${bus.plate}</div>
                </td>
                <td>
                    <div class="inline-flex items-center">
                        ${getTerminalBadge(bus.terminal)}
                        <span class="ml-1.5">${bus.terminal || 'No asignado'}</span>
                    </div>
                </td>
                <td>${statusPill}</td>
                <td>${bus.location || 'No especificado'}</td>
                <td>${bus.detail || bus.observations || 'No especificado'}</td>
                <td>
                    <button class="btn btn-outline text-xs py-1 px-2" onclick="showBusDetail('${bus.plate}')">
                        <iconify-icon icon="heroicons:eye"></iconify-icon>
                        <span>Ver</span>
                    </button>
                </td>
            </tr>
        `;
    });
}

function renderTerminalData() {
    // No specific implementation needed here, as the terminal data
    // is rendered in other functions (updateTerminalMetrics, renderTerminalBusGrids)
}

function renderLocations() {
    const locationsContainer = document.getElementById('locations-container');
    const elRobleLocations = document.getElementById('el-roble-locations');
    const laReinaLocations = document.getElementById('la-reina-locations');
    const mariaAngelicaLocations = document.getElementById('maria-angelica-locations');
    
    // Reset containers
    locationsContainer.innerHTML = '';
    elRobleLocations.innerHTML = '';
    laReinaLocations.innerHTML = '';
    mariaAngelicaLocations.innerHTML = '';
    
    if (Object.keys(combinedData.locations).length === 0) {
        locationsContainer.innerHTML = `
            <div class="text-center py-4 text-slate-500 dark:text-slate-400">
                No hay datos de ubicación disponibles
            </div>
        `;
        
        elRobleLocations.innerHTML = `
            <div class="text-center py-4 text-slate-500 dark:text-slate-400">
                No hay datos de ubicación disponibles
            </div>
        `;
        
        laReinaLocations.innerHTML = `
            <div class="text-center py-4 text-slate-500 dark:text-slate-400">
                No hay datos de ubicación disponibles
            </div>
        `;
        
        mariaAngelicaLocations.innerHTML = `
            <div class="text-center py-4 text-slate-500 dark:text-slate-400">
                No hay datos de ubicación disponibles
            </div>
        `;
        
        return;
    }
    
    // Sort locations by count in descending order
    const sortedLocations = Object.entries(combinedData.locations)
        .sort((a, b) => b[1].count - a[1].count);
    
    // Render for overall locations
    sortedLocations.forEach(([location, data]) => {
        locationsContainer.innerHTML += `
            <div class="flex justify-between items-center p-2 bg-slate-50 dark:bg-slate-900 rounded-lg">
                <div>
                    <div class="font-medium text-xs text-slate-800 dark:text-slate-200">${location}</div>
                    <div class="text-xs text-slate-500 dark:text-slate-400">${data.terminal}</div>
                </div>
                <div class="text-xs font-semibold">${data.count} buses</div>
            </div>
        `;
    });
    
    // Filter and render terminal-specific locations
    const elRobleLocationsList = sortedLocations.filter(([_, data]) => data.terminal === 'El Roble');
    const laReinaLocationsList = sortedLocations.filter(([_, data]) => data.terminal === 'La Reina');
    const mariaAngelicaLocationsList = sortedLocations.filter(([_, data]) => data.terminal === 'María Angélica');
    
    if (elRobleLocationsList.length > 0) {
        elRobleLocationsList.forEach(([location, data]) => {
            elRobleLocations.innerHTML += `
                <div class="flex justify-between items-center p-2 bg-slate-50 dark:bg-slate-900 rounded-lg">
                    <div class="font-medium text-xs text-slate-800 dark:text-slate-200">${location}</div>
                    <div class="text-xs font-semibold">${data.count} buses</div>
                </div>
            `;
        });
    } else {
        elRobleLocations.innerHTML = `
            <div class="text-center py-4 text-slate-500 dark:text-slate-400">
                No hay datos de ubicación disponibles
            </div>
        `;
    }
    
    if (laReinaLocationsList.length > 0) {
        laReinaLocationsList.forEach(([location, data]) => {
            laReinaLocations.innerHTML += `
                <div class="flex justify-between items-center p-2 bg-slate-50 dark:bg-slate-900 rounded-lg">
                    <div class="font-medium text-xs text-slate-800 dark:text-slate-200">${location}</div>
                    <div class="text-xs font-semibold">${data.count} buses</div>
                </div>
            `;
        });
    } else {
        laReinaLocations.innerHTML = `
            <div class="text-center py-4 text-slate-500 dark:text-slate-400">
                No hay datos de ubicación disponibles
            </div>
        `;
    }
    
    if (mariaAngelicaLocationsList.length > 0) {
        mariaAngelicaLocationsList.forEach(([location, data]) => {
            mariaAngelicaLocations.innerHTML += `
                <div class="flex justify-between items-center p-2 bg-slate-50 dark:bg-slate-900 rounded-lg">
                    <div class="font-medium text-xs text-slate-800 dark:text-slate-200">${location}</div>
                    <div class="text-xs font-semibold">${data.count} buses</div>
                </div>
            `;
        });
    } else {
        mariaAngelicaLocations.innerHTML = `
            <div class="text-center py-4 text-slate-500 dark:text-slate-400">
                No hay datos de ubicación disponibles
            </div>
        `;
    }
}

function renderAnomalies() {
    const anomaliesContainer = document.getElementById('anomalies-container');
    
    // Reset container
    anomaliesContainer.innerHTML = '';
    
    const anomalies = [];
    
    // Check for buses with abnormally high consumption
    const loadedBuses = combinedData.fuel.loadedBuses;
    if (loadedBuses.length > 0) {
        // Calculate average consumption per bus
        let totalLiters = 0;
        loadedBuses.forEach(plate => {
            const bus = combinedData.buses[plate];
            if (bus) {
                totalLiters += bus.totalLiters;
            }
        });
        
        const avgLitersPerBus = totalLiters / loadedBuses.length;
        const threshold = avgLitersPerBus * 1.5; // 50% above average
        
        // Find buses with high consumption
        loadedBuses.forEach(plate => {
            const bus = combinedData.buses[plate];
            if (bus && bus.totalLiters > threshold) {
                anomalies.push({
                    type: 'high-consumption',
                    bus: bus.plate,
                    terminal: bus.terminal,
                    value: bus.totalLiters,
                    threshold: threshold,
                    percent: Math.round((bus.totalLiters / avgLitersPerBus - 1) * 100)
                });
            }
        });
    }
    
    // Check for "bad loads" from fuel data
    if (combinedData.fuel.badLoads.length > 0) {
        combinedData.fuel.badLoads.forEach(load => {
            anomalies.push({
                type: 'bad-load',
                bus: load.plate,
                terminal: load.terminal,
                liters: load.liters,
                driver: load.driver
            });
        });
    }
    
    // Check for operational buses without fuel
    const pendingBuses = combinedData.pendingBuses;
    if (pendingBuses.length > 0) {
        // We'll just add the first 5 to avoid cluttering
        pendingBuses.slice(0, 5).forEach(bus => {
            anomalies.push({
                type: 'pending',
                bus: bus.plate,
                terminal: bus.terminal,
                location: bus.location
            });
        });
        
        if (pendingBuses.length > 5) {
            anomalies.push({
                type: 'pending-more',
                count: pendingBuses.length - 5
            });
        }
    }
    
    // Render anomalies
    if (anomalies.length === 0) {
        anomaliesContainer.innerHTML = `
            <div class="text-center py-4 text-slate-500 dark:text-slate-400">
                No se detectaron anomalías en los datos
            </div>
        `;
        return;
    }
    
    anomalies.forEach(anomaly => {
        switch (anomaly.type) {
            case 'high-consumption':
                anomaliesContainer.innerHTML += `
                    <div class="p-3 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg">
                        <div class="flex items-start gap-2">
                            <div class="text-amber-500 dark:text-amber-400 mt-0.5">
                                <iconify-icon icon="heroicons:exclamation-triangle" width="18"></iconify-icon>
                            </div>
                            <div>
                                <div class="font-medium text-amber-800 dark:text-amber-300 text-sm">Consumo Elevado</div>
                                <p class="text-xs text-amber-700 dark:text-amber-400">
                                    El bus <span class="font-semibold">${anomaly.bus}</span> (${anomaly.terminal}) ha consumido
                                    <span class="font-semibold">${Math.round(anomaly.value).toLocaleString('es-CL')} Lts</span>,
                                    un ${anomaly.percent}% más que el promedio.
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                break;
                
            case 'bad-load':
                anomaliesContainer.innerHTML += `
                    <div class="p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
                        <div class="flex items-start gap-2">
                            <div class="text-red-500 dark:text-red-400 mt-0.5">
                                <iconify-icon icon="heroicons:exclamation-circle" width="18"></iconify-icon>
                            </div>
                            <div>
                                <div class="font-medium text-red-800 dark:text-red-300 text-sm">Carga Manual Detectada</div>
                                <p class="text-xs text-red-700 dark:text-red-400">
                                    El bus <span class="font-semibold">${anomaly.bus}</span> tiene una carga manual de
                                    <span class="font-semibold">${Math.round(anomaly.liters).toLocaleString('es-CL')} Lts</span>
                                    en ${anomaly.terminal}.
                                    ${anomaly.driver !== 'N/A' ? `Conductor: ${anomaly.driver}` : ''}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                break;
                
            case 'pending':
                anomaliesContainer.innerHTML += `
                    <div class="p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                        <div class="flex items-start gap-2">
                            <div class="text-blue-500 dark:text-blue-400 mt-0.5">
                                <iconify-icon icon="heroicons:clock" width="18"></iconify-icon>
                            </div>
                            <div>
                                <div class="font-medium text-blue-800 dark:text-blue-300 text-sm">Bus Operativo Sin Carga</div>
                                <p class="text-xs text-blue-700 dark:text-blue-400">
                                    El bus <span class="font-semibold">${anomaly.bus}</span> (${anomaly.terminal}) está operativo
                                    pero no registra cargas de combustible. Ubicación: ${anomaly.location || 'No especificada'}.
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                break;
                
            case 'pending-more':
                anomaliesContainer.innerHTML += `
                    <div class="p-3 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-800 rounded-lg">
                        <div class="flex items-start gap-2">
                            <div class="text-slate-500 dark:text-slate-400 mt-0.5">
                                <iconify-icon icon="heroicons:information-circle" width="18"></iconify-icon>
                            </div>
                            <div>
                                <p class="text-xs text-slate-700 dark:text-slate-300">
                                    <span class="font-semibold">${anomaly.count} buses más</span> están operativos pero sin cargas registradas.
                                    Revise la sección "Buses Pendientes por Cargar" para ver el listado completo.
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                break;
        }
    });
}

function renderTerminalBusGrids() {
    const elRobleBusesContainer = document.getElementById('el-roble-buses-container');
    const laReinaBusesContainer = document.getElementById('la-reina-buses-container');
    const mariaAngelicaBusesContainer = document.getElementById('maria-angelica-buses-container');
    
    // El Roble
    if (combinedData.terminals['El Roble'].buses.length > 0) {
        elRobleBusesContainer.innerHTML = '<div class="bus-grid"></div>';
        const elRobleGrid = elRobleBusesContainer.querySelector('.bus-grid');
        
        // Sort buses by plate
        const elRobleBuses = combinedData.terminals['El Roble'].buses.slice().sort();
        
        elRobleBuses.forEach(plate => {
            const bus = combinedData.buses[plate];
            if (!bus) return;
            
            let statusClass = '';
            if (bus.status === 'operational') statusClass = 'operational';
            else if (bus.status === 'maintenance') statusClass = 'maintenance';
            else if (bus.status === 'panne') statusClass = 'panne';
            else statusClass = 'inactive';
            
            elRobleGrid.innerHTML += `
                <div class="bus-item ${statusClass}" onclick="showBusDetail('${bus.plate}')">
                    <div class="bus-item-plate">${bus.plate}</div>
                    <div class="bus-item-terminal">${bus.location || 'No ubicado'}</div>
                </div>
            `;
        });
    } else {
        elRobleBusesContainer.innerHTML = `
            <div class="text-center py-4 text-slate-500 dark:text-slate-400">
                No hay buses asignados a este terminal
            </div>
        `;
    }
    
    // La Reina
    if (combinedData.terminals['La Reina'].buses.length > 0) {
        laReinaBusesContainer.innerHTML = '<div class="bus-grid"></div>';
        const laReinaGrid = laReinaBusesContainer.querySelector('.bus-grid');
        
        // Sort buses by plate
        const laReinaBuses = combinedData.terminals['La Reina'].buses.slice().sort();
        
        laReinaBuses.forEach(plate => {
            const bus = combinedData.buses[plate];
            if (!bus) return;
            
            let statusClass = '';
            if (bus.status === 'operational') statusClass = 'operational';
            else if (bus.status === 'maintenance') statusClass = 'maintenance';
            else if (bus.status === 'panne') statusClass = 'panne';
            else statusClass = 'inactive';
            
            laReinaGrid.innerHTML += `
                <div class="bus-item ${statusClass}" onclick="showBusDetail('${bus.plate}')">
                    <div class="bus-item-plate">${bus.plate}</div>
                    <div class="bus-item-terminal">${bus.location || 'No ubicado'}</div>
                </div>
            `;
        });
    } else {
        laReinaBusesContainer.innerHTML = `
            <div class="text-center py-4 text-slate-500 dark:text-slate-400">
                No hay buses asignados a este terminal
            </div>
        `;
    }
    
    // María Angélica
    if (combinedData.terminals['María Angélica'].buses.length > 0) {
        mariaAngelicaBusesContainer.innerHTML = '<div class="bus-grid"></div>';
        const mariaAngelicaGrid = mariaAngelicaBusesContainer.querySelector('.bus-grid');
        
        // Sort buses by plate
        const mariaAngelicaBuses = combinedData.terminals['María Angélica'].buses.slice().sort();
        
        mariaAngelicaBuses.forEach(plate => {
            const bus = combinedData.buses[plate];
            if (!bus) return;
            
            let statusClass = '';
            if (bus.status === 'operational') statusClass = 'operational';
            else if (bus.status === 'maintenance') statusClass = 'maintenance';
            else if (bus.status === 'panne') statusClass = 'panne';
            else statusClass = 'inactive';
            
            mariaAngelicaGrid.innerHTML += `
                <div class="bus-item ${statusClass}" onclick="showBusDetail('${bus.plate}')">
                    <div class="bus-item-plate">${bus.plate}</div>
                    <div class="bus-item-terminal">${bus.location || 'No ubicado'}</div>
                </div>
            `;
        });
    } else {
        mariaAngelicaBusesContainer.innerHTML = `
            <div class="text-center py-4 text-slate-500 dark:text-slate-400">
                No hay buses asignados a este terminal
            </div>
        `;
    }
}

function updateFilterChips() {
    const filterChips = document.querySelectorAll('.filter-chip');
    filterChips.forEach(chip => {
        if (chip.getAttribute('data-filter') === 'all') {
            chip.classList.add('active');
        } else {
            chip.classList.remove('active');
        }
    });
}

// -------------------------------------------------------------
// SEARCH FUNCTIONALITY
// -------------------------------------------------------------
function handleGlobalSearch() {
    const searchInput = document.getElementById('global-search');
    const searchResults = document.getElementById('search-results');
    
    const query = searchInput.value.trim().toUpperCase();
    
    if (query.length < 2) {
        searchResults.classList.remove('show');
        return;
    }
    
    // Search in combinedData.buses
    const matchingBuses = [];
    
    // First search by exact plate match
    if (combinedData.buses[query]) {
        matchingBuses.push(combinedData.buses[query]);
    }
    
    // Then search by partial plate match
    Object.values(combinedData.buses).forEach(bus => {
        if (bus.plate !== query && bus.plate.includes(query)) {
            matchingBuses.push(bus);
        }
    });
    
    // Search by internal number
    if (internalToPPU[query] && combinedData.buses[internalToPPU[query]]) {
        const bus = combinedData.buses[internalToPPU[query]];
        if (!matchingBuses.some(b => b.plate === bus.plate)) {
            matchingBuses.push(bus);
        }
    }
    
    // Search by partial internal number
    Object.entries(internalToPPU).forEach(([internal, plate]) => {
        if (internal.includes(query) && combinedData.buses[plate]) {
            const bus = combinedData.buses[plate];
            if (!matchingBuses.some(b => b.plate === bus.plate)) {
                matchingBuses.push(bus);
            }
        }
    });
    
    // Limit to first 10 matches
    const limitedMatches = matchingBuses.slice(0, 10);
    
    if (limitedMatches.length === 0) {
        searchResults.innerHTML = `
            <div class="p-3 text-center text-slate-500 dark:text-slate-400 text-sm">
                No se encontraron buses que coincidan con "${query}"
            </div>
        `;
    } else {
        searchResults.innerHTML = '';
        
        limitedMatches.forEach(bus => {
            // Determine status pill
            let statusPill = '';
            if (bus.status === 'operational') {
                statusPill = '<span class="status-pill status-operational">Operativo</span>';
            } else if (bus.status === 'maintenance') {
                statusPill = '<span class="status-pill status-maintenance">Mantención</span>';
            } else if (bus.status === 'panne') {
                statusPill = '<span class="status-pill status-panne">Panne</span>';
            } else {
                statusPill = '<span class="status-pill status-inactive">Sin datos</span>';
            }
            
            searchResults.innerHTML += `
                <div class="search-results-item" onclick="showBusDetail('${bus.plate}')">
                    <div class="search-results-primary">
                        <span>${bus.plate}</span>
                        ${statusPill}
                    </div>
                    <div class="search-results-secondary">
                        ${getTerminalBadge(bus.terminal)}
                        <span>${bus.terminal || 'No asignado'}</span>
                        ${bus.loaded ? `<span class="ml-auto text-emerald-600 dark:text-emerald-400">Cargado: ${Math.round(bus.totalLiters)} Lts</span>` : 
                                       '<span class="ml-auto text-amber-600 dark:text-amber-400">Pendiente</span>'}
                    </div>
                </div>
            `;
        });
    }
    
    searchResults.classList.add('show');
}

function performQuickSearch(query) {
    query = query.trim().toUpperCase();
    
    if (query.length === 0) {
        document.getElementById('quick-search-results').innerHTML = `
            <div class="text-center text-slate-500 dark:text-slate-400 text-sm py-6">
                Ingrese una PPU o N° Interno para consultar el estado del bus
            </div>
        `;
        return;
    }
    
    // Check if it's a valid search
    let bus = null;
    
    // Check direct PPU match
    if (combinedData.buses[query]) {
        bus = combinedData.buses[query];
    }
    
    // Check internal number
    if (!bus && internalToPPU[query] && combinedData.buses[internalToPPU[query]]) {
        bus = combinedData.buses[internalToPPU[query]];
    }
    
    if (!bus) {
        document.getElementById('quick-search-results').innerHTML = `
            <div class="p-3 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg">
                <div class="flex items-start gap-2">
                    <div class="text-amber-500 dark:text-amber-400 mt-0.5">
                        <iconify-icon icon="heroicons:exclamation-triangle"></iconify-icon>
                    </div>
                    <div>
                        <div class="font-medium text-amber-800 dark:text-amber-300">No se encontró el bus</div>
                        <p class="text-xs text-amber-700 dark:text-amber-400">
                            No se encontró ningún bus con PPU o N° Interno "${query}".
                            Verifique e intente nuevamente.
                        </p>
                    </div>
                </div>
            </div>
        `;
        return;
    }
    
    // Render bus details in the quick search results
    let statusClass = '';
    let statusText = '';
    let statusIcon = '';
    let statusColor = '';
    
    if (bus.status === 'operational') {
        statusClass = 'bg-emerald-50 dark:bg-emerald-900/20 border-emerald-200 dark:border-emerald-800';
        statusText = 'Operativo';
        statusIcon = 'heroicons:check-circle';
        statusColor = 'text-emerald-500 dark:text-emerald-400';
    } else if (bus.status === 'maintenance') {
        statusClass = 'bg-amber-50 dark:bg-amber-900/20 border-amber-200 dark:border-amber-800';
        statusText = 'En Mantención';
        statusIcon = 'heroicons:wrench-screwdriver';
        statusColor = 'text-amber-500 dark:text-amber-400';
    } else if (bus.status === 'panne') {
        statusClass = 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800';
        statusText = 'En Panne';
        statusIcon = 'heroicons:exclamation-circle';
        statusColor = 'text-red-500 dark:text-red-400';
    } else {
        statusClass = 'bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700';
        statusText = 'Sin datos';
        statusIcon = 'heroicons:question-mark-circle';
        statusColor = 'text-slate-500 dark:text-slate-400';
    }
    
    const fuelStatus = bus.loaded ? 
        `<span class="text-emerald-600 dark:text-emerald-400 font-medium">Cargado</span> (${Math.round(bus.totalLiters).toLocaleString('es-CL')} Lts)` : 
        '<span class="text-amber-600 dark:text-amber-400 font-medium">Pendiente</span>';
    
    document.getElementById('quick-search-results').innerHTML = `
        <div class="p-3 ${statusClass} border rounded-lg">
            <div class="flex items-start gap-2 mb-2">
                <div class="${statusColor} mt-0.5">
                    <iconify-icon icon="${statusIcon}"></iconify-icon>
                </div>
                <div>
                    <div class="font-medium text-sm flex items-center justify-between">
                        <span>${bus.plate}</span>
                        <span class="text-xs">${statusText}</span>
                    </div>
                    <div class="text-xs text-slate-600 dark:text-slate-400 flex items-center gap-1.5 mt-0.5">
                        ${getTerminalBadge(bus.terminal)}
                        <span>${bus.terminal || 'No asignado'}</span>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-2 mt-3">
                <div class="bg-white/50 dark:bg-black/10 p-2 rounded">
                    <div class="text-xs text-slate-500 dark:text-slate-400">Combustible</div>
                    <div class="text-sm font-medium">${fuelStatus}</div>
                </div>
                <div class="bg-white/50 dark:bg-black/10 p-2 rounded">
                    <div class="text-xs text-slate-500 dark:text-slate-400">Ubicación</div>
                    <div class="text-sm font-medium">${bus.location || 'No especificado'}</div>
                </div>
                ${bus.detail || bus.observations ? `
                <div class="col-span-2 bg-white/50 dark:bg-black/10 p-2 rounded">
                    <div class="text-xs text-slate-500 dark:text-slate-400">Detalle</div>
                    <div class="text-sm font-medium">${bus.detail || bus.observations}</div>
                </div>
                ` : ''}
            </div>
            
            <div class="flex justify-end mt-3">
                <button class="btn btn-outline text-xs py-1 px-2" onclick="showBusDetail('${bus.plate}')">
                    <iconify-icon icon="heroicons:eye"></iconify-icon>
                    <span>Ver Detalle Completo</span>
                </button>
            </div>
        </div>
    `;
}

// -------------------------------------------------------------
// FILTER AND SORT FUNCTIONS
// -------------------------------------------------------------
function filterDashboard(event) {
    const query = event.target.value.trim().toUpperCase();
    
    // Reset filter chips
    document.querySelectorAll('.filter-chip').forEach(chip => chip.classList.remove('active'));
    document.querySelector('.filter-chip[data-filter="all"]').classList.add('active');
    
    // Filter tables
    filterTable('pending-buses', query);
    filterTable('maintenance-buses', query);
    filterTable('consumption', query);
    filterTable('status', query);
    filterTable('el-roble', query);
    filterTable('la-reina', query);
    filterTable('maria-angelica', query);
}

function applyDashboardFilter(filter) {
    // Reset all tables
    resetAllTables();
    
    if (filter === 'all') {
        // No additional filtering needed
        return;
    }
    
    // Apply specific filters
    if (filter === 'pending') {
        // Show only pending buses
        const busElements = document.querySelectorAll('#pending-buses-table tr');
        busElements.forEach(row => {
            row.style.display = '';
        });
        
        filterTerminalBuses('operational', false);
    } else if (filter === 'operational') {
        // Show only operational buses
        filterTerminalBuses('operational', true);
    } else if (filter === 'maintenance') {
        // Show only maintenance buses
        const busElements = document.querySelectorAll('#maintenance-buses-table tr');
        busElements.forEach(row => {
            if (row.querySelector('.status-maintenance')) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
        
        filterTerminalBuses('maintenance', true);
    } else if (filter === 'panne') {
        // Show only panne buses
        const busElements = document.querySelectorAll('#maintenance-buses-table tr');
        busElements.forEach(row => {
            if (row.querySelector('.status-panne')) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
        
        filterTerminalBuses('panne', true);
    }
}

function filterTerminalBuses(statusType, includeLoaded) {
    const terminals = ['el-roble', 'la-reina', 'maria-angelica'];
    
    terminals.forEach(terminal => {
        const busItems = document.querySelectorAll(`#${terminal}-buses-container .bus-item`);
        
        busItems.forEach(item => {
            if (statusType === 'operational' && !includeLoaded) {
                // For pending, we want operational buses that are not loaded
                const plate = item.querySelector('.bus-item-plate').textContent;
                const bus = combinedData.buses[plate];
                
                if (bus && bus.status === 'operational' && !bus.loaded) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            } else if (item.classList.contains(statusType)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    });
}

function resetAllTables() {
    // Reset all rows in all tables
    const tables = ['pending-buses-table', 'maintenance-buses-table', 'consumption-table', 'status-table'];
    tables.forEach(tableId => {
        const rows = document.querySelectorAll(`#${tableId} tr`);
        rows.forEach(row => {
            row.style.display = '';
        });
    });
    
    // Reset terminal bus grids
    const terminals = ['el-roble', 'la-reina', 'maria-angelica'];
    terminals.forEach(terminal => {
        const busItems = document.querySelectorAll(`#${terminal}-buses-container .bus-item`);
        busItems.forEach(item => {
            item.style.display = '';
        });
    });
}

function filterTable(tableId, query) {
    // Determine which element to target based on table ID
    let selector;
    if (['el-roble', 'la-reina', 'maria-angelica'].includes(tableId)) {
        // Terminal bus grids
        selector = `#${tableId}-buses-container .bus-item`;
    } else {
        // Regular tables
        selector = `#${tableId}-table tr`;
    }
    
    const elements = document.querySelectorAll(selector);
    
    if (query === '') {
        // If query is empty, show all elements
        elements.forEach(el => {
            el.style.display = '';
        });
        return;
    }
    
    elements.forEach(el => {
        // For tables, check all cells; for bus grids, check bus plate and location
        let text;
        if (el.classList.contains('bus-item')) {
            text = el.textContent;
        } else {
            text = Array.from(el.querySelectorAll('td')).map(td => td.textContent).join(' ');
        }
        
        if (text.toUpperCase().includes(query)) {
            el.style.display = '';
        } else {
            el.style.display = 'none';
        }
    });
}

function sortTable(tableId, sortBy) {
    const table = document.getElementById(`${tableId}-table`);
    if (!table) return;
    
    const tbody = table;
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Skip if there are no rows or only has a "no data" message
    if (rows.length === 0 || (rows.length === 1 && rows[0].cells.length === 1 && rows[0].cells[0].colSpan > 1)) {
        return;
    }
    
    // Sort rows based on the selected criteria
    rows.sort((a, b) => {
        // Handle specific sort types
        switch (sortBy) {
            case 'plate':
                const plateA = a.querySelector('td:first-child')?.textContent.trim() || '';
                const plateB = b.querySelector('td:first-child')?.textContent.trim() || '';
                return plateA.localeCompare(plateB);
                
            case 'liters-desc':
                const litersA = parseFloat(a.querySelector('td:nth-child(4)')?.textContent.replace(/\./g, '').replace(',', '.')) || 0;
                const litersB = parseFloat(b.querySelector('td:nth-child(4)')?.textContent.replace(/\./g, '').replace(',', '.')) || 0;
                return litersB - litersA;
                
            case 'liters-asc':
                const litersAsc = parseFloat(a.querySelector('td:nth-child(4)')?.textContent.replace(/\./g, '').replace(',', '.')) || 0;
                const litersBsc = parseFloat(b.querySelector('td:nth-child(4)')?.textContent.replace(/\./g, '').replace(',', '.')) || 0;
                return litersAsc - litersBsc;
                
            case 'loads':
                const loadsA = parseInt(a.querySelector('td:nth-child(3)')?.textContent) || 0;
                const loadsB = parseInt(b.querySelector('td:nth-child(3)')?.textContent) || 0;
                return loadsB - loadsA;
                
            case 'terminal':
                const terminalA = a.querySelector('td:nth-child(2)')?.textContent.trim() || '';
                const terminalB = b.querySelector('td:nth-child(2)')?.textContent.trim() || '';
                return terminalA.localeCompare(terminalB);
                
            case 'status':
                const statusA = a.querySelector('td:nth-child(3)')?.textContent.trim() || '';
                const statusB = b.querySelector('td:nth-child(3)')?.textContent.trim() || '';
                return statusA.localeCompare(statusB);
                
            case 'location':
                const locationA = a.querySelector('td:nth-child(4)')?.textContent.trim() || '';
                const locationB = b.querySelector('td:nth-child(4)')?.textContent.trim() || '';
                return locationA.localeCompare(locationB);
                
            default:
                return 0;
        }
    });
    
    // Clear and re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
}

// -------------------------------------------------------------
// EXPORT AND REPORTING FUNCTIONS
// -------------------------------------------------------------
function exportData(dataType) {
    let exportData = [];
    let filename = '';
    
    switch (dataType) {
        case 'pending-btn':
            exportData = combinedData.pendingBuses.map(bus => ({
                Patente: bus.plate,
                Terminal: bus.terminal || 'No asignado',
                Ubicación: bus.location || 'No especificado',
                Estado: 'Pendiente',
                Servicio: bus.service || 'No especificado'
            }));
            filename = 'Buses_Pendientes';
            break;
            
        case 'maintenance-btn':
            exportData = combinedData.maintenanceBuses.map(bus => ({
                Patente: bus.plate,
                Terminal: bus.terminal || 'No asignado',
                Tipo: bus.type,
                Detalle: bus.detail || 'No especificado',
                Ubicación: bus.location || 'No especificado'
            }));
            filename = 'Buses_Mantención_Panne';
            break;
            
        case 'consumption-btn':
            exportData = combinedData.fuel.loadedBuses.map(plate => {
                const bus = combinedData.buses[plate];
                return {
                    Patente: bus.plate,
                    Terminal: bus.terminal || 'No asignado',
                    Cargas: bus.loadCount,
                    'Total Litros': Math.round(bus.totalLiters),
                    'Promedio': bus.loadCount > 0 ? Math.round(bus.totalLiters / bus.loadCount) : 0
                };
            });
            filename = 'Consumo_Combustible';
            break;
            
        case 'status-btn':
            exportData = Object.values(combinedData.buses).map(bus => ({
                Patente: bus.plate,
                Terminal: bus.terminal || 'No asignado',
                Estado: getStatusText(bus.status),
                Ubicación: bus.location || 'No especificado',
                Detalle: bus.detail || bus.observations || 'No especificado',
                'Litros Cargados': Math.round(bus.totalLiters)
            }));
            filename = 'Estado_Flota';
            break;
            
        case 'el-roble-btn':
            exportData = combinedData.terminals['El Roble'].buses.map(plate => {
                const bus = combinedData.buses[plate];
                return {
                    Patente: bus.plate,
                    Estado: getStatusText(bus.status),
                    Ubicación: bus.location || 'No especificado',
                    'Carga Combustible': bus.loaded ? 'Sí' : 'No',
                    'Litros': Math.round(bus.totalLiters)
                };
            });
            filename = 'Terminal_El_Roble';
            break;
            
        case 'la-reina-btn':
            exportData = combinedData.terminals['La Reina'].buses.map(plate => {
                const bus = combinedData.buses[plate];
                return {
                    Patente: bus.plate,
                    Estado: getStatusText(bus.status),
                    Ubicación: bus.location || 'No especificado',
                    'Carga Combustible': bus.loaded ? 'Sí' : 'No',
                    'Litros': Math.round(bus.totalLiters)
                };
            });
            filename = 'Terminal_La_Reina';
            break;
            
        case 'maria-angelica-btn':
            exportData = combinedData.terminals['María Angélica'].buses.map(plate => {
                const bus = combinedData.buses[plate];
                return {
                    Patente: bus.plate,
                    Estado: getStatusText(bus.status),
                    Ubicación: bus.location || 'No especificado',
                    'Carga Combustible': bus.loaded ? 'Sí' : 'No',
                    'Litros': Math.round(bus.totalLiters)
                };
            });
            filename = 'Terminal_Maria_Angelica';
            break;
            
        default:
            showToast('Error', 'Tipo de datos no reconocido', 'error');
            return;
    }
    
    if (exportData.length === 0) {
        showToast('Info', 'No hay datos para exportar', 'info');
        return;
    }
    
    // Export to Excel
    exportToExcel(exportData, filename);
}

function exportToExcel(data, filename) {
    try {
        // Create workbook and worksheet
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(data);
        
        // Add styling (column widths)
        const colWidths = [];
        if (data.length > 0) {
            Object.keys(data[0]).forEach(key => {
                colWidths.push({ wch: Math.max(key.length, 12) });
            });
            ws['!cols'] = colWidths;
        }
        
        // Add worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, 'Reporte');
        
        // Generate download
        XLSX.writeFile(wb, `${filename}_${getFormattedDateFilename()}.xlsx`);
        
        showToast('Éxito', 'Archivo exportado correctamente', 'success');
    } catch (error) {
        console.error('Error exporting to Excel:', error);
        showToast('Error', 'No se pudo exportar el archivo', 'error');
    }
}

function generateReport() {
    const reportType = document.getElementById('report-type').value;
    const reportFormat = document.getElementById('report-format').value;
    const reportTerminal = document.getElementById('report-terminal').value;
    const reportStatus = document.getElementById('report-status').value;
    const reportBuses = document.getElementById('report-buses').value.trim().toUpperCase();
    
    // Prepare specific buses array if provided
    const specificBuses = reportBuses ? reportBuses.split(',').map(plate => plate.trim()) : [];
    
    // Filter buses based on criteria
    let filteredBuses = Object.values(combinedData.buses);
    
    // Apply terminal filter
    if (reportTerminal !== 'all') {
        const terminalName = reportTerminal === 'el-roble' ? 'El Roble' : 
                           reportTerminal === 'la-reina' ? 'La Reina' : 
                           'María Angélica';
        
        filteredBuses = filteredBuses.filter(bus => bus.terminal === terminalName);
    }
    
    // Apply status filter
    if (reportStatus !== 'all') {
        if (reportStatus === 'pending') {
            filteredBuses = filteredBuses.filter(bus => bus.status === 'operational' && !bus.loaded);
        } else {
            filteredBuses = filteredBuses.filter(bus => bus.status === reportStatus);
        }
    }
    
    // Apply specific buses filter if provided
    if (specificBuses.length > 0) {
        filteredBuses = filteredBuses.filter(bus => specificBuses.includes(bus.plate));
    }
    
    // Generate report data based on type
    let reportData = [];
    let reportTitle = '';
    
    switch (reportType) {
        case 'status':
            reportTitle = 'Reporte de Estado de Flota';
            reportData = filteredBuses.map(bus => ({
                Patente: bus.plate,
                Terminal: bus.terminal || 'No asignado',
                Estado: getStatusText(bus.status),
                Ubicación: bus.location || 'No especificado',
                Detalle: bus.detail || bus.observations || 'No especificado'
            }));
            break;
            
        case 'fuel':
            reportTitle = 'Reporte de Consumo de Combustible';
            reportData = filteredBuses.map(bus => ({
                Patente: bus.plate,
                Terminal: bus.terminal || 'No asignado',
                Estado: bus.loaded ? 'Cargado' : 'Pendiente',
                'N° Cargas': bus.loadCount || 0,
                'Total Litros': Math.round(bus.totalLiters || 0),
                'Promedio': bus.loadCount > 0 ? Math.round(bus.totalLiters / bus.loadCount) : 0
            }));
            break;
            
        case 'maintenance':
            reportTitle = 'Reporte de Mantención y Panne';
            reportData = filteredBuses
                .filter(bus => bus.status === 'maintenance' || bus.status === 'panne')
                .map(bus => ({
                    Patente: bus.plate,
                    Terminal: bus.terminal || 'No asignado',
                    Tipo: bus.status === 'maintenance' ? 'Mantención' : 'Panne',
                    Detalle: bus.detail || bus.observations || 'No especificado',
                    Ubicación: bus.location || 'No especificado'
                }));
            break;
            
        case 'terminals':
            reportTitle = 'Reporte por Terminal';
            reportData = filteredBuses.map(bus => ({
                Patente: bus.plate,
                Terminal: bus.terminal || 'No asignado',
                Estado: getStatusText(bus.status),
                Ubicación: bus.location || 'No especificado',
                'Carga Combustible': bus.loaded ? 'Sí' : 'No',
                'Litros': Math.round(bus.totalLiters || 0)
            }));
            break;
    }
    
    // If no data, show message
    if (reportData.length === 0) {
        document.getElementById('report-preview').innerHTML = `
            <div class="text-center py-4 text-slate-500 dark:text-slate-400">
                No hay datos que coincidan con los criterios seleccionados
            </div>
        `;
        document.getElementById('download-report-btn').disabled = true;
        return;
    }
    
    // Store report data for download
    window.currentReport = {
        title: reportTitle,
        data: reportData,
        format: reportFormat
    };
    
    // Create preview (limited to first 10 rows)
    const previewData = reportData.slice(0, 10);
    
    document.getElementById('report-preview').innerHTML = `
        <div class="mb-3">
            <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-200">${reportTitle}</h3>
            <p class="text-xs text-slate-500 dark:text-slate-400">
                Mostrando ${previewData.length} de ${reportData.length} registros
            </p>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-slate-100 dark:bg-slate-800">
                    <tr>
                        ${Object.keys(previewData[0]).map(key => `<th class="px-3 py-2 text-left text-xs font-medium">${key}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${previewData.map(row => `
                        <tr class="border-b border-slate-200 dark:border-slate-700">
                            ${Object.values(row).map(value => `<td class="px-3 py-2">${value}</td>`).join('')}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    document.getElementById('download-report-btn').disabled = false;
}

function downloadReport() {
    if (!window.currentReport) {
        showToast('Error', 'No hay reporte para descargar', 'error');
        return;
    }
    
    const { title, data, format } = window.currentReport;
    
    switch (format) {
        case 'excel':
            exportToExcel(data, title.replace(/\s+/g, '_'));
            break;
            
        case 'csv':
            exportToCSV(data, title.replace(/\s+/g, '_'));
            break;
            
        case 'pdf':
            showToast('Info', 'La exportación a PDF no está disponible en esta versión', 'info');
            break;
            
        case 'print':
            printReport(title, data);
            break;
            
        default:
            showToast('Error', 'Formato no soportado', 'error');
    }
}

function exportToCSV(data, filename) {
    try {
        // Create CSV string
        const header = Object.keys(data[0]).join(',') + '\n';
        const rows = data.map(row => Object.values(row).join(','));
        const csvContent = header + rows.join('\n');
        
        // Create download link
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', `${filename}_${getFormattedDateFilename()}.csv`);
        document.body.appendChild(link);
        
        // Download file and clean up
        link.click();
        document.body.removeChild(link);
        
        showToast('Éxito', 'Archivo CSV exportado correctamente', 'success');
    } catch (error) {
        console.error('Error exporting to CSV:', error);
        showToast('Error', 'No se pudo exportar el archivo CSV', 'error');
    }
}

function printReport(title, data) {
    // Create a window for printing
    const printWindow = window.open('', '_blank');
    
    if (!printWindow) {
        showToast('Error', 'El navegador bloqueó la ventana emergente para impresión', 'error');
        return;
    }
    
    // Create HTML content
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>${title}</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    margin: 20px;
                }
                h1 {
                    font-size: 18px;
                    margin-bottom: 10px;
                }
                .date {
                    font-size: 12px;
                    color: #666;
                    margin-bottom: 20px;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                }
                th, td {
                    border: 1px solid #ddd;
                    padding: 8px;
                    text-align: left;
                    font-size: 12px;
                }
                th {
                    background-color: #f2f2f2;
                    font-weight: bold;
                }
                tr:nth-child(even) {
                    background-color: #f9f9f9;
                }
                .footer {
                    margin-top: 20px;
                    font-size: 12px;
                    color: #666;
                    text-align: center;
                }
            </style>
        </head>
        <body>
            <h1>${title}</h1>
            <div class="date">Fecha: ${formatDate(new Date())}</div>
            <table>
                <thead>
                    <tr>
                        ${Object.keys(data[0]).map(key => `<th>${key}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${data.map(row => `
                        <tr>
                            ${Object.values(row).map(value => `<td>${value}</td>`).join('')}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div class="footer">
                Fleet Analytics Pro - Reporte generado el ${formatDate(new Date())}
            </div>
        </body>
        </html>
    `);
    
    // Print and close the window after loading
    printWindow.document.close();
    printWindow.addEventListener('load', function() {
        printWindow.print();
        printWindow.close();
    });
    
    showToast('Info', 'Preparando impresión...', 'info');
}

function exportCurrentView() {
    // Determine current active tab
    const activeTab = document.querySelector('.tab.active');
    if (!activeTab) {
        showToast('Error', 'No se pudo determinar la vista actual', 'error');
        return;
    }
    
    const tabId = activeTab.getAttribute('data-tab');
    
    // Export based on active tab
    switch (tabId) {
        case 'general':
            // Export combined data (status and pending)
            exportData('status-btn');
            break;
            
        case 'fuel':
            // Export fuel consumption data
            exportData('consumption-btn');
            break;
            
        case 'operativity':
            // Export maintenance and panne data
            exportData('maintenance-btn');
            break;
            
        case 'terminals':
            // Determine which terminal is active
            const activeTerminal = document.querySelector('.terminal-details:not(.hidden)');
            if (activeTerminal) {
                const terminalId = activeTerminal.id.replace('-details', '');
                exportData(`${terminalId}-btn`);
            } else {
                // Default to all terminals combined
                exportData('status-btn');
            }
            break;
            
        case 'reports':
            // Trigger report download if available
            if (!window.currentReport) {
                showToast('Info', 'Primero debe generar un reporte', 'info');
            } else {
                downloadReport();
            }
            break;
            
        default:
            showToast('Error', 'Tipo de vista no reconocido', 'error');
    }
}

function printCurrentView() {
    // Determine current active tab
    const activeTab = document.querySelector('.tab.active');
    if (!activeTab) {
        showToast('Error', 'No se pudo determinar la vista actual', 'error');
        return;
    }
    
    const tabId = activeTab.getAttribute('data-tab');
    
    // Set up report data based on active tab
    let reportTitle = '';
    let reportData = [];
    
    switch (tabId) {
        case 'general':
            reportTitle = 'Reporte de Estado de Flota';
            reportData = Object.values(combinedData.buses).map(bus => ({
                Patente: bus.plate,
                Terminal: bus.terminal || 'No asignado',
                Estado: getStatusText(bus.status),
                Ubicación: bus.location || 'No especificado',
                Detalle: bus.detail || bus.observations || 'No especificado'
            }));
            break;
            
        case 'fuel':
            reportTitle = 'Reporte de Consumo de Combustible';
            reportData = combinedData.fuel.loadedBuses.map(plate => {
                const bus = combinedData.buses[plate];
                return {
                    Patente: bus.plate,
                    Terminal: bus.terminal || 'No asignado',
                    'N° Cargas': bus.loadCount || 0,
                    'Total Litros': Math.round(bus.totalLiters || 0),
                    'Promedio': bus.loadCount > 0 ? Math.round(bus.totalLiters / bus.loadCount) : 0
                };
            });
            break;
            
        case 'operativity':
            reportTitle = 'Reporte de Operatividad de Flota';
            reportData = Object.values(combinedData.buses).map(bus => ({
                Patente: bus.plate,
                Terminal: bus.terminal || 'No asignado',
                Estado: getStatusText(bus.status),
                Ubicación: bus.location || 'No especificado',
                Detalle: bus.detail || bus.observations || 'No especificado'
            }));
            break;
            
        case 'terminals':
            // Determine which terminal is active
            const activeTerminal = document.querySelector('.terminal-details:not(.hidden)');
            if (activeTerminal) {
                const terminalId = activeTerminal.id.replace('-details', '');
                const terminalName = terminalId === 'el-roble' ? 'El Roble' : 
                                   terminalId === 'la-reina' ? 'La Reina' : 
                                   'María Angélica';
                
                reportTitle = `Reporte de Terminal ${terminalName}`;
                reportData = combinedData.terminals[terminalName].buses.map(plate => {
                    const bus = combinedData.buses[plate];
                    return {
                        Patente: bus.plate,
                        Estado: getStatusText(bus.status),
                        Ubicación: bus.location || 'No especificado',
                        'Carga Combustible': bus.loaded ? 'Sí' : 'No',
                        'Litros': Math.round(bus.totalLiters || 0)
                    };
                });
            } else {
                // Default to all terminals
                reportTitle = 'Reporte de Todos los Terminales';
                reportData = Object.values(combinedData.buses).map(bus => ({
                    Patente: bus.plate,
                    Terminal: bus.terminal || 'No asignado',
                    Estado: getStatusText(bus.status),
                    Ubicación: bus.location || 'No especificado'
                }));
            }
            break;
            
        case 'reports':
            // Use current report if available
            if (window.currentReport) {
                reportTitle = window.currentReport.title;
                reportData = window.currentReport.data;
            } else {
                showToast('Info', 'Primero debe generar un reporte', 'info');
                return;
            }
            break;
            
        default:
            showToast('Error', 'Tipo de vista no reconocido', 'error');
            return;
    }
    
    // Print the report
    if (reportData.length > 0) {
        printReport(reportTitle, reportData);
    } else {
        showToast('Info', 'No hay datos para imprimir', 'info');
    }
}

// -------------------------------------------------------------
// UI HELPER FUNCTIONS
// -------------------------------------------------------------
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    
    sidebar.classList.toggle('open');
    sidebarOverlay.classList.toggle('active');
}

function closeSidebar() {
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    
    sidebar.classList.remove('open');
    sidebarOverlay.classList.remove('active');
}

function toggleTheme() {
    isDarkMode = !isDarkMode;
    document.body.classList.toggle('dark', isDarkMode);
    
    // Update charts for the new theme
    updateChartsForTheme();
}

function updateChartsForTheme() {
    // Update Chart.js defaults
    Chart.defaults.color = isDarkMode ? '#94a3b8' : '#64748b';
    Chart.defaults.borderColor = isDarkMode ? 'rgba(71, 85, 105, 0.2)' : 'rgba(203, 213, 225, 0.3)';
    
    // Update all charts
    Object.values(charts).forEach(chart => {
        // Update point border colors for line charts
        if (chart.config.type === 'line') {
            chart.data.datasets.forEach(dataset => {
                dataset.pointBorderColor = isDarkMode ? '#1e293b' : '#ffffff';
            });
        }
        
        // Update doughnut/pie chart borders
        if (chart.config.type === 'doughnut' || chart.config.type === 'pie') {
            chart.data.datasets.forEach(dataset => {
                dataset.borderColor = isDarkMode ? '#1e293b' : '#ffffff';
            });
        }
        
        chart.update();
    });
}

function activateTab(tabId) {
    // Update tab buttons
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
        if (tab.getAttribute('data-tab') === tabId) {
            tab.classList.add('active');
        } else {
            tab.classList.remove('active');
        }
    });
    
    // Update tab content
    const tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(content => {
        if (content.id === `${tabId}-tab`) {
            content.classList.add('active');
        } else {
            content.classList.remove('active');
        }
    });
}

function showTerminalDetails(terminalId) {
    // Hide all terminal details
    const terminalDetails = document.querySelectorAll('.terminal-details');
    terminalDetails.forEach(detail => {
        detail.classList.add('hidden');
    });
    
    // Show selected terminal details
    const selectedTerminal = document.getElementById(`${terminalId}-details`);
    if (selectedTerminal) {
        selectedTerminal.classList.remove('hidden');
    }
    
    // Update terminal cards
    const terminalCards = document.querySelectorAll('.terminal-card');
    terminalCards.forEach(card => {
        if (card.getAttribute('data-terminal') === terminalId) {
            card.classList.add('bg-primary-50', 'dark:bg-primary-900/20', 'border-primary-200', 'dark:border-primary-700');
        } else {
            card.classList.remove('bg-primary-50', 'dark:bg-primary-900/20', 'border-primary-200', 'dark:border-primary-700');
        }
    });
}

function closeModal(modal) {
    modal.classList.remove('open');
}

function showToast(title, message, type = 'success') {
    // Set icon and colors based on type
    const toastIcon = document.getElementById('toast-icon');
    
    if (type === 'success') {
        toastIcon.innerHTML = '<iconify-icon icon="heroicons:check"></iconify-icon>';
        toastIcon.className = 'toast-icon bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400';
    } else if (type === 'error') {
        toastIcon.innerHTML = '<iconify-icon icon="heroicons:x-mark"></iconify-icon>';
        toastIcon.className = 'toast-icon bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400';
    } else if (type === 'warning') {
        toastIcon.innerHTML = '<iconify-icon icon="heroicons:exclamation-triangle"></iconify-icon>';
        toastIcon.className = 'toast-icon bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400';
    } else if (type === 'info') {
        toastIcon.innerHTML = '<iconify-icon icon="heroicons:information-circle"></iconify-icon>';
        toastIcon.className = 'toast-icon bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400';
    }
    
    // Set content
    document.getElementById('toast-title').textContent = title;
    document.getElementById('toast-message').textContent = message;
    
    // Show toast
    const toast = document.getElementById('toast');
    toast.classList.add('show');
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        hideToast();
    }, 5000);
}

function hideToast() {
    const toast = document.getElementById('toast');
    toast.classList.remove('show');
}

function getTerminalBadge(terminal) {
    if (terminal === 'El Roble') {
        return '<span class="terminal-badge terminal-el-roble">ER</span>';
    } else if (terminal === 'La Reina') {
        return '<span class="terminal-badge terminal-la-reina">LR</span>';
    } else if (terminal === 'María Angélica') {
        return '<span class="terminal-badge terminal-maria-angelica">MA</span>';
    } else {
        return '<span class="terminal-badge">--</span>';
    }
}

function getStatusText(status) {
    switch (status) {
        case 'operational':
            return 'Operativo';
        case 'maintenance':
            return 'Mantención';
        case 'panne':
            return 'Panne';
        default:
            return 'Sin datos';
    }
}

function formatDate(date) {
    if (!date) return 'N/A';
    
    if (typeof date === 'string') {
        return date;
    }
    
    try {
        const options = { 
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        
        return date.toLocaleDateString('es-CL', options);
    } catch (e) {
        return 'Fecha inválida';
    }
}

function getFormattedDateFilename() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    return `${year}${month}${day}`;
}

// -------------------------------------------------------------
// FLEET MANAGEMENT
// -------------------------------------------------------------
function updateFleetPreview() {
    const fleetPreview = document.getElementById('fleet-preview');
    const fleetCount = document.getElementById('fleet-count');
    
    fleetPreview.innerHTML = '';
    
    if (masterFleet.length === 0) {
        fleetPreview.innerHTML = '<div class="text-slate-500 dark:text-slate-400">No hay buses registrados</div>';
        fleetCount.textContent = '0 buses registrados';
        return;
    }
    
    // Create badges for a preview (limited to first 20)
    const previewLimit = 20;
    const previewBuses = masterFleet.slice(0, previewLimit);
    const remainingCount = masterFleet.length - previewLimit;
    
    // Add badges
    previewBuses.forEach(plate => {
        const badge = document.createElement('span');
        badge.className = 'inline-block bg-slate-200 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded-md px-1.5 py-0.5 m-0.5';
        badge.textContent = plate;
        fleetPreview.appendChild(badge);
    });
    
    // Add remaining count if needed
    if (remainingCount > 0) {
        const moreIndicator = document.createElement('span');
        moreIndicator.className = 'inline-block bg-slate-300 dark:bg-slate-700 text-slate-800 dark:text-slate-200 rounded-md px-1.5 py-0.5 m-0.5 font-medium';
        moreIndicator.textContent = `+${remainingCount} más`;
        fleetPreview.appendChild(moreIndicator);
    }
    
    // Update count
    fleetCount.textContent = `${masterFleet.length} buses registrados`;
    
    // Update process button state
    checkProcessButtonState();
}

function showEditFleetModal() {
    const editFleetModal = document.getElementById('edit-fleet-modal');
    const fleetTextarea = document.getElementById('fleet-textarea');
    
    fleetTextarea.value = masterFleet.join('\n');
    editFleetModal.classList.add('open');
}

function showImportFleetModal() {
    const importFleetModal = document.getElementById('import-fleet-modal');
    const importFleetTextarea = document.getElementById('import-fleet-textarea');
    
    importFleetTextarea.value = '';
    importFleetModal.classList.add('open');
}

function saveFleet() {
    const fleetTextarea = document.getElementById('fleet-textarea');
    const editFleetModal = document.getElementById('edit-fleet-modal');
    
    const fleetText = fleetTextarea.value;
    masterFleet = fleetText
        .split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0);
    
    updateFleetPreview();
    closeModal(editFleetModal);
    showToast('Éxito', 'Flota actualizada correctamente', 'success');
}

function processImportFleet() {
    const importFleetTextarea = document.getElementById('import-fleet-textarea');
    const importFleetModal = document.getElementById('import-fleet-modal');
    
    const importText = importFleetTextarea.value;
    if (!importText.trim()) {
        showToast('Error', 'Debe ingresar datos para importar', 'error');
        return;
    }
    
    // Process input to extract valid plates
    const processedPlates = processPlatesInput(importText);
    
    if (processedPlates.length === 0) {
        showToast('Error', 'No se encontraron patentes válidas en los datos ingresados', 'error');
        return;
    }
    
    // Add new plates to master fleet (avoid duplicates)
    const oldCount = masterFleet.length;
    const uniquePlates = new Set([...masterFleet, ...processedPlates]);
    masterFleet = Array.from(uniquePlates);
    
    updateFleetPreview();
    closeModal(importFleetModal);
    
    const newPlates = masterFleet.length - oldCount;
    showToast('Éxito', `${processedPlates.length} patentes procesadas, ${newPlates} nuevas agregadas`, 'success');
}

function processPlatesInput(input) {
    // Split by common delimiters
    const parts = input.split(/[\n\t,;]+/);
    
    // Define a pattern for valid Chilean license plates
    // This is a simplified pattern for demonstration
    const platePattern = /([A-Z]{2,4}[0-9]{2,3})/;
    
    // Extract valid plates
    const plates = [];
    
    parts.forEach(part => {
        const cleanPart = part.trim().toUpperCase();
        
        // Direct match
        if (platePattern.test(cleanPart)) {
            plates.push(cleanPart);
            return;
        }
        
        // Try to extract a valid plate from text
        const matches = cleanPart.match(platePattern);
        if (matches) {
            plates.push(matches[0]);
        }
    });
    
    // Remove duplicates
    return [...new Set(plates)];
}

// -------------------------------------------------------------
// BUS DETAIL MODAL
// -------------------------------------------------------------
function showBusDetail(plate) {
    const bus = combinedData.buses[plate];
    const busDetailModal = document.getElementById('bus-detail-modal');
    const busDetailContent = document.getElementById('bus-detail-content');
    
    if (!bus) {
        showToast('Error', `No se encontró información para el bus ${plate}`, 'error');
        return;
    }
    
    // Build status badge
    let statusBadge = '';
    let statusClass = '';
    let statusIcon = '';
    
    if (bus.status === 'operational') {
        statusBadge = '<span class="status-pill status-operational">Operativo</span>';
        statusClass = 'text-emerald-600 dark:text-emerald-400';
        statusIcon = 'heroicons:check-circle';
    } else if (bus.status === 'maintenance') {
        statusBadge = '<span class="status-pill status-maintenance">Mantención</span>';
        statusClass = 'text-amber-600 dark:text-amber-400';
        statusIcon = 'heroicons:wrench-screwdriver';
    } else if (bus.status === 'panne') {
        statusBadge = '<span class="status-pill status-panne">Panne</span>';
        statusClass = 'text-red-600 dark:text-red-400';
        statusIcon = 'heroicons:exclamation-circle';
    } else {
        statusBadge = '<span class="status-pill status-inactive">Sin datos</span>';
        statusClass = 'text-slate-500 dark:text-slate-400';
        statusIcon = 'heroicons:question-mark-circle';
    }
    
    // Format for loaded/pending status
    const fuelStatus = bus.loaded 
        ? `<span class="text-emerald-600 dark:text-emerald-400 font-medium">Cargado</span> (${Math.round(bus.totalLiters).toLocaleString('es-CL')} Lts)`
        : '<span class="text-amber-600 dark:text-amber-400 font-medium">Pendiente</span>';
    
    // Build detail content
    busDetailContent.innerHTML = `
        <div class="bus-details-card">
            <div class="bus-details-header">
                <div class="bus-details-plate">${plate}</div>
                <div class="bus-details-status">
                    <iconify-icon icon="${statusIcon}"></iconify-icon>
                    <span>${getStatusText(bus.status)}</span>
                </div>
            </div>
            
            <div class="bus-details-body">
                <div class="bus-details-section">
                    <div class="bus-details-section-title">
                        <iconify-icon icon="heroicons:truck"></iconify-icon>
                        <span>Información General</span>
                    </div>
                    
                    <div class="bus-details-info-grid">
                        <div class="bus-details-info-item">
                            <div class="bus-details-info-label">Terminal</div>
                            <div class="bus-details-info-value">${bus.terminal || 'No asignado'}</div>
                        </div>
                        
                        <div class="bus-details-info-item">
                            <div class="bus-details-info-label">Ubicación</div>
                            <div class="bus-details-info-value">${bus.location || 'No especificado'}</div>
                        </div>
                        
                        <div class="bus-details-info-item">
                            <div class="bus-details-info-label">Servicio</div>
                            <div class="bus-details-info-value">${bus.service || 'No especificado'}</div>
                        </div>
                        
                        <div class="bus-details-info-item">
                            <div class="bus-details-info-label">Estado</div>
                            <div class="bus-details-info-value ${statusClass}">${getStatusText(bus.status)}</div>
                        </div>
                    </div>
                </div>
                
                <div class="bus-details-section">
                    <div class="bus-details-section-title">
                        <iconify-icon icon="heroicons:beaker"></iconify-icon>
                        <span>Información de Combustible</span>
                    </div>
                    
                    <div class="bus-details-info-grid">
                        <div class="bus-details-info-item">
                            <div class="bus-details-info-label">Estado</div>
                            <div class="bus-details-info-value">${fuelStatus}</div>
                        </div>
                        
                        <div class="bus-details-info-item">
                            <div class="bus-details-info-label">Cargas</div>
                            <div class="bus-details-info-value">${bus.loadCount || 0}</div>
                        </div>
                        
                        <div class="bus-details-info-item">
                            <div class="bus-details-info-label">Litros Totales</div>
                            <div class="bus-details-info-value">${Math.round(bus.totalLiters || 0).toLocaleString('es-CL')} Lts</div>
                        </div>
                        
                        <div class="bus-details-info-item">
                            <div class="bus-details-info-label">Promedio por Carga</div>
                            <div class="bus-details-info-value">
                                ${bus.loadCount > 0 ? Math.round(bus.totalLiters / bus.loadCount).toLocaleString('es-CL') : 0} Lts
                            </div>
                        </div>
                    </div>
                </div>
                
                ${(bus.detail || bus.observations) ? `
                <div class="bus-details-section">
                    <div class="bus-details-section-title">
                        <iconify-icon icon="heroicons:information-circle"></iconify-icon>
                        <span>Detalles Adicionales</span>
                    </div>
                    
                    <div class="p-3 bg-slate-50 dark:bg-slate-900 rounded-lg">
                        ${bus.detail ? `<p class="text-sm mb-2">${bus.detail}</p>` : ''}
                        ${bus.observations ? `<p class="text-sm">${bus.observations}</p>` : ''}
                    </div>
                </div>
                ` : ''}
                
                <div class="bus-details-section">
                    <div class="bus-details-section-title">
                        <iconify-icon icon="heroicons:clipboard-document-list"></iconify-icon>
                        <span>Acciones Recomendadas</span>
                    </div>
                    
                    <div class="p-3 bg-slate-50 dark:bg-slate-900 rounded-lg">
                        ${getRecommendedActions(bus)}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Show modal
    busDetailModal.classList.add('open');
}

function getRecommendedActions(bus) {
    // Generate recommendations based on bus status
    if (!bus.loaded && bus.status === 'operational') {
        return `
            <div class="text-sm text-amber-600 dark:text-amber-400 font-medium mb-2 flex items-center gap-1.5">
                <iconify-icon icon="heroicons:exclamation-triangle"></iconify-icon>
                <span>Bus operativo pendiente por cargar</span>
            </div>
            <p class="text-sm text-slate-600 dark:text-slate-400">
                Este bus está marcado como operativo pero no registra cargas de combustible.
                Se recomienda priorizar su carga o verificar su ubicación actual.
            </p>
        `;
    } else if (bus.status === 'maintenance') {
        return `
            <div class="text-sm text-amber-600 dark:text-amber-400 font-medium mb-2 flex items-center gap-1.5">
                <iconify-icon icon="heroicons:wrench-screwdriver"></iconify-icon>
                <span>Bus en mantención programada</span>
            </div>
            <p class="text-sm text-slate-600 dark:text-slate-400">
                Este bus se encuentra actualmente en mantención programada.
                ${bus.detail ? `Detalle: ${bus.detail}` : 'No hay detalles adicionales registrados.'}
            </p>
        `;
    } else if (bus.status === 'panne') {
        return `
            <div class="text-sm text-red-600 dark:text-red-400 font-medium mb-2 flex items-center gap-1.5">
                <iconify-icon icon="heroicons:exclamation-circle"></iconify-icon>
                <span>Bus en panne</span>
            </div>
            <p class="text-sm text-slate-600 dark:text-slate-400">
                Este bus se encuentra actualmente en panne.
                ${bus.detail ? `Detalle: ${bus.detail}` : 'No hay detalles adicionales registrados.'}
                Se recomienda contactar al departamento de mantenimiento.
            </p>
        `;
    } else if (bus.loaded && bus.status === 'operational') {
        return `
            <div class="text-sm text-emerald-600 dark:text-emerald-400 font-medium mb-2 flex items-center gap-1.5">
                <iconify-icon icon="heroicons:check-circle"></iconify-icon>
                <span>Bus operativo y cargado</span>
            </div>
            <p class="text-sm text-slate-600 dark:text-slate-400">
                Este bus está operativo y ha sido cargado con combustible.
                No se requieren acciones adicionales en este momento.
            </p>
        `;
    } else {
        return `
            <div class="text-sm text-slate-600 dark:text-slate-400 font-medium mb-2 flex items-center gap-1.5">
                <iconify-icon icon="heroicons:information-circle"></iconify-icon>
                <span>Información insuficiente</span>
            </div>
            <p class="text-sm text-slate-600 dark:text-slate-400">
                No hay suficiente información para generar recomendaciones.
                Se sugiere verificar el estado operativo del bus.
            </p>
        `;
    }
}

function printBusDetail() {
    const busDetailContent = document.getElementById('bus-detail-content');
    const printWindow = window.open('', '_blank');
    
    if (!printWindow) {
        showToast('Error', 'El navegador bloqueó la ventana emergente para impresión', 'error');
        return;
    }
    
    // Create HTML content
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Detalle de Bus</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    margin: 20px;
                    color: #333;
                }
                h1 {
                    font-size: 20px;
                    margin-bottom: 10px;
                }
                .section {
                    margin-bottom: 20px;
                }
                .section-title {
                    font-size: 16px;
                    font-weight: bold;
                    margin-bottom: 10px;
                    padding-bottom: 5px;
                    border-bottom: 1px solid #ddd;
                }
                .info-grid {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 10px;
                }
                .info-item {
                    padding: 8px;
                    background-color: #f8f8f8;
                    border-radius: 4px;
                }
                .info-label {
                    font-size: 12px;
                    color: #666;
                    margin-bottom: 4px;
                }
                .info-value {
                    font-size: 14px;
                    font-weight: 600;
                }
                .details-box {
                    background-color: #f8f8f8;
                    padding: 10px;
                    border-radius: 4px;
                    margin-bottom: 15px;
                }
                .status-operational {
                    color: #047857;
                }
                .status-maintenance {
                    color: #b45309;
                }
                .status-panne {
                    color: #b91c1c;
                }
                .footer {
                    margin-top: 20px;
                    font-size: 12px;
                    color: #666;
                    text-align: center;
                }
            </style>
        </head>
        <body>
            <h1>Detalle de Bus</h1>
            <div class="bus-details">
                ${busDetailContent.innerHTML}
            </div>
            <div class="footer">
                Fleet Analytics Pro - Documento generado el ${formatDate(new Date())}
            </div>
        </body>
        </html>
    `);
    
    // Print and close the window after loading
    printWindow.document.close();
    printWindow.addEventListener('load', function() {
        printWindow.print();
        printWindow.close();
    });
    
    showToast('Info', 'Preparando impresión...', 'info');
}

// -------------------------------------------------------------
// REFRESH AND UPDATE FUNCTIONS
// -------------------------------------------------------------
function refreshData() {
    if (!fuelData || !operativityData) {
        showToast('Error', 'No hay datos para actualizar', 'error');
        return;
    }
    
    // Re-combine data
    combineData();
    
    // Update dashboard
    updateKeyMetrics();
    updateCharts();
    renderPendingBusesTable();
    renderMaintenanceBusesTable();
    renderConsumptionTable();
    renderStatusTable();
    updateTerminalMetrics();
    renderLocations();
    renderAnomalies();
    renderTerminalBusGrids();
    
    showToast('Éxito', 'Datos actualizados correctamente', 'success');
}

// -------------------------------------------------------------
// MAKE FUNCTIONS AVAILABLE GLOBALLY
// -------------------------------------------------------------
window.showBusDetail = showBusDetail;
window.printBusDetail = printBusDetail;
window.showTerminalDetails = showTerminalDetails;
window.getTerminalBadge = getTerminalBadge;
window.getStatusText = getStatusText;
window.formatDate = formatDate;
window.exportData = exportData;
window.generateReport = generateReport;
window.downloadReport = downloadReport;
window.printReport = printReport;
window.exportCurrentView = exportCurrentView;
window.printCurrentView = printCurrentView;
window.getRecommendedActions = getRecommendedActions;
window.refreshData = refreshData;

</script>
</body>
</html>